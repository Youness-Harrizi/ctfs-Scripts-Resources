<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>19-demo steps</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>19-demo steps</h1><br/><p><h2>Exam : ACBxxx</h2></p><p><div class="codebox"><pre>Based on the document, here<span style="color:#333333;font-weight:400">&#39;s a detailed breakdown of the penetration testing path used in the CTF report:<br /><br />1. **Initial Foothold**:<br />   - **Identify** machines with port 25 (SMTP) open for email spoofing and port 80 for web services.<br />   - **Craft a modified Meterpreter payload** (`met.exe`) to evade antivirus detection, using a custom C# application named `Helper` and another named `Met` to encode and execute the payload.<br /><br />2. **AV Evasion Payload Execution**:<br />   - The payload, crafted with `msfvenom` and encoded in C#, is designed to bypass antivirus software by modifying the payload bytes and executing it in memory without touching the disk.<br /><br />3. **Delivery and Execution**:<br />   - **Create an HTA file** that, when opened, executes a PowerShell command to download and run the Meterpreter payload (`Met.exe`) from a controlled server.<br />   - **Use Swaks** for email spoofing to deliver the HTA file to the target, simulating a phishing attack to gain initial access.<br /><br />4. **Privilege Escalation and Credential Access**:<br />   - Upon gaining shell access, **find sensitive files** like `mail.ps1` in `C:\ProgramFiles\Setup` to extract credentials.<br />   - **Execute PowerShell scripts remotely** to download additional tools like `PowerView` for further enumeration and privilege escalation.<br /><br />5. **Lateral Movement**:<br />   - **Enumerate the domain** using tools like `SharpHound`.<br />   - **Set up a SOCKS proxy** with `autoroute` in Metasploit and use `proxychains` for network pivoting and accessing additional systems.<br /><br />6. **Domain Privilege Escalation**:<br />   - Exploit SQL servers&#39;</span> link to <span style="color:#ff9d00;font-weight:700">**</span>perform NTLM relay attacks<span style="color:#ff9d00;font-weight:700">**</span>, dumping SAM databases to extract administrative credentials.<br />   <span style="color:#ff9d00;font-weight:700">-</span> <span style="color:#ff9d00;font-weight:700">**</span>Use local admin hashes<span style="color:#ff9d00;font-weight:700">**</span> to enable RDP, disable antivirus, and execute <span style="color:#ff9d00;font-weight:700">`</span>mimikatz<span style="color:#ff9d00;font-weight:700">`</span> <span style="color:#ff9d00;font-weight:700">for</span> further credential dumping and lateral movement.<br /><br /><span style="color:#333333;font-weight:400">7</span>. <span style="color:#ff9d00;font-weight:700">**</span>Persistence and Exfiltration<span style="color:#ff9d00;font-weight:700">**:</span><br />   <span style="color:#ff9d00;font-weight:700">-</span> <span style="color:#ff9d00;font-weight:700">**</span>Manipulate system settings<span style="color:#ff9d00;font-weight:700">**</span> to ensure persistence, such as disabling Windows Defender <span style="color:#00117f;font-weight:400">real-time</span> monitoring and enabling RDP.<br />   <span style="color:#ff9d00;font-weight:700">-</span> <span style="color:#ff9d00;font-weight:700">**</span>Exploit RBCD (<span style="color:#00117f;font-weight:400">Resource-Based</span> Constrained Delegation)<span style="color:#ff9d00;font-weight:700">**</span> to gain execution as a highly privileged service account on targeted machines.<br />   <span style="color:#ff9d00;font-weight:700">-</span> <span style="color:#ff9d00;font-weight:700">**</span>Insert reverse shells<span style="color:#ff9d00;font-weight:700">**</span> and use port forwarding to maintain access and exfiltrate data.<br /><br /><span style="color:#333333;font-weight:400">8</span>. <span style="color:#ff9d00;font-weight:700">**</span>Final Exfiltration<span style="color:#ff9d00;font-weight:700">**:</span><br />   <span style="color:#ff9d00;font-weight:700">-</span> <span style="color:#ff9d00;font-weight:700">**</span>Perform command injection<span style="color:#ff9d00;font-weight:700">**</span> on a web application to gain shell access on a critical server, reading sensitive files like <span style="color:#ff9d00;font-weight:700">`</span>secret.txt<span style="color:#ff9d00;font-weight:700">`</span>.<br /><br />This summary encapsulates the attacker<span style="color:#333333;font-weight:400">&#39;s journey from initial access via spear-phishing to deep lateral movement, privilege escalation, and ultimately data exfiltration, highlighting the sophistication and stealth required in modern penetration testing and red teaming operations.</span></pre></div></p><p><h2>Exam </h2>2</p><p></p><p><div class="codebox"><pre><span style="color:#333333;font-weight:400">1</span>. Upload aspx shell(same one as <span style="color:#ff9d00;font-weight:700">in</span> Challenge <span style="color:#333333;font-weight:400">6</span> <span style="color:#ff9d00;font-weight:700">in</span> the lab), <span style="color:#ff9d00;font-weight:700">then</span> trigger it <span style="color:#ff9d00;font-weight:700">in</span> <span style="color:#ff9d00;font-weight:700">/</span>files<span style="color:#ff9d00;font-weight:700">/</span> folder<br /><span style="color:#333333;font-weight:400">2</span>. Priv esc using PrintSpoofer(same way as <span style="color:#ff9d00;font-weight:700">in</span> the labs and on page <span style="color:#00117f;font-weight:400">474-478</span> <span style="color:#ff9d00;font-weight:700">in</span> PDF)<br /><span style="color:#333333;font-weight:400">3</span>. Disable Defender on the machine, disable LSA protection <span style="color:#ff9d00;font-weight:700">in</span> mimikatz(same way as <span style="color:#ff9d00;font-weight:700">in</span> labs)<br /><span style="color:#333333;font-weight:400">4</span>. Enumerate domain(with BloodHound or PowerView) to see that FILE machine have constrained delegation enabled<br /><span style="color:#333333;font-weight:400">5</span>. Use s4u attack to exploit constrained delegation<br /><span style="color:#333333;font-weight:400">6</span>. Find encrypted ssh key on the FILE machine which you crack and <span style="color:#ff9d00;font-weight:700">then</span> login on the ansible machine<br /><span style="color:#333333;font-weight:400">7</span>. Priv esc using <span style="color:#3ad900;font-weight:400">&quot;sudo -l&quot;</span><br /><span style="color:#333333;font-weight:400">8</span>. <span style="color:#ff9d00;font-weight:700">Switch</span> to ansiblesvc user and login with the ssh key <span style="color:#ff9d00;font-weight:700">in</span> home folder on the machine mentioned <span style="color:#ff9d00;font-weight:700">in</span> <span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>ansible<span style="color:#ff9d00;font-weight:700">/</span>hosts<br /><span style="color:#333333;font-weight:400">9</span>. Priv esc using <span style="color:#3ad900;font-weight:400">&quot;sudo -l&quot;</span> <br /><span style="color:#333333;font-weight:400">10</span>. Find ccache ticket <span style="color:#ff9d00;font-weight:700">in</span> <span style="color:#ff9d00;font-weight:700">/</span>tmp that belongs to dave user and transfer this to your machine.<br /><span style="color:#333333;font-weight:400">11</span>. <span style="color:#ff9d00;font-weight:700">Set</span> ticket <span style="color:#ff9d00;font-weight:700">in</span> KRB5CCNAME environment variable<br /><span style="color:#333333;font-weight:400">12</span>. Check <span style="color:#ff9d00;font-weight:700">in</span> BloodHound what machine dave has a session on, and connect to this machine with Kerberos authentication<br /><span style="color:#333333;font-weight:400">13</span>. Create a SQL binary(same way as <span style="color:#ff9d00;font-weight:700">in</span> course on page <span style="color:#00117f;font-weight:400">575-579</span>) and execute the following commands to pwn the SQL links(change name from SQL01 to whatever you have on your SQL link<span style="color:#ff9d00;font-weight:700">:</span><br />EXECUTE AS LOGIN <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">&#39;sa&#39;</span>;<br />EXEC (<span style="color:#333333;font-weight:400">&#39;sp_configure &#39;&#39;show advanced options&#39;&#39;, 1; reconfigure&#39;</span>) AT SQL01<br />EXEC (<span style="color:#333333;font-weight:400">&#39;sp_configure &#39;&#39;xp_cmdshell&#39;&#39;, 1; reconfigure&#39;</span>) AT SQL01<br />EXEC (<span style="color:#333333;font-weight:400">&#39;xp_cmdshell &#39;&#39;hostname&amp;&amp;whoami&#39;&#39; &#39;</span>) AT SQL01<br /><br /><span style="color:#ff9d00;font-weight:700">If</span> you have command execution now, spawn a shell <span style="color:#ff9d00;font-weight:700">in</span> any way you like(powershell.exe <span style="color:#ff9d00;font-weight:700">-</span>e encodedHere) <span style="color:#ff9d00;font-weight:700">for</span> example<br /><span style="color:#333333;font-weight:400">14</span>. Priv esc using PrintSpoofer(same way as <span style="color:#ff9d00;font-weight:700">in</span> the labs and on page <span style="color:#00117f;font-weight:400">474-478</span> <span style="color:#ff9d00;font-weight:700">in</span> PDF)<br /><span style="color:#333333;font-weight:400">15</span>. Disable AV, dump hashes using mimikatz to find password <span style="color:#ff9d00;font-weight:700">for</span> zen user<br /><span style="color:#333333;font-weight:400">16</span>. Check BloodHound and see that zen user can read LAPS<br /><span style="color:#333333;font-weight:400">17</span>. Read the LAPS password with any preferrable way on the machine left <span style="color:#ff9d00;font-weight:700">in</span> the domain(check BH <span style="color:#ff9d00;font-weight:700">for</span> this)<br /><span style="color:#333333;font-weight:400">18</span>. Enable RDP pass the hash on the SQL machine(after doing step number <span style="color:#333333;font-weight:400">15</span>), <span style="color:#ff9d00;font-weight:700">then</span> RDP into it as admin<br /><span style="color:#333333;font-weight:400">19</span>. From this RDP machine, RDP to the machine you read LAPS on using the LAPS password as user administrator<br /><span style="color:#333333;font-weight:400">20</span>. Disable all firewall completely since there is a firewall rule that blocks SMB which we want to remove so we can connect to the machine from our Kali<br /><span style="color:#333333;font-weight:400">21</span>. Setup socks proxy from your msf shell on the SQL machine (same way as page <span style="color:#00117f;font-weight:400">511-512</span> <span style="color:#ff9d00;font-weight:700">in</span> OSEP PDF)<br /><span style="color:#333333;font-weight:400">22</span>. Connect to the machine(same machine as you found out <span style="color:#ff9d00;font-weight:700">in</span> step number <span style="color:#333333;font-weight:400">17</span>) from your Kali with Impacket<br /><span style="color:#333333;font-weight:400">23</span>. Grab secret.txt</pre></div></p><p></p><p></p><p><h2>Exam 3: BetaPxxx</h2></p><p></p><p><div class="codebox"><pre>Initial Foothold<span style="color:#ff9d00;font-weight:700">:</span><br /><br />The tester exploits a web vulnerability to upload and execute an ASPX web shell on the target server, establishing an initial foothold.<br />Privilege Escalation<span style="color:#ff9d00;font-weight:700">:</span><br /><br />Utilizing the PrintSpoofer exploit, the tester escalates privileges to SYSTEM on the compromised server.<br />Techniques to disable Windows Defender and evade detection are applied, ensuring uninterrupted access.<br />Domain Enumeration<span style="color:#ff9d00;font-weight:700">:</span><br /><br />Tools like BloodHound and PowerView are deployed to map out the domain<span style="color:#333333;font-weight:400">&#39;s trust relationships and identify potential privilege escalation vectors.<br />Exploiting Delegation:<br /><br />An S4U (Service for User) attack is performed to exploit constrained delegation, allowing the tester to impersonate domain users and access restricted resources.<br />Credential Access and Lateral Movement:<br /><br />The tester cracks encrypted SSH keys found on one of the servers, gaining access to additional systems.<br />Leveraging sudo privileges on a Linux server, the tester moves laterally within the network.<br />Database and Application Server Exploits:<br /><br />SQL Server configuration manipulations are performed to execute commands and further escalate privileges.<br />Mimikatz is used to dump credentials from memory, facilitating access to other sensitive areas of the network.<br />Final Objective - Sensitive Data Exfiltration:<br /></span><br /><span style="color:#333333;font-weight:400">The Local Administrator Password Solution (LAPS) is exploited to retrieve administrative credentials.<br />Sensitive information is identified and exfiltrated, achieving the penetration test&#39;</span>s objectives.</pre></div></p></div>
</body>
</html>
