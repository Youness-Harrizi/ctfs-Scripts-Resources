<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ADCS</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>ADCS</h1><br/><p><a href="https://www.youtube.com/watch?v=YLlfMtOkwA0">https://www.youtube.com/watch?v=YLlfMtOkwA0</a></p><p></p><p><ul><li>PKINIT : kerberos extension that allows extension of kerberos auth to include certificate authentication</li><li>certificate template is a model to ask for a certificate (client send CSR and get cert)</li><li>ESC1: template need to have domain attacker able to enroll + enrolle supply subkect enabled (allow to request certificate for any domain user) + eku (purpose) contains client authentication</li><li>ESC2 vs ESC1: in ESC2 we need any purpose EKU allows to get a certificate for any purpose like client auth, server auth , code signing etc </li><li>ESC2<ul><li></li></ul></li></ul><img src="images/464-1.png" alt="images/464-1.png" /><ul><li></li></ul><img src="images/464-2.png" alt="images/464-2.png" /><ul><li></li></ul><img src="images/464-3.png" alt="images/464-3.png" /><ul><li>abuse same as esc1</li><li></li></ul><img src="images/464-4.png" alt="images/464-4.png" /></p><p></p><p></p><p><ul><li>ESC3 has different EKU : enrollement agent (get a certificate on behalf of other user=<ul><li>requirements <ul><li></li></ul></li></ul></li></ul><img src="images/464-5.png" alt="images/464-5.png" /></p><p></p><p><ul><li></li></ul><img src="images/464-6.png" alt="images/464-6.png" /><ul><li></li></ul><img src="images/464-7.png" alt="images/464-7.png" /></p><p></p><p></p><p></p><p><ul><li>exploit <ul><li>we request cert for esc3 </li><li>we use esc3 to isse certificate request to esct3</li><li></li></ul></li></ul><img src="images/464-8.png" alt="images/464-8.png" /><ul><li></li></ul><img src="images/464-9.png" alt="images/464-9.png" /><ul><li></li></ul><img src="images/464-10.png" alt="images/464-10.png" /></p><p></p><p></p><p></p><p><ul><li>ESC8 is when havong web enrollem√πent<ul><li>web allow ntlm relay </li><li></li></ul></li></ul><img src="images/464-11.png" alt="images/464-11.png" /></p><p></p><p><ul><li>attack let domain user to authenticate to our server and relay it </li><li>we can corece the domain machint ti authenticate to our machine </li></ul></p><p></p><p><ul><li>NTLM allowed<ul><li></li></ul></li></ul><img src="images/464-12.png" alt="images/464-12.png" /><ul><li>set up ntlm relay server listening for all known protocols we specify the target which is web enrollement interface then we specify the template we want to abuse <ul><li></li></ul></li></ul><img src="images/464-13.png" alt="images/464-13.png" /></p><p></p><p><ul><li>force dc to inititate connection to our attacker machine via dfscoerce<ul><li>why is that possible well several windows protocols like MS(RRPN(print spoller service) ; MS-FSRVP(file share shadow copy service); MS-EFSRPC (encrypting file system) ; MS-dfsnm (distributed filesystem) allows unauthentciated or low priv users to interact with the services and many of the services push the dc to authenticate back to the user </li></ul></li></ul><img src="images/464-14.png" alt="images/464-14.png" /><img src="images/464-15.png" alt="images/464-15.png" /><ul><li>$attacker machine $target machine </li><li></li></ul><img src="images/464-16.png" alt="images/464-16.png" /> </p></div>
</body>
</html>
