<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>01-AD102</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>01-AD102</h1><br/><p><h2>NTLM relay</h2></p><p><ul><li>prérequis <ul><li>se mettre en MITM </li><li>di c&#39;est pas compte machine essaier de le casser</li><li>e.g via LLMNR poisononng or IPV6 poisoning (mitm6) since IPV6 is the prefered method for Microsoft or via coearcing attacj</li><li>then a session is created </li><li>protocols can be SMB HTTP, LDAP </li><li>absence de signature de flux (les requetes sont signees avec le mdp du client que l&#39;attaquznt ne possede pas ) et de channel binding  </li><li>on peut realiser des actions sur le serveur ciblé avec les droit du client (lire des oartages de reseau par SMB , acces annuaire LDAP, execution de commandes si droits administrateur)</li><li>SMB ; HTTP; LDAP integrent NTLM via SSP <ul><li>a noter que pour post exploit via mimikatz il y a loption d&#39;enregister un SSPi malveillant kiwi_ssp comme backdoor et qui va ecrire tous les mdp de ceux qui s&#39;authentifient avec lui dans un txt </li></ul></li><li>with channel biniding (EPA enabled) ca restreint l&#39;attque au protocole normele et au serveur <ul><li>en channel binding on a aussi encapsulaion ssl </li></ul></li></ul></li><li>si NTLMv1 est supporté le relai est toujours possible </li><li>SMBv1: il faut tester d autres vulns comme  RCE non authentifier comme eternalblue a tester</li><li>relais SMB=&gt; LDAP : pas possible sauf avec exploitation de la CVE DropTheMic</li><li>si le serveur n&#39;a pas de SMB signing exigé cote serveur alors relais oossible depuis HTTP/SMB</li><li>nxc smb all_ips </li></ul></p><p></p><p><ul><li>Etapes <ul><li>capture hash</li><li>attempt to crack hash</li><li>verifier que l&#39;on est bien capable de se mettre en position MITM (LLMNR &amp; NBTNS/ IPV6 preffered over IPV4, ARP poisoning, coerce)</li><li>cree liste de serveurs qui n&#39;ont pas de smb signing (--gen-relay-list de NXC)<ul><li>nxc smb all_ipq --gen-relay-list smb_targets </li></ul></li><li>lancer ntlmrelayx avec cette liste en target</li><li>on se place en position MITM</li><li>on responder.conf put SMB off and HTTp OFF</li><li>responder -I interface</li></ul></li></ul><img src="images/465-1.png" alt="images/465-1.png" /><ul><li>E.g responder repond positivement a tous les requetes LLMNR &amp; NBTNS (DNS obsolete= resolution de nom en peer to peer : en 2025 ca ne doit pas etre actové </li><li>ce qui se passe c&#39;est que attaquant  se met en positiond e resolveur de nom et repond que c&#39;est son IP pour toute requete </li><li>ntlmrelay ecout sur port smb 445 et ldap 636  </li></ul><img src="images/465-2.png" alt="images/465-2.png" /><ul><li>ntlmrelayx -t ldap://$target -of netntlm --smb2suport -socks <ul><li>-of pour fichier qui ecrit hashs </li><li>ntlmrelayx relay l&#39;authentiocation et execute des actions avec </li><li>-socks lorque on veut faire du lateral movement sinon il y a d&#39;autres type d&#39;actions</li><li>--remove-mic c&#39;est assez rare mais ca coute rien  ,</li></ul></li><li>verifier si on est admin car on pourrait lancer secretsdumps (adminstatus)</li></ul><img src="images/465-3.png" alt="images/465-3.png" /><ul><li></li></ul><img src="images/465-4.png" alt="images/465-4.png" /><ul><li>ou smbexec -no-pass </li><li>ou dumpapi pour collecter les ùmdp en clairs </li><li>ps proxychains c&#39;est un le tunnel cree par ntlmrelayx c&#39;est pas un proxychains classic qui permet de s&#39;authentifier vers d&#39;autres machines </p><p></li></ul><img src="images/465-5.png" alt="images/465-5.png" /></p><p><ul><li>notes par defaut secretsdump fais du smbexec <ul><li>smbexec =&gt; smb en tant qu&#39;admin =&gt;creation de service =&gt; execution =&gt;stockage du resulta dans un fichier =&gt; lecture du resulta avec un fichier </li><li>--no-pass utilise le cache </li></ul></li></ul></p><p></p><p></p><p><h2>Relai SMB vers ldap</h2></p><p><ul><li>e.g coercer une machine avec coercer </li><li>coercer : </li><li>forcer serveur distant a sauthentifiant vers un champ qu&#39;on controle   e;g smb://ourIP </li><li>si dans bloodhound ou AD miner on voit qu&#39;on a une machine qui est admin d&#39;une autre machine on peut compromotter machine 1 et relayer vers machine 2 </li><li>coercer peut sonner un edr (mais pas de grave vu que ca evoei des rpc requests mal formés) ; responder si tu le lances par defaut sur un reseau local ca met un bordel du reseau (car repondre de la merde sur llmnr sur approximativembt tous; du coup on commence par une ecoute passive  </li><li>il faut que le flux de la mahcine vers nous meme soit oiuvert</p><p></li></ul><img src="images/465-6.png" alt="images/465-6.png" /><ul><li>lacer ntlmrelayx (&#39;se met en, mode passif)</li><li></li></ul><img src="images/465-7.png" alt="images/465-7.png" /><ul><li>-l listening maching = my machine but could be  arremote machine </li><li></li></ul><img src="images/465-8.png" alt="images/465-8.png" /><ul><li>in ntlmrelayx<ul><li></li></ul></li></ul><img src="images/465-9.png" alt="images/465-9.png" /><ul><li>lootdir contain domain info</li></ul></li><li>SI TU PEUX COERCER UN DOMAIN Controller et tu puisse faire des actions du coup tu as compromis le Domaine </p></div>
</body>
</html>
