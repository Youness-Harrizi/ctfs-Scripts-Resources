<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>RBCD</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>RBCD</h1><br/><p><h2>Intro</h2></p><p><ul><li> Exemple de base de delegation : <ul><li>user s&#39;authentifie sur un web serveur</li><li>server Web a besoin de consulter base de donnée en backend : on vent que l&#39;auth soit fait avec AD ; </li><li>service en AD sont definis par SPN et pour lesqueles on peut requeter via TGS </li></ul></li></ul><img src="images/468-1.png" alt="images/468-1.png" /></p><p></p><p></p><p><h2>Prérequis attaque 1</h2></p><p><ul><li>si on compromet serveur   (plus specifiquent controle d&#39;un object computer , mentionné dans l&#39;attribut msds-allowedToActOnBehalfOfOtherIdentity&quot; de la machine cible (serveur2)</li><li>ce scenario est peu probable du fait de la peu presence de RCBD </li></ul></p><p></p><p></p><p></p><p><h2>Prérequis attaque 2</h2></p><p><ul><li>droits d&#39;ecriture sur la machine cible + behaviour par defauts (chaque user can join 10 machine accounts to AD)</li><li>exploit<ul><li>on ajoute un ordinateur compromis (ou cree nouveu ordinateur) à l&#39;attribut &quot;msds-allowedToActOnBehalfOfOtherIdentity&quot; de la machine cible</li><li>e.g genericAll rights </li></ul></li></ul><img src="images/468-2.png" alt="images/468-2.png" /><ul><li></li></ul><img src="images/468-3.png" alt="images/468-3.png" /></p><p></p><p></p><p><h2>Exploit</h2></p><p><ul><li></li></ul><img src="images/468-4.png" alt="images/468-4.png" /></p><p></p><p></p><p><ul><li>dans notr example le dc est aussi target </li><li>check via net.py (equivalent de netxec qui permet de faire net computer)</li><li></li></ul><img src="images/468-5.png" alt="images/468-5.png" /><ul><li>2/a jout l(ordinateur a latrribut mlsds-allowed... de l&#39;ordianteur cible via rbcd.py  </li><li></li></ul><img src="images/468-6.png" alt="images/468-6.png" /><ul><li>3/ optionnel : get TGT for machine account <ul><li>getTGT.py ‘domain/computername&gt;:&lt;pass&gt;’ -debug </li></ul></li></ul><img src="images/468-7.png" alt="images/468-7.png" /><ul><li>export KRB5CCNAME=&quot;&lt;computername&gt;.ccache&gt;</li><li>use -k -no-pass </li></ul></li><li>4/ requet de TGS pour l&#39;ordinatur compromis , puis request TGS pour user privilegie pour la machine cible </li><li><img src="images/468-8.png" alt="images/468-8.png" /></p><p></p><p><ul><li>next use TGS yo smbexec or wmiexec <ul><li></li></ul></li></ul><img src="images/468-9.png" alt="images/468-9.png" />*<ul><li>note : smbexec and wmiexec have different behaviours that may impact OPSEC</li><li>when launching smbexec u are launching as SYSTEM where as wmiexec u are administrator </li><li>when dumping SAM as admin u may trigger EDR for example </li><li>quand vous voulez faire du proxying par exemple si vous etes system le proxy ne va être configuré </li><li>note ; to upload§download  u can use lput and lget  </li><li>ps whoami.exe c est pas discret en red team</li></ul></li><li>Clean Up<ul><li>rbcd.py</li><li>addcomputer.py </li><li>use --delete in parameters with the same commands </li></ul></p></div>
</body>
</html>
