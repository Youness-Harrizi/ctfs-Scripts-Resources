<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>00-AD101</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>00-AD101</h1><br/><p><h2>Intro</h2><ul><li>annuaire pour gestion d&#39;objets : users,generic users , groups, certificats, comptes machines <ul><li>permet auth, authorisation</li><li>gestion de parc (windows) via des gpos (group policy objects)</li><li>ca sert de MDM (gestion de terminal)</li><li>autres fonctionalités : DHCP, DNS , PKI </li></ul></li></ul></p><p></p><p><h2>Machine Names</h2><ul><li>fqdn : e.g W10xxx.ad.pwcintenal.com</li><li>Hostname : W10xxxx</li></ul></p><p><ul><li>SAM account name : legacy DOMAIN\hostnale</li><li>UPN : user@domain</li><li>DN: distinguished name : format LDAP <ul><li>CN=w10xxxx OU=Computer DC=PWC DC=com</li></ul></li></ul></p><p></p><p></p><p><h2>Security Principal</h2></p><p><ul><li>entity that can be authenticated </li><li>SID : unique <ul><li></li></ul></li></ul><img src="images/470-1.png" alt="images/470-1.png" /></p><p></p><p></p><p></p><p></p><p><h2>SSP</h2></p><p><ul><li>ca gere l&#39;auth<ul><li>sspi c&#39;est des DLLs qui communuie avec SSP  </li><li>e.g kerberos SSPI, NTLM SSSPI , Digest security SSPI etc <ul><li> </li></ul></li></ul></li></ul></p><p></p><p></p><p><h2>Domain controller</h2></p><p><ul><li>windows server </li><li>stocke tous les AD info sous db NTDS.dit + in network SYSVOL<ul><li>c:\windows\NTDS\NTDS.dit</li><li>NTDS can be on another drive </li><li>file cznnot be copied u need ntdsutil or VM snapshot or disk backup </li><li>for SYSVOL \\LOGONSERVER\sysvol CAN Cconatin policies ; scripts, etc </li></ul></li><li>souvent joue le role de Kerbeor DC = respo  auth </li><li>certans ont des infos limited : e.g Read only (e.g doesnt contain krbtgt account hash)</li><li>c&#39;est des tier 0 durcissemnt<ul><li>limit the number of DC </li><li>first to be patched </li><li>hardned </li><li>no local accounts</li><li>optionnel<ul><li>dedicated hardware : mitigate side channel attacks </li><li>no remote control/monitoring agent deployed </li><li>dedicated backup and update systems </li><li>we dont recommed AV deployment or minimal AV </li></ul></li></ul></li></ul></p><p></p><p></p><p><h2>ACLs</h2></p><p><ul><li>access token is an object contains identiy and user rights (USER SID, group SID, LIST of privs, etc)</li><li>2 types<ul><li>primary: all processes have a primary token (user token associated to the process)</li><li>impersonation token: threads can change their security context if they have the proper rights </li></ul></li><li>ACL= decis les droits d&#39;un objets : compose de plusierus entrées ACE (SID + acces right allowed or denied)</li><li>ACLs can be misconfigured :bloodhound </li></ul></p><p></p><p></p><p><h2>GPOS</h2></p><p><ul><li>permet de faire de la gestion de parc<ul><li>appliquer des configs a des users ou computers (suvent plus de machines)</li></ul></li><li>gpedit.msc : pour changer des politiques </li><li>example : desactiver spooler d&#39;impression, mot de passe complexité , ne pas d&#39;authentifier sur certains postes </li><li>ca peut s&#39;appliquer sur OU </li><li>attaques<ul><li>\\DOMAIN\SYSVOL\POLICIES\&lt;SUID_GPO&gt;</li><li>chercher des creds </li></ul></li></ul><img src="images/470-2.png" alt="images/470-2.png" /><ul><li>LDAP signing not required =&gt; MITM and modif of script=&gt; privescv</li></ul></p><p></p><p></p><p><h2>NTLM v1 vs NTLM v2</h2></p><p></p><p><img src="images/470-3.png" alt="images/470-3.png" /></p><p></p><p><img src="images/470-4.png" alt="images/470-4.png" /></p><p></p><p></p><p></p><p>e.g diffs NTLM v2 has timestamp to migate relay attacks on non real time </p><p><ul><li></li></ul><table class="table"><tr><th>Weakness     (attack)                                                      </th><th>NTLMv1</th><th>NTLMv2                    </th></tr><tr><td>weak crypto (no salt)=&gt; easy to crack hashes</td><td>yes</td><td>yes but longer</td></tr><tr><td>offline relay attack (capture traffic and relay from another source </td><td>yes</td><td>No (timestamp)</td></tr><tr><td>No mutual auth =&gt; online relay attack</td><td>yes</td><td>yes</td></tr></table></p><p><ul><li>LM hash is very weak (max  and shouldnt be used chars; split into 2 strings, not salted ; not case sensitive)<ul><li>however always stored and mostly ignored and souvent LM hash c&#39;est AADXXX (empty)</li><li>if you find them you can try to crack them to have an idea </li></ul></li><li>NT hash<ul><li>also weak no salt </li><li>if 2 NT hashes are similar say one from admin and other user account u can say this is a vuln </li></ul></li><li>NTLMv1 and NTLMv2 allow pass the hash (only rely on NT hash) </li></ul></p><p></p><p></p><p><h2>NTLM relay mitigation</h2></p><p><ul><li>happens on protocol side e.g HTTPS , LDAPs </li><li>for SMB implent smb signing and smbv2 where session signing is enforced </li><li>for ldap , ldaps </li><li>ttp https</li><li>channel bingind : prevent cross-protocl relay <ul><li>service</li></ul></li></ul></p><p></p><p></p><p><h2>Pass The hash mitigation</h2><ul><li>PTH is a function by functioning of NTLM so Disble NTLM (very hard ; many soft dont support it)<ul><li>we can do it for TIER 0 </li></ul></li><li>cannot perform netork logon </li></ul></p><p></p><p><h2>Service accounts</h2></p><p><ul><li> specific accounts to secure services and avoid managing servuce accounts<ul><li>pass management, (pass roration) , can be used for load valancing etc </li></ul></li><li>MSA created by default for some stuff like DC$ </li><li>GMSA need to be created (more advanced and recommended)</li></ul></p><p></p><p></p><p></p><p></p><p><h2>Kerberos</h2></p><p></p><p><ul><li>centralized KDC knows all the secrest </li><li>secrets = long term keys (passwords )</li><li>based on tickets (session keys) </li><li>tickets are public ; sensitive parts are encrypted <ul><li>TGT</li><li>ST</li></ul></li><li></li></ul><img src="images/470-5.png" alt="images/470-5.png" /></p><p></p><p><ul><li>can u do PTH with kerberos<ul><li>technically yes : because you have RC4 tickets that contains NT hash </li><li>practically no , becasue it should be flagged since No one is supposed normally to do it </li></ul></li><li>step 6 : if you enable mutual auth</li><li>PAC validation<ul><li>App server ask DC that I received TGS if you are the one who have egenerated it </li><li>can mitigate forging tickets </li><li>recommened on critical services  </li></ul></li></ul></p><p></p><p></p><p><h2>AS rep roasting</h2></p><p><ul><li>on kerberos a client gets:<ul><li>TGT with Sc,k session key encrypted by DC </li><li>session key Sc,k encrypted by the client Kc </li><li>this causes a problem because no secret is required to permo AS REQ =&gt; risk of offlone bruteforce attack </li><li>hence a preauth step by defaukt in AS REQ is needed</li></ul></li><li>AS REP roastable account have preauth disabled param<ul><li>we can offline bruteforce their sectey key </li></ul></li><li>we dont need valid domain account </li></ul></p><p></p><p><h2>Golden Ticket/silver ticket</h2><ul><li>the knowledge of secret of krbtgt/DOMAIN enable to forge arbitrary keys unless  PAC validation is enabled  </li><li>for silver ticket we need service ticket bbut if PAC enabled we need also krbtgt hash </li></ul></p><p></p><p></p><p><h2>Kerberoating</h2><ul><li>if SPN set we can request ST , because a portion is encrypted with pass of service account </li><li>prerequisites : need domain account valid </li><li>ps all computers have default SPN but pass is not crackable </li></ul></p><p></p><p></p><p><h2>LAPS</h2><ul><li>Local admin password solution</li><li>one agent deployed through gpo</li><li>add ACL rights vulnerability : LAPS reader </li></ul></p><p></p><p></p><p></p><p><h2>Delegation</h2></p><p><ul><li>situation:<ul><li>utiliser kerberos AD pour s&#39;authentifier à un service web</li><li>ce service web va chercher des données sur DB server </li><li>vous avez envie que sur cette DB il y ait aussi AD auth et qu&#39;elle soit nominatif avec les personnes qui y accedent </li></ul></li><li>service SPN a déléguer l&#39;authentification d&#39;un user vers une uatre SPN </li></ul></p><p></p><p></p><p><h2>Unconstrained delegation</h2><ul><li></li></ul><img src="images/470-6.png" alt="images/470-6.png" /><ul><li>web SPN has the right to delegate to all SPNs <ul><li>object: has the userAccountControl:Tusted_For_Delegation</li><li></li></ul></li></ul><img src="images/470-7.png" alt="images/470-7.png" /><ul><li>si vous compromettez le serveur WEB n&#39;importe quelle personne qui se connecte vers vous vous pouvez l&#39;impersonifizer </li><li>coerce a domain Admin =&gt; gets domain admin creds </li><li>ps Protected users can&#39;t be delegated (should incelude all tier0 at least)<ul><li>tier0 users include domain admins or equivalent (e.g backup operator)</li><li>tier1: servers </li><li>tier2 : endpoints </li></ul></li><li>A flag set on account that pervent delegation</li><li></li></ul><img src="images/470-8.png" alt="images/470-8.png" /></p><p></p><p></p><p><h2>Constrained delegation</h2><ul><li>you specify types of services</li><li> </li></ul><img src="images/470-9.png" alt="images/470-9.png" /></p><p></p><p></p><p><h2>Trusts</h2></p><p><ul><li>connection entre 2 domaines ou 2 forets </li><li>soit directionnele soit bi / Transitive ou non </li><li>types<ul><li>forest trusts </li><li>external trusts </li></ul></li><li>each domain </li><li>en gros vous accepter les tickets qui viennent de l&#39;autre DC </li></ul></p><p></p><p><ul><li>SID history <ul><li>but : faciliter la migration e.g ajouter les users de l&#39;ancien domain </li><li>en essayant d&#39;acceder a une ressource si le SID <strong>ou</strong> le SID histiory correspond à une ACL alors c&#39;est bon</li><li>un attaquant peut faire du SID spoofing (modifier extraSIDs ) en utilisant des collisions </li></ul></li><li>SID filtering<ul><li>contre SID spoofing </li><li>si user B wants to access ressource in A (A trusts B) , any SID from domain A will be filtered/stripped from PAC </li><li>restrictions<ul><li>protections uniquement pour RID&lt;1000 (builtin RIDs): e.g exchange highly privileged users and groups will not be filtered </li><li>si user from B have been granted high privs in A , attacker can still imperonate them</li><li>quelques SIDs sont whitelisted e.g enterprise domain controllers </li></ul></li></ul></li><li>Exploit lateralization (domain 1 compromised) <ul><li>creer un golden ticket  (includes aenterprise admin par defaut)</p><p></li></ul></li></ul><img src="images/470-10.png" alt="images/470-10.png" /></p><p></p><p></p><p></p><p></p><p><h2>Recon AD </h2></p><p><ul><li>si on a pas de compte <ul><li>il  y a une netree dhcp par defaut qui commence par __ldap contenant DC IP </li></ul></li><li>scan DC </li><li>enumerer users sur ports kerberos via bruteforce via usernames<ul><li>kerbrute </li></ul></li><li>asreproast</li><li>next password spraying avec custom pass</li><li>Once we have account<ul><li>ADIDNS (equivalent to zone transfer)</li><li></li></ul></li></ul><img src="images/470-11.png" alt="images/470-11.png" /><ul><li>bloodhound</li><li>enumerate spns to find services without scanning </li><li>kerberoasting</li></ul></p></div>
</body>
</html>
